---
title: "R Notebook"
output: html_notebook
---

```{r loading data}
pacman::p_load(stringr,tidyverse,RJDBC,sqldf,dplyr,splitstackshape,svMisc)

#downloading files
#bn_books <- read.csv2("C:/Users/Cezary/Downloads/pw_ksiazki.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE) 
bn_books <- read.csv2("C:/Users/cezar/Downloads/pw_ksiazki.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE) 
#bn_articles <- read.csv2("C:/Users/Cezary/Downloads/pw_czasopisma.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE) 
bn_articles <- read.csv2("C:/Users/cezar/Downloads/pw_czasopisma.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE) 
#cz_books <- read.csv2("C:/Users/Cezary/Downloads/cz_pw_file_1.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE) 
cz_books <- read.csv2("C:/Users/cezar/Downloads/cz_pw_file_1.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE) 
#cz_articles <- read.csv2("C:/Users/Cezary/Downloads/cz_pw_file_2.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE) 
cz_articles <- read.csv2("C:/Users/cezar/Downloads/cz_pw_file_2.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE)
#connecting to PBL database
jdbcDriver =JDBC("oracle.jdbc.OracleDriver",classPath="C:/Users/cezar/Documents/R/ojdbc6.jar")
#jdbcDriver =JDBC("oracle.jdbc.OracleDriver",classPath="E:/Cezary/Documents/ojdbc6.jar")
PBL <- dbConnect(jdbcDriver, "jdbc:oracle:thin:@//pbl.ibl.poznan.pl:1521/xe", "IBL_SELECT", "CR333444")
pbl_articles1 <- dbGetQuery(PBL,
                        "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                          dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                          tw.tw_imie \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                          a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                          to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                          z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                          z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                        from pbl_zapisy z
                        join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                        join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                        join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                        join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                        join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                        join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                        join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                        join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                        join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                        join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                        where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                        and z.za_uzytk_wpisal like 'ANIA'
                        and z.za_ro_rok<2000")
pbl_articles2 <- dbGetQuery(PBL,
                          "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                            dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                            tw.tw_imie \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                            a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                            to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                            z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                            z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                          from pbl_zapisy z
                          join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                          join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                          join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                          join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                          join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                          join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                          join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                          where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                          and z.za_uzytk_wpisal like 'ANIA'
                          and z.za_ro_rok<2000")
pbl_articles3 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                                    tw.tw_imie \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                                    to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                                    z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                            join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                            join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                            join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                            join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")
pbl_articles4 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                                    tw.tw_imie \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                                    to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                                    z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                            join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                            join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")

pbl_articles <- sqldf("select *
              from pbl_articles1 a
              UNION
              select *
              from pbl_articles2 b
              where b.rekord_id not in (select a.rekord_id
              from pbl_articles1 a)")
pbl_articles <- sqldf("select *
                      from pbl_articles a
                      UNION
                      select * 
                      from pbl_articles3 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_articles a)")
pbl_articles <- sqldf("select *
                      from pbl_articles a
                      UNION
                      select *
                      from pbl_articles4 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_articles a)")
pbl_articles1 <- dbGetQuery(PBL,
                        "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                          dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                          to_char(null) \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                          a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                          to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                          z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                          z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                        from pbl_zapisy z
                        join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                        join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                        join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                        join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                        join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                        join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                        join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                        join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                        where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                        and z.za_uzytk_wpisal like 'ANIA'
                        and z.za_ro_rok<2000")
pbl_articles2 <- dbGetQuery(PBL,
                          "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                            dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                            to_char(null) \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                            a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                            to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                            z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                            z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                          from pbl_zapisy z
                          join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                          join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                          join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                          join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                          join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                          where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                          and z.za_uzytk_wpisal like 'ANIA'
                          and z.za_ro_rok<2000")
pbl_articles3 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                                    to_char(null) \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                                    to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                                    z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                            join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                            join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")
pbl_articles4 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                                    to_char(null) \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                                    to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", to_char(zr.zr_zrodlo_id) \"czasopismo_id\", zr.zr_tytul \"czasopismo\", 
                                    z.za_zrodlo_rok \"rok\", z.za_zrodlo_nr \"numer\", z.za_zrodlo_str \"strony\"
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zrodla zr on zr.zr_zrodlo_id=z.za_zr_zrodlo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")

pbl_articles1 <- sqldf("select *
              from pbl_articles1 a
              UNION
              select *
              from pbl_articles2 b
              where b.rekord_id not in (select a.rekord_id
              from pbl_articles1 a)")
pbl_articles1 <- sqldf("select *
                      from pbl_articles a
                      UNION
                      select * 
                      from pbl_articles3 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_articles1 a)")
pbl_articles1 <- sqldf("select *
                      from pbl_articles a
                      UNION
                      select *
                      from pbl_articles4 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_articles1 a)")
pbl_articles <- sqldf("select *
              from pbl_articles a
              UNION
              select *
              from pbl_articles1 b
              where b.rekord_id not in (select a.rekord_id
              from pbl_articles a)")

pbl_books1 <- dbGetQuery(PBL,
                        "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                          dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                          tw.tw_imie \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                          a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                          to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                          z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok
                        from pbl_zapisy z
                        join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                        join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                        join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                        join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                        join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
						join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                        join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                        join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                        join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                        join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                        join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                        where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                        and z.za_uzytk_wpisal like 'ANIA'
                        and z.za_ro_rok<2000")
pbl_books2 <- dbGetQuery(PBL,
                          "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                            dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                            tw.tw_imie \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                            a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                            to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                            z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok
                          from pbl_zapisy z
                          join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                          join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                          join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                          join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                          join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
						  join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                          join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                          join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                          where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                          and z.za_uzytk_wpisal like 'ANIA'
                          and z.za_ro_rok<2000")
pbl_books3 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                                    tw.tw_imie \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                                    to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok  
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                            join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                            join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
							join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                            join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                            join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")
pbl_books4 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(tw.tw_tworca_id) \"tworca_id\", tw.tw_nazwisko \"tworca_nazwisko\",
                                    tw.tw_imie \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                                    to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok 
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zapisy_tworcy zt on zt.zatw_za_zapis_id=z.za_zapis_id
                            join IBL_OWNER.pbl_tworcy tw on zt.zatw_tw_tworca_id=tw.tw_tworca_id
                            join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
							join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")

pbl_books <- sqldf("select *
              from pbl_books1 a
              UNION
              select *
              from pbl_books2 b
              where b.rekord_id not in (select a.rekord_id
              from pbl_books1 a)")
pbl_books <- sqldf("select *
                      from pbl_books a
                      UNION
                      select * 
                      from pbl_books3 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_books a)")
pbl_books <- sqldf("select *
                      from pbl_books a
                      UNION
                      select *
                      from pbl_books4 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_books a)")
pbl_books1 <- dbGetQuery(PBL,
                        "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                          dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                          to_char(null) \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                          a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                          to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                          z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok
                        from pbl_zapisy z
                        join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                        join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                        join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
						join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                        join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                        join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                        join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                        join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                        join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                        where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                        and z.za_uzytk_wpisal like 'ANIA'
                        and z.za_ro_rok<2000")
pbl_books2 <- dbGetQuery(PBL,
                          "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                            dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                            to_char(null) \"tworca_imie\", to_char(a.am_autor_id) \"autor_id\", a.am_nazwisko \"autor_nazwisko\", 
                            a.am_imie \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                            to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                            z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok
                          from pbl_zapisy z
                          join IBL_OWNER.pbl_zapisy_autorzy za on za.zaam_za_zapis_id=z.za_zapis_id
                          join IBL_OWNER.pbl_autorzy a on za.zaam_am_autor_id=a.am_autor_id
                          join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
						  join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                          join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                          join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                          where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                          and z.za_uzytk_wpisal like 'ANIA'
                          and z.za_ro_rok<2000")
pbl_books3 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                                    to_char(null) \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", fo.fo_nazwa \"funkcja_osoby\", 
                                    to_char(os.os_osoba_id) \"wspoltworca_id\", os.os_nazwisko \"wspoltworca_nazwisko\", os.os_imie \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
							join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            join IBL_OWNER.pbl_udzialy_osob uo on uo.uo_za_zapis_id = z.za_zapis_id
                            join IBL_OWNER.pbl_osoby os on uo.uo_os_osoba_id=os.os_osoba_id
                            join IBL_OWNER.pbl_funkcje_osob fo on fo.fo_symbol=uo.uo_fo_symbol
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")
pbl_books4 <- dbGetQuery(PBL,
                            "select z.za_zapis_id \"rekord_id\", z.za_type \"typ\", rz.rz_rodzaj_id \"rodzaj_zapisu_id\", rz.rz_nazwa \"rodzaj_zapisu\", 
                                    dz.dz_dzial_id \"dzial_id\", dz.dz_nazwa \"dzial\", to_char(null) \"tworca_id\", to_char(null) \"tworca_nazwisko\",
                                    to_char(null) \"tworca_imie\", to_char(null) \"autor_id\", to_char(null) \"autor_nazwisko\", 
                                    to_char(null) \"autor_imie\", z.za_tytul \"tytul\", z.za_opis_wspoltworcow \"wspoltworcy\", to_char(null) \"funkcja_osoby\", 
                                    to_char(null) \"wspoltworca_id\", to_char(null) \"wspoltworca_nazwisko\", to_char(null) \"wspoltworca_imie\", 
                                    z.za_adnotacje \"adnotacja\", w.wy_nazwa \"wydawnictwo\", w.wy_miasto \"miejscowosc\", z.za_rok_wydania \"rok_wydania\", z.za_opis_fizyczny_ksiazki \"opis_fizyczny\", z.za_uzytk_wpisal, z.za_ro_rok                               
                            from pbl_zapisy z
                            join IBL_OWNER.pbl_zapisy_wydawnictwa zw on zw.zawy_za_zapis_id=z.za_zapis_id 
							join IBL_OWNER.pbl_wydawnictwa w on zw.zawy_wy_wydawnictwo_id=w.wy_wydawnictwo_id
                            join IBL_OWNER.pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            where z.za_uzytk_wpis_data between '2019/05/01' and '2019/06/30'
                            and z.za_uzytk_wpisal like 'ANIA'
                            and z.za_ro_rok<2000")

pbl_books1 <- sqldf("select *
              from pbl_books1 a
              UNION
              select *
              from pbl_books2 b
              where b.rekord_id not in (select a.rekord_id
              from pbl_books1 a)")
pbl_books1 <- sqldf("select *
                      from pbl_books1 a
                      UNION
                      select * 
                      from pbl_books3 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_books1 a)")
pbl_books1 <- sqldf("select *
                      from pbl_books1 a
                      UNION
                      select *
                      from pbl_books4 b
                      where b.rekord_id not in (select a.rekord_id
                      from pbl_books1 a)")
pbl_books <- sqldf("select *
              from pbl_books a
              UNION
              select *
              from pbl_books1 b
              where b.rekord_id not in (select a.rekord_id
              from pbl_books a)")
```


```{r extracting personal data}
#bn_books
trim <- function (x) gsub("^\\s+|\\s+$", "", x)
#field X100
marc_field <- bn_books %>%
  select(id,X100)%>%
  filter(X100!="")
subfield_list<- str_extract_all(bn_books$X100,"\\%.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list
marc_field<-cbind(marc_field,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field$X100 <- str_replace(marc_field$X100,subfield_list_char[i],"|\\1")
}
subfield_list_char2 <- str_replace_all(subfield_list,"\\%","\\\\%")
for (i in x) {
  progress(match(i,x), max.value = length(x))
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\%)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field[,i+2] <- ifelse(grepl(subfield_list_char2[i],marc_field$X100),str_replace_all(gsub(string,"\\3",marc_field$X100),"\\%.", "~"),NA)
}

marc_field$`%1` <- trim(marc_field$`%1`)
marc_field$`%2` <- trim(marc_field$`%2`)
marc_field$`%d` <- trim(marc_field$`%d`)
marc_field$`%4` <- trim(marc_field$`%4`)
marc_field$`%3` <- trim(marc_field$`%3`)
marc_field$`%s` <- trim(marc_field$`%s`)
marc_field$`%w` <- trim(marc_field$`%w`)
marc_field$`%r` <- trim(marc_field$`%r`)
marc_field$`%m` <- trim(marc_field$`%m`)
marc_field$`%p` <- trim(marc_field$`%p`)
marc_field$`%k` <- trim(marc_field$`%k`)

bn_record_people_X100 <- marc_field %>%
  select(record_id = id, `%1`, `%2`, `%d`, `%4`, `%3`, `%s`,`%w`,`%p`,`%k`) %>%
  mutate(`%1` = paste(`%1`,`%3`,sep = " ")) %>%
  mutate(`%2` = paste(`%2`,`%4`,sep = " ")) %>%
  select(-`%3`,-`%4`) %>%
  mutate(data_set = "bn_books", field = "X100") %>%
  select(data_set, field, 1:8)
bn_record_people_X100[] <- lapply(bn_record_people_X100, gsub, pattern=' NA', replacement='')
bn_record_people_X100[] <- lapply(bn_record_people_X100, gsub, pattern='NANA', replacement='')
bn_record_people_X100[] <- lapply(bn_record_people_X100, gsub, pattern='NA$', replacement='')
bn_record_people_X100$name <- paste(bn_record_people_X100$`%1`,bn_record_people_X100$`%2`,bn_record_people_X100$`%d`,sep = "|")
bn_record_people_X100[] <- lapply(bn_record_people_X100, gsub, pattern='\\|NA', replacement='')
#field X700
marc_field <- bn_books %>%
  select(id,X700)%>%
  filter(X700!="")
subfield_list<- str_extract_all(bn_books$X700,"\\%.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list
marc_field<-cbind(marc_field,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field$X700 <- str_replace(marc_field$X700,subfield_list_char[i],"|\\1")
}
subfield_list_char2 <- str_replace_all(subfield_list,"\\%","\\\\%")
for (i in x) {
  progress(match(i,x), max.value = length(x))
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\%)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field[,i+2] <- ifelse(grepl(subfield_list_char2[i],marc_field$X700),str_replace_all(gsub(string,"\\3",marc_field$X700),"\\%.", "~"),NA)
}

marc_field$`%1` <- trim(marc_field$`%1`)
marc_field$`%2` <- trim(marc_field$`%2`)
marc_field$`%d` <- trim(marc_field$`%d`)
marc_field$`%4` <- trim(marc_field$`%4`)
marc_field$`%3` <- trim(marc_field$`%3`)
marc_field$`%s` <- trim(marc_field$`%s`)
marc_field$`%w` <- trim(marc_field$`%w`)
marc_field$`%r` <- trim(marc_field$`%r`)
marc_field$`%m` <- trim(marc_field$`%m`)
marc_field$`%p` <- trim(marc_field$`%p`)
marc_field$`%k` <- trim(marc_field$`%k`)

bn_record_people_X700 <- marc_field %>%
  select(record_id = id, `%1`, `%2`, `%d`, `%4`, `%3`, `%s`,`%w`,`%p`,`%k`) %>%
  mutate(`%1` = paste(`%1`,`%3`,sep = " ")) %>%
  mutate(`%2` = paste(`%2`,`%4`,sep = " ")) %>%
  select(-`%3`,-`%4`) %>%
  mutate(data_set = "bn_books", field = "X700") %>%
  select(data_set, field, 1:8)
bn_record_people_X700[] <- lapply(bn_record_people_X700, gsub, pattern=' NA', replacement='')
bn_record_people_X700[] <- lapply(bn_record_people_X700, gsub, pattern='NANA', replacement='')
bn_record_people_X700[] <- lapply(bn_record_people_X700, gsub, pattern='NA$', replacement='')
bn_record_people_X700$name <- paste(bn_record_people_X700$`%1`,bn_record_people_X700$`%2`,bn_record_people_X700$`%d`,sep = "|")
bn_record_people_X700[] <- lapply(bn_record_people_X700, gsub, pattern='\\|NA', replacement='')
#field X701
marc_field <- bn_books %>%
  select(id,X701)%>%
  filter(X701!="")
subfield_list<- str_extract_all(bn_books$X701,"\\%.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list
marc_field<-cbind(marc_field,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field$X701 <- str_replace(marc_field$X701,subfield_list_char[i],"|\\1")
}
subfield_list_char2 <- str_replace_all(subfield_list,"\\%","\\\\%")
for (i in x) {
  progress(match(i,x), max.value = length(x))
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\%)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field[,i+2] <- ifelse(grepl(subfield_list_char2[i],marc_field$X701),str_replace_all(gsub(string,"\\3",marc_field$X701),"\\%.", "~"),NA)
}

marc_field$`%1` <- trim(marc_field$`%1`)
marc_field$`%2` <- trim(marc_field$`%2`)
marc_field$`%d` <- trim(marc_field$`%d`)
marc_field$`%3` <- trim(marc_field$`%3`)
marc_field$`%s` <- trim(marc_field$`%s`)
marc_field$`%r` <- trim(marc_field$`%r`)
marc_field$`%p` <- trim(marc_field$`%p`)


bn_record_people_X701 <- marc_field %>%
  select(record_id = id, `%1`, `%2`, `%d`, `%3`, `%s`, `%p`) %>%
  mutate(`%4` = NA, `%w` = NA, `%k` = NA) %>%
  mutate(`%1` = paste(`%1`,`%3`,sep = " ")) %>%
  mutate(`%2` = paste(`%2`,`%4`,sep = " ")) %>%
  select(-`%3`,-`%4`) %>%
  mutate(data_set = "bn_books", field = "X701") %>%
  select(colnames(bn_record_people_X100)[1:10])
bn_record_people_X701[] <- lapply(bn_record_people_X701, gsub, pattern=' NA', replacement='')
bn_record_people_X701[] <- lapply(bn_record_people_X701, gsub, pattern='NANA', replacement='')
bn_record_people_X701[] <- lapply(bn_record_people_X701, gsub, pattern='NA$', replacement='')
bn_record_people_X701$name <- paste(bn_record_people_X701$`%1`,bn_record_people_X701$`%2`,bn_record_people_X701$`%d`,sep = "|")
bn_record_people_X701[] <- lapply(bn_record_people_X701, gsub, pattern='\\|NA', replacement='')

bn_record_people <- rbind(bn_record_people_X100,bn_record_people_X700,bn_record_people_X701)
set1 <- bn_record_people %>%
  select(1:6,11) %>%
  mutate(`%1` = paste(`%1`,`%2`,`%d`, sep = " ")) %>% 
  select(data_set,field,record_id,`%1`,name) %>%
  mutate(subfield = colnames(set1)[4])
colnames(set1)[4] <- "name_form"
set1[] <- lapply(set1, gsub, pattern=' NA', replacement='')
set1$name_form <- trim(set1$name_form)

set2 <- bn_record_people[c(1:3,7,11)] %>%
  filter(!is.na(`%s`)) %>%
  mutate(subfield = colnames(set2)[4])
colnames(set2)[4] <- "name_form"
set3 <- bn_record_people[c(1:3,8,11)] %>%
  filter(!is.na(`%w`)) %>%
  mutate(subfield = colnames(set3)[4])
colnames(set3)[4] <- "name_form"
set4 <- bn_record_people[c(1:3,9,11)] %>%
  filter(!is.na(`%p`)) %>%
  mutate(subfield = colnames(set4)[4])
colnames(set4)[4] <- "name_form"
set5 <- bn_record_people[c(1:3,10,11)] %>%
  filter(!is.na(`%k`)) %>%
  mutate(subfield = colnames(set5)[4])
colnames(set5)[4] <- "name_form"

bn_record_people <- rbind(bn_record_people[c(1:6,11)] %>% mutate(`%1` = paste(`%1`,`%2`,`%d`, sep = " ")) %>% select(data_set,field,record_id,`%1`,name),bn_record_people[c(1:3,7,11)],bn_record_people[c(1:3,8,11)],bn_record_people[c(1:3,9,11)],bn_record_people[c(1:3,10,11)])

#cz_books
#field X100
marc_field <- cz_books %>%
  select(id,X100)%>%
  filter(X100!="")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(cz_books$X100,"\\${2}.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list
marc_field<-cbind(marc_field,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")
x <- 1:length(subfield_list)
for (i in x) {
  marc_field$X100 <- str_replace(marc_field$X100,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  progress(match(i,x), max.value = length(x))
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\${2})(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X100),str_replace_all(gsub(string,"\\3",marc_field$X100),"\\${2}.", "~"),NA)
}

marc_field$`$$a` <- trim(marc_field$`$$a`)
marc_field$`$$d` <- trim(marc_field$`$$d`)
marc_field$`$$b` <- str_remove(trim(marc_field$`$$b`),"\\.$")

cz_people_record_id_X100 <- marc_field %>%
  select(record_id = id, name = `$$a`, name2 = `$$b`, years = `$$d`) %>%
  mutate(full_name = paste(name,name2,sep = " "))
cz_people_record_id_X100[] <- lapply(cz_people_record_id_X100, gsub, pattern=' NA', replacement='')
cz_people_record_id_X100$full_name <- ifelse(cz_people_record_id_X100$full_name=="Jan Pavel II.","Jan Pavel II", as.character(cz_people_record_id_X100$full_name))
cz_people_record_id_X100 <- cz_people_record_id_X100 %>%
  mutate(last_name = str_replace(full_name,"(^.*?)(\\,.*$)","\\1")) %>%
  mutate(first_name = ifelse(grepl("\\,",full_name),str_replace(full_name,"(^.*?\\, )(.*?)","\\2"),NA)) %>%
  select(record_id,last_name,first_name,years)

cz_people_record_id_X100$name_total <- paste(cz_people_record_id_X100$last_name,cz_people_record_id_X100$first_name,cz_people_record_id_X100$years,sep = "|")
cz_people_record_id_X100[] <- lapply(cz_people_record_id_X100, gsub, pattern='\\|NA', replacement='')

cz_people_record_id_X100 <- cz_people_record_id_X100 %>%
  group_by(name_total) %>%
  mutate(record_id_group = paste(record_id,collapse = "|")) %>%
  mutate(record_id_group = paste("cz_X100",record_id_group,sep = "|")) %>%
  ungroup() %>%
  select(last_name,first_name,years,name_total,record_id_group) %>%
  unique()

#field X600
marc_field <- cz_books %>%
  select(id,X600)%>%
  filter(X600!="")
marc_field$X600<-str_replace_all(marc_field$X600,"(^|\\|)","~\\1")
marc_field<- cSplit(marc_field,"X600",sep = "~",direction = "long")
marc_field<- marc_field%>%
  filter(X600!="")
marc_field$X600<-str_remove_all(marc_field$X600,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X600,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(cz_books$X600,"\\${2}.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list
marc_field<-cbind(marc_field,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")
x <- 1:length(subfield_list)
for (i in x) {
  marc_field$X600 <- str_replace(marc_field$X600,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  progress(match(i,x), max.value = length(x))
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\${2})(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X600),str_replace_all(gsub(string,"\\3",marc_field$X600),"\\${2}.", "~"),NA)
}

marc_field$`$$a` <- trim(marc_field$`$$a`)
marc_field$`$$d` <- trim(marc_field$`$$d`)
marc_field$`$$b` <- str_remove(trim(marc_field$`$$b`),"\\.$")

cz_people_record_id_X600 <- marc_field %>%
  select(record_id = id, name = `$$a`, name2 = `$$b`, years = `$$d`) %>%
  mutate(full_name = paste(name,name2,sep = " "))
cz_people_record_id_X600[] <- lapply(cz_people_record_id_X600, gsub, pattern=' NA', replacement='')
cz_people_record_id_X600$full_name <- ifelse(cz_people_record_id_X600$full_name=="Jan Pavel II.","Jan Pavel II", as.character(cz_people_record_id_X600$full_name))
cz_people_record_id_X600 <- cz_people_record_id_X600 %>%
  mutate(last_name = str_replace(full_name,"(^.*?)(\\,.*$)","\\1")) %>%
  mutate(first_name = ifelse(grepl("\\,",full_name),str_replace(full_name,"(^.*?\\, )(.*?)","\\2"),NA)) %>%
  select(record_id,last_name,first_name,years)

cz_people_record_id_X600$name_total <- paste(cz_people_record_id_X600$last_name,cz_people_record_id_X600$first_name,cz_people_record_id_X600$years,sep = "|")
cz_people_record_id_X600[] <- lapply(cz_people_record_id_X600, gsub, pattern='\\|NA', replacement='')

cz_people_record_id_X600 <- cz_people_record_id_X600 %>%
  group_by(name_total) %>%
  mutate(record_id_group = paste(record_id,collapse = "|")) %>%
  mutate(record_id_group = paste("cz_X600",record_id_group,sep = "|")) %>%
  ungroup() %>%
  select(last_name,first_name,years,name_total,record_id_group) %>%
  unique()

#field X700
marc_field <- cz_books %>%
  select(id,X700)%>%
  filter(X700!="")
marc_field$X700<-str_replace_all(marc_field$X700,"(^|\\|)","~\\1")
marc_field<- cSplit(marc_field,"X700",sep = "~",direction = "long")
marc_field<- marc_field%>%
  filter(X700!="")
marc_field$X700<-str_remove_all(marc_field$X700,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X700,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(cz_books$X700,"\\${2}.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list
marc_field<-cbind(marc_field,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")
x <- 1:length(subfield_list)
for (i in x) {
  marc_field$X700 <- str_replace(marc_field$X700,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  progress(match(i,x), max.value = length(x))
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\${2})(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X700),str_replace_all(gsub(string,"\\3",marc_field$X700),"\\${2}.", "~"),NA)
}

marc_field$`$$a` <- trim(marc_field$`$$a`)
marc_field$`$$d` <- trim(marc_field$`$$d`)
marc_field$`$$b` <- str_remove(trim(marc_field$`$$b`),"\\.$")

cz_people_record_id_X700 <- marc_field %>%
  select(record_id = id, name = `$$a`, name2 = `$$b`, years = `$$d`) %>%
  mutate(full_name = paste(name,name2,sep = " "))
cz_people_record_id_X700[] <- lapply(cz_people_record_id_X700, gsub, pattern=' NA', replacement='')
cz_people_record_id_X700$full_name <- ifelse(cz_people_record_id_X700$full_name=="Jan Pavel II.","Jan Pavel II", as.character(cz_people_record_id_X700$full_name))
cz_people_record_id_X700 <- cz_people_record_id_X700 %>%
  mutate(last_name = str_replace(full_name,"(^.*?)(\\,.*$)","\\1")) %>%
  mutate(first_name = ifelse(grepl("\\,",full_name),str_replace(full_name,"(^.*?\\, )(.*?)","\\2"),NA)) %>%
  select(record_id,last_name,first_name,years)

cz_people_record_id_X700$name_total <- paste(cz_people_record_id_X700$last_name,cz_people_record_id_X700$first_name,cz_people_record_id_X700$years,sep = "|")
cz_people_record_id_X700[] <- lapply(cz_people_record_id_X700, gsub, pattern='\\|NA', replacement='')

cz_people_record_id_X700 <- cz_people_record_id_X700 %>%
  group_by(name_total) %>%
  mutate(record_id_group = paste(record_id,collapse = "|")) %>%
  mutate(record_id_group = paste("cz_X700",record_id_group,sep = "|")) %>%
  ungroup() %>%
  select(last_name,first_name,years,name_total,record_id_group) %>%
  unique()

#concatenate all cz
cz_people_record_id <- rbind(cz_people_record_id_X100,cz_people_record_id_X600,cz_people_record_id_X700)
cz_people_record_id <- cz_people_record_id %>%
  group_by(name_total) %>%
  mutate(record_id_group = paste(record_id_group,collapse = "~")) %>%
  ungroup() %>%
  mutate(person_id = paste("cz_b_",seq.int(nrow(cz_people_record_id)),sep = "")) %>%
  select(person_id,1:5)


#putting it together
people_record_id <- rbind(bn_people_record_id,cz_people_record_id)

write.csv2(people_record_id, "C:/Users/Cezary/Desktop/people_record_id.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')
```

```{r}
bn_people_record_id_X701 <- bn_people_record_id_X701 %>%
  group_by(name_total) %>%
  mutate(record_id_group = paste(record_id,collapse = "|")) %>%
  mutate(record_id_group = paste("bn_X701",record_id_group,sep = "|")) %>%
  ungroup() %>%
  select(last_name,first_name,years,name_total,record_id_group) %>%
  unique()

#concatenate all bn
bn_people_record_id <- rbind(bn_people_record_id_X100,bn_people_record_id_X700,bn_people_record_id_X701)
bn_people_record_id <- bn_people_record_id %>%
  group_by(name_total) %>%
  mutate(record_id_group = paste(record_id_group,collapse = "~")) %>%
  ungroup() %>%
  mutate(person_id = paste("bn_b_",seq.int(nrow(bn_people_record_id)),sep = "")) %>%
  select(person_id,1:5)
```


