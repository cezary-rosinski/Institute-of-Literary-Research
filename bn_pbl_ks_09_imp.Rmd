---
title: "R Notebook"
output: html_notebook
---
cel: automatycznie IMPORT OK co się da; IMPORT - 5000 zapisów z ukd i deskryptorami najbardziej literackimi; reszta nie wchodzi
```{r Wczytanie plików}
#biblioteki
options(java.parameters = "-Xmx32000m")
options(scipen = 999)
pacman::p_load(utf8,googlesheets4,zoo,stringr,splitstackshape,plyr,dplyr,sqldf,stringdist,fuzzyjoin,data.table,svMisc,tidyverse,RJDBC,arrangements,tokenizers,openxlsx)

#połączenie z bazą PBL
jdbcDriver =JDBC("oracle.jdbc.OracleDriver",classPath="C:/Users/Cezary/Downloads/ojdbc6.jar")
PBL <- dbConnect(jdbcDriver, "jdbc:oracle:thin:@//pbl.ibl.poznan.pl:1521/xe", "IBL_SELECT", "CR333444")

#wgranie zbiorów książek
bn_ks <- read.csv2("C:/Users/Cezary/Downloads/bn_ks_2009.csv", encoding = "UTF-8", header = TRUE, stringsAsFactors = FALSE) %>%
  filter(!grepl("\\\\$aArtykuły|\\\\$Druki ulotne",X380)) %>%
  filter(!grepl("\\$aNadbitki i odbitki",X655)) %>%
  filter(grepl("Książki",X380,ignore.case = FALSE)|X380=="") %>%
  filter(grepl("\\$aWA|\\$aW ",X040)) %>%
  filter(X655!="\\7$aKomiks$2DBN") %>%
  mutate(BN_URL = paste("https://katalogi.bn.org.pl/discovery/fulldisplay?docid=alma",as.character(X009),"&context=L&vid=48OMNIS_NLOP:48OMNIS_NLOP&lang=pl",sep = ""))

### przenieść kolejnych autorów z 700 do pola 100
marc_field_700 <- bn_ks %>%
  select(id,X700)%>%
  filter(X700!="") %>%
  mutate(X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X700",sep = "~",direction = "long") %>%
  filter(X700!="") %>%
  mutate(X700=str_remove_all(X700,"^\\|")) %>%
  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(bn_ks$X700,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
colnames(empty_table) <-subfield_list
marc_field_700<-cbind(marc_field_700,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")
x <- 1:length(subfield_list)

for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
}

marc_field_700 <- marc_field_700 %>%
  filter(is.na(`$e`)&is.na(`$t`)) %>%
  select(id, X700) %>%
  mutate(drugi_autor = str_remove_all(X700,"\\|")) %>%
  select(id,drugi_autor)

drugi_autor <- bn_ks %>%
  full_join(.,marc_field_700,by = "id") %>%
  select(id,X100,X700,drugi_autor) %>%
  group_by(id) %>%
  mutate(X100 = ifelse(!is.na(drugi_autor),str_remove(paste(X100,paste(drugi_autor,collapse = "|"),sep = "|"),"^\\|"),as.character(X100)),
         drugi_autor = list(drugi_autor)) %>%
  ungroup() %>%
  unique()
  
x <- 1:length(drugi_autor$id)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  y <- 1:lengths(drugi_autor$drugi_autor[i])
  for (j in y) {
    drugi_autor$X700[i] <- ifelse(is.na(drugi_autor$drugi_autor[i]),as.character(drugi_autor$X700[i]),
                           ifelse(grepl(str_replace_all(str_replace_all(str_replace_all(str_replace_all(drugi_autor$drugi_autor[i][[1]][j],"\\\\","\\\\\\\\"),"\\$","\\\\$"),"\\(","\\\\("),"\\)","\\\\)"),drugi_autor$X700[i]),str_remove(drugi_autor$X700[i],str_replace_all(str_replace_all(str_replace_all(str_replace_all(drugi_autor$drugi_autor[i][[1]][j],"\\\\","\\\\\\\\"),"\\$","\\\\$"),"\\(","\\\\("),"\\)","\\\\)")),as.character(drugi_autor$X700[i])))
  }
}

drugi_autor <- drugi_autor %>%
  mutate(X700 = str_replace_all(X700,"(\\|)+","|"),
         X700 = str_remove(X700,"\\||$"),
         X700 = ifelse(X700=="|","",as.character(X700))) %>%
  select(id,X100,X700)
bn_ks <- bn_ks %>%
  mutate(X100 = drugi_autor$X100,
         X700 = drugi_autor$X700)

##koniec przenosin
```

```{r generowanie listy zapisow z osobami PBL}
#wczytanie listy utożsamionych twórców z autorami BN
pbl_viaf <- sheets_read(ss = "1cEz73dGN2r2-TTc702yne9tKfH9PQ6UyAJ2zBSV6Jb0") %>%
  filter(czy_ten_sam!="nie") %>%
  select(pbl_id, BN_id, BN_name) %>%
  mutate(BN_name = str_replace_all(BN_name,"\\|\\(", " ("),
         BN_name = str_replace_all(BN_name, "\\;\\|", "; ")) %>%
  cSplit(.,"BN_name",sep = "|",direction = "long") %>%
  filter(BN_name!="")
pbl_viaf2 <- sheets_read(ss = "1_Bhwzo0xu4yTn8tF0ZNAZq9iIAqIxfcrjeLVCm_mggM") %>%
  filter(czy_ten_sam!="nie") %>%
  select(pbl_id, BN_id, BN_name) %>%
  mutate(BN_name = str_replace_all(BN_name,"\\|\\(", " ("),
         BN_name = str_replace_all(BN_name, "\\;\\|", "; ")) %>%
  cSplit(.,"BN_name",sep = "|",direction = "long") %>%
  filter(BN_name!="")
pbl_viaf <- rbind(pbl_viaf,pbl_viaf2) %>%
  arrange(pbl_id) %>%
  unique()
remove(pbl_viaf2)

#zostawić do testowania, czy jedno hasło bn nie zasila kilku haseł twórców pbl
#pbl_viaf <- sheets_read(ss = "1cEz73dGN2r2-TTc702yne9tKfH9PQ6UyAJ2zBSV6Jb0") %>%
#  filter(czy_ten_sam!="nie") %>%
#  select(pbl_id, BN_id, BN_name)
#pbl_viaf2 <- sheets_read(ss = "1_Bhwzo0xu4yTn8tF0ZNAZq9iIAqIxfcrjeLVCm_mggM") %>%
#  filter(czy_ten_sam!="nie") %>%
#  select(pbl_id, BN_id, BN_name)
#pbl_viaf <- rbind(pbl_viaf,pbl_viaf2) %>%
#  arrange(pbl_id) %>%
#  unique()
#
#count <- as.data.frame(table(pbl_viaf$BN_id))
#pbl_viaf <- merge(pbl_viaf,count,by.x = "BN_id",by.y = "Var1",all.x = TRUE)
#pbl_viaf <- pbl_viaf %>%
#  unique()
#count2 <- as.data.frame(table(pbl_viaf$pbl_id))

#utożsamianie po nazewnictwie z informacją o dziale
tworca_i_dzial <- dbGetQuery(PBL,
                             "select tw.tw_tworca_id \"pbl_id\", dz.dz_dzial_id||'|'||dz.dz_nazwa \"osoba_pbl_dzial_id_name\"
                              from pbl_tworcy tw
                              full join pbl_dzialy dz on dz.dz_dzial_id=tw.tw_dz_dzial_id")

#listy nazwisk BN ze zbioru
#100
marc_field_100 <- bn_ks %>%
  select(id,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(bn_ks$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}
marc_field_100 <- marc_field_100 %>%
  select(id,`$a`,`$d`,`$c`) %>%
  mutate(name = ifelse(!is.na(`$c`)&substr(`$c`,nchar(`$c`),nchar(`$c`))==";",paste(`$a`,`$c`,`$d`,sep = " "),ifelse(!is.na(`$d`),paste(`$a`,`$d`,sep = " "),as.character(`$a`)))) %>%
  select(id,name) %>%
  mutate(name = str_replace(name,"(\\))(\\.$)","\\1"),
         name = str_replace(name, "([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)","\\1"))

osoba_bn_100_pbl <- marc_field_100 %>%
  unique() %>%
  inner_join(.,pbl_viaf,by = c("name" = "BN_name")) %>%
  select(1:3) %>%
  left_join(.,tworca_i_dzial,by = "pbl_id") %>%
  select(id,osoba_pbl_dzial_id_name) %>%
  group_by(id) %>%
  mutate(osoba_bn_autor = paste(unique(osoba_pbl_dzial_id_name),collapse = "~")) %>%
  select(-osoba_pbl_dzial_id_name) %>%
  ungroup() %>%
  unique()

#600
marc_field_600 <- bn_ks %>%
  select(id,X600)%>%
  filter(X600!="") %>%
  mutate(X600=str_replace_all(X600,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X600",sep = "~",direction = "long") %>%
  filter(X600!="") %>%
  mutate(X600=str_remove_all(X600,"^\\|")) %>%
  mutate(indicator = str_replace_all(X600,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(bn_ks$X600,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_600)[1]))
colnames(empty_table) <-subfield_list
marc_field_600<-cbind(marc_field_600,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")
x <- 1:length(subfield_list)

for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_600$X600 <- str_replace(marc_field_600$X600,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_600[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_600$X600),str_replace_all(gsub(string,"\\3",marc_field_600$X600),"\\${2}.", "~"),NA)
}
marc_field_600 <- marc_field_600 %>%
  select(id,`$a`,`$d`,`$c`) %>%
  mutate(name = ifelse(!is.na(`$c`)&substr(`$c`,nchar(`$c`),nchar(`$c`))==";",paste(`$a`,`$c`,`$d`,sep = " "),ifelse(!is.na(`$d`),paste(`$a`,`$d`,sep = " "),as.character(`$a`)))) %>%
  select(id,name) %>%
  mutate(name = str_replace(name,"(\\))(\\.$)","\\1"),
         name = str_replace(name, "([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)","\\1"))
osoba_bn_600_pbl <- marc_field_600 %>%
  unique() %>%
  inner_join(.,pbl_viaf,by = c("name" = "BN_name")) %>%
  select(1:3) %>%
  left_join(.,tworca_i_dzial,by = "pbl_id") %>%
  select(id,osoba_pbl_dzial_id_name) %>%
  group_by(id) %>%
  mutate(osoba_bn_temat = paste(unique(osoba_pbl_dzial_id_name),collapse = "~")) %>%
  select(-osoba_pbl_dzial_id_name) %>%
  ungroup() %>%
  unique()

##700
#marc_field_700 <- bn_ks %>%
#  select(id,X700)%>%
#  filter(X700!="") %>%
#  mutate(X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
#  cSplit(.,"X700",sep = "~",direction = "long") %>%
#  filter(X700!="") %>%
#  mutate(X700=str_remove_all(X700,"^\\|")) %>%
#  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1"))
#subfield_list<- str_extract_all(bn_ks$X700,"\\$.")
#subfield_list<- unique(unlist(subfield_list))
#empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
#colnames(empty_table) <-subfield_list
#marc_field_700<-cbind(marc_field_700,empty_table)
#subfield_list_char <- paste("(",subfield_list,")",sep = "")
#subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")
#x <- 1:length(subfield_list)
#
#for (i in x) {
#  progress(match(i,x), max.value = length(x)) 
#  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
#}
#for (i in x) {
#  progress(match(i,x), max.value = length(x)) 
#  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
#  string_a <- "(^)(.*?\\|"
#  string_b <- subfield_list_char2[i]
#  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
#  string <- paste(string_a,string_b,string_c,sep = "")
#  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
#}
#marc_field_700 <- marc_field_700 %>%
#  select(id,`$a`,`$d`,`$c`) %>%
#  mutate(name = ifelse(!is.na(`$c`)&substr(`$c`,nchar(`$c`),nchar(`$c`))==";",paste(`$a`,`$c`,`$d`,sep = " "),ifelse(!is.na(`$d`),paste(`$a`,`$d`,sep = " "),as.character(`$a`)))) %>%
#  select(id,name) %>%
#  mutate(name = str_replace(name,"(\\))(\\.$)","\\1"),
#         name = str_replace(name, "([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)","\\1"))

###sprawdzić czy nie ma zdublowanego mapowania BN->PBL (czy np. jedna osoba z BN nie zasila kilku twórców PBL)

bn_ks <- bn_ks %>%
  full_join(.,osoba_bn_100_pbl,by = "id") %>%
  full_join(.,osoba_bn_600_pbl,by = "id")
```

```{r dalsze przygotowanie zbioru do importu - UKD, słowa kluczowe, poloniki}
#wskazanie interesujących PBL dziedzin wiedzy po UKD i określenie typu UKD
bn_ks <- bn_ks %>%
  mutate(dziedzina_PBL = ifelse(str_detect(X080,"(?<=\\$a|:|\\[|\\+|\\()(82)"),"ukd_lit",
                                ifelse(str_detect(X080,"(?<=\\$a|:|\\[|\\+)(791)")|str_detect(X080,"(?<=\\$a|:)(792)")|str_detect(X080,"\\$a7\\.09"),"ukd_tfrtv",
                                       ifelse(str_detect(X080,"(?<=\\$a01)(\\(|\\/|2|4|5|9)")|str_detect(X080,"(?<=\\$a|\\[])(050)"),"ukd_biblio",
                                              ifelse(str_detect(X080,"\\$a002")|str_detect(X080,"(?<=\\$a|:)(305)")|str_detect(X080,"(?<=\\$a39|:39)(\\(438\\)|8\\.2)")|str_detect(X080,"(?<=\\$a|:)(929[^\\.]051)"),"ukd_pogranicze","bez_ukd_PBL")))))
#wskazanie interesujących PBL rekordów bez UKD, które są w kluczu PBL
bez_ukd_ale_PBL <- bn_ks %>%
  select(id, X080, X650, X655, osoba_bn_autor, osoba_bn_temat, dziedzina_PBL) %>%
  filter(dziedzina_PBL == "bez_ukd_PBL"&X080==""&is.na(osoba_bn_autor)&is.na(osoba_bn_temat)) %>%
  mutate(bez_ukd_ale_PBL = grepl("literat|literac|pisar|bajk|dramat|epigramat|esej|felieton|film|komedi|nowel|opowiadani|pamiętnik|poemiks|poezj|powieść|proza|reportaż|satyr|wspomnieni|Scenariusze zajęć|Podręczniki dla gimnazjów|teatr|Nagrod|aforyzm|baśń|baśnie|polonijn|dialogi|fantastyka naukowa|legend|pieśń|poemat|przypowieś|honoris causa|filologi|kino polskie|pieśni",X650, ignore.case = TRUE)|grepl("literat|literac|pisar|bajk|dramat|epigramat|esej|felieton|film|komedi|nowel|opowiadani|pamiętnik|poemiks|poezj|powieść|proza|reportaż|satyr|wspomnieni|Scenariusze zajęć|Podręczniki dla gimnazjów|teatr|Nagrod|aforyzm|baśń|baśnie|polonijn|dialogi|fantastyka naukowa|legend|pieśń|poemat|przypowieś|honoris causa|filologi|kino polskie|pieśni",X655,ignore.case = TRUE)) %>%
  filter(bez_ukd_ale_PBL == TRUE) %>%
  select(id) %>%
  mutate(bez_ukd_ale_PBL = "tak")

bn_ks <- bn_ks %>%
  full_join(.,bez_ukd_ale_PBL,by = "id")

#wspomnienia,pamiętniki,literatura podróżnicza,reportaż
wspomnienia <- bn_ks %>%
  mutate(czy_wspomnienia_reportaz = ifelse(str_detect(X655,"Pamiętniki i wspomnienia")|str_detect(X655,"Literatura podróżnicza")|str_detect(X655,"Pamiętniki")|str_detect(X655,"Reportaż"),"tak",NA)) %>%
  select(id,czy_wspomnienia_reportaz) %>%
  unique()
bn_ks <- bn_ks %>%
  full_join(.,wspomnienia,by = "id")

#słowa literackie w polu 245
rekordy_slowa <- sqldf("select *
                    from bn_ks a
                    where LOWER(a.X245) like ('%'||'pisar'||'%')
                   or LOWER(a.X245) like ('%'||'literat'||'%')
                   or LOWER(a.X245) like ('%'||'literac'||'%')
                   or LOWER(a.X245) like ('%'||'teatr'||'%')
                   or LOWER(a.X245) like ('%'||'film'||'%')
                   or LOWER(a.X245) like ('%'||'dramat'||'%')") %>%
  select(id) %>%
  mutate(slowa_literackie = "tak") %>%
  unique()
bn_ks <- bn_ks %>%
  full_join(.,rekordy_slowa,by = "id")

bn_ok <- bn_ks %>%
  filter(!((is.na(osoba_bn_autor)&is.na(osoba_bn_temat))&dziedzina_PBL=="bez_ukd_PBL"&is.na(bez_ukd_ale_PBL)&is.na(czy_wspomnienia_reportaz)&is.na(slowa_literackie)))

#czy tu usunąć zdublowane isbny?
#020
marc_field_020 <- bn_ok %>%
  select(id,X020)%>%
  filter(X020!="") %>%
  mutate(X020=str_replace_all(X020,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X020",sep = "~",direction = "long") %>%
  filter(X020!="") %>%
  mutate(X020=str_remove_all(X020,"^\\|")) %>%
  mutate(indicator = str_replace_all(X020,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(bn_ok$X020,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_020)[1]))
colnames(empty_table) <-subfield_list
marc_field_020<-cbind(marc_field_020,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_020$X020 <- str_replace(marc_field_020$X020,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_020[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_020$X020),str_replace_all(gsub(string,"\\3",marc_field_020$X020),"\\${2}.", "~"),NA)
}
marc_field_020 <- marc_field_020 %>%
  select(id,isbn=`$a`)

distance1 <- bn_ok %>%
  filter(!grepl("\\$n",X245)) %>%
  left_join(.,marc_field_020,by="id") %>%
  mutate(porownanie = paste(isbn,substr(str_to_lower(str_replace_all(X245, "\\W", "")),4,14),str_extract(X300,"(?<=\\$a)(.*?)(?=,| )"),sep = "|"))

count <- as.data.frame(table(distance1$porownanie))

distance1 <- merge(distance1,count,by.x = "porownanie",by.y = "Var1",all.x = TRUE) %>%
  select(porownanie,Freq,2:155) %>%
  arrange(-Freq,porownanie) %>%
  select(porownanie,Freq,id) %>%
  cSplit(.,"porownanie",sep = "|",direction = "wide")

#poszukanie dystansu Levenshteina == 1 przy takim samym ISBN

distance2 <- distance1 %>%
  filter(!is.na(porownanie_1)) %>%
  group_by(porownanie_1) %>%
  mutate(Freq = paste(Freq,collapse = "|"),
         id = paste(id,collapse = "|"),
         porownanie_2 = paste(porownanie_2,collapse = "|"),
         porownanie_3 = paste(porownanie_3,collapse = "|")) %>%
  ungroup() %>%
  unique() %>%
  mutate(ile = str_count(porownanie_2,"\\|")+1) %>%
  arrange(-ile) %>%
  mutate(id_grupy = 1:lengths(.)) %>%
  filter(ile>1) %>%
  cSplit(.,c("Freq","id","porownanie_2","porownanie_3"),sep = "|",direction = "long") %>%
  unique() %>%
  filter(!is.na(id))

permutations <- data.frame(stringsAsFactors = FALSE)
x <- 1:max(distance2$id_grupy)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  distance3 <- as.vector(unlist(distance2 %>% filter(id_grupy==i) %>% select(porownanie_2)))
  iteration <- as.data.frame(permutations(distance3,2)) %>%
    mutate(id_grupy = i)
  y <- 1:length(iteration$V1)
  for (j in y) {
    progress(match(j,y), max.value = length(y))
    iteration$distance[j] <- adist(iteration$V1[j],iteration$V2[j])
  }
  permutations <- rbind(permutations,iteration)
}

permutations <- permutations %>%
  filter(distance==1)

distance2 <- distance2 %>%
  filter(id_grupy %in% permutations$id_grupy) %>%
  select(id,id_grupy)
#połączyć distance2 z distance1, żeby wydobyć pełną listę zdublowanych książek
duble_ksiazek <- distance1 %>%
  unite("porownanie", porownanie_1:porownanie_3, sep = "|") %>%
  filter(Freq>1) %>%
  full_join(.,distance2,by="id")

duble_ksiazek$same <- cumsum(!duplicated(duble_ksiazek$porownanie))

duble_ksiazek <- duble_ksiazek %>%
  arrange(id_grupy,same) %>%
  mutate(id_grupy_dubli = ifelse(!is.na(id_grupy),as.character(id_grupy),paste("x",same,sep = ""))) %>%
  select(id,id_grupy_dubli) %>%
  arrange(id_grupy_dubli)

duble_ksiazek$id_grupy_dubli <- cumsum(!duplicated(duble_ksiazek$id_grupy_dubli))
#uzupełnienie całego zbioru o informację o dublu, wydobycie dubli do osobnego pliku i usuniecie ich z głównego pliku z rekordami bn; wskazanie listy interesujących pól
bn_ok <- bn_ok %>%
  left_join(.,duble_ksiazek,by="id") %>%
  select(id, X008, X009, X015, X041, X044, X080, X100, X245, X246, X250, X260, X300, X380, X386, X490, X500, X501, X546, X600, X650, X655, X700, X710, X800, X830, rok, BN_URL, osoba_bn_autor, osoba_bn_temat, dziedzina_PBL, bez_ukd_ale_PBL, czy_wspomnienia_reportaz, slowa_literackie, id_grupy_dubli)

duble_ksiazek <- bn_ok %>%
  filter(!is.na(id_grupy_dubli)) %>%
  arrange(id_grupy_dubli)

bn_ok <- bn_ok %>%
  filter(is.na(id_grupy_dubli))
#wpisanie w zdublowane rekordy jak największej ilości danych (suma wszystkich dubli)
duble_ksiazek <- duble_ksiazek %>%
  arrange(id_grupy_dubli,-nchar(X015))
duble_ksiazek[is.na(duble_ksiazek)] <- ""
duble_naprawione <- data.frame(stringsAsFactors = FALSE)
x <- 1:max(duble_ksiazek$id_grupy_dubli)
y <- c(4:27,29:34)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  iteration <- duble_ksiazek %>%
    filter(id_grupy_dubli==i)
  for (j in y) {
    if (j==30) {
      iteration[,j] <- iteration[,j][nchar(iteration[,j])==min(nchar(iteration[,j]))][1]
    } else {
        iteration[,j] <- iteration[,j][nchar(iteration[,j])==max(nchar(iteration[,j]))][1]
      }
  }
  duble_naprawione <- rbind(duble_naprawione,iteration)
}
#pozostawienie pojedynczych wierszy dla książek
duble_naprawione <- duble_naprawione[!duplicated(duble_naprawione$id_grupy_dubli),]
duble_naprawione <- duble_naprawione %>%
  mutate(osoba_bn_autor = ifelse(osoba_bn_autor!="",as.character(osoba_bn_autor),NA),
         osoba_bn_temat = ifelse(osoba_bn_temat!="",as.character(osoba_bn_temat),NA),
         dziedzina_PBL = ifelse(dziedzina_PBL!="",as.character(dziedzina_PBL),NA),
         bez_ukd_ale_PBL = ifelse(bez_ukd_ale_PBL!="",as.character(bez_ukd_ale_PBL),NA),
         czy_wspomnienia_reportaz = ifelse(czy_wspomnienia_reportaz!="",as.character(czy_wspomnienia_reportaz),NA),
         slowa_literackie = ifelse(slowa_literackie!="",as.character(slowa_literackie),NA),)
#połączenie unikatowych książek z dubli z całym zbiorem
bn_ok <- bn_ok %>%
  bind_rows(.,duble_naprawione) %>%
  select(-id_grupy_dubli)

#usunięcie zagranicznych zapisów, które nie są polonikami 
#na podstawie braku wystąpień frazy "pol" w polach MARC
nie_poloniki <- bn_ok %>%
  filter(if (X501=="") !grepl("pl",substr(X008,16,18))) %>%
  filter(!grepl("pol",substr(X008,36,38))) %>%
  filter(!grepl("pol",X041)) %>%
  filter(!grepl("pl",X044)) %>%
  filter(!grepl("pol",X500,ignore.case = TRUE)) %>%
  filter(!grepl("pol",X501,ignore.case = TRUE)) %>%
  filter(!grepl("pol",X546,ignore.case = TRUE)) %>%
  select(id) %>%
  mutate(czy_polonik = "nie") %>%
  unique()

#na postawie wystąpień twórców pbl w polach uwag
#czy warto? co zrobić z case insensitivenes? --> za dużo śmieci wpada, zrezygnowałem z tego

bn_ok <- bn_ok %>%
  full_join(.,nie_poloniki,by = "id") %>%
  select(id, X008, X009, X041, X044, X080, X100, X245, X246, X250, X260, X300, X380, X386, X490, X500, X501, X500, X546, X600, X650, X655, X700, X710, X800, X830, rok, BN_URL, osoba_bn_autor, osoba_bn_temat, dziedzina_PBL, bez_ukd_ale_PBL, czy_wspomnienia_reportaz, slowa_literackie, czy_polonik) %>%
  unique()
#wskazanie niepoloników i usunięcie ze zbioru
nie_poloniki <- bn_ok %>%
  filter(czy_polonik=="nie") %>%
  filter(is.na(osoba_bn_autor)|is.na(osoba_bn_temat)|!(osoba_bn_autor %in% c("148|Hasła osobowe (literatura polska)","430|Hasła osobowe (Ludzie teatru i filmu)"))|!(osoba_bn_temat %in% c("148|Hasła osobowe (literatura polska)","430|Hasła osobowe (Ludzie teatru i filmu)")))
bn_ok <- sqldf("select *
               from bn_ok a
               where a.id not in (select b.id from nie_poloniki b)") %>%
  select(-czy_polonik)

#usunięcie książek zabawek, do kolorowania, dla małych dzieci, z naklejkami, które nie mają żadnego deskryptora gatunkowego
ks_zabawki <- bn_ok %>% 
  filter((str_count(X655,"\\$a")==1&grepl("Książka zabawka|Książki dla małych dzieci|Książka do kolorowania|Książka z naklejkami|Książki dla przedszkolaków|Wydawnictwa dla dzieci",X655))|str_count(X655,"\\$a")==2&grepl("Książka obrazkowa",X655)&grepl("Książki dla małych dzieci",X655)|str_count(X655,"\\$a")==2&grepl("Książka do kolorowania",X655)&grepl("Publikacje dla dzieci",X655)|str_count(X655,"\\$a")==2&grepl("Książki zabawki",X655)&grepl("Wycinanki",X655)|str_count(X655,"\\$a")==2&grepl("Książki dla małych dzieci",X655)&grepl("Publikacje dla dzieci",X655))

bn_ok <- sqldf("select *
               from bn_ok a
               where a.id not in (select b.id from ks_zabawki b)")

```

```{r automatyczne usunięcie INO na podstawie wcześniejszych importów}
#pobranie starych list książek z importu
listy_2005 <- sheets_read(ss = "1HkWkX61sQWktSXf0v0uPV8j2DwuTocesyCJuKTdisIU", sheet = "lista_ksiazek")
listy_2006 <- sheets_read(ss = "1zeMx_Idsum8JmlM6G7Eufx9LxloHoAHv8V-My71VZf4", sheet = "lista_ksiazek")
listy_2007 <- sheets_read(ss = "19iL7YoD8ug-rLnpzS6FD46aS2J1BRf4qL5VxllywCGE", sheet = "lista_ksiazek")
listy_2008 <- sheets_read(ss = "1RshTeWdXBE7OzOEfoGpL9Ljb_GXDlGDePNjV1HKmuOo", sheet = "lista_ksiazek")
listy_2004 <- sheets_read(ss = "1RmDia97s4B8F74sS7Wbpnv_A9zMfr4xTvcD9leukAfM", sheet = "lista_książek") %>%
  mutate(typ_ksiazki = NA, link = NA, link_1 = NA, status = NA, blad_w_imporcie_tytulu = NA) %>%
  select(pracownik,ZA_ZAPIS_ID,typ_ksiazki, link, link_1, rok, status, blad_w_imporcie_tytulu, X100, X245, X650, X655, X246, X250, X260, X300, X380, X490, X500, X501, X546, X600, X700, X041, X080)
#ujednolicenie 2004 do wzoru późniejszych rocznikóW
do2004 <- RJDBC::dbGetQuery(PBL,
                            "select z.za_zapis_id, z.za_status_imp
                            from pbl_zapisy z
                            where z.za_uwagi like '%import%02%'")
listy_2004 <- merge(listy_2004,do2004,by = "ZA_ZAPIS_ID",all.x = TRUE) %>%
  mutate(status = ZA_STATUS_IMP) %>%
  select(-ZA_STATUS_IMP) %>%
  select(pracownik,ZA_ZAPIS_ID,typ_ksiazki, link, link_1, rok, status, blad_w_imporcie_tytulu, X100, X245, X650, X655, X246, X250, X260, X300, X380, X490, X500, X501, X546, X600, X700, X041, X080)
#zapewnienie tych samych nazw kolumn
colnames(listy_2005) <- names(listy_2004)
colnames(listy_2006) <- names(listy_2004)
colnames(listy_2007) <- names(listy_2004)
colnames(listy_2008) <- names(listy_2004)
listy_2004 <- listy_2004 %>%
  mutate(X655 = str_remove(str_replace_all(X655,"(\\$a)","|\\1"),"^\\|"),
         X650 = str_remove(str_replace_all(X650,"(\\$a)","|\\1"),"^\\|"))

#wyznaczenie listy 650 i 655 do automatycznego INO na podstawie wcześniejszych importów - usunięte są tylko te deskryptory, które nie mają związku z literaturą podmiotową
zapisy <- RJDBC::dbGetQuery(PBL,
                            "select z.za_zapis_id, z.za_status_imp, z.za_uwagi
                            from pbl_zapisy z
                            where z.za_uwagi like '%import%'") %>%
  mutate(pracownik_pbl = str_extract(ZA_UWAGI, "(?<=akceptuje:)([A-Z]*)")) %>%
  select(ZA_ZAPIS_ID,pracownik_pbl,ZA_STATUS_IMP)

do_importu_NIE <- rbind(listy_2004,listy_2005,listy_2006,listy_2007,listy_2008) %>%
  full_join(.,zapisy,by = "ZA_ZAPIS_ID") %>%
  select(X650,X655,ZA_STATUS_IMP) %>%
  mutate(X650 = str_remove_all(X650,"\\\\7"),
         X655 = str_remove_all(X655,"\\\\7"),
         joint = paste(X650,X655,sep = "~")) %>%
  select(ZA_STATUS_IMP,joint) %>%
  group_by(joint) %>%
  mutate(grupa = paste(ZA_STATUS_IMP,collapse = ",")) %>%
  ungroup() %>%
  select(joint, grupa) %>%
  unique() %>%
  mutate(ile = str_count(grupa,",")+1) %>%
  filter(grepl("INO",grupa)) %>%
  filter(!grepl("IOK|IMP|IPN|IPC",grupa)) %>%
  mutate(czy = str_detect(joint,"\\$y[\\d-]+ w\\.")) %>%
  filter(czy==FALSE) %>%
  select(joint) %>%
  mutate(joint = str_remove_all(str_replace_all(joint,"(\\$a)","\\\\#7\\1"),"#")) %>%
  mutate(do_wyrzucenia_na_podstawie_INO = "tak")

bn_ok <- bn_ok %>%
  mutate(X650 = ifelse(X650=="",NA,as.character(X650)),
         X655 = ifelse(X655=="",NA,as.character(X655)),
         joint = paste(X650,X655,sep = "~")) %>%
  left_join(.,do_importu_NIE,by = "joint") %>%
  mutate(X650 = ifelse(is.na(X650),"",as.character(X650)),
         X655 = ifelse(is.na(X655),"",as.character(X655)))

do_importu_NIE <- bn_ok %>%
  filter(is.na(osoba_bn_autor)&is.na(osoba_bn_temat)&is.na(slowa_literackie)&do_wyrzucenia_na_podstawie_INO=="tak") %>%
  filter(!grepl("literat|literac|pamiętnik|pisar",X655,ignore.case = TRUE))

bn_ok <- sqldf("select *
               from bn_ok a
               where a.id not in (select b.id from do_importu_NIE b)") %>%
  select(-joint,-do_wyrzucenia_na_podstawie_INO)

#usunięcie na podstawie tabel KP
out <- sheets_read(ss = "1lO_ZtwyBDePGqXkgWyk_WmGeQBaAQBvEUjNnctrw-vg") %>%
  filter(wchodzi_do_pbl == "nie")

KP_out <- bn_ok %>%
  filter(grepl("Wydawnictwa popularne",X655)) %>%
  unique() %>%
  full_join(.,out,by = "X650") %>%
  filter(wchodzi_do_pbl=="nie") %>%
  filter(!is.na(X655)) %>%
  select(id)

bn_ok <- sqldf("select *
               from bn_ok a
               where a.id not in (select b.id from KP_out b)")

#czy próbować wyrzucać po UKD, które dostawało tylko INO?
do_importu_NIE2 <- rbind(listy_2004,listy_2005,listy_2006,listy_2007,listy_2008) %>%
  full_join(.,zapisy,by = "ZA_ZAPIS_ID") %>%
  select(X080,ZA_STATUS_IMP) %>%
  mutate(X080 = str_remove_all(X080,"\\\\")) %>%
  select(ZA_STATUS_IMP,X080) %>%
  group_by(X080) %>%
  mutate(grupa = paste(ZA_STATUS_IMP,collapse = ",")) %>%
  ungroup() %>%
  select(X080, grupa) %>%
  unique() %>%
  mutate(ile = str_count(grupa,",")+1) %>%
  filter(grepl("INO",grupa)) %>%
  filter(!grepl("IOK|IMP|IPN|IPC",grupa)) %>%
#tu się musi KP wypowiedzieć, czy jak było 2xNIE to wystarczy, żeby wywalać
#  filter(ile > 1) %>%
  select(X080) %>%
  mutate(X080 = paste("\\",str_remove_all(str_replace_all(X080,"(\\$a)","\\\\#\\1"),"#"),sep = "")) %>%
  mutate(do_wyrzucenia_na_podstawie_INO = "tak")

#na podstawie UKD też wyrzucić - decyzja KP
bn_ok <- bn_ok %>%
  full_join(.,do_importu_NIE2,by = "X080") %>%
  filter(!is.na(id))

do_importu_NIE2 <- bn_ok %>%
  filter(is.na(osoba_bn_autor)&is.na(osoba_bn_temat)&is.na(slowa_literackie)&do_wyrzucenia_na_podstawie_INO=="tak")

bn_ok <- sqldf("select *
               from bn_ok a
               where a.id not in (select b.id from do_importu_NIE2 b)") %>%
  select(-do_wyrzucenia_na_podstawie_INO)

#reszta rekordów, które nie będą zaimportowane
reszta <- sqldf("select *
               from bn_ks a
               where a.id not in 
               (select b.id
               from bn_ok b)")
```
```{r testowe przypisanie rodzaju ksiazki}
blabla <- bn_ok
bn_ok <- blabla














test2 <- bn_ok %>%
  mutate(czy_ma_ukd = ifelse(X080=="","nie","tak"),
         position_dash = ifelse(grepl("(\\\\\\\\\\$a|:)(821\\.)",X080),str_locate(X080,"\\-")[,1], NA),
         position_dash = ifelse(is.na(position_dash),"",as.integer(position_dash)),
         position_091 = str_locate(X080,"\\(091\\)")[,1],
         position_091 = ifelse(is.na(position_091),"",as.integer(position_091)),
         rodzaj_ksiazki = ifelse(grepl("antologi|przysłowia|cytaty",X655,ignore.case = TRUE),"antologia",
                                 ifelse(position_091!=""&position_dash!="",
                          ifelse(as.integer(position_091)<as.integer(position_dash), "przedmiotowa", "podmiotowa"),
                          ifelse(position_dash!="","podmiotowa","przedmiotowa"))),
         rodzaj_ksiazki = ifelse(czy_ma_ukd=="nie","",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("82-93",X080),"podmiotowa",as.character(rodzaj_ksiazki)))

rekordy_podmiotowe_stare <- dbGetQuery(PBL,
                                       "select z.za_zapis_id
                                        from pbl_zapisy z
                                        join IBL_OWNER.pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                                        where rz.rz_rodzaj_id=1
                                        and z.za_uwagi like '%import%'")

gatunki_poprzednie_imp <- rbind(listy_2004,listy_2005,listy_2006,listy_2007,listy_2008) %>% 
  filter(ZA_ZAPIS_ID %in% rekordy_podmiotowe_stare$ZA_ZAPIS_ID) %>% 
  mutate(X655 = ifelse(rok==2004,str_remove_all(str_replace_all(X655,"(\\$a)","\\\\#7\\1"),"#"),as.character(X655))) %>% 
  select(X655) %>% 
  unique()

gatunki_podmiotowe <- test2 %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  select(X655) %>%
  bind_rows(.,gatunki_poprzednie_imp) %>% 
  unique() %>%
  cSplit(.,"X655",sep = "|",direction = "long") %>%
  unique() %>%
  filter(!grepl("xhistoria|xtematyka|xbiografia",X655)) %>% 
  filter(str_detect(X655,"\\$y[\\d-]+ w\\.")) %>% 
  #mutate(X655 = str_replace(X655, "(?<= )(\\S+)(\\$y)(.*?$)", "[\\\\S]+\\2")) %>% 
  mutate(X655 = str_replace(X655, "(?<= )(\\S+)(\\$y)(.*?$)", ".+\\2")) %>% 
  unique()

gatunki_podmiotowe <- str_replace_all(str_replace_all(paste(gatunki_podmiotowe$X655,collapse = "|"),"(.{2})(\\$a)","\\2"),"\\$","\\\\$")
test2$czy_podmiotowy <- grepl(gatunki_podmiotowe,test2$X655)|grepl(gatunki_podmiotowe,test2$X650)
test2 <- test2 %>%
  mutate(rodzaj_ksiazki = ifelse(str_count(X245, " / ")+1>2,"antologia",
                                 ifelse(str_count(X245, " / ")+1==2,"współwydanie",
                                        ifelse(rodzaj_ksiazki==""&czy_podmiotowy==TRUE&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                               ifelse(X100!=""&grepl("aPamiętnik|aLiteratura podróżnicza",X655)&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                      ifelse(X100!=""&grepl("aReportaż",X655)&grepl("\\$y",X655)&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                             ifelse(X100!=""&(X655=="\\7$aReportaż polski$2DBN"|X655=="\\7$aReportaż$2DBN")&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                                    ifelse(rodzaj_ksiazki==""&czy_podmiotowy==FALSE,"przedmiotowa",as.character(rodzaj_ksiazki)))))))),
         rodzaj_ksiazki = ifelse(rodzaj_ksiazki=="","przedmiotowa",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("Lektury Wszech Czasów \\: streszczenie, analiza, interpretacja|Lektury Wszech Czasów - Literat|Biblioteczka Opracowań",X490)|grepl("Lektury Wszech Czasów \\: streszczenie, analiza, interpretacja|Lektury Wszech Czasów - Literat|Biblioteczka Opracowań",X830),"przedmiotowa",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("aLektura z Opracowaniem - Zielona Sowa|aLektura \\(Greg\\)|aLektura Dobrze Opracowana|aLektura z Opracowaniem - Ibis",X830),"podmiotowa",as.character(rodzaj_ksiazki)),
         ilu_tworcow = str_count(X100,"\\$a"),
         rodzaj_ksiazki = ifelse(ilu_tworcow>4&rodzaj_ksiazki=="podmiotowa","antologia",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("Legendy",X655),"antologia",as.character(rodzaj_ksiazki))) %>%
  select(1:30,rodzaj_ksiazki)


# przypisania do podmiotowej na podstawie smierci przed 1700
marc_field_100 <- test2 %>%
  filter(!is.na(osoba_bn_autor)) %>%
  select(id,X100)%>%
  filter(!grepl("\\|", X100)) %>% 
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(test2$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}

marc_field_100 <- marc_field_100 %>% 
  filter(!is.na(`$d`) & str_extract(`$d`, "\\d+(?!.*\\d+)") < 1700)

test2 <- test2 %>% 
  mutate(rodzaj_ksiazki = ifelse(id %in% marc_field_100$id, "podmiotowa", as.character(rodzaj_ksiazki)))









x <- 1:nrow(test)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  test$czy_to_samo[i] <- test$rodzaj_ksiazki[i] == test2$rodzaj_ksiazki[i]
}

test <- test %>%
  filter(czy_to_samo==FALSE)


gatunki_podmiotowe <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  select(X655) %>%
  unique() %>%
  cSplit(.,"X655",sep = "|",direction = "long") %>%
  unique() %>%
  filter(str_detect(X655,"\\$y[\\d-]+ w\\."))
gatunki_podmiotowe <- str_replace_all(str_replace_all(paste(gatunki_podmiotowe$X655,collapse = "|"),"(.{2})(\\$a)","\\2"),"\\$","\\\\$")
bn_ok$czy_podmiotowy <- grepl(gatunki_podmiotowe,bn_ok$X655)|grepl(gatunki_podmiotowe,bn_ok$X650)
bn_ok <- bn_ok %>%
  mutate(rodzaj_ksiazki = ifelse(str_count(X245, " / ")+1>2,"antologia",
                                 ifelse(str_count(X245, " / ")+1==2,"współwydanie",
                                        ifelse(rodzaj_ksiazki==""&czy_podmiotowy==TRUE&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                               ifelse(X100!=""&grepl("aPamiętnik|aLiteratura podróżnicza",X655)&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                      ifelse(X100!=""&grepl("aReportaż",X655)&grepl("\\$y",X655)&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                             ifelse(X100!=""&(X655=="\\7$aReportaż polski$2DBN"|X655=="\\7$aReportaż$2DBN")&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                                    ifelse(rodzaj_ksiazki==""&czy_podmiotowy==FALSE,"przedmiotowa",as.character(rodzaj_ksiazki)))))))),
         rodzaj_ksiazki = ifelse(rodzaj_ksiazki=="","przedmiotowa",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("Lektury Wszech Czasów : streszczenie, analiza, interpretacja|Lektury Wszech Czasów - Literat|Biblioteczka Opracowań",X490)|grepl("Lektury Wszech Czasów : streszczenie, analiza, interpretacja|Lektury Wszech Czasów - Literat|Biblioteczka Opracowań",X830),"przedmiotowa",as.character(rodzaj_ksiazki)),
         ilu_tworcow = str_count(X100,"\\$a"),
         rodzaj_ksiazki = ifelse(ilu_tworcow>4&rodzaj_ksiazki=="podmiotowa","antologia",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("Legendy",X655),"antologia",as.character(rodzaj_ksiazki))) %>%
  select(1:30,rodzaj_ksiazki)
```

```{r przypisanie książce rodzaju (podmiotowa, przedmiotowa, antologie, współwydanie)}
blabla <- bn_ok

bn_ok <- bn_ok %>%
  mutate(czy_ma_ukd = ifelse(X080=="","nie","tak"),
         position_dash = ifelse(grepl("(\\\\\\\\\\$a|:)(821\\.)",X080),str_locate(X080,"\\-")[,1], NA),
         position_dash = ifelse(is.na(position_dash),"",as.integer(position_dash)),
         position_091 = str_locate(X080,"\\(091\\)")[,1],
         position_091 = ifelse(is.na(position_091),"",as.integer(position_091)),
         rodzaj_ksiazki = ifelse(grepl("Antologi",X655),"antologia",
                                 ifelse(position_091!=""&position_dash!="",
                          ifelse(as.integer(position_091)<as.integer(position_dash), "przedmiotowa", "podmiotowa"),
                          ifelse(position_dash!="","podmiotowa","przedmiotowa"))),
         rodzaj_ksiazki = ifelse(czy_ma_ukd=="nie","",as.character(rodzaj_ksiazki)))
gatunki_podmiotowe <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  select(X655) %>%
  unique() %>%
  cSplit(.,"X655",sep = "|",direction = "long") %>%
  unique() %>%
  filter(str_detect(X655,"\\$y[\\d-]+ w\\."))
gatunki_podmiotowe <- str_replace_all(str_replace_all(paste(gatunki_podmiotowe$X655,collapse = "|"),"(.{2})(\\$a)","\\2"),"\\$","\\\\$")
bn_ok$czy_podmiotowy <- grepl(gatunki_podmiotowe,bn_ok$X655)|grepl(gatunki_podmiotowe,bn_ok$X650)
bn_ok <- bn_ok %>%
  mutate(rodzaj_ksiazki = ifelse(str_count(X245, " / ")+1>2,"antologia",
                                 ifelse(str_count(X245, " / ")+1==2,"współwydanie",
                                        ifelse(rodzaj_ksiazki==""&czy_podmiotowy==TRUE&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                               ifelse(X100!=""&grepl("aPamiętnik|aLiteratura podróżnicza",X655)&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                      ifelse(X100!=""&grepl("aReportaż",X655)&grepl("\\$y",X655)&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                             ifelse(X100!=""&(X655=="\\7$aReportaż polski$2DBN"|X655=="\\7$aReportaż$2DBN")&!grepl("xhistoria|xtematyka|xbiografia",X650)&!grepl("xhistoria|xtematyka|xbiografia",X655),"podmiotowa",
                                                                    ifelse(rodzaj_ksiazki==""&czy_podmiotowy==FALSE,"przedmiotowa",as.character(rodzaj_ksiazki)))))))),
         rodzaj_ksiazki = ifelse(rodzaj_ksiazki=="","przedmiotowa",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("Lektury Wszech Czasów : streszczenie, analiza, interpretacja|Lektury Wszech Czasów - Literat|Biblioteczka Opracowań",X490)|grepl("Lektury Wszech Czasów : streszczenie, analiza, interpretacja|Lektury Wszech Czasów - Literat|Biblioteczka Opracowań",X830),"przedmiotowa",as.character(rodzaj_ksiazki)),
         ilu_tworcow = str_count(X100,"\\$a"),
         rodzaj_ksiazki = ifelse(ilu_tworcow>4&rodzaj_ksiazki=="podmiotowa","antologia",as.character(rodzaj_ksiazki)),
         rodzaj_ksiazki = ifelse(grepl("Legendy",X655),"antologia",as.character(rodzaj_ksiazki))) %>%
  select(1:30,rodzaj_ksiazki)
```

```{r wyznaczenie zbioru automatycznie IOK}
IOK_podm <- bn_ok %>%
  filter(!grepl("\\$t",X700)) %>%
  mutate(ile_gatunkow = ifelse(rodzaj_ksiazki=="podmiotowa",str_count(X655,"\\$a"),"nie"),
         tylko_podmiotowe = ifelse(str_count(X655,"\\$a")>0&str_count(X655,"\\$a")==str_count(X655,"\\$y")&str_count(X655,"\\$y")!=str_count(X655,"\\$x"),"tak","nie")) %>%
  filter(str_count(X100,"\\$a")==1) %>%
  filter(!grepl("pseud|nazwa",X500,ignore.case = TRUE)&X501==""&(tylko_podmiotowe=="tak"|ile_gatunkow=="1")&X100!="")

#zestawienie 100 i 245
#100
marc_field_100 <- IOK_podm %>%
  select(id,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(IOK_podm$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}
marc_field_100 <- marc_field_100 %>%
  select(id,`$a`) %>%
  mutate(bn_nazwisko = ifelse(str_detect(`$a`,","),str_replace(`$a`,"^(.*?)(, )(.*?$)","\\1"),as.character(`$a`)),
         bn_imie = ifelse(str_detect(`$a`,","),str_replace(`$a`,"^(.*?)(, )(.*?$)","\\3"),"")) %>%
  select(id,bn_nazwisko,bn_imie)

IOK_podm <- IOK_podm %>%
  full_join(.,marc_field_100,by = "id")

x <- 1:length(IOK_podm$id)
for (i in x) {
  
  IOK_podm$czy_nazwisko[i] <- grepl(IOK_podm$bn_nazwisko[i],IOK_podm$X245[i])
  IOK_podm$czy_imie[i] <- grepl(IOK_podm$bn_imie[i],IOK_podm$X245[i])
  
}
#usunięcie tych, które nie mają tytułów oryginalnych
IOK_podm <- IOK_podm %>%
  filter(czy_nazwisko==1&czy_imie==1&!grepl("et al\\.",X245)) %>%
  select(-bn_nazwisko,-bn_imie,-czy_nazwisko,-czy_imie) %>%
  unique() %>%
  mutate(jezyk = str_extract(X041,("(?<=\\$h)(...)"))) %>%
  mutate(czy_tytul_obcy = ifelse(is.na(jezyk),"nie dotyczy",
                                 ifelse(!grepl("pol",jezyk),
                                        ifelse(X246!="","ok",
                                               ifelse(grepl("Tyt[,\\.] oryg",X501)|grepl("Tyt[,\\.] oryg",X500),"ok","problem")),"nie dotyczy"))) %>%
  filter(czy_tytul_obcy!="problem") %>%
  select(id) %>%
  mutate(automatyczna_podmiotowa = "tak")
###tutaj kończą się automatyczne podmiotowe

#automatyczny IOK dla przedmiotowych; osoba z PBL jako temat
#600
IOK_przedm <- bn_ok %>%
  filter(str_count(X600,"\\$a")==1)
marc_field_600 <- IOK_przedm %>%
  select(id,X600)%>%
  filter(X600!="") %>%
  mutate(X600=str_replace_all(X600,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X600",sep = "~",direction = "long") %>%
  filter(X600!="") %>%
  mutate(X600=str_remove_all(X600,"^\\|")) %>%
  mutate(indicator = str_replace_all(X600,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(IOK_przedm$X600,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_600)[1]))
colnames(empty_table) <-subfield_list
marc_field_600<-cbind(marc_field_600,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")
x <- 1:length(subfield_list)

for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_600$X600 <- str_replace(marc_field_600$X600,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_600[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_600$X600),str_replace_all(gsub(string,"\\3",marc_field_600$X600),"\\${2}.", "~"),NA)
}
marc_field_600 <- marc_field_600 %>%
  select(id,`$a`,`$d`,`$c`) %>%
  mutate(name = ifelse(!is.na(`$c`)&substr(`$c`,nchar(`$c`),nchar(`$c`))==";",paste(`$a`,`$c`,`$d`,sep = " "),ifelse(!is.na(`$d`),paste(`$a`,`$d`,sep = " "),as.character(`$a`)))) %>%
  select(id,name) %>%
  mutate(name = str_replace(name,"(\\))(\\.$)","\\1"),
         name = str_replace(name, "([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)","\\1"))

tworca_i_dzial <- dbGetQuery(PBL,
                             "select tw.tw_tworca_id \"pbl_id\", tw.tw_nazwisko||', '||tw.tw_imie \"tworca_pbl\", dz.dz_dzial_id||'|'||dz.dz_nazwa \"osoba_pbl_dzial_id_name\"
                              from pbl_tworcy tw
                              full join pbl_dzialy dz on dz.dz_dzial_id=tw.tw_dz_dzial_id")

bn_records_pbl_people <- marc_field_600 %>%
  unique() %>%
  inner_join(.,pbl_viaf,by = c("name" = "BN_name")) %>%
  select(1:3) %>%
  left_join(.,tworca_i_dzial,by = "pbl_id")
bn_records_pbl_people_id <- bn_records_pbl_people %>%
  select(id,tworca_pbl) %>%
  group_by(id) %>%
  mutate(tworca_pbl = paste(unique(tworca_pbl),collapse = "~")) %>%
  ungroup() %>%
  unique() %>%
  filter(!grepl("~",tworca_pbl))

IOK_przedm <- IOK_przedm %>%
  full_join(.,bn_records_pbl_people_id,by = "id") %>%
  filter(rodzaj_ksiazki=="przedmiotowa"&X600!=""&str_count(X600,"\\$a")==1&!is.na(tworca_pbl)) %>%
  mutate(czy_o_czyms = str_detect(X655,"\\$x"))
IOK_przedm$czy_gatunek <- grepl(gatunki_podmiotowe,IOK_przedm$X655)
IOK_przedm <- IOK_przedm %>%
  filter((grepl("tematyka|biografia|historia",X655,ignore.case = TRUE)|czy_o_czyms==TRUE)&!grepl("Księga pamiątkowa",X655)) %>%
  filter(grepl("((a|:)(821))|(791)",X080)) %>%
  select(id) %>%
  mutate(automatyczna_przedmiotowa = "tak")

bn_ok <- bn_ok %>%
  full_join(.,IOK_podm,by = "id") %>%
  full_join(.,IOK_przedm,by = "id") %>%
  mutate(czy_automatycznie = ifelse(!is.na(automatyczna_podmiotowa),"podmiotowa",
                                    ifelse(!is.na(automatyczna_przedmiotowa),"przedmiotowa","nie"))) %>%
  select(-automatyczna_podmiotowa,-automatyczna_przedmiotowa) %>%
  mutate(czy_automatycznie = ifelse(czy_automatycznie=="podmiotowa"&rodzaj_ksiazki!="podmiotowa","nie",as.character(czy_automatycznie)))

#write.csv2(bn_ok, "C:/Users/Cezary/Desktop/bn_ok_2009.csv", row.names = F, na = '', fileEncoding = 'UTF-8')
```

```{r wyznaczenie zbioru na do uzupełnienia w przyszłości}
na_pozniej <- bn_ok %>%
  filter(czy_automatycznie=="nie"&rodzaj_ksiazki=="przedmiotowa"&dziedzina_PBL=="bez_ukd_PBL") %>%
  mutate(kategorie_literackie = ifelse(grepl("mitolog|baś|bajk|poezj|liryk|epik|dramat|literac|literat|pisar|wiersz|proz|powieś|opowiad|miniatur|aforyzm|esej|szkic|feliet|report|dzienni|wspomnie|autobiograf|kaza|rozmyśl|list",X650,ignore.case = TRUE)|grepl("mitolog|baś|bajk|poezj|liryk|epik|dramat|literac|literat|pisar|wiersz|proz|powieś|opowiad|miniatur|aforyzm|esej|szkic|feliet|report|dzienni|wspomnie|autobiograf|kaza|rozmyśl|list",X655, ignore.case = TRUE),"tak","nie")) %>%
  filter(kategorie_literackie=="nie") %>%
  mutate(lata = ifelse(grepl("\\d{2}-",X100),str_replace(X100,"(.*\\$d\\(.*?)(\\d{2,4})(\\?{0,1}-.*)","\\2"),NA),
         lata_temat = ifelse(grepl("\\d{2}-",X600),str_replace(X600,"(.*\\$d\\(.*?)(\\d{2,4})(\\?{0,1}-.*)","\\2"),NA)) %>%
filter((is.na(lata)&is.na(lata_temat))|!(as.integer(lata)<1800)|!(as.integer(lata_temat)<1800)) %>%
  select(id)

write.csv2(na_pozniej, "C:/Users/Cezary/Desktop/bn_2009_ks_na_pozniej.csv", row.names = F, na = '', fileEncoding = 'UTF-8')

bn_ok <- sqldf("select *
               from bn_ok a
               where a.id not in (select b.id from na_pozniej b)")
```

Czy jest sens to robić?
```{r automatyczne działowanie przedmiotowej}
###automatycznie działowanie przedmiotowej na podstawie dotychczasowych importów
#zapisy <- RJDBC::dbGetQuery(PBL,
#                            "select z.za_zapis_id, dz.dz_dzial_id, dz.dz_nazwa, z.za_status_imp, z.za_uwagi
#                            from pbl_zapisy z
#                            join pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
#                            where z.za_uwagi like '%import%'") %>%
#  mutate(pracownik_pbl = str_extract(ZA_UWAGI, "(?<=akceptuje:)([A-Z]*)")) %>%
#  select(-ZA_UWAGI)
#
#poprzednie_importy <- rbind(listy_2004,listy_2005,listy_2006,listy_2007,listy_2008) %>%
#  full_join(.,zapisy,by = "ZA_ZAPIS_ID") %>%
#  select(X650,X655,DZ_DZIAL_ID,DZ_NAZWA,ZA_STATUS_IMP) %>%
#  mutate(X650 = str_remove_all(X650,"\\\\7"),
#         X655 = str_remove_all(X655,"\\\\7"),
#         X650 = str_remove_all(str_replace_all(X650,"(\\$a)","\\\\#7\\1"),"#"),
#         X655 = str_remove_all(str_replace_all(X655,"(\\$a)","\\\\#7\\1"),"#")) %>%
#  group_by_at(vars(X650:DZ_NAZWA)) %>%
#  mutate(ZA_STATUS_IMP = paste(ZA_STATUS_IMP,collapse = "|")) %>%
#  ungroup() %>%
#  unique() %>%
#  ungroup() %>%
#  filter(!grepl("\\|",DZ_DZIAL_ID)) %>%
#  filter(grepl("IOK",ZA_STATUS_IMP)) %>%
#  filter(!grepl("INO|IMP|IPN|IPC",ZA_STATUS_IMP)) %>%
#  filter(!grepl("osobowe",DZ_NAZWA)) %>%
#  filter(!(is.na(X650)&is.na(X655))) %>%
#  mutate(ile650 = str_count(X650,"\\|")+1,
#         ile655 = str_count(X655,"\\|")+1) %>%
#  filter(ile650<=10|ile655<=10) %>%
#  select(-ile650,-ile655) %>%
#  mutate(ile_statusow = str_count(ZA_STATUS_IMP,"\\|")+1) %>%
#  arrange(X655,X650,-ile_statusow)
#poprzednie_importy$id_grupy <- cumsum(!duplicated(poprzednie_importy[1:2]))
#poprzednie_importy <- poprzednie_importy[!duplicated(poprzednie_importy$id_grupy),] %>%
#  mutate(id = row_number()) %>%
#  select(-ile_statusow,-id_grupy)
#
#do_dzialowania <- data.frame(id = as.integer(), X650 = as.character(), X655 = as.character(), stringsAsFactors = FALSE)
#x <- 1:length(poprzednie_importy$id)
#for (i in x){
#  progress(match(i,x), max.value = length(x)) 
#    if (is.na(poprzednie_importy$X650[i])&!is.na(poprzednie_importy$X655[i])){
#      permutations <- as.data.frame(permutations(unlist(str_split(poprzednie_importy$X655[i],"\\|")), str_count(poprzednie_importy$X655[i],"\\|")+1)) %>%
#        unite(data=.,col = "permutation", sep = "|") %>%
#        mutate(X650 = NA,
#               X655 = permutation,
#               id = poprzednie_importy$id[i]) %>%
#        select(id,X650,X655)
#      do_dzialowania <- rbind(do_dzialowania,permutations)
#    } else if (is.na(poprzednie_importy$X655[i])&!is.na(poprzednie_importy$X650[i])){
#      permutations <- as.data.frame(permutations(unlist(str_split(poprzednie_importy$X650[i],"\\|")), str_count(poprzednie_importy$X650[i],"\\|")+1)) %>%
#        unite(data=.,col = "permutation", sep = "|") %>%
#        mutate(X650 = permutation,
#               X655 = NA,
#               id = poprzednie_importy$id[i]) %>%
#        select(id,X650,X655)
#      do_dzialowania <- rbind(do_dzialowania,permutations)
#    } else {
#      permutations <- as.data.frame(permutations(unlist(str_split(poprzednie_importy$X650[i],"\\|")), str_count(poprzednie_importy$X650[i],"\\|")+1)) %>%
#        unite(data=.,col = "permutation", sep = "|") %>%
#        mutate(X650 = permutation,
#               id = poprzednie_importy$id[i]) %>%
#        select(id,X650)
#      permutations650 <- data.frame(stringsAsFactors = FALSE)
#      permutations650 <- rbind(permutations650,permutations)
#      permutations <- as.data.frame(permutations(unlist(str_split(poprzednie_importy$X655[i],"\\|")), str_count(poprzednie_importy$X655[i],"\\|")+1)) %>%
#        unite(data=.,col = "permutation", sep = "|") %>%
#        mutate(X655 = permutation,
#               id = poprzednie_importy$id[i]) %>%
#        select(id,X655)
#      permutations655 <- data.frame(stringsAsFactors = FALSE)
#      permutations655 <- rbind(permutations655,permutations)
#      permutations <- merge(permutations650,permutations655,by = "id",all = TRUE) %>%
#        select(id,X650,X655)
#      do_dzialowania <- rbind(do_dzialowania,permutations)
#    }
#}
#
#do_dzialowania <- do_dzialowania %>%
#  full_join(.,poprzednie_importy %>% select(id,DZ_DZIAL_ID,DZ_NAZWA),by = "id") %>%
#  select(-id)
#do_dzialowania[is.na(do_dzialowania)] <- ""
#####tutaj sprawdzić
#do_dzialowania_przedm <- merge(bn_ok %>% filter(czy_automatycznie=="nie"&rodzaj_ksiazki=="przedmiotowa"),do_dzialowania, by = c("X650","X655")) %>%
#  select(id,DZ_DZIAL_ID,DZ_NAZWA)
```

```{r wczytanie danych PBL}
#wczytanie kartotek PBL
redaktorzy_dzialow <- sheets_read(ss = "1Baje-ZfPgAKEDAoDzeo_eCBDrsL7jAXt6ubP2cedbFc", sheet = "redaktorzy_działów") %>%
  select(DZ_DZIAL_ID, DZ_NAZWA, redaktor_dzialu) #%>%
  #mutate(DZ_DZIAL_ID = as.character(DZ_DZIAL_ID))

PBL_dzialy <- dbReadTable(PBL,'PBL_DZIALY') %>%
  select(1,3,6)

PBL_dzialy_path <- merge(x = PBL_dzialy, y = PBL_dzialy, by.x = "DZ_DZ_DZIAL_ID", by.y = "DZ_DZIAL_ID", all.x = TRUE)
colnames(PBL_dzialy_path) <- c("NAD_DZ_DZIAL_ID", "DZ_DZIAL_ID", "DZ_NAZWA", "NAD_DZ_NAZWA", "NAD_NAD_DZ_DZIAL_ID")

PBL_dzialy_path <- merge(x = PBL_dzialy_path, y = PBL_dzialy, by.x = "NAD_NAD_DZ_DZIAL_ID", by.y = "DZ_DZIAL_ID", all.x = TRUE)
colnames(PBL_dzialy_path) <- c("NAD_NAD_DZ_DZIAL_ID", "NAD_DZ_DZIAL_ID", "DZ_DZIAL_ID", "DZ_NAZWA", "NAD_DZ_NAZWA", "NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_DZ_DZIAL_ID")

PBL_dzialy_path <- merge(x = PBL_dzialy_path, y = PBL_dzialy, by.x = "NAD_NAD_NAD_DZ_DZIAL_ID", by.y = "DZ_DZIAL_ID", all.x = TRUE)
colnames(PBL_dzialy_path) <- c("NAD_NAD_NAD_DZ_DZIAL_ID", "NAD_NAD_DZ_DZIAL_ID", "NAD_DZ_DZIAL_ID", "DZ_DZIAL_ID", "DZ_NAZWA", "NAD_DZ_NAZWA", "NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_NAD_DZ_DZIAL_ID")

PBL_dzialy_path <- merge(x = PBL_dzialy_path, y = PBL_dzialy, by.x = "NAD_NAD_NAD_NAD_DZ_DZIAL_ID", by.y = "DZ_DZIAL_ID", all.x = TRUE)
colnames(PBL_dzialy_path) <- c("NAD_NAD_NAD_NAD_DZ_DZIAL_ID", "NAD_NAD_NAD_DZ_DZIAL_ID", "NAD_NAD_DZ_DZIAL_ID", "NAD_DZ_DZIAL_ID", "DZ_DZIAL_ID", "DZ_NAZWA", "NAD_DZ_NAZWA", "NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_NAD_NAD_DZ_DZIAL_ID")

PBL_dzialy_path <- merge(x = PBL_dzialy_path, y = PBL_dzialy, by.x = "NAD_NAD_NAD_NAD_NAD_DZ_DZIAL_ID", by.y = "DZ_DZIAL_ID", all.x = TRUE)
colnames(PBL_dzialy_path) <- c("NAD_NAD_NAD_NAD_NAD_DZ_DZIAL_ID", "NAD_NAD_NAD_NAD_DZ_DZIAL_ID", "NAD_NAD_NAD_DZ_DZIAL_ID", "NAD_NAD_DZ_DZIAL_ID", "NAD_DZ_DZIAL_ID", "DZ_DZIAL_ID", "DZ_NAZWA", "NAD_DZ_NAZWA", "NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_NAD_NAD_DZ_NAZWA", "NAD_NAD_NAD_NAD_NAD_NAD_DZ_DZIAL_ID")

PBL_dzialy_path <- PBL_dzialy_path %>%
  select(-length(PBL_dzialy_path)) %>%
  filter(DZ_DZIAL_ID!=0) %>%
  select(6,7,5,8,4,9,3,10,2,11,1,12) %>%
  unique()

PBL_dz_osob <- PBL_dzialy_path %>%
  filter(grepl("osobowe", DZ_NAZWA)|grepl("osobowe", NAD_DZ_NAZWA)|grepl("osobowe", NAD_NAD_DZ_NAZWA)|grepl("osobowe", NAD_NAD_NAD_DZ_NAZWA)|grepl("osobowe", NAD_NAD_NAD_NAD_DZ_NAZWA)|grepl("osobowe", NAD_NAD_NAD_NAD_NAD_DZ_NAZWA)) %>%
  select(1,2,3,4,5,6,7,8) %>%
  filter(DZ_DZIAL_ID!=148)

PBL_dz_osob_1 <- PBL_dz_osob %>%
  select(1,2,3,4)
PBL_dz_osob_2 <- PBL_dz_osob %>%
  select(1,2,5,6)
PBL_dz_osob_3 <- PBL_dz_osob %>%
  select(1,2,7,8)
colnames(PBL_dz_osob_2) <- c(names(PBL_dz_osob_1))
colnames(PBL_dz_osob_3) <- c(names(PBL_dz_osob_1))
PBL_dz_osob <- rbind(PBL_dz_osob_1,PBL_dz_osob_2,PBL_dz_osob_3) %>%
  filter(!is.na(NAD_DZ_DZIAL_ID)) %>%
  unique()
PBL_dz_osob <- rbind(PBL_dz_osob, c("15043", "Hasła osobowe(luksemburska)","15043", "Hasła osobowe(luksemburska)"), c("430", "Hasła osobowe (Ludzie teatru i filmu)","430", "Hasła osobowe (Ludzie teatru i filmu)"))
PBL_dz_osob_bez_teatru <- PBL_dz_osob %>%
  filter(DZ_DZIAL_ID!=430)

PBL_tworcy <- dbReadTable(PBL,'PBL_TWORCY')
tw_i_dz_podm <- merge(x=PBL_tworcy,y=PBL_dz_osob_bez_teatru, by.x = "TW_DZ_DZIAL_ID", by.y = "NAD_DZ_DZIAL_ID", all.x = TRUE) %>%
  arrange(TW_TWORCA_ID)

tw_i_dz_podm <- data.frame(tw_i_dz_podm, pol_osob = ifelse(tw_i_dz_podm$TW_DZ_DZIAL_ID == 148 & substr(tw_i_dz_podm$TW_NAZWISKO,1,1)==str_sub(tw_i_dz_podm$DZ_NAZWA,nchar(as.character(tw_i_dz_podm$DZ_NAZWA)),nchar(as.character(tw_i_dz_podm$DZ_NAZWA))),TRUE,FALSE), pol = ifelse(tw_i_dz_podm$TW_DZ_DZIAL_ID == 148, TRUE, FALSE)) %>%
  filter(pol_osob == TRUE | pol == FALSE)
PBL_tworcy_podm <- tw_i_dz_podm %>%
  select(TW_TWORCA_ID, TW_NAZWISKO, TW_IMIE, DZ_DZIAL_ID, DZ_NAZWA, TW_NAZW_WLASCIWE, TW_PSEUDONIMY, TW_DATA_URODZIN, TW_DATA_ZGONU, TW_ROCZNIKI_PBL, TW_SLOWA_KLUCZOWE, TW_UWAGI, TW_ROK_URODZIN, TW_ROK_ZGONU, TW_LICZBA_ZAPISOW, TW_ADNOTACJE, TW_TRANSLITERACJE) %>%
  filter(!is.na(DZ_DZIAL_ID))
colnames(PBL_tworcy_podm) <- c("TW_TWORCA_ID", "TW_NAZWISKO", "TW_IMIE", "TW_DZ_DZIAL_ID", "DZ_NAZWA", "TW_NAZW_WLASCIWE", "TW_PSEUDONIMY", "TW_DATA_URODZIN", "TW_DATA_ZGONU", "TW_ROCZNIKI_PBL", "TW_SLOWA_KLUCZOWE", "TW_UWAGI", "TW_ROK_URODZIN", "TW_ROK_ZGONU", "TW_LICZBA_ZAPISOW", "TW_ADNOTACJE", "TW_TRANSLITERACJE")
PBL_tworcy_podm <- PBL_tworcy_podm %>%
  mutate(nazwa = ifelse(is.na(TW_IMIE),as.character(TW_NAZWISKO),paste(TW_NAZWISKO,TW_IMIE, sep = "")),
         nazwa = str_to_lower(str_replace_all(nazwa, "\\W", "")),
         nazwa = str_replace_all(str_to_lower(nazwa), "\\W", ""))

tw_i_dz <- merge(x=PBL_tworcy,y=PBL_dz_osob, by.x = "TW_DZ_DZIAL_ID", by.y = "NAD_DZ_DZIAL_ID", all.x = TRUE) %>%
  arrange(TW_TWORCA_ID)
tw_i_dz <- data.frame(tw_i_dz, pol_osob = ifelse(tw_i_dz$TW_DZ_DZIAL_ID == 148 & substr(tw_i_dz$TW_NAZWISKO,1,1)==str_sub(tw_i_dz$DZ_NAZWA,nchar(as.character(tw_i_dz$DZ_NAZWA)),nchar(as.character(tw_i_dz$DZ_NAZWA))),TRUE,FALSE), pol = ifelse(tw_i_dz$TW_DZ_DZIAL_ID == 148, TRUE, FALSE)) %>%
  filter(pol_osob == TRUE | pol == FALSE)
PBL_tworcy <- tw_i_dz %>%
  select(TW_TWORCA_ID, TW_NAZWISKO, TW_IMIE, DZ_DZIAL_ID, DZ_NAZWA, TW_NAZW_WLASCIWE, TW_PSEUDONIMY, TW_DATA_URODZIN, TW_DATA_ZGONU, TW_ROCZNIKI_PBL, TW_SLOWA_KLUCZOWE, TW_UWAGI, TW_ROK_URODZIN, TW_ROK_ZGONU, TW_LICZBA_ZAPISOW, TW_ADNOTACJE, TW_TRANSLITERACJE)
colnames(PBL_tworcy) <- c("TW_TWORCA_ID", "TW_NAZWISKO", "TW_IMIE", "TW_DZ_DZIAL_ID", "DZ_NAZWA", "TW_NAZW_WLASCIWE", "TW_PSEUDONIMY", "TW_DATA_URODZIN", "TW_DATA_ZGONU", "TW_ROCZNIKI_PBL", "TW_SLOWA_KLUCZOWE", "TW_UWAGI", "TW_ROK_URODZIN", "TW_ROK_ZGONU", "TW_LICZBA_ZAPISOW", "TW_ADNOTACJE", "TW_TRANSLITERACJE")
PBL_tworcy <- PBL_tworcy %>%
  mutate(nazwa = ifelse(is.na(TW_IMIE),as.character(TW_NAZWISKO),paste(TW_NAZWISKO,TW_IMIE, sep = "")),
         nazwa = str_to_lower(str_replace_all(nazwa, "\\W", "")),
         nazwa = str_replace_all(str_to_lower(nazwa), "\\W", ""),
         TW_DZ_DZIAL_ID = as.numeric(TW_DZ_DZIAL_ID))

PBL_autorzy <- dbReadTable(PBL,'PBL_AUTORZY') %>%
  mutate(nazwa = ifelse(is.na(AM_IMIE),as.character(AM_NAZWISKO),paste(AM_NAZWISKO,AM_IMIE, sep = "")),
         nazwa = str_to_lower(str_replace_all(nazwa, "\\W", "")),
         nazwa = str_replace_all(str_to_lower(nazwa), "\\W", "")) %>%
  filter(nazwa != "nana")

PBL_autor_to_tworca <- sheets_read(ss = "1RuyR3pZl4vNLprIqAWgiWfvG8EJhYGcLWb24J7VwrvA", sheet = "Arkusz1")

PBL_wspoltworcy <- dbReadTable(PBL,'PBL_OSOBY') %>%
  mutate(nazwa_prosta = str_replace_all(str_to_lower(ifelse(is.na(OS_IMIE),as.character(OS_NAZWISKO),paste(OS_NAZWISKO,OS_IMIE, sep = ""))), "\\W", "")) %>%
  filter(nazwa_prosta !="nana")

PBL_funkcje <- sheets_read(ss = "1htn_L6REs3GdG1xSiGHIfr6MJvjmmU_kVGxiMZtCV24", sheet = "Arkusz1")

PBL_wydawnictwa <- dbReadTable(PBL,'PBL_WYDAWNICTWA') %>%
  mutate(nazwa_prosta = str_replace_all(str_to_lower(paste(WY_MIASTO, WY_NAZWA)), "\\W", "")) %>%
  filter(nazwa_prosta !="nana")

PBL_rodzaje_zapisow <- dbReadTable(PBL,'PBL_RODZAJE_ZAPISOW')

BN_PBL_lista_literatur <- sheets_read(ss = "1zbwjnrtWGvbjrQTLMavJcWSu7HfP0I-USNgZ_KWiXjc", sheet = "lista ukd bn") %>%
  filter(!is.na(ukd_ogolne)) %>%
  select(3:9) %>%
  cSplit(.,c("pbl_id","pbl_nazwa","redaktor_dzialu","pbl_id_literatury","pbl_literatura"),sep = "|",direction = "long") %>%
  filter(!is.na(pbl_id))

PBL_hasla_osobowe <- sheets_read(ss = "1zbwjnrtWGvbjrQTLMavJcWSu7HfP0I-USNgZ_KWiXjc", sheet = "pbl_hasla_osobowe") %>%
  select(2:5)
colnames(PBL_hasla_osobowe) <- c("DZ_DZIAL_ID","DZ_NAZWA","redaktor_dzialu","nazwa")
```

```{r przypisanie redaktorów do przedmiotowej, podmiotowej i antologii}
przedmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa")
###przypisanie redaktora na podstawie osoby z 600 jako tematu - książki o twórcy
#600
marc_field_600 <- przedmiotowa_redaktorzy %>%
  select(id,X600)%>%
  filter(X600!="") %>%
  mutate(X600=str_replace_all(X600,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X600",sep = "~",direction = "long") %>%
  filter(X600!="") %>%
  mutate(X600=str_remove_all(X600,"^\\|")) %>%
  mutate(indicator = str_replace_all(X600,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(przedmiotowa_redaktorzy$X600,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_600)[1]))
colnames(empty_table) <-subfield_list
marc_field_600<-cbind(marc_field_600,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_600$X600 <- str_replace(marc_field_600$X600,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_600[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_600$X600),str_replace_all(gsub(string,"\\3",marc_field_600$X600),"\\${2}.", "~"),NA)
}
marc_field_600 <- marc_field_600 %>%
  select(id,`$a`,`$d`,`$c`) %>%
  mutate(name = ifelse(!is.na(`$c`)&substr(`$c`,nchar(`$c`),nchar(`$c`))==";",paste(`$a`,`$c`,`$d`,sep = " "),ifelse(!is.na(`$d`),paste(`$a`,`$d`,sep = " "),as.character(`$a`)))) %>%
  select(id,name) %>%
  mutate(name = str_replace(name,"(\\))(\\.$)","\\1"),
         name = str_replace(name, "([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)","\\1"))

marc_field_600 <- marc_field_600 %>%
  unique() %>%
  inner_join(.,pbl_viaf,by = c("name" = "BN_name")) %>%
  left_join(.,PBL_tworcy,by = c("pbl_id"="TW_TWORCA_ID")) %>%
  left_join(.,redaktorzy_dzialow,by = c("TW_DZ_DZIAL_ID"="DZ_DZIAL_ID")) %>%
  select(id,TW_TWORCA_ID=pbl_id,TW_NAZWISKO,TW_IMIE,TW_DZ_DZIAL_ID,DZ_NAZWA=DZ_NAZWA.x,redaktor_dzialu)
count <- as.data.frame(table(marc_field_600$id))
marc_field_600 <- merge(marc_field_600,count,by.x = "id", by.y = "Var1") %>%
  filter(Freq<2) %>%
  select(-Freq) %>%
  rename(DZ_DZIAL_ID=TW_DZ_DZIAL_ID) %>%
  mutate(RZ_RODZAJ_ID = 2,
         RZ_NAZWA = "książka o twórcy (przedmiotowa)")

###przypisanie do redaktorów na podstawie literatury z pola 655
`%notin%` <- Negate(`%in%`)
przedmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa") %>%
  filter(id %notin% marc_field_600$id)

#655
marc_field_655 <- przedmiotowa_redaktorzy %>%
  select(id,X655)%>%
  filter(X655!="") %>%
  mutate(X655=str_replace_all(X655,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X655",sep = "~",direction = "long") %>%
  filter(X655!="") %>%
  mutate(X655=str_remove_all(X655,"^\\|")) %>%
  mutate(indicator = str_replace_all(X655,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(przedmiotowa_redaktorzy$X655,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_655)[1]))
colnames(empty_table) <-subfield_list
marc_field_655<-cbind(marc_field_655,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_655$X655 <- str_replace(marc_field_655$X655,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_655[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_655$X655),str_replace_all(gsub(string,"\\3",marc_field_655$X655),"\\${2}.", "~"),NA)
}

marc_field_655 <- marc_field_655 %>%
  select(id,`$a`) %>%
  unique()

PBL_literatury_obce <- PBL_dzialy_path %>%
  filter(NAD_DZ_DZIAL_ID==30) %>%
  select(1,2) %>%
  left_join(.,redaktorzy_dzialow,by = "DZ_DZIAL_ID") %>%
  filter(!is.na(redaktor_dzialu)) %>%
  select(1,DZ_NAZWA = 2,4) %>%
  mutate(nazwa = substr(str_replace(DZ_NAZWA, "(.*?)( )(.*?)","\\3"),1,nchar(str_replace(DZ_NAZWA, "(.*?)( )(.*?)","\\3"))-1),
         nazwa = ifelse(nazwa=="romska (cygańska","romsk|cygańsk",as.character(nazwa)))

reczne <- data.frame(DZ_DZIAL_ID = c(32,32,32,32,59,86,107,149,67,69,34,34,34,34,34,55,32,99,34),DZ_NAZWA = c("Literatura brytyjska i irlandzka","Literatura brytyjska i irlandzka","Literatura brytyjska i irlandzka","Literatura brytyjska i irlandzka","Literatura grecka starożytna","Literatura łacińska średniowieczna","Literatura syryjska","Literatura esperanto","Literatura holenderska","Literatury Indii","Literatury Afryki Subsaharyjskiej","Literatury Afryki Subsaharyjskiej","Literatury Afryki Subsaharyjskiej","Literatury Afryki Subsaharyjskiej","Literatury Afryki Subsaharyjskiej", "Literatura egipsko-arabska", "Literatura brytyjska i irlandzka","Literatura palestyńsko-arabska","Literatury Afryki Subsaharyjskiej"), redaktor_dzialu = c("BEATAK","BEATAK","BEATAK","BEATAK","BEATAS","BEATAS","BEATAD","CEZARY","TOMASZU","EWA","EWA","EWA","EWA","EWA","EWA","BEATAD","BEATAK","BEATAD","EWA"), nazwa = c("angielsk","szkock","irlandzk","walijsk","greck","łacińsk","syryjsk","esperanck","niderlandzk","indyjsk","południowoafryka","senegalsk","nigeryjsk","afrykańsk","ruandyjsk","egipsk. nowożytn","celtyck","palestyńsk","somalijsk"))

PBL_literatury_obce <- rbind(PBL_literatury_obce,reczne)

marc_field_655 <- sqldf("select *
                            from marc_field_655 a
                            left join PBL_literatury_obce b on a.`$a` like ('%'||b.nazwa||'%')") %>%
  arrange(id,DZ_DZIAL_ID)

marc_field_655$same <- cumsum(!duplicated(marc_field_655[1]))
marc_field_655 <- marc_field_655[!duplicated(marc_field_655$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(marc_field_600))
###przypisanie do redaktorów na podstawie literatury z pola 650
przedmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa") %>%
  filter(id %notin% marc_field_600$id) %>%
  filter(id %notin% marc_field_655$id)

#650
marc_field_650 <- przedmiotowa_redaktorzy %>%
  select(id,X650)%>%
  filter(X650!="") %>%
  mutate(X650=str_replace_all(X650,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X650",sep = "~",direction = "long") %>%
  filter(X650!="") %>%
  mutate(X650=str_remove_all(X650,"^\\|")) %>%
  mutate(indicator = str_replace_all(X650,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(przedmiotowa_redaktorzy$X650,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_650)[1]))
colnames(empty_table) <-subfield_list
marc_field_650<-cbind(marc_field_650,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_650$X650 <- str_replace(marc_field_650$X650,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_650[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_650$X650),str_replace_all(gsub(string,"\\3",marc_field_650$X650),"\\${2}.", "~"),NA)
}

marc_field_650 <- marc_field_650 %>%
  select(id,`$a`) %>%
  unique()

marc_field_650 <- sqldf("select *
                            from marc_field_650 a
                            left join PBL_literatury_obce b on a.`$a` like ('%'||b.nazwa||'%')") %>%
  arrange(id,DZ_DZIAL_ID)

marc_field_650$same <- cumsum(!duplicated(marc_field_650[1]))
marc_field_650 <- marc_field_650[!duplicated(marc_field_650$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(marc_field_600))

do_przedmiotowej1 <- rbind(marc_field_600,marc_field_655,marc_field_650)

#przypisanie na podstawie deskryptorów tematycznych z 650 i 655
zapisy <- RJDBC::dbGetQuery(PBL,
                            "select z.za_zapis_id, dz.dz_dzial_id, dz.dz_nazwa, rz.rz_rodzaj_id, rz.rz_nazwa, z.za_status_imp, z.za_uwagi
                            from pbl_zapisy z
                            join pbl_dzialy dz on dz.dz_dzial_id=z.za_dz_dzial1_id
                            join pbl_rodzaje_zapisow rz on rz.rz_rodzaj_id=z.za_rz_rodzaj1_id
                            where z.za_uwagi like '%import%'") %>%
  mutate(pracownik_pbl = str_extract(ZA_UWAGI, "(?<=akceptuje:)([A-Z]*)")) %>%
  select(-ZA_UWAGI)
nazwy_lit_obcych <- str_replace_all(paste(PBL_literatury_obce$nazwa,collapse = "|"),"\\(","\\\\(")
poprzednie_importy <- rbind(listy_2004,listy_2005,listy_2006,listy_2007,listy_2008) %>%
  full_join(.,zapisy,by = "ZA_ZAPIS_ID") %>%
  select(ZA_ZAPIS_ID,X650,X655,DZ_DZIAL_ID,DZ_NAZWA,RZ_RODZAJ_ID,RZ_NAZWA,pracownik_pbl,ZA_STATUS_IMP) %>%
  mutate(X650 = str_remove_all(X650,"\\\\7"),
         X655 = str_remove_all(X655,"\\\\7"),
         X650 = str_remove_all(str_replace_all(X650,"(\\$a)","\\\\#7\\1"),"#"),
         X655 = str_remove_all(str_replace_all(X655,"(\\$a)","\\\\#7\\1"),"#")) %>%
  unique() %>%
  filter(RZ_RODZAJ_ID %notin% c(0,1,2,250,764)) %>%
  arrange(pracownik_pbl,DZ_DZIAL_ID) %>%
  filter(!grepl(nazwy_lit_obcych,X650)&!grepl(nazwy_lit_obcych,X655)) %>%
  filter(!is.na(pracownik_pbl)) %>%
  filter(ZA_STATUS_IMP %in% c("IOK","IPC"))

#przypisanie na podstawie częstotliwości deskryptorów 655
przedmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa") %>%
  filter(id %notin% do_przedmiotowej1$id)

deskryptory655 <- poprzednie_importy %>%
  select(X655,pracownik_pbl,DZ_DZIAL_ID,DZ_NAZWA) %>%
  filter(!is.na(X655)) %>%
  unite(data=.,col = "deskryptor655", sep = "~")

deskryptory655 <- as.data.frame(table(deskryptory655$deskryptor655)) %>%
  cSplit(.,"Var1",sep = "~",direction = "wide") %>%
  rename(X655 = Var1_1,
         redaktor_dzialu = Var1_2,
         DZ_DZIAL_ID = Var1_3,
         DZ_NAZWA = Var1_4) %>%
  mutate(X655 = str_remove_all(X655,"\\\\7\\$a"),
         X655 = str_remove_all(X655,"\\$2DBN"),
         X655 = str_replace_all(X655,"\\$.|\\|"," "),
         X655 = str_replace_all(X655," ",".*")) %>%
  arrange(X655,-Freq,DZ_NAZWA)

deskryptory655$id_grupy <- cumsum(!duplicated(deskryptory655[2]))
deskryptory655 <- deskryptory655[!duplicated(deskryptory655$id_grupy),] %>%
  select(-id_grupy) %>%
  arrange(-Freq)

x <- 1:length(deskryptory655$X655)
test <- data.frame(stringsAsFactors = FALSE)
for (i in x) {
  progress(match(i,x), max.value = length(x))
    do_przedmiotowej2 <- przedmiotowa_redaktorzy %>%
      mutate(redaktor_dzialu = ifelse(grepl(deskryptory655$X655[i],X655),as.character(deskryptory655$redaktor_dzialu)[i],NA),
             ile = ifelse(grepl(deskryptory655$X655[i],X655),as.integer(deskryptory655$Freq)[i],NA),
             co = ifelse(grepl(deskryptory655$X655[i],X655),as.character(deskryptory655$X655)[i],NA),
             DZ_DZIAL_ID = ifelse(grepl(deskryptory655$X655[i],X655),as.integer(deskryptory655$DZ_DZIAL_ID)[i],NA),
             DZ_NAZWA = ifelse(grepl(deskryptory655$X655[i],X655),as.character(deskryptory655$DZ_NAZWA)[i],NA)) %>%
      filter(!is.na(redaktor_dzialu))
    if (length(do_przedmiotowej2$redaktor_dzialu)>0) {
      test <- rbind(test,do_przedmiotowej2)
    } else {}
    
}
count <- as.data.frame(table(test$id))
do_przedmiotowej2 <- merge(test,count, by.x = "id",by.y = "Var1") %>%
  mutate(dlugosc = nchar(co)) %>%
  arrange(-Freq,id,-dlugosc,-ile)

do_przedmiotowej2$id_grupy <- cumsum(!duplicated(do_przedmiotowej2[1]))
do_przedmiotowej2 <- do_przedmiotowej2[!duplicated(do_przedmiotowej2$id_grupy),] %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(do_przedmiotowej1))
#przypisanie na podstawie częstotliwości deskryptorów 650
przedmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa") %>%
  filter(id %notin% do_przedmiotowej1$id) %>%
  filter(id %notin% do_przedmiotowej2$id)

deskryptory650 <- poprzednie_importy %>%
  select(X650,pracownik_pbl,DZ_DZIAL_ID,DZ_NAZWA) %>%
  filter(!is.na(X650)) %>%
  unite(data=.,col = "deskryptor650", sep = "~")

deskryptory650 <- as.data.frame(table(deskryptory650$deskryptor650)) %>%
  cSplit(.,"Var1",sep = "~",direction = "wide") %>%
  rename(X650 = Var1_1,
         redaktor_dzialu = Var1_2,
         DZ_DZIAL_ID = Var1_3,
         DZ_NAZWA = Var1_4) %>%
  mutate(X650 = str_remove_all(X650,"\\\\7\\$a"),
         X650 = str_remove_all(X650,"\\$2DBN"),
         X650 = str_remove_all(X650,"\\\\\\\\"),
         X650 = str_replace_all(X650,"\\$.|\\|"," "),
         X650 = str_replace_all(X650," ",".*")) %>%
  arrange(X650,-Freq,DZ_NAZWA)

deskryptory650$id_grupy <- cumsum(!duplicated(deskryptory650[2]))
deskryptory650 <- deskryptory650[!duplicated(deskryptory650$id_grupy),] %>%
  select(-id_grupy) %>%
  arrange(-Freq)

x <- 1:length(deskryptory650$X650)
test <- data.frame(stringsAsFactors = FALSE)
for (i in x) {
  progress(match(i,x), max.value = length(x))
    do_przedmiotowej3 <- przedmiotowa_redaktorzy %>%
      mutate(redaktor_dzialu = ifelse(grepl(deskryptory650$X650[i],X650),as.character(deskryptory650$redaktor_dzialu)[i],NA),
             ile = ifelse(grepl(deskryptory650$X650[i],X650),as.integer(deskryptory650$Freq)[i],NA),
             co = ifelse(grepl(deskryptory650$X650[i],X650),as.character(deskryptory650$X650)[i],NA),
             DZ_DZIAL_ID = ifelse(grepl(deskryptory650$X650[i],X650),as.integer(deskryptory650$DZ_DZIAL_ID)[i],NA),
             DZ_NAZWA = ifelse(grepl(deskryptory650$X650[i],X650),as.character(deskryptory650$DZ_NAZWA)[i],NA)) %>%
      filter(!is.na(redaktor_dzialu))
    if (length(do_przedmiotowej3$redaktor_dzialu)>0) {
      test <- rbind(test,do_przedmiotowej3)
    } else {}
    
}
count <- as.data.frame(table(test$id))
do_przedmiotowej3 <- merge(test,count, by.x = "id",by.y = "Var1") %>%
  mutate(dlugosc = nchar(co)) %>%
  arrange(-Freq,id,-dlugosc,-ile)

do_przedmiotowej3$id_grupy <- cumsum(!duplicated(do_przedmiotowej3[1]))
do_przedmiotowej3 <- do_przedmiotowej3[!duplicated(do_przedmiotowej3$id_grupy),] %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(do_przedmiotowej1))

do_przedmiotowej <- rbind(do_przedmiotowej1,do_przedmiotowej2,do_przedmiotowej3)
#przypisanie przedmiotowej na podstawie słownika pojęć
do_przedmiotowej <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa") %>%
  left_join(.,do_przedmiotowej,by="id") %>%
#przypisanie na podstawie zdefiniowanych słów (dopisanie do gotowego pliku)
  mutate(redaktor_dzialu = ifelse(is.na(redaktor_dzialu),
                                  ifelse(grepl("teatr",X655,ignore.case = TRUE)|grepl("teatr",X650,ignore.case = TRUE),"MARTAK",
                                         ifelse(grepl("film",X655,ignore.case = TRUE)|grepl("film",X650,ignore.case = TRUE),"OLA",
                                                    ifelse(grepl("telewizj",X655,ignore.case = TRUE)|grepl("telewizj",X650,ignore.case = TRUE),"EWA",
                                                           ifelse(grepl("radio",X655,ignore.case = TRUE)|grepl("radio",X650,ignore.case = TRUE),"EWA",
                                                                  ifelse(grepl("czasopism",X655,ignore.case = TRUE)|grepl("czasopism",X650,ignore.case = TRUE),"TOMASZ",
                                                                         ifelse(grepl("wydawnictw",X655,ignore.case = TRUE)|grepl("wydawnictw",X650,ignore.case = TRUE),"BARBARAW",
                                                                                ifelse(grepl("od 1989",X655,ignore.case = TRUE)|grepl("od 1989",X650,ignore.case = TRUE),"PAULINA",
                                                                                       ifelse(grepl("ćwicze|zadan|szkoł|szkół|scenariusz|zajęć|pomocnicz",X655,ignore.case = TRUE)|grepl("ćwicze|zadan|szkoł|szkół|scenariusz|zajęć|pomocnicz",X650,ignore.case = TRUE),"KAROLINA",
                                                                                              ifelse(grepl("sceniczn",X655,ignore.case = TRUE)|grepl("sceniczn",X650,ignore.case = TRUE),"MARTAK",
                                                                                                     ifelse(grepl("teoria|socjologia|antropologia|metafizyk|interpretac|filozof",X655,ignore.case = TRUE)|grepl("teoria|socjologia|antropologia|metafizyk|interpretac|filozof",X650,ignore.case = TRUE),"PAULINA",
                                                                                                            ifelse(grepl("ludow|zwycz|obycz|folkl",X655,ignore.case = TRUE)|grepl("ludow|zwycz|obycz|folkl",X650,ignore.case = TRUE),"ANIA",
                                                                                                                   ifelse(grepl("katolic|biblia|biblij|kościół",X655,ignore.case = TRUE)|grepl("katolic|biblia|biblij|kościół",X650,ignore.case = TRUE),"BEATAS",
                                                                                                                          ifelse(grepl("druk|rękopi|inkunab|inwent|bibliogr|słownik|bibliotek",X655,ignore.case = TRUE)|grepl("druk|rękopi|inkunab|inwent|bibliogr|słownik|bibliotek",X650,ignore.case = TRUE),"IZA",
                                                                                                                                 ifelse(grepl("zabawk|dziec",X655,ignore.case = TRUE)|grepl("zabawk|dziec",X650,ignore.case = TRUE),"BARBARAW",
                                                                                                                                        ifelse(grepl("tematyka|20-21 w.|21 w.",X655,ignore.case = TRUE)|grepl("tematyka|20-21 w.|21 w.",X650,ignore.case = TRUE),"PAULINA",
                                                                                                                                               ifelse(grepl("19|18|17|16|15|14|13",X655,ignore.case = TRUE)|grepl("19|18|17|16|15|14|13",X650,ignore.case = TRUE),"GOSIA",
                                                                                                                                                      ifelse(grepl("polityk",X655,X655,ignore.case = TRUE)|grepl("polityk",X650,X655,ignore.case = TRUE),"PAULINA",
                                                                                                                                                             ifelse(grepl("historia",X655,X655,ignore.case = TRUE)|grepl("historia",X650,X655,ignore.case = TRUE),"GOSIA",NA)))))))))))))))))),as.character(redaktor_dzialu)),
         RZ_RODZAJ_ID = ifelse(is.na(RZ_RODZAJ_ID),21,as.integer(RZ_RODZAJ_ID)),
         RZ_NAZWA = ifelse(is.na(RZ_NAZWA),"książka w haśle rzeczowym",as.character(RZ_NAZWA))) %>%
  select(names(do_przedmiotowej1)) %>%
  filter(!is.na(redaktor_dzialu))
#wydobycie zbioru, który ciągle nie ma przypisanych redaktorów do przedmiotowej
przedmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa") %>%
  filter(id %notin% do_przedmiotowej$id)
#dla książek, które mają kilku autorów w osoba_bn_temat - przypisanie do redaktora powszechnej - BEATAD?
do_przedmiotowej4 <- przedmiotowa_redaktorzy %>%
  filter(!is.na(osoba_bn_temat)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         DZ_DZIAL_ID = NA,
         DZ_NAZWA = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym",
         redaktor_dzialu = "BEATAD") %>%
  select(names(do_przedmiotowej1))
#dla książek, które nie mają wypełnionego osoba_bn_autor - przypisanie do Marty z x? czy losowo do kogoś?
do_przedmiotowej5 <- przedmiotowa_redaktorzy %>%
  filter(is.na(osoba_bn_autor)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         DZ_DZIAL_ID = NA,
         DZ_NAZWA = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym",
         redaktor_dzialu = "MARTAKx") %>%
  select(names(do_przedmiotowej1))
#połaczenie wszystkich przedmiotowych z przypisanymi redaktorami w jeden plik
do_przedmiotowej <- rbind(do_przedmiotowej,do_przedmiotowej4,do_przedmiotowej5)
#dla książek, które mają wypełnione osoba_bn_autor - zmiana na podmiotową do ręcznego przejrzenia i przypisanie redaktorów
###przypisanie do podmiotowej!!!!!!!!!!!!!!!!!!!###############
do_podmiotowej1 <- przedmiotowa_redaktorzy %>%
  filter(!is.na(osoba_bn_autor))
#trzeba zaktualizować w bn_ok, że teraz to są podmiotowe
#lista rekordów do przepisania z przedmiotowej na podmiotową
lista_do_przepisania <- do_podmiotowej1$id
bn_ok$rodzaj_ksiazki[bn_ok$id %in% lista_do_przepisania] <- "podmiotowa"
#przetworzenie całej podmiotowej (bo plik do_podmiotowej1 już jest w środku)
#przypisanie podmiotowej anonimowej
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa"&X100=="")

#655
marc_field_655 <- podmiotowa_redaktorzy %>%
  select(id,X655)%>%
  filter(X655!="") %>%
  mutate(X655=str_replace_all(X655,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X655",sep = "~",direction = "long") %>%
  filter(X655!="") %>%
  mutate(X655=str_remove_all(X655,"^\\|")) %>%
  mutate(indicator = str_replace_all(X655,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(podmiotowa_redaktorzy$X655,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_655)[1]))
colnames(empty_table) <-subfield_list
marc_field_655<-cbind(marc_field_655,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_655$X655 <- str_replace(marc_field_655$X655,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_655[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_655$X655),str_replace_all(gsub(string,"\\3",marc_field_655$X655),"\\${2}.", "~"),NA)
}

marc_field_655 <- marc_field_655 %>%
  select(id,`$a`) %>%
  unique()
trim <- function (x) gsub("^\\s+|\\s+$", "", x)
PBL_literatury_anonimowe <- PBL_dzialy_path %>%
  filter(grepl("Utwory anonim",DZ_NAZWA)) %>%
  select(DZ_DZIAL_ID,DZ_NAZWA,NAD_NAD_DZ_DZIAL_ID) %>%
  left_join(.,redaktorzy_dzialow,by = c("NAD_NAD_DZ_DZIAL_ID"="DZ_DZIAL_ID")) %>%
  select(1,DZ_NAZWA = 2,5) %>%
  filter(DZ_DZIAL_ID %notin% c(1922,1983)) %>%
  group_by(DZ_DZIAL_ID) %>%
  mutate(nazwa = paste(trim(unlist(str_extract_all(DZ_NAZWA,"(?<=\\()(.*?)(?=\\(|\\))"))),collapse = "|"),
         nazwa = str_remove_all(nazwa,"(.)(?=\\||$)"),
         nazwa = str_remove(nazwa,"literatur. "),
         nazwa = ifelse(nazwa=="","polsk",as.character(nazwa)),
         redaktor_dzialu = ifelse(is.na(redaktor_dzialu),"ANIA",as.character(redaktor_dzialu))) %>%
  ungroup()

reczne <- data.frame(DZ_DZIAL_ID = c(899,694,694,1174,145,1220),DZ_NAZWA = c("Utwory anonimowe (Indii)","Utwory anonimowe (brytyjska i irlandzka)","Utwory anonimowe (brytyjska i irlandzka)","Utwory anonimowe (starosłowiańska)","Utwory anonimowe i ulotne","Utwory anonimowe (turecka)"), redaktor_dzialu = c("EWA","BEATAK","BEATAK","BEATAD","ANIA","EWA"), nazwa = c("indyjsk","walijsk","angielsk","starorusk","kaszubsk","nogajsk"))

PBL_literatury_anonimowe <- rbind(PBL_literatury_anonimowe,reczne)

marc_field_655 <- sqldf("select *
                            from marc_field_655 a
                            left join PBL_literatury_anonimowe b on a.`$a` like ('%'||b.nazwa||'%')") %>%
  arrange(id,DZ_DZIAL_ID)

marc_field_655$same <- cumsum(!duplicated(marc_field_655[1]))
marc_field_655 <- marc_field_655[!duplicated(marc_field_655$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(marc_field_600))
###przypisanie do redaktorów literatury anonimowej na podstawie literatury z pola 650
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa"&X100=="") %>%
  filter(id %notin% marc_field_655$id)

#650
marc_field_650 <- podmiotowa_redaktorzy %>%
  select(id,X650)%>%
  filter(X650!="") %>%
  mutate(X650=str_replace_all(X650,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X650",sep = "~",direction = "long") %>%
  filter(X650!="") %>%
  mutate(X650=str_remove_all(X650,"^\\|")) %>%
  mutate(indicator = str_replace_all(X650,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(podmiotowa_redaktorzy$X650,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_650)[1]))
colnames(empty_table) <-subfield_list
marc_field_650<-cbind(marc_field_650,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_650$X650 <- str_replace(marc_field_650$X650,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_650[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_650$X650),str_replace_all(gsub(string,"\\3",marc_field_650$X650),"\\${2}.", "~"),NA)
}

marc_field_650 <- marc_field_650 %>%
  select(id,`$a`) %>%
  unique()

marc_field_650 <- sqldf("select *
                            from marc_field_650 a
                            left join PBL_literatury_anonimowe b on a.`$a` like ('%'||b.nazwa||'%')") %>%
  arrange(id,DZ_DZIAL_ID)

marc_field_650$same <- cumsum(!duplicated(marc_field_650[1]))
marc_field_650 <- marc_field_650[!duplicated(marc_field_650$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(marc_field_600))
do_podmiotowej1 <- rbind(marc_field_655,marc_field_650)
#co zrobić z pozostałymi podmiotowymi anonimowymi, których nie udało się przypisać?
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa"&X100=="") %>%
  filter(id %notin% do_podmiotowej1$id) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         DZ_DZIAL_ID = NA,
         DZ_NAZWA = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym",
         redaktor_dzialu = "KAROLINA") %>%
  select(names(do_przedmiotowej1))
do_podmiotowej1 <- rbind(do_podmiotowej1,podmiotowa_redaktorzy)
###przypisanie redaktora na podstawie osoby z 100 jako twórcy (autora) - książki twórcy
#100
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  filter(id %notin% do_podmiotowej1$id)

marc_field_100 <- podmiotowa_redaktorzy %>%
  select(id,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(podmiotowa_redaktorzy$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}
marc_field_100 <- marc_field_100 %>%
  select(id,`$a`,`$d`,`$c`) %>%
  mutate(name = ifelse(!is.na(`$c`)&substr(`$c`,nchar(`$c`),nchar(`$c`))==";",paste(`$a`,`$c`,`$d`,sep = " "),ifelse(!is.na(`$d`),paste(`$a`,`$d`,sep = " "),as.character(`$a`)))) %>%
  select(id,name) %>%
  mutate(name = str_replace(name,"(\\))(\\.$)","\\1"),
         name = str_replace(name, "([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)","\\1")) %>%
  group_by(id) %>%
  mutate(name = paste(name,collapse = "|")) %>%
  ungroup() %>%
  unique()

do_podmiotowej2 <- marc_field_100 %>%
  unique() %>%
  inner_join(.,pbl_viaf,by = c("name" = "BN_name")) %>%
  left_join(.,PBL_tworcy,by = c("pbl_id"="TW_TWORCA_ID")) %>%
  left_join(.,redaktorzy_dzialow,by = c("TW_DZ_DZIAL_ID"="DZ_DZIAL_ID")) %>%
  select(id,TW_TWORCA_ID=pbl_id,TW_NAZWISKO,TW_IMIE,DZ_DZIAL_ID=TW_DZ_DZIAL_ID,DZ_NAZWA=DZ_NAZWA.x,redaktor_dzialu) %>%
  mutate(RZ_RODZAJ_ID = 1,
         RZ_NAZWA = "książka twórcy (podmiotowa)") %>%
  unique()

###przypisanie autorów podmiotowej do literatur i przypisanie do redaktorów na podstawie kodu literatury z pola X080 i tworzenie nowych twórców na podstawie pola 100
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  filter(id %notin% do_podmiotowej1$id) %>%
  filter(id %notin% do_podmiotowej2$id)

podmiotowa_redaktorzy <- sqldf("select *
                            from podmiotowa_redaktorzy a
                            join BN_PBL_lista_literatur b on a.X080 like ('%'||b.ukd_ogolne||'%')")

###dodawanie nazewnictw nowych twórców
#100
marc_field_100 <- podmiotowa_redaktorzy %>%
  select(id,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(podmiotowa_redaktorzy$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}

marc_field_100 <- marc_field_100 %>%
  select(id,`$a`) %>%
  unique() %>%
  mutate(`$a` = str_remove(`$a`,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)")) %>%
  group_by(id) %>%
  mutate(`$a` = paste(`$a`,collapse = "|")) %>%
  ungroup() %>%
  unique() %>%
  mutate(TW_NAZWISKO = ifelse(grepl("\\|",`$a`), str_replace_all(str_remove_all(`$a`,","),"\\|",", "),
                              ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\1"),as.character(`$a`))),
         TW_IMIE = ifelse(grepl("\\|",`$a`),"*",
                          ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\3"),"*"))) %>%
  select(id,TW_NAZWISKO,TW_IMIE)
#join na podstawie identycznego id
podmiotowa_redaktorzy <- podmiotowa_redaktorzy %>%
  left_join(.,marc_field_100,by="id") %>%
  mutate(pbl_nazwa = as.character(pbl_nazwa)) %>%
  mutate(DZ_DZIAL_ID = ifelse(nazwa_prosta=="polsk"&substr(pbl_nazwa,nchar(pbl_nazwa),nchar(pbl_nazwa))!=substr(TW_NAZWISKO,1,1),NA,as.integer(pbl_id))) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  arrange(id,DZ_DZIAL_ID)

count <- as.data.frame(table(podmiotowa_redaktorzy$id))
podmiotowa_redaktorzy <- merge(podmiotowa_redaktorzy,count,by.x = "id",by.y = "Var1") %>%
  mutate(dlugosc = nchar(ukd_ogolne)) %>%
  arrange(-Freq,id,-dlugosc,pbl_id)
podmiotowa_redaktorzy$same <- cumsum(!duplicated(podmiotowa_redaktorzy[1]))
do_podmiotowej3 <- podmiotowa_redaktorzy[!duplicated(podmiotowa_redaktorzy$same),] %>%
  mutate(TW_TWORCA_ID = NA) %>%
  rename(DZ_NAZWA = pbl_nazwa) %>%
  select(id,TW_TWORCA_ID,TW_NAZWISKO,TW_IMIE,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  mutate(RZ_RODZAJ_ID = 1,
         RZ_NAZWA = "książka twórcy (podmiotowa)")

###przypisanie autorów podmiotowej do literatur i przypisanie do redaktorów na podstawie literatury z pola 655 i tworzenie nowych twórców na podstawie pola 100
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  filter(id %notin% do_podmiotowej1$id) %>%
  filter(id %notin% do_podmiotowej2$id) %>%
  filter(id %notin% do_podmiotowej3$id)

#655
marc_field_655 <- podmiotowa_redaktorzy %>%
  select(id,X655)%>%
  filter(X655!="") %>%
  mutate(X655=str_replace_all(X655,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X655",sep = "~",direction = "long") %>%
  filter(X655!="") %>%
  mutate(X655=str_remove_all(X655,"^\\|")) %>%
  mutate(indicator = str_replace_all(X655,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(podmiotowa_redaktorzy$X655,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_655)[1]))
colnames(empty_table) <-subfield_list
marc_field_655<-cbind(marc_field_655,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_655$X655 <- str_replace(marc_field_655$X655,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_655[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_655$X655),str_replace_all(gsub(string,"\\3",marc_field_655$X655),"\\${2}.", "~"),NA)
}

marc_field_655 <- marc_field_655 %>%
  select(id,`$a`) %>%
  unique()

marc_field_655 <- sqldf("select *
                            from marc_field_655 a
                            left join PBL_hasla_osobowe b on a.`$a` like ('%'||b.nazwa||'%')")

###dodawanie nazewnictw nowych twórców
#100
marc_field_100 <- podmiotowa_redaktorzy %>%
  select(id,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(podmiotowa_redaktorzy$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}

marc_field_100 <- marc_field_100 %>%
  select(id,`$a`) %>%
  unique() %>%
  mutate(`$a` = str_remove(`$a`,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)")) %>%
  group_by(id) %>%
  mutate(`$a` = paste(`$a`,collapse = "|")) %>%
  ungroup() %>%
  unique() %>%
  mutate(TW_NAZWISKO = ifelse(grepl("\\|",`$a`), str_replace_all(str_remove_all(`$a`,","),"\\|",", "),
                              ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\1"),as.character(`$a`))),
         TW_IMIE = ifelse(grepl("\\|",`$a`),"*",
                          ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\3"),"*"))) %>%
  select(id,TW_NAZWISKO,TW_IMIE)
#join na podstawie identycznego id
marc_field_655 <- marc_field_655 %>%
  left_join(.,marc_field_100,by="id") %>%
  mutate(DZ_DZIAL_ID = ifelse(nazwa=="polsk"&substr(DZ_NAZWA,nchar(DZ_NAZWA),nchar(DZ_NAZWA))!=substr(TW_NAZWISKO,1,1),NA,as.integer(DZ_DZIAL_ID))) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  arrange(id,DZ_DZIAL_ID)
    
marc_field_655$same <- cumsum(!duplicated(marc_field_655[1]))
do_podmiotowej4 <- marc_field_655[!duplicated(marc_field_655$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,TW_NAZWISKO,TW_IMIE,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         RZ_RODZAJ_ID = 1,
         RZ_NAZWA = "książka twórcy (podmiotowa)") %>%
  select(names(marc_field_600))

###przypisanie autorów podmiotowej do literatur i przypisanie do redaktorów na podstawie literatury z pola 655 i tworzenie nowych twórców na podstawie pola 100
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  filter(id %notin% do_podmiotowej1$id) %>%
  filter(id %notin% do_podmiotowej2$id) %>%
  filter(id %notin% do_podmiotowej3$id) %>%
  filter(id %notin% do_podmiotowej4$id)

#650
marc_field_650 <- podmiotowa_redaktorzy %>%
  select(id,X650)%>%
  filter(X650!="") %>%
  mutate(X650=str_replace_all(X650,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X650",sep = "~",direction = "long") %>%
  filter(X650!="") %>%
  mutate(X650=str_remove_all(X650,"^\\|")) %>%
  mutate(indicator = str_replace_all(X650,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(podmiotowa_redaktorzy$X650,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_650)[1]))
colnames(empty_table) <-subfield_list
marc_field_650<-cbind(marc_field_650,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_650$X650 <- str_replace(marc_field_650$X650,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_650[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_650$X650),str_replace_all(gsub(string,"\\3",marc_field_650$X650),"\\${2}.", "~"),NA)
}

marc_field_650 <- marc_field_650 %>%
  select(id,`$a`) %>%
  unique()

marc_field_650 <- sqldf("select *
                            from marc_field_650 a
                            left join PBL_hasla_osobowe b on a.`$a` like ('%'||b.nazwa||'%')")  %>%
  left_join(.,marc_field_100,by="id") %>%
  mutate(DZ_DZIAL_ID = ifelse(nazwa=="polsk"&substr(DZ_NAZWA,nchar(DZ_NAZWA),nchar(DZ_NAZWA))!=substr(TW_NAZWISKO,1,1),NA,as.integer(DZ_DZIAL_ID))) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  arrange(id,DZ_DZIAL_ID)

marc_field_650$same <- cumsum(!duplicated(marc_field_650[1]))
do_podmiotowej5 <- marc_field_650[!duplicated(marc_field_650$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,TW_NAZWISKO,TW_IMIE,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         RZ_RODZAJ_ID = 1,
         RZ_NAZWA = "książka twórcy (podmiotowa)") %>%
  select(names(marc_field_600))
#co zostało do podmiotowej?
podmiotowa_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  filter(id %notin% do_podmiotowej1$id) %>%
  filter(id %notin% do_podmiotowej2$id) %>%
  filter(id %notin% do_podmiotowej3$id) %>%
  filter(id %notin% do_podmiotowej4$id) %>%
  filter(id %notin% do_podmiotowej5$id)
#naddatek przypisać Karolinie jako podmiotową bez twórców i czy_automatycznie <- nie
do_podmiotowej6 <- podmiotowa_redaktorzy %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         DZ_DZIAL_ID = NA,
         DZ_NAZWA = NA,
         RZ_RODZAJ_ID = 1,
         RZ_NAZWA = "książka twórcy (podmiotowa)",
         redaktor_dzialu = "KAROLINA") %>%
  select(names(do_podmiotowej5))
#trzeba zaktualizować w bn_ok, że teraz to nie są automatyczne
lista_do_przepisania <- do_podmiotowej6$id
bn_ok$czy_automatycznie[bn_ok$id %in% lista_do_przepisania] <- "nie"
#połączenie przydziału podmiotowych w jeden plik
do_podmiotowej <- rbind(do_podmiotowej1,do_podmiotowej2,do_podmiotowej3,do_podmiotowej4,do_podmiotowej5,do_podmiotowej6)

#przypisanie antologii do Tomka i do literatur na podstawie 080
antologie_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki == "antologia")
PBL_dzialy_antologie <- PBL_dzialy_path %>%
  filter(grepl("antolog",DZ_NAZWA,ignore.case = TRUE)) %>%
  left_join(.,redaktorzy_dzialow,by="DZ_DZIAL_ID") %>%
  select(DZ_DZIAL_ID,DZ_NAZWA=DZ_NAZWA.x,redaktor_dzialu) %>%
  mutate(redaktor_dzialu = ifelse(is.na(redaktor_dzialu),"TOMASZ",as.character(redaktor_dzialu)))

PBL_dzialy_antologie <- sqldf("select *
                            from PBL_dzialy_antologie a
                            left join BN_PBL_lista_literatur b on a.DZ_NAZWA like ('%'||b.nazwa_prosta||'%')") %>%
  mutate(ukd_ogolne = ifelse(DZ_DZIAL_ID==146,"821.162.1",as.character(ukd_ogolne)),
         nazwa_prosta = ifelse(DZ_DZIAL_ID==146,"polsk",as.character(nazwa_prosta))) %>%
  filter(!is.na(ukd_ogolne)) %>%
  filter(DZ_DZIAL_ID!=744) %>%
  select(1:5) 

antologie_redaktorzy <- sqldf("select *
                            from antologie_redaktorzy a
                            join PBL_dzialy_antologie b on a.X080 like ('%'||b.ukd_ogolne||'%')")

count <- as.data.frame(table(antologie_redaktorzy$id))
antologie_redaktorzy <- merge(antologie_redaktorzy,count,by.x = "id",by.y = "Var1") %>%
  mutate(dlugosc = nchar(ukd_ogolne)) %>%
  arrange(-Freq,id,-dlugosc,DZ_DZIAL_ID)
antologie_redaktorzy$same <- cumsum(!duplicated(antologie_redaktorzy[1]))
do_antologii1 <- antologie_redaktorzy[!duplicated(antologie_redaktorzy$same),] %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA) %>%
  select(id,TW_TWORCA_ID,TW_NAZWISKO,TW_IMIE,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  mutate(RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym")
#przypisanie antologii do Tomka i do literatur na podstawie 665
antologie_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki == "antologia") %>%
  filter(id %notin% do_antologii1$id)

marc_field_655 <- antologie_redaktorzy %>%
  select(id,X655)%>%
  filter(X655!="") %>%
  mutate(X655=str_replace_all(X655,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X655",sep = "~",direction = "long") %>%
  filter(X655!="") %>%
  mutate(X655=str_remove_all(X655,"^\\|")) %>%
  mutate(indicator = str_replace_all(X655,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(antologie_redaktorzy$X655,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_655)[1]))
colnames(empty_table) <-subfield_list
marc_field_655<-cbind(marc_field_655,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_655$X655 <- str_replace(marc_field_655$X655,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_655[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_655$X655),str_replace_all(gsub(string,"\\3",marc_field_655$X655),"\\${2}.", "~"),NA)
}

marc_field_655 <- marc_field_655 %>%
  select(id,`$a`) %>%
  unique()

marc_field_655 <- sqldf("select *
                            from marc_field_655 a
                            left join PBL_dzialy_antologie b on a.`$a` like ('%'||b.nazwa_prosta||'%')") %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  arrange(id,DZ_DZIAL_ID)

marc_field_655$same <- cumsum(!duplicated(marc_field_655[1]))
do_antologii2 <- marc_field_655[!duplicated(marc_field_655$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(do_antologii1))
#przypisanie antologii do Tomka i do literatur na podstawie 665
antologie_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki == "antologia") %>%
  filter(id %notin% do_antologii1$id) %>%
  filter(id %notin% do_antologii2$id)

marc_field_650 <- antologie_redaktorzy %>%
  select(id,X650)%>%
  filter(X650!="") %>%
  mutate(X650=str_replace_all(X650,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X650",sep = "~",direction = "long") %>%
  filter(X650!="") %>%
  mutate(X650=str_remove_all(X650,"^\\|")) %>%
  mutate(indicator = str_replace_all(X650,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(antologie_redaktorzy$X650,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_650)[1]))
colnames(empty_table) <-subfield_list
marc_field_650<-cbind(marc_field_650,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_650$X650 <- str_replace(marc_field_650$X650,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_650[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_650$X650),str_replace_all(gsub(string,"\\3",marc_field_650$X650),"\\${2}.", "~"),NA)
}

marc_field_650 <- marc_field_650 %>%
  select(id,`$a`) %>%
  unique()

marc_field_650 <- sqldf("select *
                            from marc_field_650 a
                            left join PBL_dzialy_antologie b on a.`$a` like ('%'||b.nazwa_prosta||'%')") %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  arrange(id,DZ_DZIAL_ID)

marc_field_650$same <- cumsum(!duplicated(marc_field_650[1]))
do_antologii3 <- marc_field_650[!duplicated(marc_field_650$same),] %>%
  select(id,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  filter(!is.na(DZ_DZIAL_ID)) %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym") %>%
  select(names(do_antologii1))
#reszta antologii bez działu po prostu przypisana do Tomka
antologie_redaktorzy <- bn_ok %>%
  filter(rodzaj_ksiazki == "antologia") %>%
  filter(id %notin% do_antologii1$id) %>%
  filter(id %notin% do_antologii2$id) %>%
  filter(id %notin% do_antologii3$id)

do_antologii4 <- antologie_redaktorzy %>%
  mutate(TW_TWORCA_ID = NA,
         TW_NAZWISKO = NA,
         TW_IMIE = NA,
         DZ_DZIAL_ID = NA,
         DZ_NAZWA = NA,
         RZ_RODZAJ_ID = 21,
         RZ_NAZWA = "książka w haśle rzeczowym",
         redaktor_dzialu = "TOMASZ") %>%
  select(names(do_antologii1))

do_antologii <- rbind(do_antologii1,do_antologii2,do_antologii3,do_antologii4)
#połączenie przydziałów w jeden plik
redaktorzy_zapisow <- rbind(do_podmiotowej,do_przedmiotowej,do_antologii)
#połączenie przypisania ze zbiorem 
bn_ok <- bn_ok %>%
  left_join(.,redaktorzy_zapisow,by="id") %>%
  mutate(redaktor_dzialu = ifelse(is.na(DZ_NAZWA),as.character(redaktor_dzialu),
                                  ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - B","PAULINA",
                                         ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - G","MARTAK",
                                                ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - L","BEATAK",
                                                       ifelse(DZ_NAZWA=="Literatura współczesna (utwory anonimowe i ulotne)","GOSIA",
                                                              ifelse(DZ_NAZWA=="Utwory anonimowe i ulotne","GOSIA",
                                                                     ifelse(DZ_NAZWA=="Utwory anonimowe i ulotne (epoka nieznana)","GOSIA",
                                                                            ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - N","GOSIA",
                                                                                   ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - O","GOSIA",
                                                                                          ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - Q","GOSIA",
                                                                                                 ifelse(DZ_NAZWA=="Literatura brytyjska i irlandzka","EWA",
                                                                                                        ifelse(DZ_NAZWA=="Utwory anonimowe (brytyjska i irlandzka)","EWA",
                                                                                                               ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - U","PAULINA",
                                                                                                                      ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - X","PAULINA",
                                                                                                                             ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - V","PAULINA",
                                                                                                                                    ifelse(DZ_NAZWA=="Hasła osobowe (literatura polska) - Y","PAULINA",as.character(redaktor_dzialu))))))))))))))))))
bn_ok <- bn_ok %>%
  mutate(ZA_UWAGI = 1:nrow(.))

#ujednolicenie literatury dla kilku zapisów nowego twórcy
kilka_literatur_nowego_tworcy <- bn_ok %>%
  select(id,TW_TWORCA_ID,TW_NAZWISKO,TW_IMIE,DZ_DZIAL_ID,DZ_NAZWA,redaktor_dzialu) %>%
  filter(is.na(TW_TWORCA_ID)&!is.na(TW_NAZWISKO)) %>%
  select(-TW_TWORCA_ID) %>%
  arrange(TW_NAZWISKO,TW_IMIE) %>%
  group_by_at(vars(2:3)) %>%
  mutate(unikatowy_dzial = paste(unique(DZ_DZIAL_ID),collapse = "|"),
         DZ_DZIAL_ID = paste(DZ_DZIAL_ID,collapse = "|"),
         DZ_NAZWA = paste(DZ_NAZWA,collapse = "|"),
         redaktor_dzialu = paste(redaktor_dzialu,collapse = "|"),
         id = paste(id,collapse = "|")) %>%
  ungroup() %>%
  unique() %>%
  filter(grepl("\\|",unikatowy_dzial)) %>%
  select(-unikatowy_dzial) %>%
  mutate(id_grupy = 1:lengths(.)) %>%
  cSplit(.,c("id","DZ_DZIAL_ID","DZ_NAZWA","redaktor_dzialu"),sep = "|",direction = "long")

kilka_literatur_nowego_tworcy[,2:7][duplicated(kilka_literatur_nowego_tworcy$id_grupy),] <- NA
kilka_literatur_nowego_tworcy <- fill_(kilka_literatur_nowego_tworcy, names(kilka_literatur_nowego_tworcy))
#zaktualizowanie zbioru podmiotowych o ujednolicone działy dla nowych twórców
x <- 1:length(kilka_literatur_nowego_tworcy$id)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  bn_ok$DZ_DZIAL_ID[bn_ok$id==kilka_literatur_nowego_tworcy$id[i]] <- kilka_literatur_nowego_tworcy$DZ_DZIAL_ID[i]
  bn_ok$DZ_NAZWA[bn_ok$id==kilka_literatur_nowego_tworcy$id[i]] <- as.character(kilka_literatur_nowego_tworcy$DZ_NAZWA)[i]
  bn_ok$redaktor_dzialu[bn_ok$id==kilka_literatur_nowego_tworcy$id[i]] <- as.character(kilka_literatur_nowego_tworcy$redaktor_dzialu)[i]
}
#jeśli nie ma działu lub rodzaju zapisu, to wpisać id i nazwę do ustalenia
bn_ok <- bn_ok %>%
  mutate(DZ_DZIAL_ID =ifelse(is.na(DZ_DZIAL_ID),0,as.integer(DZ_DZIAL_ID)),
         DZ_NAZWA = ifelse(is.na(DZ_NAZWA),"-- do ustalenia --",as.character(DZ_NAZWA)),
         RZ_RODZAJ_ID =ifelse(is.na(RZ_RODZAJ_ID),0,as.integer(RZ_RODZAJ_ID)),
         RZ_NAZWA = ifelse(is.na(RZ_NAZWA),"-- do ustalenia --",as.character(RZ_NAZWA)))

```

```{r problemy}

#przygotować wszystko dookoła - listy pracowników; wysłać z R od razu na dysk?
#zrobić współwydanie

test <- out %>%
  filter(pracownik == "NA_podm")


write.csv2(bn_ok, "C:/Users/Cezary/Desktop/2009_listy_pracowników.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')

write.xlsx(bn_ok, "C:/Users/Cezary/Desktop/2009_listy_pracowników.xlsx",sheetName = "listy_pracownikow")


```


```{r książki podmiotowe}
data <- bn_ok %>%
  filter(rodzaj_ksiazki=="podmiotowa") %>%
  mutate(redaktor_dzialu = paste(redaktor_dzialu,"_podm",sep = ""))

#uwolnienie kolumn z danymi z bn i przetworzenie do PBL
#1: za_uwagi, rz_nazwa, za_ro_rok, za_type, rz_rodzaj_id, tw_tworca_id, tw_nazwisko, tw_imie, dz_dzial_id, dz_nazwa, redaktor_dzialu
pola_pbl <- data %>%
  select(ZA_UWAGI, RZ_NAZWA, ZA_RO_ROK = rok, RZ_RODZAJ_ID, TW_TWORCA_ID, TW_NAZWISKO, TW_IMIE, DZ_DZIAL_ID, DZ_NAZWA, redaktor_dzialu) %>%
  mutate(ZA_TYPE = "KS")
#2: autor
BN_autor <- data %>%
  select(X100,X245,ZA_UWAGI)
#pole 100
marc_field_100 <- BN_autor %>%
  select(ZA_UWAGI,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(BN_autor$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}

#pole 245
marc_field_245 <- BN_autor %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(BN_autor$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

BN_autor <- marc_field_100 %>%
  select(ZA_UWAGI,`$a`,`$b`) %>%
  unique() %>%
  mutate(`$a` = ifelse(!is.na(`$b`),paste(`$a`,`$b`,sep = " "),as.character(`$a`))) %>%
  mutate(`$a` = str_remove(`$a`,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)")) %>%
  unique() %>%
  mutate(AM_NAZWISKO = ifelse(grepl("\\|",`$a`), str_replace_all(str_remove_all(`$a`,","),"\\|",", "),
                              ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\1"),as.character(`$a`))),
         AM_IMIE = ifelse(grepl("\\|",`$a`),"*",
                          ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\3"),"*"))) %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE) %>%
  left_join(.,marc_field_245,by="ZA_UWAGI") %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE, X245c = `$c`)
  
x <- 1:lengths(BN_autor[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  BN_autor$czy_nazwisko[i] <- grepl(BN_autor$AM_NAZWISKO[i],BN_autor$X245c[i])
  BN_autor$czy_imie[i] <- grepl(BN_autor$AM_IMIE[i],BN_autor$X245c[i])
}

BN_autor <- BN_autor %>%
  mutate(ZA_ADNOTACJE = ifelse(czy_nazwisko==FALSE|czy_imie==FALSE,paste("UWAGA! Konflikt w danych osobowych w polach 100 i 245. Porównaj pole autor w formularzu z polem BN: ",X245c,sep = ""),NA)) %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE,ZA_ADNOTACJE) %>%
  mutate(nazwa = str_replace_all(str_to_lower(paste(AM_NAZWISKO,AM_IMIE, sep = "")), "\\W", "")) %>%
  left_join(.,PBL_autorzy %>% select(AM_AUTOR_ID,AM_KRYPTONIM,AM_LICZBA_ZAPISOW,nazwa) %>% filter(is.na(AM_KRYPTONIM)),by="nazwa") %>%
  arrange(ZA_UWAGI,AM_NAZWISKO,AM_IMIE,-AM_LICZBA_ZAPISOW)
BN_autor$id_grupy <- cumsum(!duplicated(BN_autor[1:3]))
BN_autor <- BN_autor[!duplicated(BN_autor$id_grupy),] %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE,ZA_ADNOTACJE,AM_AUTOR_ID)

#3: tytuł
#pole 245
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,`$a`,`$b`,`$n`,`$p`) %>%
  group_by(ZA_UWAGI) %>%
  mutate(`$a` = paste(ifelse(is.na(`$a`),"",as.character(`$a`)),collapse = " "),
         `$b` = paste(ifelse(is.na(`$b`),"",as.character(`$b`)),collapse = " "),
         `$n` = paste(ifelse(is.na(`$n`),"",as.character(`$n`)),collapse = " "),
         `$p` = paste(ifelse(is.na(`$p`),"",as.character(`$p`)),collapse = " ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(ZA_TYTUL = paste(`$a`,`$b`,`$n`,`$p`,sep = ""))

marc_field_245 <- marc_field_245 %>%
  mutate(ZA_TYTUL = paste(`$a`,`$b`,`$n`,`$p`,sep = " "),
         ZA_TYTUL = str_remove(ZA_TYTUL, "\\s+\\/\\s{0,}$"),
         ZA_TYTUL = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,ZA_TYTUL),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,ZA_TYTUL),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,ZA_TYTUL),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,ZA_TYTUL),as.character(ZA_TYTUL))))),
         ZA_TYTUL = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,ZA_TYTUL),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,ZA_TYTUL),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,ZA_TYTUL),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,ZA_TYTUL),as.character(ZA_TYTUL))))),
         ZA_TYTUL = str_replace_all(ZA_TYTUL,"\\.{3} \\.{3}","... "),
         ZA_TYTUL = str_replace_all(ZA_TYTUL," ; ",". ")) %>%
  select(ZA_UWAGI,ZA_TYTUL)
#dopisanie gatunku do przedmiotowej na podstawie 655 i 650  
gatunki_pbl <- data.frame(gatunek = c("aforyzm", "album", "antologia", "autobiografia", "dziennik", "esej", "felieton", "inne", "kazanie", "list", "miniatura prozą", "opowiadanie", "poemat", "powieść", "proza", "proza poetycka", "reportaż", "rozmyślanie religijne", "rysunek, obraz", "scenariusz", "szkic", "tekst biblijny", "tekst dramatyczny", "dramat", "wiersz", "wspomnienia", "wypowiedź", "pamiętniki", "poezja", "literatura podróżnicza", "satyra", "piosenka"))

#dramat, pamiętniki, poezja, literatura podróżnicza, satyra, piosenka
gatunki_bn <- data %>%
  select(ZA_UWAGI,X655,X650)

gatunki_bn <- sqldf("select *
                    from gatunki_bn
                    left join gatunki_pbl on lower(gatunki_bn.X655) like '%'||gatunki_pbl.gatunek||'%'")
gatunki_bn <- sqldf("select *
                      from gatunki_bn
                      left join gatunki_pbl on lower(gatunki_bn.X650) like '%'||gatunki_pbl.gatunek||'%'")
colnames(gatunki_bn)[5] <- "gatunek2"
gatunki_bn <- gatunki_bn %>%
  mutate(gatunek = ifelse(is.na(gatunek)&!is.na(gatunek2),as.character(gatunek2),as.character(gatunek)),
         gatunek = ifelse(grepl("przypowieść",X655,ignore.case = TRUE)&!grepl("[^y]powieść",X655)&gatunek=="powieść","opowiadanie",as.character(gatunek))) %>%
  filter(!is.na(gatunek)) %>%
  select(ZA_UWAGI,gatunek) %>%
  mutate(gatunek = ifelse(gatunek=="dramat","tekst dramatyczny",
                          ifelse(gatunek=="pamiętniki","wspomnienia",
                                 ifelse(gatunek=="poezja","wiersz",
                                        ifelse(gatunek=="literatura podróżnicza","reportaż",
                                               ifelse(gatunek=="piosenka","wiersz",as.character(gatunek))))))) %>%
  group_by(ZA_UWAGI) %>%
  mutate(gatunek = paste(gatunek,collapse = ", ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(gatunek = gsub("(^.)","\\U\\1",perl = TRUE, gatunek))
#połączenie tytułu z gatunkiem
za_tytul <- marc_field_245 %>%
  left_join(.,gatunki_bn,by="ZA_UWAGI") %>%
  mutate(ZA_TYTUL = ifelse(!is.na(gatunek)&(substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))=="."|substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))=="!"|substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))=="?"),paste(ZA_TYTUL," [",gatunek,"]",sep = ""),
                           ifelse(!is.na(gatunek)&(substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))!="."|substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))!="!"|substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))!="?"),paste(ZA_TYTUL,". [",gatunek,"]",sep = ""),as.character(ZA_TYTUL)))) %>%
  select(ZA_UWAGI,ZA_TYTUL)
#4: tytuł oryginału
#pole 246
marc_field_246 <- data %>%
  select(ZA_UWAGI,X246)%>%
  filter(X246!="") %>%
  mutate(X246=str_remove_all(X246,"~"),
         X246=str_replace_all(X246,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X246",sep = "~",direction = "long") %>%
  filter(X246!="") %>%
  mutate(X246=str_remove_all(X246,"^\\|")) %>%
  mutate(indicator = str_replace_all(X246,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X246,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_246)[1]))
colnames(empty_table) <-subfield_list
marc_field_246<-cbind(marc_field_246,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_246$X246 <- str_replace(marc_field_246$X246,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_246[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_246$X246),str_replace_all(gsub(string,"\\3",marc_field_246$X246),"\\${2}.", "~"),NA)
}

marc_field_246 <- marc_field_246 %>%
  filter(grepl("oryg",X246)) %>%
  select(ZA_UWAGI,`$a`,`$b`,`$n`,`$p`) %>%
  group_by(ZA_UWAGI) %>%
  mutate(`$a` = paste(ifelse(is.na(`$a`),"",as.character(`$a`)),collapse = ", "),
         `$b` = paste(ifelse(is.na(`$b`),"",as.character(`$b`)),collapse = ""),
         `$n` = paste(ifelse(is.na(`$n`),"",as.character(`$n`)),collapse = ""),
         `$p` = paste(ifelse(is.na(`$p`),"",as.character(`$p`)),collapse = "")) %>%
  ungroup() %>%
  unique() %>%
  mutate(X246 = paste(`$a`,`$b`,`$n`,`$p`,sep = "")) %>%
  mutate(X246 = str_remove(X246, "\\s+\\/\\s{0,}$"),
         X246 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X246),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X246),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X246),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)","\\1.\\2\\U\\5",perl = TRUE,X246),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X246),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X246),as.character(X246))))),
         X246 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X246),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X246),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X246),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)","\\1.\\2\\U\\5",perl = TRUE,X246),
                                         ifelse(grepl("(\\W)( )(:|;)( ){0,1}(.)",X246),gsub("(\\W)( )(:|;)( ){0,1}(.)","\\1\\2\\U\\5",perl = TRUE,X246),as.character(X246))))),
         X246 = str_replace_all(X246,"\\.{3} \\.{3}","... ")) %>%
  select(ZA_UWAGI, X246)

#pole 500
marc_field_500 <- data %>%
  select(ZA_UWAGI,X500)%>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"~"),
         X500=str_replace_all(X500,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X500",sep = "~",direction = "long") %>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"^\\|")) %>%
  mutate(indicator = str_replace_all(X500,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X500,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_500)[1]))
colnames(empty_table) <-subfield_list
marc_field_500<-cbind(marc_field_500,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_500$X500 <- str_replace(marc_field_500$X500,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_500[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_500$X500),str_replace_all(gsub(string,"\\3",marc_field_500$X500),"\\${2}.", "~"),NA)
}
marc_field_500 <- marc_field_500 %>%
  filter(grepl("oryg\\.\\:",X500)) %>%
  mutate(X500 = str_remove(`$a`,"^Tyt\\. oryg\\.: |^Tyt\\, oryg\\.: |^.*?tyt\\. oryg\\.: "),
         X500 = str_remove(X500, "\\s+\\/\\s{0,}$"),
         X500 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X500),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X500),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X500),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,X500),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X500),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X500),as.character(X500))))),
         X500 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X500),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X500),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X500),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,X500),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X500),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X500),as.character(X500))))),
         X500 = str_replace_all(X500,"\\.{3} \\.{3}","... "),
         X500 = str_remove(X500, "\\.$"),
         X500 = str_remove(X500,"(,{0,1} {0,1})\\d{4}.*$|(, t|. T)yt. oryg. cyklu:")) %>%
  select(ZA_UWAGI,X500)
#tytuł oryginału
za_tytul_oryginalu <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,marc_field_246,by="ZA_UWAGI") %>%
  left_join(.,marc_field_500,by="ZA_UWAGI") %>%
  mutate(X500 = ifelse(is.na(X500),NA,
                       ifelse(grepl("oryg",X500),NA,as.character(X500))),
         X500 = ifelse(!is.na(X500)&grepl("\\. - ",X500),str_replace(X500,"(.*?)(\\. - .*$)","\\1"),as.character(X500)),
         X500 = ifelse(!is.na(X500)&grepl("Na książce pseud",X500),str_replace(X500,"(.*?)(\\. Na książce pseud.*$)","\\1"),as.character(X500)),
         X500 = ifelse(!is.na(X500)&grepl("Przekł\\. wg",X500),str_replace(X500,"(.*?)(\\. Przekł\\. wg.*$)","\\1"),as.character(X500)),
         ZA_TYTUL_ORYGINALU = ifelse(is.na(X246)&is.na(X500),NA,
                                     ifelse(!is.na(X500),as.character(X500),as.character(X246))),
         ZA_TYTUL_ORYGINALU = str_remove_all(ZA_TYTUL_ORYGINALU,'\\"')) %>%
  select(ZA_UWAGI,ZA_TYTUL_ORYGINALU)
#5: język oryginału
marc_field_041 <- data %>%
  select(ZA_UWAGI,X041)%>%
  filter(X041!="") %>%
  mutate(X041=str_replace_all(X041,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X041",sep = "~",direction = "long") %>%
  filter(X041!="") %>%
  mutate(X041=str_remove_all(X041,"^\\|")) %>%
  mutate(indicator = str_replace_all(X041,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X041,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_041)[1]))
colnames(empty_table) <-subfield_list
marc_field_041<-cbind(marc_field_041,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_041$X041 <- str_replace(marc_field_041$X041,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_041[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_041$X041),str_replace_all(gsub(string,"\\3",marc_field_041$X041),"\\${2}.", "~"),NA)
}
za_jezyk_oryginalu <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,marc_field_041 %>% select(ZA_UWAGI,ZA_JEZYK_ORYGINALU = `$a`),by="ZA_UWAGI") %>%
  mutate(ZA_JEZYK_ORYGINALU = str_replace_all(ZA_JEZYK_ORYGINALU,"\\$a",",")) %>%
  unique()

#6: współtwórcy
marc_field_700 <- data %>%
  select(ZA_UWAGI,X700)%>%
  filter(X700!="") %>%
  mutate(X700=str_replace_all(X700,"(..\\$a)","|\\1"),
         X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X700",sep = "~",direction = "long") %>%
  filter(X700!="") %>%
  mutate(X700=str_remove_all(X700,"^\\|")) %>%
  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1")) %>%
  filter(X700!="")
subfield_list<- str_extract_all(data$X700,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
colnames(empty_table) <-subfield_list
marc_field_700<-cbind(marc_field_700,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
}

BN_wspoltworca <- marc_field_700 %>%
  select(ZA_UWAGI,osoba = `$a`,funkcja = `$e`) %>%
  filter(!is.na(funkcja)) %>%
  mutate(osoba = str_remove(osoba,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)"),
         OS_NAZWISKO = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\1"),as.character(osoba)),
         OS_IMIE = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\3"),"*"),
         ws_prosty = str_replace_all(str_to_lower(osoba), "\\W", ""),
         fu_prosta = str_replace_all(str_to_lower(funkcja), "\\W", "")) %>%
  left_join(.,PBL_wspoltworcy %>% select(OS_OSOBA_ID,OS_LICZBA_ZAPISOW,nazwa_prosta),by=c("ws_prosty"="nazwa_prosta")) %>%
  arrange(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,-OS_LICZBA_ZAPISOW)
BN_wspoltworca$id_grupy <- cumsum(!duplicated(BN_wspoltworca[1:2]))
BN_wspoltworca <- BN_wspoltworca[!duplicated(BN_wspoltworca$id_grupy),] %>%
  left_join(.,PBL_funkcje,by=c("fu_prosta"="nazwa")) %>%
  mutate(fo_symbol = ifelse(fo_symbol=="NULL",NA,as.character(fo_symbol))) %>%
  select(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,OS_OSOBA_ID,fo_symbol,fo_nazwa,funkcja)

#tutaj przeszukać X245 i znaleźć błędy współtwórców
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}
marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,X245c=`$c`)

BN_wspoltworca <- BN_wspoltworca %>%
  left_join(.,marc_field_245,by="ZA_UWAGI")

x <- 1:lengths(BN_wspoltworca[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  BN_wspoltworca$czy_nazwisko[i] <- str_detect(BN_wspoltworca$X245c[i],BN_wspoltworca$OS_NAZWISKO[i])
  BN_wspoltworca$czy_imie[i] <- grepl(BN_wspoltworca$OS_IMIE[i],BN_wspoltworca$X245c[i])
}

BN_wspoltworca <- BN_wspoltworca %>%
  mutate(ZA_ADNOTACJE = ifelse(czy_nazwisko==FALSE|czy_imie==FALSE,paste("UWAGA! Konflikt w danych osobowych w polach 700 i 245. Porównaj pola współtórców w formularzu z polem BN: ",X245c,sep = ""),NA)) %>%
  select(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,OS_OSOBA_ID,fo_symbol,fo_nazwa,funkcja,ZA_ADNOTACJE)

#7: opis współtwórców
opis_wspoltworcow <- BN_wspoltworca %>%
  select(ZA_UWAGI,funkcja,OS_IMIE,OS_NAZWISKO) %>%
  full_join(.,marc_field_245,by="ZA_UWAGI") %>%
  filter(!is.na(OS_NAZWISKO)|(is.na(OS_NAZWISKO)&grepl("et al\\.",X245c))) %>%
  mutate(jest_et_al = grepl("et al\\.",X245c),
         OS_IMIE = ifelse(OS_IMIE=="*","",as.character(OS_IMIE)),
         opis = ifelse(!is.na(OS_NAZWISKO),paste(funkcja,OS_IMIE, OS_NAZWISKO, sep = " "),""),
         opis = str_replace_all(opis," +"," "),
         opis = ifelse(opis==" ","",as.character(opis))) %>%
  select(ZA_UWAGI,opis,jest_et_al) %>%
  group_by(ZA_UWAGI) %>%
  mutate(opis = paste(opis,collapse = ", "),
         jest_et_al = paste(unique(jest_et_al),sep = "")) %>%
  ungroup() %>%
  unique() %>%
  mutate(opis = ifelse(jest_et_al==TRUE&opis=="","et al.",
                       ifelse(jest_et_al,paste(opis,"et al.",sep = " "),opis))) %>%
  select(ZA_UWAGI,opis)

#700
marc_field_700 <- data %>%
  select(ZA_UWAGI,X700)%>%
  filter(X700!="") %>%
  mutate(X700=str_replace_all(X700,"(..\\$a)","|\\1"),
         X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X700",sep = "~",direction = "long") %>%
  filter(X700!="") %>%
  mutate(X700=str_remove_all(X700,"^\\|")) %>%
  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1")) %>%
  filter(X700!="")
subfield_list<- str_extract_all(data$X700,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
colnames(empty_table) <-subfield_list
marc_field_700<-cbind(marc_field_700,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
}
marc_field_700 <- marc_field_700 %>%
  select(ZA_UWAGI,osoba = `$a`,funkcja = `$e`) %>%
  filter(!is.na(funkcja)) %>%
  mutate(osoba = str_remove(osoba,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)"),
         OS_NAZWISKO = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\1"),as.character(osoba)),
         OS_IMIE = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\3"),"*"),
         funkcja_duza = str_to_lower(funkcja),
         opis = paste(funkcja_duza,OS_IMIE,OS_NAZWISKO, sep = " "),
         opis_duzy = paste(funkcja,OS_IMIE,OS_NAZWISKO, sep = " ")) %>%
  select(ZA_UWAGI,opis,opis_duzy) %>%
  group_by(ZA_UWAGI) %>%
  mutate(opis = paste(opis,collapse = ". "),
         opis_duzy = paste(opis_duzy,collapse = ". ")) %>%
  ungroup() %>%
  unique()

#opis współtwórców ze strefy odpowiedzialności 245
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}
marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,`$c`)

#porównanie opisu współtwórców z 245 i 700
wspoltworcy <- marc_field_700 %>%
  full_join(.,marc_field_245,by="ZA_UWAGI") %>%
  cSplit(.,"$c",sep = " ; ",direction = "long") %>%
  #ograniczanie osób ze strefy odpowiedzialności
  mutate(czy_mala = grepl(" [a-zęóąśłżźćń]|^[a-zęóąśłżźćń]|\\[[a-zęóąśłżźćń]",`$c`,ignore.case = FALSE)) %>%
  filter(czy_mala==TRUE) %>%
  select(-czy_mala) %>%
  #mutate(`$c` = gsub("^(\\[){0,1}([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])","\\1\\U\\2",perl = TRUE,`$c`)) %>%
  group_by(ZA_UWAGI) %>%
  mutate(X245 = paste(`$c`, collapse = ", ")) %>%
  select(-`$c`) %>%
  unique() %>%
  mutate(order_pbl = as.character(str_extract_all(opis,"(?<=^| |\\[|-)([A-ZAÁÀÂÃÄĂĀÅĄÆEÉÈÊËĚĒĖĘIÍÌÎÏĪĮIOÓÒÔÕÖŐØŒUÚÙÛÜŰŪůYÝCĆČçDĎĐĐGĢĞKĶLŁĻNŃÑŇŅŊRŘSŚŠŞSßTŤŦÞŢ8ZŻŹŽa-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])")),
         order_pbl = str_replace_all(order_pbl,"(.*?\")(.)(\".*?.)", "\\2"),
         order_bn = as.character(str_extract_all(X245,"(?<=^| |\\[|-)([A-ZAÁÀÂÃÄĂĀÅĄÆEÉÈÊËĚĒĖĘIÍÌÎÏĪĮIOÓÒÔÕÖŐØŒUÚÙÛÜŰŪůYÝCĆČçDĎĐĐGĢĞKĶLŁĻNŃÑŇŅŊRŘSŚŠŞSßTŤŦÞŢ8ZŻŹŽa-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])")),
         order_bn = str_replace_all(order_bn,"(.*?\")(.)(\".*?.)", "\\2"),
         X245 = str_remove(X245, "\\.$"),
         X245 = str_remove(X245, "\\["),
         X245 = str_remove(X245, "\\]"),
         order_pbl = str_remove_all(order_pbl, "[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]"),
         order_bn = str_remove_all(order_bn, "[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]"),
         to_samo = order_pbl==order_bn,
         X245 = gsub("(^[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(.*)","\\U\\1\\E\\2",perl = TRUE, X245)) %>%
  left_join(.,za_jezyk_oryginalu,by="ZA_UWAGI") %>%
  mutate(czy_pl = grepl("pol",ZA_JEZYK_ORYGINALU)|is.na(ZA_JEZYK_ORYGINALU),
         decyzja = ifelse(to_samo==FALSE|czy_pl==FALSE,FALSE,TRUE))

za_opis_wspoltworcow <- wspoltworcy %>%
  mutate(za_opis_wspoltworcow = ifelse(decyzja==TRUE,as.character(X245),paste(X245,opis_duzy,sep = "#"))) %>%
  select(ZA_UWAGI,opis_duzy,za_opis_wspoltworcow) %>%
  cSplit(.,"za_opis_wspoltworcow",sep = "#",direction = "wide") %>%
  mutate(za_opis_wspoltworcow_2 = ifelse(is.na(za_opis_wspoltworcow_2),'',as.character(za_opis_wspoltworcow_2)),
         to_samo = za_opis_wspoltworcow_1==za_opis_wspoltworcow_2) %>%
  filter(to_samo==FALSE) %>%
  group_by(ZA_UWAGI) %>%
  mutate(za_opis_wspoltworcow = paste(za_opis_wspoltworcow_1,za_opis_wspoltworcow_2,sep = "#"),
         za_opis_wspoltworcow = str_remove_all(za_opis_wspoltworcow,"\\#$")) %>%
  select(ZA_UWAGI,za_opis_wspoltworcow)

opis_wspoltworcow <- opis_wspoltworcow %>%
  filter(ZA_UWAGI %notin% za_opis_wspoltworcow$ZA_UWAGI) %>%
  filter(!is.na(opis)) %>%
  rename(za_opis_wspoltworcow = opis)

za_opis_wspoltworcow <- za_opis_wspoltworcow %>%
  bind_rows(.,opis_wspoltworcow) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#8 wydanie
marc_field_250 <- data %>%
  select(ZA_UWAGI,X250)%>%
  filter(X250!="") %>%
  mutate(X250=str_replace_all(X250,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X250",sep = "~",direction = "long") %>%
  filter(X250!="") %>%
  mutate(X250=str_remove_all(X250,"^\\|")) %>%
  mutate(indicator = str_replace_all(X250,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X250,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_250)[1]))
colnames(empty_table) <-subfield_list
marc_field_250<-cbind(marc_field_250,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_250$X250 <- str_replace(marc_field_250$X250,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_250[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_250$X250),str_replace_all(gsub(string,"\\3",marc_field_250$X250),"\\${2}.", "~"),NA)
}

za_wydanie <- marc_field_250 %>%
  select(ZA_UWAGI, wydanie = `$a`) %>%
  mutate(wydanie = str_remove(wydanie," \\/$")) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#9: instytucja sprawcza
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

za_instytucja <- marc_field_245 %>%
  select(ZA_UWAGI,X245c=`$c`) %>%
  filter(!is.na(X245c)) %>%
  mutate(instytucja = ifelse(grepl("\\;",X245c),str_replace_all(X245c, "(.*?)(\\;(?!.*\\;))( )+(.*?$)","\\4"),"")) %>%
  left_join(.,BN_wspoltworca,by="ZA_UWAGI")

x <- 1:lengths(za_instytucja[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  za_instytucja$czy_nazwisko[i] <- grepl(za_instytucja$OS_NAZWISKO[i],za_instytucja$X245c[i])
  za_instytucja$czy_imie[i] <- grepl(za_instytucja$OS_IMIE[i],za_instytucja$X245c[i])
}

za_instytucja <- za_instytucja %>%
  filter(is.na(czy_nazwisko)&is.na(czy_imie)) %>%
  filter(instytucja!="") %>%
  filter(!grepl("^\\[[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]|^[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]",instytucja)) %>%
  mutate(instytucja = str_remove(instytucja,"\\.$")) %>%
  select(ZA_UWAGI,instytucja) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#10: wydawnictwo
BN_wydawnictwo <- data %>%
  select(ZA_UWAGI, X260) %>%
  mutate(X260 = str_replace_all(X260,"s\\.n\\.", "b.w."), 
         X260 = str_replace_all(X260,"s\\.l\\.", "b.m."), 
         X260 = str_replace_all(X260,"S\\.l\\.", "b.m."), 
         X260 = str_remove(X260,"^\\\\+"), 
         rok_wydania = str_extract_all(X260, "(?<=\\$c).*(?=\\$e)|(?<=\\$c).*"), 
         bez_roku = str_replace_all(X260, ".\\$c.*", ""), 
         ile_wydawnictw = str_count(bez_roku, "\\$b"),
         ile_miejsc = str_count(bez_roku, "\\$a"),
         kolejnosc = str_replace_all(as.character(str_extract_all(bez_roku, "\\$.")), "[^a-z]", ""),
         bez_roku = str_replace_all(bez_roku, ";\\$b", ":$b"),
         wydaw_podziel = ifelse(ile_wydawnictw>ile_miejsc|kolejnosc=="caabb", str_replace_all(bez_roku, "(\\$a)(.*?)( :\\$b.*?)( :\\$b)", "\\1\\2\\3 ;$a\\2\\4"),bez_roku),
         wydawnictwo_test = str_replace_all(wydaw_podziel, "(\\$b)(.*?)( ;\\$a)", "\\1\\2|\\3")) %>%
  select(ZA_UWAGI,rok_wydania,wydawnictwo_test) %>%
  cSplit(., "wydawnictwo_test", sep = "|", direction = "long") %>%
  mutate(wydawnictwo = str_extract_all(wydawnictwo_test, "(?<=\\$b)(.*)"),
         miejsce_wydania = str_replace_all(str_extract_all(wydawnictwo_test, "(?<=\\$a)(.*)(?= {0,1}: {0,1}\\$b)|(?<=\\$a)(.*)($)")," ;\\$a", ", "),
         nazwa_prosta = str_to_lower(str_replace_all(str_replace_all(unlist(wydawnictwo_test), "\\$\\w", ""), "\\W", ""))) %>%
  left_join(.,PBL_wydawnictwa,by="nazwa_prosta") %>%
  mutate(to_samo = wydawnictwo==WY_NAZWA) %>%
  arrange(ZA_UWAGI,-to_samo,-WY_LICZBA_ZAPISOW)
BN_wydawnictwo$id_grupy <- cumsum(!duplicated(BN_wydawnictwo[1:3]))
BN_wydawnictwo <- BN_wydawnictwo[!duplicated(BN_wydawnictwo$id_grupy),] %>%
  mutate(WY_NAZWA = ifelse(!is.na(WY_NAZWA),as.character(WY_NAZWA),as.character(wydawnictwo)),
         WY_MIASTO = ifelse(!is.na(WY_MIASTO),as.character(WY_MIASTO),as.character(miejsce_wydania)),
         rok_wydania = str_replace_all(rok_wydania, "(.*)(\\.)", "\\1"),
         za_rok_wydania = ifelse(nchar(rok_wydania)==4,as.character(rok_wydania),NA),
         do_opisu = ifelse(is.na(za_rok_wydania),paste("[",str_extract(rok_wydania,"\\d{4}"),"]",sep = ""),""),
         WY_MIASTO = ifelse(substr(WY_MIASTO,1,1)=="["&substr(WY_MIASTO,nchar(WY_MIASTO),nchar(WY_MIASTO))!="]"&is.na(WY_WYDAWNICTWO_ID),paste(trim(WY_MIASTO),"]",sep = ""),as.character(WY_MIASTO))) %>%
  select(ZA_UWAGI,WY_WYDAWNICTWO_ID,WY_NAZWA,WY_MIASTO,za_rok_wydania,do_opisu)

#11: opis fizyczny książki
#pole 300 do opisu fizycznego
marc_field_300 <- data %>%
  select(ZA_UWAGI,X300)%>%
  filter(X300!="") %>%
  mutate(X300=str_replace_all(X300,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X300",sep = "~",direction = "long") %>%
  filter(X300!="") %>%
  mutate(X300=str_remove_all(X300,"^\\|")) %>%
  mutate(indicator = str_replace_all(X300,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X300,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_300)[1]))
colnames(empty_table) <-subfield_list
marc_field_300<-cbind(marc_field_300,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_300$X300 <- str_replace(marc_field_300$X300,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_300[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_300$X300),str_replace_all(gsub(string,"\\3",marc_field_300$X300),"\\${2}.", "~"),NA)
}
marc_field_300 <- marc_field_300 %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"),
         `$b` = str_remove(`$b`," \\;+$| \\:+$"),
         `$e` = ifelse(grepl("CD-ROM|DVD|VCD|CD",`$e`)&grepl("\\+ dysk|płyt",`$e`),str_extract(`$e`,"(?<=\\+)(dysk|płyt.*?)(CD-ROM|DVD|VCD|CD)(\\)){0,1}"),
                       ifelse(grepl("CD-ROM|DVD|VCD|CD",`$e`),str_extract(`$e`,"(^.*?)(CD-ROM|DVD|VCD|CD)(\\)){0,1}"),NA)),
         `$a` = ifelse(is.na(`$a`),"",as.character(`$a`)),
         `$b` = ifelse(is.na(`$b`),"",as.character(`$b`)),
         `$e` = ifelse(is.na(`$e`),"",as.character(`$e`)))
#pole 500 do opisu fizycznego
marc_field_500 <- data %>%
  select(ZA_UWAGI,X500)%>%
  filter(X500!="") %>%
  mutate(X500=str_replace_all(X500,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X500",sep = "~",direction = "long") %>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"^\\|")) %>%
  mutate(indicator = str_replace_all(X500,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X500,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_500)[1]))
colnames(empty_table) <-subfield_list
marc_field_500<-cbind(marc_field_500,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_500$X500 <- str_replace(marc_field_500$X500,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_500[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_500$X500),str_replace_all(gsub(string,"\\3",marc_field_500$X500),"\\${2}.", "~"),NA)
}
marc_field_500 <- marc_field_500 %>%
  filter(!grepl("oryg(\\.|\\,)",X500)&grepl("pseud|nazwa|dotycz|pol",X500,ignore.case = TRUE)) %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"))
  
#pole 546 do opisu fizycznego
marc_field_546 <- data %>%
  select(ZA_UWAGI,X546)%>%
  filter(X546!="") %>%
  mutate(X546=str_replace_all(X546,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X546",sep = "~",direction = "long") %>%
  filter(X546!="") %>%
  mutate(X546=str_remove_all(X546,"^\\|")) %>%
  mutate(indicator = str_replace_all(X546,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X546,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_546)[1]))
colnames(empty_table) <-subfield_list
marc_field_546<-cbind(marc_field_546,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_546$X546 <- str_replace(marc_field_546$X546,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_546[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_546$X546),str_replace_all(gsub(string,"\\3",marc_field_546$X546),"\\${2}.", "~"),NA)
}
marc_field_546 <- marc_field_546 %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"))

za_opis_ks <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wydawnictwo %>% select(ZA_UWAGI,do_opisu),by="ZA_UWAGI") %>%
  left_join(.,marc_field_300 %>% select(ZA_UWAGI,X300a=`$a`,X300b=`$b`,X300e=`$e`),by="ZA_UWAGI") %>%
  left_join(.,marc_field_500 %>% select(ZA_UWAGI,X500a=`$a`),by="ZA_UWAGI") %>%
  left_join(.,marc_field_546 %>% select(ZA_UWAGI,X546a=`$a`),by="ZA_UWAGI")
za_opis_ks[is.na(za_opis_ks)]  <- ""
za_opis_ks <- za_opis_ks %>%
  mutate(za_opis_ks = paste(ifelse(do_opisu!="",paste(as.character(do_opisu),", ",sep = ""),""),ifelse(X300a!="",paste(as.character(X300a),", ",sep = ""),""),ifelse(X300b!="",paste(as.character(X300b),", ",sep = ""),""),ifelse(X300e!="",paste(as.character(X300e),", ",sep = ""),""),ifelse(X500a!="",paste(as.character(X500a),", ",sep = ""),""),ifelse(X546a!="",as.character(X546a),""),sep = ""),
         za_opis_ks = str_remove(za_opis_ks,"(, )+$")) %>%
  select(ZA_UWAGI,za_opis_ks) %>%
  unique() %>%
  arrange(ZA_UWAGI,-nchar(za_opis_ks))
za_opis_ks$id_grupy <- cumsum(!duplicated(za_opis_ks[1]))
za_opis_ks <- za_opis_ks[!duplicated(za_opis_ks$id_grupy),] %>%
  select(-id_grupy)

#12: seria wydawnicza
marc_field_490 <- data %>%
  select(ZA_UWAGI,X490,X800,X830) %>%
  mutate(X490 = ifelse(grepl("U\\+",X490),as.character(X830),as.character(X490))) %>%
  mutate(X800 = ifelse(X490!="","",as.character(X800)),
         X830 = ifelse(X490!="","",as.character(X830)),
         X800 = str_replace(X800,"(\\$a)(.*)(\\$t)","\\1"),
         X490 = ifelse(X490==""&X830!="",as.character(X830),
                       ifelse(X490==""&X800!="",as.character(X800),as.character(X490)))) %>%
  select(ZA_UWAGI,X490) %>%
  filter(X490!="") %>%
  mutate(X490=str_replace_all(X490,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X490",sep = "~",direction = "long") %>%
  filter(X490!="") %>%
  mutate(X490=str_remove_all(X490,"^\\|")) %>%
  mutate(indicator = str_replace_all(X490,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X490,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_490)[1]))
colnames(empty_table) <-subfield_list
marc_field_490<-cbind(marc_field_490,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_490$X490 <- str_replace(marc_field_490$X490,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_490[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_490$X490),str_replace_all(gsub(string,"\\3",marc_field_490$X490),"\\${2}.", "~"),NA)
}
za_seria_wydawnicza <- marc_field_490 %>%
  mutate(`$a` = str_replace_all(`$a`,"(=)(\\$a)","\\1 "),
         `$a` = str_remove(`$a`," \\;+$| \\:+$"),
         `$v` = ifelse(is.na(`$v`),"",as.character(`$v`))) %>%
  filter(!is.na(`$a`)) %>%
  mutate(seria = str_remove(paste("(",`$a`,"; ",`$v`,")",sep = ""),"; (?=\\)$)"),
         seria = gsub("( : )(.)",". \\U\\2",perl=TRUE,seria)) %>%
  select(ZA_UWAGI,seria) %>%
  group_by(ZA_UWAGI) %>%
  mutate(seria = paste(seria,collapse = " ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(seria = str_replace_all(seria,"\\$.","; ")) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#13: tomy
za_tomy <- data %>%
  select(ZA_UWAGI) %>%
  mutate(za_tomy = NA)

#14: adnotacje
za_adnotacje <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_autor %>% select(ZA_UWAGI,ZA_ADNOTACJE),by="ZA_UWAGI") %>%
  left_join(.,BN_wspoltworca %>% select(ZA_UWAGI,ZA_ADNOTACJE),by="ZA_UWAGI") %>%
  mutate(ZA_ADNOTACJE = paste(ifelse(is.na(ZA_ADNOTACJE.x),"",paste(as.character(ZA_ADNOTACJE.x),"# ",sep = "")),ifelse(is.na(ZA_ADNOTACJE.y),"",as.character(ZA_ADNOTACJE.y)),sep = ""),
         ZA_ADNOTACJE = str_remove(ZA_ADNOTACJE,"(# )+$")) %>%
  select(ZA_UWAGI,ZA_ADNOTACJE) %>%
  unique() %>%
  arrange(ZA_UWAGI,-nchar(ZA_ADNOTACJE))
za_adnotacje$id_grupy <- cumsum(!duplicated(za_adnotacje[1]))
za_adnotacje <- za_adnotacje[!duplicated(za_adnotacje$id_grupy),] %>%
  select(-id_grupy)

#15: BN_URL
BN_URL <- data %>%
  select(ZA_UWAGI,BN_URL)

#wyrównanie liczby wierszy do liczby wierszy obiektu data
BN_autor <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_autor %>% select(ZA_UWAGI,AM_AUTOR_ID,AM_NAZWISKO,AM_IMIE),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, AM_AUTOR_ID = paste(AM_AUTOR_ID, collapse="|"), AM_NAZWISKO = paste(AM_NAZWISKO, collapse="|"), AM_IMIE = paste(AM_IMIE, collapse="|"))
BN_wspoltworca <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wspoltworca %>% select(ZA_UWAGI,OS_OSOBA_ID,OS_NAZWISKO,OS_IMIE,fo_symbol),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, OS_OSOBA_ID = paste(OS_OSOBA_ID, collapse="|"), OS_NAZWISKO = paste(OS_NAZWISKO, collapse="|"), OS_IMIE = paste(OS_IMIE, collapse="|"), fo_symbol = paste(fo_symbol, collapse="|")) %>%
  mutate(fo_symbol = ifelse(fo_symbol=="NULL","NA",as.character(fo_symbol)))
BN_wydawnictwo <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wydawnictwo %>% select(ZA_UWAGI,WY_WYDAWNICTWO_ID,WY_NAZWA,WY_MIASTO,za_rok_wydania),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, WY_WYDAWNICTWO_ID = paste(WY_WYDAWNICTWO_ID, collapse="|"), WY_NAZWA = paste(WY_NAZWA, collapse="|"), WY_MIASTO = paste(WY_MIASTO, collapse="|"), za_rok_wydania = paste(unique(za_rok_wydania), collapse="|")) %>%
  mutate(za_rok_wydania = ifelse(za_rok_wydania=="NA","",as.integer(za_rok_wydania)))

#połączenie wszystkich elementów w jedną tabelę
kolejnosc <- c("ZA_UWAGI","RZ_NAZWA","ZA_RO_ROK","ZA_TYPE","RZ_RODZAJ_ID","DZ_NAZWA","DZ_DZIAL_ID","TW_TWORCA_ID","AM_AUTOR_ID","AM_NAZWISKO","AM_IMIE","ZA_TYTUL","ZA_TYTUL_ORYGINALU","ZA_JEZYK_ORYGINALU","OS_OSOBA_ID","OS_NAZWISKO","OS_IMIE","fo_symbol","za_opis_wspoltworcow","wydanie","za_tomy","instytucja","WY_WYDAWNICTWO_ID","WY_MIASTO","WY_NAZWA","za_rok_wydania","za_opis_ks","seria","TW_NAZWISKO","TW_IMIE","redaktor_dzialu","ZA_ADNOTACJE","BN_URL")
polaczone <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,pola_pbl,by = "ZA_UWAGI") %>%
  left_join(.,BN_autor,by = "ZA_UWAGI") %>%
  left_join(.,za_tytul,by = "ZA_UWAGI") %>%
  left_join(.,za_tytul_oryginalu,by = "ZA_UWAGI") %>%
  left_join(.,za_jezyk_oryginalu,by = "ZA_UWAGI") %>%
  left_join(.,BN_wspoltworca,by = "ZA_UWAGI") %>%
  left_join(.,za_opis_wspoltworcow,by = "ZA_UWAGI") %>%
  left_join(.,za_wydanie,by = "ZA_UWAGI") %>%
  left_join(.,za_instytucja,by = "ZA_UWAGI") %>%
  left_join(.,BN_wydawnictwo,by = "ZA_UWAGI") %>%
  left_join(.,za_opis_ks,by = "ZA_UWAGI") %>%
  left_join(.,za_seria_wydawnicza,by = "ZA_UWAGI") %>%
  left_join(.,za_tomy,by = "ZA_UWAGI") %>%
  left_join(.,za_adnotacje,by = "ZA_UWAGI") %>%
  left_join(.,BN_URL,by = "ZA_UWAGI") %>%
  select(noquote(kolejnosc))
colnames(polaczone) <- c("rekord_BN","rz_nazwa","za_ro_rok","za_type","rz_rodzaj_id","DZ_NAZWA","DZ_DZIAL_ID","tw_tworca_id","am_autor_id","am_nazwisko","am_imie","za_tytul","za_tytul_oryginalu","za_jezyk_oryginalu","os_osoba_id","os_nazwisko","os_imie","fo_symbol","za_opis_wspoltworcow","za_wydanie","za_tomy","za_instytucja","wy_wydawnictwo_id","wy_miejsce","wy_nazwa","za_rok_wydania","za_opis_fizyczny_ksiazki","za_seria_wydawnicza","tw_nazwisko","tw_imie","pracownik","za_adnotacje","BN_URL")

#zasygnalizowanie niepoprawnego kodowania
x <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("<U\\+(....)>",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)!=0,paste(polaczone$za_adnotacje,paste("UWAGA! Błąd kodowania w polu ",as.character(names(polaczone[i]))," Znajdź frazę \"???\" i zredaguj pole.",sep = ""),sep = "# "),paste("UWAGA! Błąd kodowania w polu ",as.character(names(polaczone[i]))," Znajdź frazę \"???\" i zredaguj pole.",sep = "")),as.character(polaczone$za_adnotacje))
  polaczone[,i] <- gsub("<U\\+(....)>", "???", polaczone[,i])
}
#zasygnalizowanie obecności znaku $ w którymś z pól
X <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("\\$",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano znak \"$\". Zredaguj treść pola.",sep = ""),paste(polaczone$za_adnotacje,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano znak \"$\". Zredaguj treść pola.",sep = ""),sep = "# ")),as.character(polaczone$za_adnotacje))
}
#zasygnalizowanie obecności frazy "character(0)" w którymś z pól
X <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("character\\(0\\)",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano frazę \"character(0)\". Zredaguj treść pola.",sep = ""),paste(polaczone$za_adnotacje,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano frazę \"character(0)\". Zredaguj treść pola.",sep = ""),sep = "# ")),as.character(polaczone$za_adnotacje))
}
#zasygnalizowanie obecności znaku # w opisie współtwórców
polaczone$za_adnotacje <- ifelse(grepl("\\#",polaczone$za_opis_wspoltworcow),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,"UWAGA! Ze względu na konflikt w opisie współtwórców wybierz właściwą wartość (strefa odpowiedzialności \"#\" współtwórcy z pola 700).",paste(polaczone$za_adnotacje,"UWAGA! Ze względu na konflikt w opisie współtwórców wybierz właściwą wartość (strefa odpowiedzialności # współtwórcy z pola 700).",sep = "# ")),as.character(polaczone$za_adnotacje))
#korekta automatycznego IOK
automatyczny_IOK <- polaczone %>%
  mutate(czy_tyt_oryg = (!grepl("polsk",DZ_NAZWA)&!is.na(za_tytul_oryginalu))|grepl("polsk",DZ_NAZWA)) %>%
  filter(za_adnotacje==""&am_nazwisko!="NA"&!grepl("pseud|nazw",za_opis_fizyczny_ksiazki)&!grepl("\\|",am_nazwisko)&czy_tyt_oryg==TRUE) %>%
  select(rekord_BN) %>%
  unique() %>%
  filter(rekord_BN %notin% data$ZA_UWAGI[data$czy_automatycznie=="nie"]) %>%
  mutate(automatyczny_import = "tak")

write.csv2(automatyczny_IOK, "C:/Users/Cezary/Desktop/imp_2009_automatyczne_podmiotowe.csv", row.names = F, na = '', fileEncoding = 'UTF-8')

out <- cSplit(polaczone, c("am_autor_id", "am_nazwisko", "am_imie","os_osoba_id","os_nazwisko", "os_imie", "fo_symbol","wy_wydawnictwo_id","wy_miejsce","wy_nazwa"),sep = "|",direction = "long") %>%
  unique()

out$rekord_BN <- ifelse(is.na(out$rekord_BN),'',as.character(out$rekord_BN))
out$rz_nazwa <- ifelse(is.na(out$rz_nazwa),'',as.character(out$rz_nazwa))
out$za_ro_rok <- ifelse(is.na(out$za_ro_rok),'',as.character(out$za_ro_rok))
out$za_type <- ifelse(is.na(out$za_type),'',as.character(out$za_type))
out$rz_rodzaj_id <- ifelse(is.na(out$rz_rodzaj_id),'',as.character(out$rz_rodzaj_id))
out$DZ_NAZWA <- ifelse(is.na(out$DZ_NAZWA),'',as.character(out$DZ_NAZWA))
out$DZ_DZIAL_ID <- ifelse(is.na(out$DZ_DZIAL_ID),'',as.character(out$DZ_DZIAL_ID))
out$tw_tworca_id <- ifelse(is.na(out$tw_tworca_id),'',as.character(out$tw_tworca_id))
out$am_autor_id <- ifelse(is.na(out$am_autor_id),'',as.character(out$am_autor_id))
out$am_nazwisko <- ifelse(is.na(out$am_nazwisko),'',as.character(out$am_nazwisko))
out$am_imie <- ifelse(is.na(out$am_imie),'',as.character(out$am_imie))
out$za_tytul <- ifelse(is.na(out$za_tytul),'',as.character(out$za_tytul))
out$za_tytul_oryginalu <- ifelse(is.na(out$za_tytul_oryginalu),'',as.character(out$za_tytul_oryginalu))
out$za_jezyk_oryginalu <- ifelse(is.na(out$za_jezyk_oryginalu),'',as.character(out$za_jezyk_oryginalu))
out$os_osoba_id <- ifelse(is.na(out$os_osoba_id),'',as.character(out$os_osoba_id))
out$os_nazwisko <- ifelse(is.na(out$os_nazwisko),'',as.character(out$os_nazwisko))
out$os_imie <- ifelse(is.na(out$os_imie),'',as.character(out$os_imie))
out$fo_symbol <- ifelse(is.na(out$fo_symbol),'',as.character(out$fo_symbol))
out$za_opis_wspoltworcow <- ifelse(is.na(out$za_opis_wspoltworcow),'',as.character(out$za_opis_wspoltworcow))
out$za_wydanie <- ifelse(is.na(out$za_wydanie),'',as.character(out$za_wydanie))
out$za_tomy <- ifelse(is.na(out$za_tomy),'',as.character(out$za_tomy))
out$za_instytucja <- ifelse(is.na(out$za_instytucja),'',as.character(out$za_instytucja))
out$wy_wydawnictwo_id <- ifelse(is.na(out$wy_wydawnictwo_id),'',as.character(out$wy_wydawnictwo_id))
out$wy_miejsce <- ifelse(is.na(out$wy_miejsce),'',as.character(out$wy_miejsce))
out$wy_nazwa <- ifelse(is.na(out$wy_nazwa),'',as.character(out$wy_nazwa))
out$za_rok_wydania <- ifelse(is.na(out$za_rok_wydania),'',as.character(out$za_rok_wydania))
out$za_opis_fizyczny_ksiazki <- ifelse(is.na(out$za_opis_fizyczny_ksiazki),'',as.character(out$za_opis_fizyczny_ksiazki))
out$za_seria_wydawnicza <- ifelse(is.na(out$za_seria_wydawnicza),'',as.character(out$za_seria_wydawnicza))
out$tw_nazwisko <- ifelse(is.na(out$tw_nazwisko),'',as.character(out$tw_nazwisko))
out$tw_imie <- ifelse(is.na(out$tw_imie),'',as.character(out$tw_imie))
out$pracownik <- ifelse(is.na(out$pracownik),'',as.character(out$pracownik))
out$za_adnotacje <- ifelse(is.na(out$za_adnotacje),'',as.character(out$za_adnotacje))
out$BN_URL <- ifelse(is.na(out$BN_URL),'',as.character(out$BN_URL))

out %$%  
    { rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,) & BN_URL==lag(BN_URL,)} %>% 
    as.numeric() %>% 
    {.} -> out$same
out$same[1] <- 0
out$dzielone <- paste(out$am_autor_id,out$am_nazwisko,out$am_imie,out$os_osoba_id,out$os_nazwisko,out$os_imie,out$fo_symbol,out$wy_wydawnictwo_id,out$wy_miejsce,out$wy_nazwa,sep = "")

out <- out %>%
  filter(!(same==1&dzielone=="")) %>%
  select(1:33)

out %$%  
    { rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,) & BN_URL==lag(BN_URL,)} %>% 
    as.numeric() %>% 
    {.} -> out$same

#ucięcie zbyt długich ciągów znaków, by weszły do oracle'a
dlugosci <- data.frame(pole = c("am_nazwisko", "am_imie", "za_tytul", "za_tytul_oryginalu", "za_jezyk_oryginalu", "os_nazwisko", "os_imie", "za_opis_wspoltworcow", "za_instytucja", "wy_miejsce", "wy_nazwa", "za_opis_fizyczny_ksiazki", "za_seria_wydawnicza", "tw_nazwisko", "tw_imie", "za_adnotacje"), liczba_znakow = c(50,40,500,500,100,50,40,500,255,40,255,1000,255,200,40,2000))
x <- match(dlugosci$pole,names(out))
for (i in x) {
  progress(match(i,x), max.value = length(x))
  dlugosc <- dlugosci$liczba_znakow[match(names(out[i]),dlugosci$pole)]
  out$za_adnotacje <- ifelse(dlugosc<nchar(as.character(out[,i]))&out$za_adnotacje!="",paste(out$za_adnotacje,paste("UWAGA! Pole ",as.character(names(out[i]))," było zbyt długie i zostało przycięte. Zredaguj treść pola.",sep = ""),sep = "# "),
                             ifelse(dlugosc<nchar(as.character(out[,i]))&out$za_adnotacje=="",paste("UWAGA! Pole ",as.character(names(out[i]))," było zbyt długie i zostało przycięte. Zredaguj treść pola.",sep = ""),as.character(out$za_adnotacje)))
  
  out[,i] <- ifelse(dlugosc<nchar(as.character(out[,i])),as.character(substr(out[,i],1,dlugosc)),as.character(out[,i]))
}

out$rekord_BN[out$same == 1] <- ""
out$rz_nazwa[out$same == 1] <- ""
out$za_ro_rok[out$same == 1] <- ""
out$za_type[out$same == 1] <- ""
out$rz_rodzaj_id[out$same == 1] <- ""
out$DZ_NAZWA[out$same == 1] <- ""
out$DZ_DZIAL_ID[out$same == 1] <- ""
out$tw_tworca_id[out$same == 1] <- ""
out$za_tytul[out$same == 1] <- ""
out$za_tytul_oryginalu[out$same == 1] <- ""
out$za_jezyk_oryginalu[out$same == 1] <- ""
out$za_opis_wspoltworcow[out$same == 1] <- ""
out$za_wydanie[out$same == 1] <- ""
out$za_tomy[out$same == 1] <- ""
out$za_instytucja[out$same == 1] <- ""
out$za_rok_wydania[out$same == 1] <- ""
out$za_opis_fizyczny_ksiazki[out$same == 1] <- ""
out$za_seria_wydawnicza[out$same == 1] <- ""
out$tw_nazwisko[out$same == 1] <- ""
out$tw_imie[out$same == 1] <- ""
out$pracownik[out$same == 1] <- ""
out$za_adnotacje[out$same == 1] <- ""
out$BN_URL[out$same == 1] <- ""

#przypisanie do automatycznego OK redaktora "automat"
out <- out %>%
  mutate(pracownik = ifelse(rekord_BN %in% automatyczny_IOK$rekord_BN,"AUTOMAT",as.character(pracownik))) %>%
  select(1:33)

#pętla zapisująca po ok. 2000 wierszy z uwzględnieniem kompletności rekordów bibliograficznych rozpisanych na kilka wierszy
out <- out %>%
  mutate(podzial = ifelse(rekord_BN!="",as.character(rekord_BN),NA)) %>%
  fill(podzial)
ile <- unique(out$podzial)
ile <- split(unique(ile), ceiling(seq_along(unique(ile))/1500))

x <- 1:length(ile)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  final <- out %>%
    filter(podzial %in% ile[[i]]) %>%
    select(-podzial)
  write.xlsx(final, paste("C:/Users/Cezary/Desktop/2009_podmiotowa_do_importu",i,".xlsx",sep = ""),sheetName = "gotowe")
}
```

```{r książki przedmiotowe}
data <- bn_ok %>%
  filter(rodzaj_ksiazki=="przedmiotowa") %>%
  mutate(redaktor_dzialu = paste(redaktor_dzialu,"_przedm",sep = ""))
#uwolnienie kolumn z danymi z bn i przetworzenie do PBL
#1: za_uwagi, rz_nazwa, za_ro_rok, za_type, rz_rodzaj_id, tw_tworca_id, tw_nazwisko, tw_imie, dz_dzial_id, dz_nazwa, redaktor_dzialu
pola_pbl <- data %>%
  select(ZA_UWAGI, RZ_NAZWA, ZA_RO_ROK = rok, RZ_RODZAJ_ID, TW_TWORCA_ID, TW_NAZWISKO, TW_IMIE, DZ_DZIAL_ID, DZ_NAZWA, redaktor_dzialu) %>%
  mutate(ZA_TYPE = "KS")
#2: autor
BN_autor <- data %>%
  select(X100,X245,ZA_UWAGI)
#pole 100
marc_field_100 <- BN_autor %>%
  select(ZA_UWAGI,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(BN_autor$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}

#pole 245
marc_field_245 <- BN_autor %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(BN_autor$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

BN_autor <- marc_field_100 %>%
  select(ZA_UWAGI,`$a`,`$b`) %>%
  unique() %>%
  mutate(`$a` = ifelse(!is.na(`$b`),paste(`$a`,`$b`,sep = " "),as.character(`$a`))) %>%
  mutate(`$a` = str_remove(`$a`,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)")) %>%
  unique() %>%
  mutate(AM_NAZWISKO = ifelse(grepl("\\|",`$a`), str_replace_all(str_remove_all(`$a`,","),"\\|",", "),
                              ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\1"),as.character(`$a`))),
         AM_IMIE = ifelse(grepl("\\|",`$a`),"*",
                          ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\3"),"*"))) %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE) %>%
  left_join(.,marc_field_245,by="ZA_UWAGI") %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE, X245c = `$c`)
  
x <- 1:lengths(BN_autor[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  BN_autor$czy_nazwisko[i] <- grepl(BN_autor$AM_NAZWISKO[i],BN_autor$X245c[i])
  BN_autor$czy_imie[i] <- grepl(BN_autor$AM_IMIE[i],BN_autor$X245c[i])
}

BN_autor <- BN_autor %>%
  mutate(ZA_ADNOTACJE = ifelse(czy_nazwisko==FALSE|czy_imie==FALSE,paste("UWAGA! Konflikt w danych osobowych w polach 100 i 245. Porównaj pole autor w formularzu z polem BN: ",X245c,sep = ""),NA)) %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE,ZA_ADNOTACJE) %>%
  mutate(nazwa = str_replace_all(str_to_lower(paste(AM_NAZWISKO,AM_IMIE, sep = "")), "\\W", "")) %>%
  left_join(.,PBL_autorzy %>% select(AM_AUTOR_ID,AM_KRYPTONIM,AM_LICZBA_ZAPISOW,nazwa) %>% filter(is.na(AM_KRYPTONIM)),by="nazwa") %>%
  arrange(ZA_UWAGI,AM_NAZWISKO,AM_IMIE,-AM_LICZBA_ZAPISOW)
BN_autor$id_grupy <- cumsum(!duplicated(BN_autor[1:3]))
BN_autor <- BN_autor[!duplicated(BN_autor$id_grupy),] %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE,ZA_ADNOTACJE,AM_AUTOR_ID)

#3: tytuł
#pole 245
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,`$a`,`$b`,`$n`,`$p`) %>%
  group_by(ZA_UWAGI) %>%
  mutate(`$a` = paste(ifelse(is.na(`$a`),"",as.character(`$a`)),collapse = " "),
         `$b` = paste(ifelse(is.na(`$b`),"",as.character(`$b`)),collapse = " "),
         `$n` = paste(ifelse(is.na(`$n`),"",as.character(`$n`)),collapse = " "),
         `$p` = paste(ifelse(is.na(`$p`),"",as.character(`$p`)),collapse = " ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(ZA_TYTUL = paste(`$a`,`$b`,`$n`,`$p`,sep = ""))

za_tytul <- marc_field_245 %>%
  mutate(ZA_TYTUL = paste(`$a`,`$b`,`$n`,`$p`,sep = " "),
         ZA_TYTUL = str_remove(ZA_TYTUL, "\\s+\\/\\s{0,}$"),
         ZA_TYTUL = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,ZA_TYTUL),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,ZA_TYTUL),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,ZA_TYTUL),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,ZA_TYTUL),as.character(ZA_TYTUL))))),
         ZA_TYTUL = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,ZA_TYTUL),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,ZA_TYTUL),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,ZA_TYTUL),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,ZA_TYTUL),as.character(ZA_TYTUL))))),
         ZA_TYTUL = str_replace_all(ZA_TYTUL,"\\.{3} \\.{3}","... "),
         ZA_TYTUL = str_replace_all(ZA_TYTUL," ; ",". ")) %>%
  select(ZA_UWAGI,ZA_TYTUL)

#4: tytuł oryginału
#pole 246
marc_field_246 <- data %>%
  select(ZA_UWAGI,X246)%>%
  filter(X246!="") %>%
  mutate(X246=str_remove_all(X246,"~"),
         X246=str_replace_all(X246,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X246",sep = "~",direction = "long") %>%
  filter(X246!="") %>%
  mutate(X246=str_remove_all(X246,"^\\|")) %>%
  mutate(indicator = str_replace_all(X246,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X246,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_246)[1]))
colnames(empty_table) <-subfield_list
marc_field_246<-cbind(marc_field_246,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_246$X246 <- str_replace(marc_field_246$X246,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_246[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_246$X246),str_replace_all(gsub(string,"\\3",marc_field_246$X246),"\\${2}.", "~"),NA)
}

marc_field_246 <- marc_field_246 %>%
  filter(grepl("oryg",X246)) %>%
  select(ZA_UWAGI,`$a`,`$b`,`$n`,`$p`) %>%
  group_by(ZA_UWAGI) %>%
  mutate(`$a` = paste(ifelse(is.na(`$a`),"",as.character(`$a`)),collapse = ", "),
         `$b` = paste(ifelse(is.na(`$b`),"",as.character(`$b`)),collapse = ""),
         `$n` = paste(ifelse(is.na(`$n`),"",as.character(`$n`)),collapse = ""),
         `$p` = paste(ifelse(is.na(`$p`),"",as.character(`$p`)),collapse = "")) %>%
  ungroup() %>%
  unique() %>%
  mutate(X246 = paste(`$a`,`$b`,`$n`,`$p`,sep = "")) %>%
  mutate(X246 = str_remove(X246, "\\s+\\/\\s{0,}$"),
         X246 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X246),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X246),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X246),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)","\\1.\\2\\U\\5",perl = TRUE,X246),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X246),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X246),as.character(X246))))),
         X246 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X246),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X246),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X246),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)","\\1.\\2\\U\\5",perl = TRUE,X246),
                                         ifelse(grepl("(\\W)( )(:|;)( ){0,1}(.)",X246),gsub("(\\W)( )(:|;)( ){0,1}(.)","\\1\\2\\U\\5",perl = TRUE,X246),as.character(X246))))),
         X246 = str_replace_all(X246,"\\.{3} \\.{3}","... ")) %>%
  select(ZA_UWAGI, X246)

#pole 500
marc_field_500 <- data %>%
  select(ZA_UWAGI,X500)%>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"~"),
         X500=str_replace_all(X500,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X500",sep = "~",direction = "long") %>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"^\\|")) %>%
  mutate(indicator = str_replace_all(X500,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X500,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_500)[1]))
colnames(empty_table) <-subfield_list
marc_field_500<-cbind(marc_field_500,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_500$X500 <- str_replace(marc_field_500$X500,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_500[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_500$X500),str_replace_all(gsub(string,"\\3",marc_field_500$X500),"\\${2}.", "~"),NA)
}
marc_field_500 <- marc_field_500 %>%
  filter(grepl("oryg\\.\\:",X500)) %>%
  mutate(X500 = str_remove(`$a`,"^Tyt\\. oryg\\.: |^Tyt\\, oryg\\.: |^.*?tyt\\. oryg\\.: "),
         X500 = str_remove(X500, "\\s+\\/\\s{0,}$"),
         X500 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X500),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X500),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X500),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,X500),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X500),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X500),as.character(X500))))),
         X500 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X500),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X500),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X500),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,X500),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X500),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X500),as.character(X500))))),
         X500 = str_replace_all(X500,"\\.{3} \\.{3}","... "),
         X500 = str_remove(X500, "\\.$"),
         X500 = str_remove(X500,"(,{0,1} {0,1})\\d{4}.*$|(, t|. T)yt. oryg. cyklu:")) %>%
  select(ZA_UWAGI,X500)
#tytuł oryginału
za_tytul_oryginalu <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,marc_field_246,by="ZA_UWAGI") %>%
  left_join(.,marc_field_500,by="ZA_UWAGI") %>%
  mutate(X500 = ifelse(is.na(X500),NA,
                       ifelse(grepl("oryg",X500),NA,as.character(X500))),
         X500 = ifelse(!is.na(X500)&grepl("\\. - ",X500),str_replace(X500,"(.*?)(\\. - .*$)","\\1"),as.character(X500)),
         X500 = ifelse(!is.na(X500)&grepl("Na książce pseud",X500),str_replace(X500,"(.*?)(\\. Na książce pseud.*$)","\\1"),as.character(X500)),
         X500 = ifelse(!is.na(X500)&grepl("Przekł\\. wg",X500),str_replace(X500,"(.*?)(\\. Przekł\\. wg.*$)","\\1"),as.character(X500)),
         ZA_TYTUL_ORYGINALU = ifelse(is.na(X246)&is.na(X500),NA,
                                     ifelse(!is.na(X500),as.character(X500),as.character(X246))),
         ZA_TYTUL_ORYGINALU = str_remove_all(ZA_TYTUL_ORYGINALU,'\\"')) %>%
  select(ZA_UWAGI,ZA_TYTUL_ORYGINALU)
#5: język oryginału
marc_field_041 <- data %>%
  select(ZA_UWAGI,X041)%>%
  filter(X041!="") %>%
  mutate(X041=str_replace_all(X041,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X041",sep = "~",direction = "long") %>%
  filter(X041!="") %>%
  mutate(X041=str_remove_all(X041,"^\\|")) %>%
  mutate(indicator = str_replace_all(X041,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X041,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_041)[1]))
colnames(empty_table) <-subfield_list
marc_field_041<-cbind(marc_field_041,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_041$X041 <- str_replace(marc_field_041$X041,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_041[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_041$X041),str_replace_all(gsub(string,"\\3",marc_field_041$X041),"\\${2}.", "~"),NA)
}
za_jezyk_oryginalu <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,marc_field_041 %>% select(ZA_UWAGI,ZA_JEZYK_ORYGINALU = `$a`),by="ZA_UWAGI") %>%
  mutate(ZA_JEZYK_ORYGINALU = str_replace_all(ZA_JEZYK_ORYGINALU,"\\$a",",")) %>%
  unique()

#6: współtwórcy
marc_field_700 <- data %>%
  select(ZA_UWAGI,X700)%>%
  filter(X700!="") %>%
  mutate(X700=str_replace_all(X700,"(..\\$a)","|\\1"),
         X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X700",sep = "~",direction = "long") %>%
  filter(X700!="") %>%
  mutate(X700=str_remove_all(X700,"^\\|")) %>%
  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1")) %>%
  filter(X700!="")
subfield_list<- str_extract_all(data$X700,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
colnames(empty_table) <-subfield_list
marc_field_700<-cbind(marc_field_700,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
}

BN_wspoltworca <- marc_field_700 %>%
  select(ZA_UWAGI,osoba = `$a`,funkcja = `$e`) %>%
  filter(!is.na(funkcja)) %>%
  mutate(osoba = str_remove(osoba,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)"),
         OS_NAZWISKO = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\1"),as.character(osoba)),
         OS_IMIE = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\3"),"*"),
         ws_prosty = str_replace_all(str_to_lower(osoba), "\\W", ""),
         fu_prosta = str_replace_all(str_to_lower(funkcja), "\\W", "")) %>%
  left_join(.,PBL_wspoltworcy %>% select(OS_OSOBA_ID,OS_LICZBA_ZAPISOW,nazwa_prosta),by=c("ws_prosty"="nazwa_prosta")) %>%
  arrange(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,-OS_LICZBA_ZAPISOW)
BN_wspoltworca$id_grupy <- cumsum(!duplicated(BN_wspoltworca[1:2]))
BN_wspoltworca <- BN_wspoltworca[!duplicated(BN_wspoltworca$id_grupy),] %>%
  left_join(.,PBL_funkcje,by=c("fu_prosta"="nazwa")) %>%
  mutate(fo_symbol = ifelse(fo_symbol=="NULL",NA,as.character(fo_symbol))) %>%
  select(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,OS_OSOBA_ID,fo_symbol,fo_nazwa,funkcja)

#tutaj przeszukać X245 i znaleźć błędy współtwórców
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}
marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,X245c=`$c`)

BN_wspoltworca <- BN_wspoltworca %>%
  left_join(.,marc_field_245,by="ZA_UWAGI")

x <- 1:lengths(BN_wspoltworca[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  BN_wspoltworca$czy_nazwisko[i] <- str_detect(BN_wspoltworca$X245c[i],BN_wspoltworca$OS_NAZWISKO[i])
  BN_wspoltworca$czy_imie[i] <- grepl(BN_wspoltworca$OS_IMIE[i],BN_wspoltworca$X245c[i])
}

BN_wspoltworca <- BN_wspoltworca %>%
  mutate(ZA_ADNOTACJE = ifelse(czy_nazwisko==FALSE|czy_imie==FALSE,paste("UWAGA! Konflikt w danych osobowych w polach 700 i 245. Porównaj pola współtórców w formularzu z polem BN: ",X245c,sep = ""),NA)) %>%
  select(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,OS_OSOBA_ID,fo_symbol,fo_nazwa,funkcja,ZA_ADNOTACJE)

#7: opis współtwórców
opis_wspoltworcow <- BN_wspoltworca %>%
  select(ZA_UWAGI,funkcja,OS_IMIE,OS_NAZWISKO) %>%
  full_join(.,marc_field_245,by="ZA_UWAGI") %>%
  filter(!is.na(OS_NAZWISKO)|(is.na(OS_NAZWISKO)&grepl("et al\\.",X245c))) %>%
  mutate(jest_et_al = grepl("et al\\.",X245c),
         OS_IMIE = ifelse(OS_IMIE=="*","",as.character(OS_IMIE)),
         opis = ifelse(!is.na(OS_NAZWISKO),paste(funkcja,OS_IMIE, OS_NAZWISKO, sep = " "),""),
         opis = str_replace_all(opis," +"," "),
         opis = ifelse(opis==" ","",as.character(opis))) %>%
  select(ZA_UWAGI,opis,jest_et_al) %>%
  group_by(ZA_UWAGI) %>%
  mutate(opis = paste(opis,collapse = ", "),
         jest_et_al = paste(unique(jest_et_al),sep = "")) %>%
  ungroup() %>%
  unique() %>%
  mutate(opis = ifelse(jest_et_al==TRUE&opis=="","et al.",
                       ifelse(jest_et_al,paste(opis,"et al.",sep = " "),opis))) %>%
  select(ZA_UWAGI,opis)

#700
marc_field_700 <- data %>%
  select(ZA_UWAGI,X700)%>%
  filter(X700!="") %>%
  mutate(X700=str_replace_all(X700,"(..\\$a)","|\\1"),
         X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X700",sep = "~",direction = "long") %>%
  filter(X700!="") %>%
  mutate(X700=str_remove_all(X700,"^\\|")) %>%
  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1")) %>%
  filter(X700!="")
subfield_list<- str_extract_all(data$X700,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
colnames(empty_table) <-subfield_list
marc_field_700<-cbind(marc_field_700,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
}
marc_field_700 <- marc_field_700 %>%
  select(ZA_UWAGI,osoba = `$a`,funkcja = `$e`) %>%
  filter(!is.na(funkcja)) %>%
  mutate(osoba = str_remove(osoba,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)"),
         OS_NAZWISKO = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\1"),as.character(osoba)),
         OS_IMIE = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\3"),"*"),
         funkcja_duza = str_to_lower(funkcja),
         opis = paste(funkcja_duza,OS_IMIE,OS_NAZWISKO, sep = " "),
         opis_duzy = paste(funkcja,OS_IMIE,OS_NAZWISKO, sep = " ")) %>%
  select(ZA_UWAGI,opis,opis_duzy) %>%
  group_by(ZA_UWAGI) %>%
  mutate(opis = paste(opis,collapse = ". "),
         opis_duzy = paste(opis_duzy,collapse = ". ")) %>%
  ungroup() %>%
  unique()

#opis współtwórców ze strefy odpowiedzialności 245
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}
marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,`$c`)

#porównanie opisu współtwórców z 245 i 700
wspoltworcy <- marc_field_700 %>%
  full_join(.,marc_field_245,by="ZA_UWAGI") %>%
  cSplit(.,"$c",sep = " ; ",direction = "long") %>%
  #ograniczanie osób ze strefy odpowiedzialności
  mutate(czy_mala = grepl(" [a-zęóąśłżźćń]|^[a-zęóąśłżźćń]|\\[[a-zęóąśłżźćń]",`$c`,ignore.case = FALSE)) %>%
  filter(czy_mala==TRUE) %>%
  select(-czy_mala) %>%
  #mutate(`$c` = gsub("^(\\[){0,1}([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])","\\1\\U\\2",perl = TRUE,`$c`)) %>%
  group_by(ZA_UWAGI) %>%
  mutate(X245 = paste(`$c`, collapse = ", ")) %>%
  select(-`$c`) %>%
  unique() %>%
  mutate(order_pbl = as.character(str_extract_all(opis,"(?<=^| |\\[|-)([A-ZAÁÀÂÃÄĂĀÅĄÆEÉÈÊËĚĒĖĘIÍÌÎÏĪĮIOÓÒÔÕÖŐØŒUÚÙÛÜŰŪůYÝCĆČçDĎĐĐGĢĞKĶLŁĻNŃÑŇŅŊRŘSŚŠŞSßTŤŦÞŢ8ZŻŹŽa-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])")),
         order_pbl = str_replace_all(order_pbl,"(.*?\")(.)(\".*?.)", "\\2"),
         order_bn = as.character(str_extract_all(X245,"(?<=^| |\\[|-)([A-ZAÁÀÂÃÄĂĀÅĄÆEÉÈÊËĚĒĖĘIÍÌÎÏĪĮIOÓÒÔÕÖŐØŒUÚÙÛÜŰŪůYÝCĆČçDĎĐĐGĢĞKĶLŁĻNŃÑŇŅŊRŘSŚŠŞSßTŤŦÞŢ8ZŻŹŽa-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])")),
         order_bn = str_replace_all(order_bn,"(.*?\")(.)(\".*?.)", "\\2"),
         X245 = str_remove(X245, "\\.$"),
         X245 = str_remove(X245, "\\["),
         X245 = str_remove(X245, "\\]"),
         order_pbl = str_remove_all(order_pbl, "[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]"),
         order_bn = str_remove_all(order_bn, "[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]"),
         to_samo = order_pbl==order_bn,
         X245 = gsub("(^[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(.*)","\\U\\1\\E\\2",perl = TRUE, X245)) %>%
  left_join(.,za_jezyk_oryginalu,by="ZA_UWAGI") %>%
  mutate(czy_pl = grepl("pol",ZA_JEZYK_ORYGINALU)|is.na(ZA_JEZYK_ORYGINALU),
         decyzja = ifelse(to_samo==FALSE|czy_pl==FALSE,FALSE,TRUE))

za_opis_wspoltworcow <- wspoltworcy %>%
  mutate(za_opis_wspoltworcow = ifelse(decyzja==TRUE,as.character(X245),paste(X245,opis_duzy,sep = "#"))) %>%
  select(ZA_UWAGI,opis_duzy,za_opis_wspoltworcow) %>%
  cSplit(.,"za_opis_wspoltworcow",sep = "#",direction = "wide") %>%
  mutate(za_opis_wspoltworcow_2 = ifelse(is.na(za_opis_wspoltworcow_2),'',as.character(za_opis_wspoltworcow_2)),
         to_samo = za_opis_wspoltworcow_1==za_opis_wspoltworcow_2) %>%
  filter(to_samo==FALSE) %>%
  group_by(ZA_UWAGI) %>%
  mutate(za_opis_wspoltworcow = paste(za_opis_wspoltworcow_1,za_opis_wspoltworcow_2,sep = "#"),
         za_opis_wspoltworcow = str_remove_all(za_opis_wspoltworcow,"\\#$")) %>%
  select(ZA_UWAGI,za_opis_wspoltworcow)

opis_wspoltworcow <- opis_wspoltworcow %>%
  filter(ZA_UWAGI %notin% za_opis_wspoltworcow$ZA_UWAGI) %>%
  filter(!is.na(opis)) %>%
  rename(za_opis_wspoltworcow = opis)

za_opis_wspoltworcow <- za_opis_wspoltworcow %>%
  bind_rows(.,opis_wspoltworcow) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#8 wydanie
marc_field_250 <- data %>%
  select(ZA_UWAGI,X250)%>%
  filter(X250!="") %>%
  mutate(X250=str_replace_all(X250,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X250",sep = "~",direction = "long") %>%
  filter(X250!="") %>%
  mutate(X250=str_remove_all(X250,"^\\|")) %>%
  mutate(indicator = str_replace_all(X250,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X250,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_250)[1]))
colnames(empty_table) <-subfield_list
marc_field_250<-cbind(marc_field_250,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_250$X250 <- str_replace(marc_field_250$X250,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_250[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_250$X250),str_replace_all(gsub(string,"\\3",marc_field_250$X250),"\\${2}.", "~"),NA)
}

za_wydanie <- marc_field_250 %>%
  select(ZA_UWAGI, wydanie = `$a`) %>%
  mutate(wydanie = str_remove(wydanie," \\/$")) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#9: instytucja sprawcza
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

za_instytucja <- marc_field_245 %>%
  select(ZA_UWAGI,X245c=`$c`) %>%
  filter(!is.na(X245c)) %>%
  mutate(instytucja = ifelse(grepl("\\;",X245c),str_replace_all(X245c, "(.*?)(\\;(?!.*\\;))( )+(.*?$)","\\4"),"")) %>%
  left_join(.,BN_wspoltworca,by="ZA_UWAGI")

x <- 1:lengths(za_instytucja[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  za_instytucja$czy_nazwisko[i] <- grepl(za_instytucja$OS_NAZWISKO[i],za_instytucja$X245c[i])
  za_instytucja$czy_imie[i] <- grepl(za_instytucja$OS_IMIE[i],za_instytucja$X245c[i])
}

za_instytucja <- za_instytucja %>%
  filter(is.na(czy_nazwisko)&is.na(czy_imie)) %>%
  filter(instytucja!="") %>%
  filter(!grepl("^\\[[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]|^[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]",instytucja)) %>%
  mutate(instytucja = str_remove(instytucja,"\\.$")) %>%
  select(ZA_UWAGI,instytucja) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#10: wydawnictwo
BN_wydawnictwo <- data %>%
  select(ZA_UWAGI, X260) %>%
  mutate(X260 = str_replace_all(X260,"s\\.n\\.", "b.w."), 
         X260 = str_replace_all(X260,"s\\.l\\.", "b.m."), 
         X260 = str_replace_all(X260,"S\\.l\\.", "b.m."), 
         X260 = str_remove(X260,"^\\\\+"), 
         rok_wydania = str_extract_all(X260, "(?<=\\$c).*(?=\\$e)|(?<=\\$c).*"), 
         bez_roku = str_replace_all(X260, ".\\$c.*", ""), 
         ile_wydawnictw = str_count(bez_roku, "\\$b"),
         ile_miejsc = str_count(bez_roku, "\\$a"),
         kolejnosc = str_replace_all(as.character(str_extract_all(bez_roku, "\\$.")), "[^a-z]", ""),
         bez_roku = str_replace_all(bez_roku, ";\\$b", ":$b"),
         wydaw_podziel = ifelse(ile_wydawnictw>ile_miejsc|kolejnosc=="caabb", str_replace_all(bez_roku, "(\\$a)(.*?)( :\\$b.*?)( :\\$b)", "\\1\\2\\3 ;$a\\2\\4"),bez_roku),
         wydawnictwo_test = str_replace_all(wydaw_podziel, "(\\$b)(.*?)( ;\\$a)", "\\1\\2|\\3")) %>%
  select(ZA_UWAGI,rok_wydania,wydawnictwo_test) %>%
  cSplit(., "wydawnictwo_test", sep = "|", direction = "long") %>%
  mutate(wydawnictwo = str_extract_all(wydawnictwo_test, "(?<=\\$b)(.*)"),
         miejsce_wydania = str_replace_all(str_extract_all(wydawnictwo_test, "(?<=\\$a)(.*)(?= {0,1}: {0,1}\\$b)|(?<=\\$a)(.*)($)")," ;\\$a", ", "),
         nazwa_prosta = str_to_lower(str_replace_all(str_replace_all(unlist(wydawnictwo_test), "\\$\\w", ""), "\\W", ""))) %>%
  left_join(.,PBL_wydawnictwa,by="nazwa_prosta") %>%
  mutate(to_samo = wydawnictwo==WY_NAZWA) %>%
  arrange(ZA_UWAGI,-to_samo,-WY_LICZBA_ZAPISOW)
BN_wydawnictwo$id_grupy <- cumsum(!duplicated(BN_wydawnictwo[1:3]))
BN_wydawnictwo <- BN_wydawnictwo[!duplicated(BN_wydawnictwo$id_grupy),] %>%
  mutate(WY_NAZWA = ifelse(!is.na(WY_NAZWA),as.character(WY_NAZWA),as.character(wydawnictwo)),
         WY_MIASTO = ifelse(!is.na(WY_MIASTO),as.character(WY_MIASTO),as.character(miejsce_wydania)),
         rok_wydania = str_replace_all(rok_wydania, "(.*)(\\.)", "\\1"),
         za_rok_wydania = ifelse(nchar(rok_wydania)==4,as.character(rok_wydania),NA),
         do_opisu = ifelse(is.na(za_rok_wydania),paste("[",str_extract(rok_wydania,"\\d{4}"),"]",sep = ""),""),
         WY_MIASTO = ifelse(substr(WY_MIASTO,1,1)=="["&substr(WY_MIASTO,nchar(WY_MIASTO),nchar(WY_MIASTO))!="]"&is.na(WY_WYDAWNICTWO_ID),paste(trim(WY_MIASTO),"]",sep = ""),as.character(WY_MIASTO))) %>%
  select(ZA_UWAGI,WY_WYDAWNICTWO_ID,WY_NAZWA,WY_MIASTO,za_rok_wydania,do_opisu)

#11: opis fizyczny książki
#pole 300 do opisu fizycznego
marc_field_300 <- data %>%
  select(ZA_UWAGI,X300)%>%
  filter(X300!="") %>%
  mutate(X300=str_replace_all(X300,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X300",sep = "~",direction = "long") %>%
  filter(X300!="") %>%
  mutate(X300=str_remove_all(X300,"^\\|")) %>%
  mutate(indicator = str_replace_all(X300,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X300,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_300)[1]))
colnames(empty_table) <-subfield_list
marc_field_300<-cbind(marc_field_300,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_300$X300 <- str_replace(marc_field_300$X300,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_300[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_300$X300),str_replace_all(gsub(string,"\\3",marc_field_300$X300),"\\${2}.", "~"),NA)
}
marc_field_300 <- marc_field_300 %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"),
         `$b` = str_remove(`$b`," \\;+$| \\:+$"),
         `$e` = ifelse(grepl("CD-ROM|DVD|VCD|CD",`$e`)&grepl("\\+ dysk|płyt",`$e`),str_extract(`$e`,"(?<=\\+)(dysk|płyt.*?)(CD-ROM|DVD|VCD|CD)(\\)){0,1}"),
                       ifelse(grepl("CD-ROM|DVD|VCD|CD",`$e`),str_extract(`$e`,"(^.*?)(CD-ROM|DVD|VCD|CD)(\\)){0,1}"),NA)),
         `$a` = ifelse(is.na(`$a`),"",as.character(`$a`)),
         `$b` = ifelse(is.na(`$b`),"",as.character(`$b`)),
         `$e` = ifelse(is.na(`$e`),"",as.character(`$e`)))
#pole 500 do opisu fizycznego
marc_field_500 <- data %>%
  select(ZA_UWAGI,X500)%>%
  filter(X500!="") %>%
  mutate(X500=str_replace_all(X500,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X500",sep = "~",direction = "long") %>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"^\\|")) %>%
  mutate(indicator = str_replace_all(X500,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X500,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_500)[1]))
colnames(empty_table) <-subfield_list
marc_field_500<-cbind(marc_field_500,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_500$X500 <- str_replace(marc_field_500$X500,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_500[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_500$X500),str_replace_all(gsub(string,"\\3",marc_field_500$X500),"\\${2}.", "~"),NA)
}
marc_field_500 <- marc_field_500 %>%
  filter(!grepl("oryg(\\.|\\,)",X500)&grepl("pseud|nazwa|dotycz|pol",X500,ignore.case = TRUE)) %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"))
  
#pole 546 do opisu fizycznego
marc_field_546 <- data %>%
  select(ZA_UWAGI,X546)%>%
  filter(X546!="") %>%
  mutate(X546=str_replace_all(X546,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X546",sep = "~",direction = "long") %>%
  filter(X546!="") %>%
  mutate(X546=str_remove_all(X546,"^\\|")) %>%
  mutate(indicator = str_replace_all(X546,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X546,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_546)[1]))
colnames(empty_table) <-subfield_list
marc_field_546<-cbind(marc_field_546,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_546$X546 <- str_replace(marc_field_546$X546,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_546[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_546$X546),str_replace_all(gsub(string,"\\3",marc_field_546$X546),"\\${2}.", "~"),NA)
}
marc_field_546 <- marc_field_546 %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"))

za_opis_ks <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wydawnictwo %>% select(ZA_UWAGI,do_opisu),by="ZA_UWAGI") %>%
  left_join(.,marc_field_300 %>% select(ZA_UWAGI,X300a=`$a`,X300b=`$b`,X300e=`$e`),by="ZA_UWAGI") %>%
  left_join(.,marc_field_500 %>% select(ZA_UWAGI,X500a=`$a`),by="ZA_UWAGI") %>%
  left_join(.,marc_field_546 %>% select(ZA_UWAGI,X546a=`$a`),by="ZA_UWAGI")
za_opis_ks[is.na(za_opis_ks)]  <- ""
za_opis_ks <- za_opis_ks %>%
  mutate(za_opis_ks = paste(ifelse(do_opisu!="",paste(as.character(do_opisu),", ",sep = ""),""),ifelse(X300a!="",paste(as.character(X300a),", ",sep = ""),""),ifelse(X300b!="",paste(as.character(X300b),", ",sep = ""),""),ifelse(X300e!="",paste(as.character(X300e),", ",sep = ""),""),ifelse(X500a!="",paste(as.character(X500a),", ",sep = ""),""),ifelse(X546a!="",as.character(X546a),""),sep = ""),
         za_opis_ks = str_remove(za_opis_ks,"(, )+$")) %>%
  select(ZA_UWAGI,za_opis_ks) %>%
  unique() %>%
  arrange(ZA_UWAGI,-nchar(za_opis_ks))
za_opis_ks$id_grupy <- cumsum(!duplicated(za_opis_ks[1]))
za_opis_ks <- za_opis_ks[!duplicated(za_opis_ks$id_grupy),] %>%
  select(-id_grupy)

#12: seria wydawnicza
marc_field_490 <- data %>%
  select(ZA_UWAGI,X490,X800,X830) %>%
  mutate(X490 = ifelse(grepl("U\\+",X490),as.character(X830),as.character(X490))) %>%
  mutate(X800 = ifelse(X490!="","",as.character(X800)),
         X830 = ifelse(X490!="","",as.character(X830)),
         X800 = str_replace(X800,"(\\$a)(.*)(\\$t)","\\1"),
         X490 = ifelse(X490==""&X830!="",as.character(X830),
                       ifelse(X490==""&X800!="",as.character(X800),as.character(X490)))) %>%
  select(ZA_UWAGI,X490) %>%
  filter(X490!="") %>%
  mutate(X490=str_replace_all(X490,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X490",sep = "~",direction = "long") %>%
  filter(X490!="") %>%
  mutate(X490=str_remove_all(X490,"^\\|")) %>%
  mutate(indicator = str_replace_all(X490,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X490,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_490)[1]))
colnames(empty_table) <-subfield_list
marc_field_490<-cbind(marc_field_490,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_490$X490 <- str_replace(marc_field_490$X490,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_490[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_490$X490),str_replace_all(gsub(string,"\\3",marc_field_490$X490),"\\${2}.", "~"),NA)
}
za_seria_wydawnicza <- marc_field_490 %>%
  mutate(`$a` = str_replace_all(`$a`,"(=)(\\$a)","\\1 "),
         `$a` = str_remove(`$a`," \\;+$| \\:+$"),
         `$v` = ifelse(is.na(`$v`),"",as.character(`$v`))) %>%
  filter(!is.na(`$a`)) %>%
  mutate(seria = str_remove(paste("(",`$a`,"; ",`$v`,")",sep = ""),"; (?=\\)$)"),
         seria = gsub("( : )(.)",". \\U\\2",perl=TRUE,seria)) %>%
  select(ZA_UWAGI,seria) %>%
  group_by(ZA_UWAGI) %>%
  mutate(seria = paste(seria,collapse = " ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(seria = str_replace_all(seria,"\\$.","; ")) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#13: tomy
za_tomy <- data %>%
  select(ZA_UWAGI) %>%
  mutate(za_tomy = NA)

#14: adnotacje
za_adnotacje <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_autor %>% select(ZA_UWAGI,ZA_ADNOTACJE),by="ZA_UWAGI") %>%
  left_join(.,BN_wspoltworca %>% select(ZA_UWAGI,ZA_ADNOTACJE),by="ZA_UWAGI") %>%
  mutate(ZA_ADNOTACJE = paste(ifelse(is.na(ZA_ADNOTACJE.x),"",paste(as.character(ZA_ADNOTACJE.x),"# ",sep = "")),ifelse(is.na(ZA_ADNOTACJE.y),"",as.character(ZA_ADNOTACJE.y)),sep = ""),
         ZA_ADNOTACJE = str_remove(ZA_ADNOTACJE,"(# )+$")) %>%
  select(ZA_UWAGI,ZA_ADNOTACJE) %>%
  unique() %>%
  arrange(ZA_UWAGI,-nchar(ZA_ADNOTACJE))
za_adnotacje$id_grupy <- cumsum(!duplicated(za_adnotacje[1]))
za_adnotacje <- za_adnotacje[!duplicated(za_adnotacje$id_grupy),] %>%
  select(-id_grupy)

#15: BN_URL
BN_URL <- data %>%
  select(ZA_UWAGI,BN_URL)

#wyrównanie liczby wierszy do liczby wierszy obiektu data
BN_autor <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_autor %>% select(ZA_UWAGI,AM_AUTOR_ID,AM_NAZWISKO,AM_IMIE),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, AM_AUTOR_ID = paste(AM_AUTOR_ID, collapse="|"), AM_NAZWISKO = paste(AM_NAZWISKO, collapse="|"), AM_IMIE = paste(AM_IMIE, collapse="|"))
BN_wspoltworca <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wspoltworca %>% select(ZA_UWAGI,OS_OSOBA_ID,OS_NAZWISKO,OS_IMIE,fo_symbol),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, OS_OSOBA_ID = paste(OS_OSOBA_ID, collapse="|"), OS_NAZWISKO = paste(OS_NAZWISKO, collapse="|"), OS_IMIE = paste(OS_IMIE, collapse="|"), fo_symbol = paste(fo_symbol, collapse="|")) %>%
  mutate(fo_symbol = ifelse(fo_symbol=="NULL","NA",as.character(fo_symbol)))
BN_wydawnictwo <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wydawnictwo %>% select(ZA_UWAGI,WY_WYDAWNICTWO_ID,WY_NAZWA,WY_MIASTO,za_rok_wydania),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, WY_WYDAWNICTWO_ID = paste(WY_WYDAWNICTWO_ID, collapse="|"), WY_NAZWA = paste(WY_NAZWA, collapse="|"), WY_MIASTO = paste(WY_MIASTO, collapse="|"), za_rok_wydania = paste(unique(za_rok_wydania), collapse="|")) %>%
  mutate(za_rok_wydania = ifelse(za_rok_wydania=="NA","",as.integer(za_rok_wydania)))

#połączenie wszystkich elementów w jedną tabelę
kolejnosc <- c("ZA_UWAGI","RZ_NAZWA","ZA_RO_ROK","ZA_TYPE","RZ_RODZAJ_ID","DZ_NAZWA","DZ_DZIAL_ID","TW_TWORCA_ID","AM_AUTOR_ID","AM_NAZWISKO","AM_IMIE","ZA_TYTUL","ZA_TYTUL_ORYGINALU","ZA_JEZYK_ORYGINALU","OS_OSOBA_ID","OS_NAZWISKO","OS_IMIE","fo_symbol","za_opis_wspoltworcow","wydanie","za_tomy","instytucja","WY_WYDAWNICTWO_ID","WY_MIASTO","WY_NAZWA","za_rok_wydania","za_opis_ks","seria","TW_NAZWISKO","TW_IMIE","redaktor_dzialu","ZA_ADNOTACJE","BN_URL")
polaczone <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,pola_pbl,by = "ZA_UWAGI") %>%
  left_join(.,BN_autor,by = "ZA_UWAGI") %>%
  left_join(.,za_tytul,by = "ZA_UWAGI") %>%
  left_join(.,za_tytul_oryginalu,by = "ZA_UWAGI") %>%
  left_join(.,za_jezyk_oryginalu,by = "ZA_UWAGI") %>%
  left_join(.,BN_wspoltworca,by = "ZA_UWAGI") %>%
  left_join(.,za_opis_wspoltworcow,by = "ZA_UWAGI") %>%
  left_join(.,za_wydanie,by = "ZA_UWAGI") %>%
  left_join(.,za_instytucja,by = "ZA_UWAGI") %>%
  left_join(.,BN_wydawnictwo,by = "ZA_UWAGI") %>%
  left_join(.,za_opis_ks,by = "ZA_UWAGI") %>%
  left_join(.,za_seria_wydawnicza,by = "ZA_UWAGI") %>%
  left_join(.,za_tomy,by = "ZA_UWAGI") %>%
  left_join(.,za_adnotacje,by = "ZA_UWAGI") %>%
  left_join(.,BN_URL,by = "ZA_UWAGI") %>%
  select(noquote(kolejnosc))
colnames(polaczone) <- c("rekord_BN","rz_nazwa","za_ro_rok","za_type","rz_rodzaj_id","DZ_NAZWA","DZ_DZIAL_ID","tw_tworca_id","am_autor_id","am_nazwisko","am_imie","za_tytul","za_tytul_oryginalu","za_jezyk_oryginalu","os_osoba_id","os_nazwisko","os_imie","fo_symbol","za_opis_wspoltworcow","za_wydanie","za_tomy","za_instytucja","wy_wydawnictwo_id","wy_miejsce","wy_nazwa","za_rok_wydania","za_opis_fizyczny_ksiazki","za_seria_wydawnicza","tw_nazwisko","tw_imie","pracownik","za_adnotacje","BN_URL")

#zasygnalizowanie niepoprawnego kodowania
x <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("<U\\+(....)>",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)!=0,paste(polaczone$za_adnotacje,paste("UWAGA! Błąd kodowania w polu ",as.character(names(polaczone[i]))," Znajdź frazę \"???\" i zredaguj pole",sep = ""),sep = "# "),paste("UWAGA! Błąd kodowania w polu ",as.character(names(polaczone[i]))," Znajdź frazę \"???\" i zredaguj pole",sep = "")),as.character(polaczone$za_adnotacje))
  polaczone[,i] <- gsub("<U\\+(....)>", "???", polaczone[,i])
}
#zasygnalizowanie obecności znaku $ w którymś z pól
X <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("\\$",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano znak \"$\". Zredaguj treść pola.",sep = ""),paste(polaczone$za_adnotacje,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano znak \"$\". Zredaguj treść pola.",sep = ""),sep = "# ")),as.character(polaczone$za_adnotacje))
}
#zasygnalizowanie obecności frazy "character(0)" w którymś z pól
X <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("character\\(0\\)",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano frazę \"character(0)\". Zredaguj treść pola.",sep = ""),paste(polaczone$za_adnotacje,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano frazę \"character(0)\". Zredaguj treść pola.",sep = ""),sep = "# ")),as.character(polaczone$za_adnotacje))
}
#zasygnalizowanie obecności znaku # w opisie współtwórców
polaczone$za_adnotacje <- ifelse(grepl("\\#",polaczone$za_opis_wspoltworcow),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,"UWAGA! Ze względu na konflikt w opisie współtwórców wybierz właściwą wartość (strefa odpowiedzialności \"#\" współtwórcy z pola 700)",paste(polaczone$za_adnotacje,"UWAGA! Ze względu na konflikt w opisie współtwórców wybierz właściwą wartość (strefa odpowiedzialności # współtwórcy z pola 700)",sep = "# ")),as.character(polaczone$za_adnotacje))
#korekta automatycznego IOK
automatyczny_IOK <- polaczone %>%
  mutate(czy_tyt_oryg = (!grepl("polsk",DZ_NAZWA)&!is.na(za_tytul_oryginalu))|grepl("polsk",DZ_NAZWA)) %>%
  filter(za_adnotacje==""&am_nazwisko!="NA"&!grepl("pseud|nazw",za_opis_fizyczny_ksiazki)&!grepl("\\|",am_nazwisko)&czy_tyt_oryg==TRUE) %>%
  select(rekord_BN) %>%
  unique() %>%
  filter(rekord_BN %notin% data$ZA_UWAGI[data$czy_automatycznie=="nie"]) %>%
  mutate(automatyczny_import = "tak")

write.csv2(automatyczny_IOK, "C:/Users/Cezary/Desktop/imp_2009_automatyczne_przedmiotowe.csv", row.names = F, na = '', fileEncoding = 'UTF-8')

out <- cSplit(polaczone, c("am_autor_id", "am_nazwisko", "am_imie","os_osoba_id","os_nazwisko", "os_imie", "fo_symbol","wy_wydawnictwo_id","wy_miejsce","wy_nazwa"),sep = "|",direction = "long") %>%
  unique()

out$rekord_BN <- ifelse(is.na(out$rekord_BN),'',as.character(out$rekord_BN))
out$rz_nazwa <- ifelse(is.na(out$rz_nazwa),'',as.character(out$rz_nazwa))
out$za_ro_rok <- ifelse(is.na(out$za_ro_rok),'',as.character(out$za_ro_rok))
out$za_type <- ifelse(is.na(out$za_type),'',as.character(out$za_type))
out$rz_rodzaj_id <- ifelse(is.na(out$rz_rodzaj_id),'',as.character(out$rz_rodzaj_id))
out$DZ_NAZWA <- ifelse(is.na(out$DZ_NAZWA),'',as.character(out$DZ_NAZWA))
out$DZ_DZIAL_ID <- ifelse(is.na(out$DZ_DZIAL_ID),'',as.character(out$DZ_DZIAL_ID))
out$tw_tworca_id <- ifelse(is.na(out$tw_tworca_id),'',as.character(out$tw_tworca_id))
out$am_autor_id <- ifelse(is.na(out$am_autor_id),'',as.character(out$am_autor_id))
out$am_nazwisko <- ifelse(is.na(out$am_nazwisko),'',as.character(out$am_nazwisko))
out$am_imie <- ifelse(is.na(out$am_imie),'',as.character(out$am_imie))
out$za_tytul <- ifelse(is.na(out$za_tytul),'',as.character(out$za_tytul))
out$za_tytul_oryginalu <- ifelse(is.na(out$za_tytul_oryginalu),'',as.character(out$za_tytul_oryginalu))
out$za_jezyk_oryginalu <- ifelse(is.na(out$za_jezyk_oryginalu),'',as.character(out$za_jezyk_oryginalu))
out$os_osoba_id <- ifelse(is.na(out$os_osoba_id),'',as.character(out$os_osoba_id))
out$os_nazwisko <- ifelse(is.na(out$os_nazwisko),'',as.character(out$os_nazwisko))
out$os_imie <- ifelse(is.na(out$os_imie),'',as.character(out$os_imie))
out$fo_symbol <- ifelse(is.na(out$fo_symbol),'',as.character(out$fo_symbol))
out$za_opis_wspoltworcow <- ifelse(is.na(out$za_opis_wspoltworcow),'',as.character(out$za_opis_wspoltworcow))
out$za_wydanie <- ifelse(is.na(out$za_wydanie),'',as.character(out$za_wydanie))
out$za_tomy <- ifelse(is.na(out$za_tomy),'',as.character(out$za_tomy))
out$za_instytucja <- ifelse(is.na(out$za_instytucja),'',as.character(out$za_instytucja))
out$wy_wydawnictwo_id <- ifelse(is.na(out$wy_wydawnictwo_id),'',as.character(out$wy_wydawnictwo_id))
out$wy_miejsce <- ifelse(is.na(out$wy_miejsce),'',as.character(out$wy_miejsce))
out$wy_nazwa <- ifelse(is.na(out$wy_nazwa),'',as.character(out$wy_nazwa))
out$za_rok_wydania <- ifelse(is.na(out$za_rok_wydania),'',as.character(out$za_rok_wydania))
out$za_opis_fizyczny_ksiazki <- ifelse(is.na(out$za_opis_fizyczny_ksiazki),'',as.character(out$za_opis_fizyczny_ksiazki))
out$za_seria_wydawnicza <- ifelse(is.na(out$za_seria_wydawnicza),'',as.character(out$za_seria_wydawnicza))
out$tw_nazwisko <- ifelse(is.na(out$tw_nazwisko),'',as.character(out$tw_nazwisko))
out$tw_imie <- ifelse(is.na(out$tw_imie),'',as.character(out$tw_imie))
out$pracownik <- ifelse(is.na(out$pracownik),'',as.character(out$pracownik))
out$za_adnotacje <- ifelse(is.na(out$za_adnotacje),'',as.character(out$za_adnotacje))
out$BN_URL <- ifelse(is.na(out$BN_URL),'',as.character(out$BN_URL))

out %$%  
    { rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,) & BN_URL==lag(BN_URL,)} %>% 
    as.numeric() %>% 
    {.} -> out$same
out$same[1] <- 0
out$dzielone <- paste(out$am_autor_id,out$am_nazwisko,out$am_imie,out$os_osoba_id,out$os_nazwisko,out$os_imie,out$fo_symbol,out$wy_wydawnictwo_id,out$wy_miejsce,out$wy_nazwa,sep = "")

out <- out %>%
  filter(!(same==1&dzielone=="")) %>%
  select(1:33)

out %$%  
    { rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,) & BN_URL==lag(BN_URL,)} %>% 
    as.numeric() %>% 
    {.} -> out$same

#ucięcie zbyt długich ciągów znaków, by weszły do oracle'a
dlugosci <- data.frame(pole = c("am_nazwisko", "am_imie", "za_tytul", "za_tytul_oryginalu", "za_jezyk_oryginalu", "os_nazwisko", "os_imie", "za_opis_wspoltworcow", "za_instytucja", "wy_miejsce", "wy_nazwa", "za_opis_fizyczny_ksiazki", "za_seria_wydawnicza", "tw_nazwisko", "tw_imie", "za_adnotacje"), liczba_znakow = c(50,40,500,500,100,50,40,500,255,40,255,1000,255,200,40,2000))
x <- match(dlugosci$pole,names(out))
for (i in x) {
  progress(match(i,x), max.value = length(x))
  dlugosc <- dlugosci$liczba_znakow[match(names(out[i]),dlugosci$pole)]
  out$za_adnotacje <- ifelse(dlugosc<nchar(as.character(out[,i]))&out$za_adnotacje!="",paste(out$za_adnotacje,paste("UWAGA! Pole ",as.character(names(out[i]))," było zbyt długie i zostało przycięte. Zredaguj treść pola.",sep = ""),sep = "# "),
                             ifelse(dlugosc<nchar(as.character(out[,i]))&out$za_adnotacje=="",paste("UWAGA! Pole ",as.character(names(out[i]))," było zbyt długie i zostało przycięte. Zredaguj treść pola.",sep = ""),as.character(out$za_adnotacje)))
  
  out[,i] <- ifelse(dlugosc<nchar(as.character(out[,i])),as.character(substr(out[,i],1,dlugosc)),as.character(out[,i]))
}

out$rekord_BN[out$same == 1] <- ""
out$rz_nazwa[out$same == 1] <- ""
out$za_ro_rok[out$same == 1] <- ""
out$za_type[out$same == 1] <- ""
out$rz_rodzaj_id[out$same == 1] <- ""
out$DZ_NAZWA[out$same == 1] <- ""
out$DZ_DZIAL_ID[out$same == 1] <- ""
out$tw_tworca_id[out$same == 1] <- ""
out$za_tytul[out$same == 1] <- ""
out$za_tytul_oryginalu[out$same == 1] <- ""
out$za_jezyk_oryginalu[out$same == 1] <- ""
out$za_opis_wspoltworcow[out$same == 1] <- ""
out$za_wydanie[out$same == 1] <- ""
out$za_tomy[out$same == 1] <- ""
out$za_instytucja[out$same == 1] <- ""
out$za_rok_wydania[out$same == 1] <- ""
out$za_opis_fizyczny_ksiazki[out$same == 1] <- ""
out$za_seria_wydawnicza[out$same == 1] <- ""
out$tw_nazwisko[out$same == 1] <- ""
out$tw_imie[out$same == 1] <- ""
out$pracownik[out$same == 1] <- ""
out$za_adnotacje[out$same == 1] <- ""
out$BN_URL[out$same == 1] <- ""

#przypisanie do automatycznego OK redaktora "automat"
out <- out %>%
  mutate(pracownik = ifelse(rekord_BN %in% automatyczny_IOK$rekord_BN,"AUTOMAT",as.character(pracownik))) %>%
  select(1:33)

#pętla zapisująca po ok. 2000 wierszy z uwzględnieniem kompletności rekordów bibliograficznych rozpisanych na kilka wierszy
out <- out %>%
  mutate(podzial = ifelse(rekord_BN!="",as.character(rekord_BN),NA)) %>%
  fill(podzial)
ile <- unique(out$podzial)
ile <- split(unique(ile), ceiling(seq_along(unique(ile))/1500))

x <- 1:length(ile)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  final <- out %>%
    filter(podzial %in% ile[[i]]) %>%
    select(-podzial)
  write.xlsx(final, paste("C:/Users/Cezary/Desktop/2009_przedmiotowa_do_importu",i,".xlsx",sep = ""),sheetName = "gotowe")
}
```

```{r książki antologie}
data <- bn_ok %>%
  filter(rodzaj_ksiazki=="antologia") %>%
  mutate(redaktor_dzialu = paste(redaktor_dzialu,"_ant",sep = ""))
#uwolnienie kolumn z danymi z bn i przetworzenie do PBL
#1: za_uwagi, rz_nazwa, za_ro_rok, za_type, rz_rodzaj_id, tw_tworca_id, tw_nazwisko, tw_imie, dz_dzial_id, dz_nazwa, redaktor_dzialu
pola_pbl <- data %>%
  select(ZA_UWAGI, RZ_NAZWA, ZA_RO_ROK = rok, RZ_RODZAJ_ID, TW_TWORCA_ID, TW_NAZWISKO, TW_IMIE, DZ_DZIAL_ID, DZ_NAZWA, redaktor_dzialu) %>%
  mutate(ZA_TYPE = "KS")
#2: autor
BN_autor <- data %>%
  select(ZA_UWAGI) %>%
  mutate(AM_AUTOR_ID = NA,
         AM_NAZWISKO = NA,
         AM_IMIE = NA)

#adnotacje z autorów
#w antologii adnotacja musi być wcześniej, żeby na górze było info o tekstach autorów

ZA_ADNOTACJE <- data %>%
  select(X100,X245,ZA_UWAGI)
#pole 100
marc_field_100 <- ZA_ADNOTACJE %>%
  select(ZA_UWAGI,X100)%>%
  filter(X100!="") %>%
  mutate(X100=str_replace_all(X100,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X100",sep = "~",direction = "long") %>%
  filter(X100!="") %>%
  mutate(X100=str_remove_all(X100,"^\\|")) %>%
  mutate(indicator = str_replace_all(X100,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(ZA_ADNOTACJE$X100,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_100)[1]))
colnames(empty_table) <-subfield_list
marc_field_100<-cbind(marc_field_100,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_100$X100 <- str_replace(marc_field_100$X100,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_100[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_100$X100),str_replace_all(gsub(string,"\\3",marc_field_100$X100),"\\${2}.", "~"),NA)
}

#tutaj może być błąd ze względu na brak kolumny $b, wtedy należy zmienić linię z selectem i zakomentować linię: mutate(`$a` = ifelse(!is.na(`$b`),paste(`$a`,`$b`,sep = " "),as.character(`$a`))) %>%
ZA_ADNOTACJE <- marc_field_100 %>%
  #select(ZA_UWAGI,`$a`,`$b`) %>%
  select(ZA_UWAGI,`$a`) %>%
  unique() %>%
  #mutate(`$a` = ifelse(!is.na(`$b`),paste(`$a`,`$b`,sep = " "),as.character(`$a`))) %>%
  mutate(`$a` = str_remove(`$a`,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)")) %>%
  unique() %>%
  mutate(AM_NAZWISKO = ifelse(grepl("\\|",`$a`), str_replace_all(str_remove_all(`$a`,","),"\\|",", "),
                              ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\1"),as.character(`$a`))),
         AM_IMIE = ifelse(grepl("\\|",`$a`),"*",
                          ifelse(grepl(",",`$a`),str_replace_all(`$a`,"(.*?)(, )(.*)","\\3"),"*"))) %>%
  select(ZA_UWAGI,AM_NAZWISKO,AM_IMIE) %>%
  unite("ZA_ADNOTACJE", AM_IMIE:AM_NAZWISKO, sep = " ") %>%
  group_by(ZA_UWAGI) %>%
  mutate(ZA_ADNOTACJE = paste("[Teksty aut.:]",paste(ZA_ADNOTACJE,collapse = ", "),sep = " ")) %>%
  ungroup() %>%
  unique() %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#3: tytuł
#pole 245
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,`$a`,`$b`,`$n`,`$p`) %>%
  group_by(ZA_UWAGI) %>%
  mutate(`$a` = paste(ifelse(is.na(`$a`),"",as.character(`$a`)),collapse = " "),
         `$b` = paste(ifelse(is.na(`$b`),"",as.character(`$b`)),collapse = " "),
         `$n` = paste(ifelse(is.na(`$n`),"",as.character(`$n`)),collapse = " "),
         `$p` = paste(ifelse(is.na(`$p`),"",as.character(`$p`)),collapse = " ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(ZA_TYTUL = paste(`$a`,`$b`,`$n`,`$p`,sep = ""))

marc_field_245 <- marc_field_245 %>%
  mutate(ZA_TYTUL = paste(`$a`,`$b`,`$n`,`$p`,sep = " "),
         ZA_TYTUL = str_remove(ZA_TYTUL, "\\s+\\/\\s{0,}$"),
         ZA_TYTUL = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,ZA_TYTUL),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,ZA_TYTUL),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,ZA_TYTUL),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,ZA_TYTUL),as.character(ZA_TYTUL))))),
         ZA_TYTUL = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,ZA_TYTUL),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,ZA_TYTUL),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",ZA_TYTUL),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,ZA_TYTUL),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",ZA_TYTUL),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,ZA_TYTUL),as.character(ZA_TYTUL))))),
         ZA_TYTUL = str_replace_all(ZA_TYTUL,"\\.{3} \\.{3}","... "),
         ZA_TYTUL = str_replace_all(ZA_TYTUL," ; ",". ")) %>%
  select(ZA_UWAGI,ZA_TYTUL)
#dopisanie gatunku do przedmiotowej na podstawie 655 i 650  
gatunki_pbl <- data.frame(gatunek = c("aforyzm", "album", "antologia", "autobiografia", "dziennik", "esej", "felieton", "inne", "kazanie", "list", "miniatura prozą", "opowiadanie", "poemat", "powieść", "proza", "proza poetycka", "reportaż", "rozmyślanie religijne", "rysunek, obraz", "scenariusz", "szkic", "tekst biblijny", "tekst dramatyczny", "dramat", "wiersz", "wspomnienia", "wypowiedź", "pamiętniki", "poezja", "literatura podróżnicza", "satyra", "piosenka"))

#dramat, pamiętniki, poezja, literatura podróżnicza, satyra, piosenka
gatunki_bn <- data %>%
  select(ZA_UWAGI,X655,X650)

gatunki_bn <- sqldf("select *
                    from gatunki_bn
                    left join gatunki_pbl on lower(gatunki_bn.X655) like '%'||gatunki_pbl.gatunek||'%'")
gatunki_bn <- sqldf("select *
                      from gatunki_bn
                      left join gatunki_pbl on lower(gatunki_bn.X650) like '%'||gatunki_pbl.gatunek||'%'")
colnames(gatunki_bn)[5] <- "gatunek2"
gatunki_bn <- gatunki_bn %>%
  mutate(gatunek = ifelse(is.na(gatunek)&!is.na(gatunek2),as.character(gatunek2),as.character(gatunek))) %>%
  filter(!is.na(gatunek)) %>%
  select(ZA_UWAGI,gatunek) %>%
  mutate(gatunek = ifelse(gatunek=="dramat","tekst dramatyczny",
                          ifelse(gatunek=="pamiętniki","wspomnienia",
                                 ifelse(gatunek=="poezja","wiersz",
                                        ifelse(gatunek=="literatura podróżnicza","reportaż",
                                               ifelse(gatunek=="piosenka","wiersz",as.character(gatunek))))))) %>%
  group_by(ZA_UWAGI) %>%
  mutate(gatunek = paste(gatunek,collapse = ", ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(gatunek = gsub("(^.)","\\U\\1",perl = TRUE, gatunek))
#połączenie tytułu z gatunkiem
za_tytul <- marc_field_245 %>%
  left_join(.,gatunki_bn,by="ZA_UWAGI") %>%
  mutate(ZA_TYTUL = ifelse(!is.na(gatunek)&substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))==".",paste(ZA_TYTUL," [",gatunek,"]",sep = ""),
                           ifelse(!is.na(gatunek)&substr(ZA_TYTUL,nchar(ZA_TYTUL),nchar(ZA_TYTUL))!=".",paste(ZA_TYTUL,". [",gatunek,"]",sep = ""),as.character(ZA_TYTUL)))) %>%
  select(ZA_UWAGI,ZA_TYTUL)
#4: tytuł oryginału
#pole 246
marc_field_246 <- data %>%
  select(ZA_UWAGI,X246)%>%
  filter(X246!="") %>%
  mutate(X246=str_remove_all(X246,"~"),
         X246=str_replace_all(X246,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X246",sep = "~",direction = "long") %>%
  filter(X246!="") %>%
  mutate(X246=str_remove_all(X246,"^\\|")) %>%
  mutate(indicator = str_replace_all(X246,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X246,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_246)[1]))
colnames(empty_table) <-subfield_list
marc_field_246<-cbind(marc_field_246,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_246$X246 <- str_replace(marc_field_246$X246,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_246[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_246$X246),str_replace_all(gsub(string,"\\3",marc_field_246$X246),"\\${2}.", "~"),NA)
}

marc_field_246 <- marc_field_246 %>%
  filter(grepl("oryg",X246)) %>%
  select(ZA_UWAGI,`$a`,`$b`,`$n`,`$p`) %>%
  group_by(ZA_UWAGI) %>%
  mutate(`$a` = paste(ifelse(is.na(`$a`),"",as.character(`$a`)),collapse = ", "),
         `$b` = paste(ifelse(is.na(`$b`),"",as.character(`$b`)),collapse = ""),
         `$n` = paste(ifelse(is.na(`$n`),"",as.character(`$n`)),collapse = ""),
         `$p` = paste(ifelse(is.na(`$p`),"",as.character(`$p`)),collapse = "")) %>%
  ungroup() %>%
  unique() %>%
  mutate(X246 = paste(`$a`,`$b`,`$n`,`$p`,sep = "")) %>%
  mutate(X246 = str_remove(X246, "\\s+\\/\\s{0,}$"),
         X246 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X246),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X246),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X246),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)","\\1.\\2\\U\\5",perl = TRUE,X246),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X246),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X246),as.character(X246))))),
         X246 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X246),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X246),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X246),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)",X246),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( ){0,1}(.)","\\1.\\2\\U\\5",perl = TRUE,X246),
                                         ifelse(grepl("(\\W)( )(:|;)( ){0,1}(.)",X246),gsub("(\\W)( )(:|;)( ){0,1}(.)","\\1\\2\\U\\5",perl = TRUE,X246),as.character(X246))))),
         X246 = str_replace_all(X246,"\\.{3} \\.{3}","... ")) %>%
  select(ZA_UWAGI, X246)

#pole 500
marc_field_500 <- data %>%
  select(ZA_UWAGI,X500)%>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"~"),
         X500=str_replace_all(X500,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X500",sep = "~",direction = "long") %>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"^\\|")) %>%
  mutate(indicator = str_replace_all(X500,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X500,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_500)[1]))
colnames(empty_table) <-subfield_list
marc_field_500<-cbind(marc_field_500,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_500$X500 <- str_replace(marc_field_500$X500,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_500[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_500$X500),str_replace_all(gsub(string,"\\3",marc_field_500$X500),"\\${2}.", "~"),NA)
}
marc_field_500 <- marc_field_500 %>%
  filter(grepl("oryg\\.\\:",X500)) %>%
  mutate(X500 = str_remove(`$a`,"^Tyt\\. oryg\\.: |^Tyt\\, oryg\\.: |^.*?tyt\\. oryg\\.: "),
         X500 = str_remove(X500, "\\s+\\/\\s{0,}$"),
         X500 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X500),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X500),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X500),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,X500),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X500),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X500),as.character(X500))))),
         X500 = ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(\\(|\\[)(.)","\\1.\\2\\5\\U\\6",perl=TRUE,X500),
                           ifelse(grepl("(\\W)( )(:|;)( )(\\(|\\[)(.)",X500),gsub("(\\W)( )(:|;)( )(\\(|\\[)(.)","\\1\\2\\U\\5\\6",perl = TRUE,X500),
                                  ifelse(grepl("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)",X500),gsub("([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźžIVX])( )(:|;)( )(.)","\\1.\\2\\U\\5",perl = TRUE,X500),
                                         ifelse(grepl("(\\W)( )(:|;)( )(.)",X500),gsub("(\\W)( )(:|;)( )(.)","\\1\\2\\U\\5",perl = TRUE,X500),as.character(X500))))),
         X500 = str_replace_all(X500,"\\.{3} \\.{3}","... "),
         X500 = str_remove(X500, "\\.$"),
         X500 = str_remove(X500,"(,{0,1} {0,1})\\d{4}.*$|(, t|. T)yt. oryg. cyklu:")) %>%
  select(ZA_UWAGI,X500)
#tytuł oryginału
za_tytul_oryginalu <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,marc_field_246,by="ZA_UWAGI") %>%
  left_join(.,marc_field_500,by="ZA_UWAGI") %>%
  mutate(X500 = ifelse(is.na(X500),NA,
                       ifelse(grepl("oryg",X500),NA,as.character(X500))),
         X500 = ifelse(!is.na(X500)&grepl("\\. - ",X500),str_replace(X500,"(.*?)(\\. - .*$)","\\1"),as.character(X500)),
         X500 = ifelse(!is.na(X500)&grepl("Na książce pseud",X500),str_replace(X500,"(.*?)(\\. Na książce pseud.*$)","\\1"),as.character(X500)),
         X500 = ifelse(!is.na(X500)&grepl("Przekł\\. wg",X500),str_replace(X500,"(.*?)(\\. Przekł\\. wg.*$)","\\1"),as.character(X500)),
         ZA_TYTUL_ORYGINALU = ifelse(is.na(X246)&is.na(X500),NA,
                                     ifelse(!is.na(X500),as.character(X500),as.character(X246))),
         ZA_TYTUL_ORYGINALU = str_remove_all(ZA_TYTUL_ORYGINALU,'\\"')) %>%
  select(ZA_UWAGI,ZA_TYTUL_ORYGINALU)

#5: język oryginału
marc_field_041 <- data %>%
  select(ZA_UWAGI,X041)%>%
  filter(X041!="") %>%
  mutate(X041=str_replace_all(X041,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X041",sep = "~",direction = "long") %>%
  filter(X041!="") %>%
  mutate(X041=str_remove_all(X041,"^\\|")) %>%
  mutate(indicator = str_replace_all(X041,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X041,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_041)[1]))
colnames(empty_table) <-subfield_list
marc_field_041<-cbind(marc_field_041,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_041$X041 <- str_replace(marc_field_041$X041,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_041[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_041$X041),str_replace_all(gsub(string,"\\3",marc_field_041$X041),"\\${2}.", "~"),NA)
}
za_jezyk_oryginalu <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,marc_field_041 %>% select(ZA_UWAGI,ZA_JEZYK_ORYGINALU = `$a`),by="ZA_UWAGI") %>%
  mutate(ZA_JEZYK_ORYGINALU = str_replace_all(ZA_JEZYK_ORYGINALU,"\\$a",",")) %>%
  unique()

#6: współtwórcy
marc_field_700 <- data %>%
  select(ZA_UWAGI,X700)%>%
  filter(X700!="") %>%
  mutate(X700=str_replace_all(X700,"(..\\$a)","|\\1"),
         X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X700",sep = "~",direction = "long") %>%
  filter(X700!="") %>%
  mutate(X700=str_remove_all(X700,"^\\|")) %>%
  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1")) %>%
  filter(X700!="")
subfield_list<- str_extract_all(data$X700,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
colnames(empty_table) <-subfield_list
marc_field_700<-cbind(marc_field_700,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
}

BN_wspoltworca <- marc_field_700 %>%
  select(ZA_UWAGI,osoba = `$a`,funkcja = `$e`) %>%
  filter(!is.na(funkcja)) %>%
  mutate(osoba = str_remove(osoba,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)"),
         OS_NAZWISKO = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\1"),as.character(osoba)),
         OS_IMIE = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\3"),"*"),
         ws_prosty = str_replace_all(str_to_lower(osoba), "\\W", ""),
         fu_prosta = str_replace_all(str_to_lower(funkcja), "\\W", "")) %>%
  left_join(.,PBL_wspoltworcy %>% select(OS_OSOBA_ID,OS_LICZBA_ZAPISOW,nazwa_prosta),by=c("ws_prosty"="nazwa_prosta")) %>%
  arrange(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,-OS_LICZBA_ZAPISOW)
BN_wspoltworca$id_grupy <- cumsum(!duplicated(BN_wspoltworca[1:2]))
BN_wspoltworca <- BN_wspoltworca[!duplicated(BN_wspoltworca$id_grupy),] %>%
  left_join(.,PBL_funkcje,by=c("fu_prosta"="nazwa")) %>%
  mutate(fo_symbol = ifelse(fo_symbol=="NULL",NA,as.character(fo_symbol))) %>%
  select(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,OS_OSOBA_ID,fo_symbol,fo_nazwa,funkcja)

#tutaj przeszukać X245 i znaleźć błędy współtwórców
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}
marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,X245c=`$c`)

BN_wspoltworca <- BN_wspoltworca %>%
  left_join(.,marc_field_245,by="ZA_UWAGI")

x <- 1:lengths(BN_wspoltworca[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  BN_wspoltworca$czy_nazwisko[i] <- str_detect(BN_wspoltworca$X245c[i],BN_wspoltworca$OS_NAZWISKO[i])
  BN_wspoltworca$czy_imie[i] <- grepl(BN_wspoltworca$OS_IMIE[i],BN_wspoltworca$X245c[i])
}

BN_wspoltworca <- BN_wspoltworca %>%
  mutate(ZA_ADNOTACJE = ifelse(czy_nazwisko==FALSE|czy_imie==FALSE,paste("UWAGA! Konflikt w danych osobowych w polach 700 i 245. Porównaj pola współtórców w formularzu z polem BN: ",X245c,sep = ""),NA)) %>%
  select(ZA_UWAGI,OS_NAZWISKO,OS_IMIE,OS_OSOBA_ID,fo_symbol,fo_nazwa,funkcja,ZA_ADNOTACJE)

#7: opis współtwórców
opis_wspoltworcow <- BN_wspoltworca %>%
  select(ZA_UWAGI,funkcja,OS_IMIE,OS_NAZWISKO) %>%
  full_join(.,marc_field_245,by="ZA_UWAGI") %>%
  filter(!is.na(OS_NAZWISKO)|(is.na(OS_NAZWISKO)&grepl("et al\\.",X245c))) %>%
  mutate(jest_et_al = grepl("et al\\.",X245c),
         OS_IMIE = ifelse(OS_IMIE=="*","",as.character(OS_IMIE)),
         opis = ifelse(!is.na(OS_NAZWISKO),paste(funkcja,OS_IMIE, OS_NAZWISKO, sep = " "),""),
         opis = str_replace_all(opis," +"," "),
         opis = ifelse(opis==" ","",as.character(opis))) %>%
  select(ZA_UWAGI,opis,jest_et_al) %>%
  group_by(ZA_UWAGI) %>%
  mutate(opis = paste(opis,collapse = ", "),
         jest_et_al = paste(unique(jest_et_al),sep = "")) %>%
  ungroup() %>%
  unique() %>%
  mutate(opis = ifelse(jest_et_al==TRUE&opis=="","et al.",
                       ifelse(jest_et_al,paste(opis,"et al.",sep = " "),opis))) %>%
  select(ZA_UWAGI,opis)

#700
marc_field_700 <- data %>%
  select(ZA_UWAGI,X700)%>%
  filter(X700!="") %>%
  mutate(X700=str_replace_all(X700,"(..\\$a)","|\\1"),
         X700=str_replace_all(X700,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X700",sep = "~",direction = "long") %>%
  filter(X700!="") %>%
  mutate(X700=str_remove_all(X700,"^\\|")) %>%
  mutate(indicator = str_replace_all(X700,"(^.*?)(\\$.*)","\\1")) %>%
  filter(X700!="")
subfield_list<- str_extract_all(data$X700,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_700)[1]))
colnames(empty_table) <-subfield_list
marc_field_700<-cbind(marc_field_700,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_700$X700 <- str_replace(marc_field_700$X700,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_700[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_700$X700),str_replace_all(gsub(string,"\\3",marc_field_700$X700),"\\${2}.", "~"),NA)
}
marc_field_700 <- marc_field_700 %>%
  select(ZA_UWAGI,osoba = `$a`,funkcja = `$e`) %>%
  filter(!is.na(funkcja)) %>%
  mutate(osoba = str_remove(osoba,"(?<=[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(\\.$)"),
         OS_NAZWISKO = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\1"),as.character(osoba)),
         OS_IMIE = ifelse(grepl(",",osoba),str_replace_all(osoba,"(.*?)(, )(.*)","\\3"),"*"),
         funkcja_duza = str_to_lower(funkcja),
         opis = paste(funkcja_duza,OS_IMIE,OS_NAZWISKO, sep = " "),
         opis_duzy = paste(funkcja,OS_IMIE,OS_NAZWISKO, sep = " ")) %>%
  select(ZA_UWAGI,opis,opis_duzy) %>%
  group_by(ZA_UWAGI) %>%
  mutate(opis = paste(opis,collapse = ". "),
         opis_duzy = paste(opis_duzy,collapse = ". ")) %>%
  ungroup() %>%
  unique()

#opis współtwórców ze strefy odpowiedzialności 245
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}
marc_field_245 <- marc_field_245 %>%
  select(ZA_UWAGI,`$c`)

#porównanie opisu współtwórców z 245 i 700
wspoltworcy <- marc_field_700 %>%
  full_join(.,marc_field_245,by="ZA_UWAGI") %>%
  cSplit(.,"$c",sep = " ; ",direction = "long") %>%
  #ograniczanie osób ze strefy odpowiedzialności
  mutate(czy_mala = grepl(" [a-zęóąśłżźćń]|^[a-zęóąśłżźćń]|\\[[a-zęóąśłżźćń]",`$c`,ignore.case = FALSE)) %>%
  filter(czy_mala==TRUE) %>%
  select(-czy_mala) %>%
  #mutate(`$c` = gsub("^(\\[){0,1}([a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])","\\1\\U\\2",perl = TRUE,`$c`)) %>%
  group_by(ZA_UWAGI) %>%
  mutate(X245 = paste(`$c`, collapse = ", ")) %>%
  select(-`$c`) %>%
  unique() %>%
  mutate(order_pbl = as.character(str_extract_all(opis,"(?<=^| |\\[|-)([A-ZAÁÀÂÃÄĂĀÅĄÆEÉÈÊËĚĒĖĘIÍÌÎÏĪĮIOÓÒÔÕÖŐØŒUÚÙÛÜŰŪůYÝCĆČçDĎĐĐGĢĞKĶLŁĻNŃÑŇŅŊRŘSŚŠŞSßTŤŦÞŢ8ZŻŹŽa-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])")),
         order_pbl = str_replace_all(order_pbl,"(.*?\")(.)(\".*?.)", "\\2"),
         order_bn = as.character(str_extract_all(X245,"(?<=^| |\\[|-)([A-ZAÁÀÂÃÄĂĀÅĄÆEÉÈÊËĚĒĖĘIÍÌÎÏĪĮIOÓÒÔÕÖŐØŒUÚÙÛÜŰŪůYÝCĆČçDĎĐĐGĢĞKĶLŁĻNŃÑŇŅŊRŘSŚŠŞSßTŤŦÞŢ8ZŻŹŽa-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])")),
         order_bn = str_replace_all(order_bn,"(.*?\")(.)(\".*?.)", "\\2"),
         X245 = str_remove(X245, "\\.$"),
         X245 = str_remove(X245, "\\["),
         X245 = str_remove(X245, "\\]"),
         order_pbl = str_remove_all(order_pbl, "[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]"),
         order_bn = str_remove_all(order_bn, "[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]"),
         to_samo = order_pbl==order_bn,
         X245 = gsub("(^[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž])(.*)","\\U\\1\\E\\2",perl = TRUE, X245)) %>%
  left_join(.,za_jezyk_oryginalu,by="ZA_UWAGI") %>%
  mutate(czy_pl = grepl("pol",ZA_JEZYK_ORYGINALU)|is.na(ZA_JEZYK_ORYGINALU),
         decyzja = ifelse(to_samo==FALSE|czy_pl==FALSE,FALSE,TRUE))

za_opis_wspoltworcow <- wspoltworcy %>%
  mutate(za_opis_wspoltworcow = ifelse(decyzja==TRUE,as.character(X245),paste(X245,opis_duzy,sep = "#"))) %>%
  select(ZA_UWAGI,opis_duzy,za_opis_wspoltworcow) %>%
  cSplit(.,"za_opis_wspoltworcow",sep = "#",direction = "wide") %>%
  mutate(za_opis_wspoltworcow_2 = ifelse(is.na(za_opis_wspoltworcow_2),'',as.character(za_opis_wspoltworcow_2)),
         to_samo = za_opis_wspoltworcow_1==za_opis_wspoltworcow_2) %>%
  filter(to_samo==FALSE) %>%
  group_by(ZA_UWAGI) %>%
  mutate(za_opis_wspoltworcow = paste(za_opis_wspoltworcow_1,za_opis_wspoltworcow_2,sep = "#"),
         za_opis_wspoltworcow = str_remove_all(za_opis_wspoltworcow,"\\#$")) %>%
  select(ZA_UWAGI,za_opis_wspoltworcow)

opis_wspoltworcow <- opis_wspoltworcow %>%
  filter(ZA_UWAGI %notin% za_opis_wspoltworcow$ZA_UWAGI) %>%
  filter(!is.na(opis)) %>%
  rename(za_opis_wspoltworcow = opis)

za_opis_wspoltworcow <- za_opis_wspoltworcow %>%
  bind_rows(.,opis_wspoltworcow) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#8 wydanie
marc_field_250 <- data %>%
  select(ZA_UWAGI,X250)%>%
  filter(X250!="") %>%
  mutate(X250=str_replace_all(X250,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X250",sep = "~",direction = "long") %>%
  filter(X250!="") %>%
  mutate(X250=str_remove_all(X250,"^\\|")) %>%
  mutate(indicator = str_replace_all(X250,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X250,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_250)[1]))
colnames(empty_table) <-subfield_list
marc_field_250<-cbind(marc_field_250,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_250$X250 <- str_replace(marc_field_250$X250,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_250[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_250$X250),str_replace_all(gsub(string,"\\3",marc_field_250$X250),"\\${2}.", "~"),NA)
}

za_wydanie <- marc_field_250 %>%
  select(ZA_UWAGI, wydanie = `$a`) %>%
  mutate(wydanie = str_remove(wydanie," \\/$")) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#9: instytucja sprawcza
marc_field_245 <- data %>%
  select(ZA_UWAGI,X245)%>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"~"),
         X245=str_replace_all(X245,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X245",sep = "~",direction = "long") %>%
  filter(X245!="") %>%
  mutate(X245=str_remove_all(X245,"^\\|")) %>%
  mutate(indicator = str_replace_all(X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_245)[1]))
colnames(empty_table) <-subfield_list
marc_field_245<-cbind(marc_field_245,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_245$X245 <- str_replace(marc_field_245$X245,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_245[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_245$X245),str_replace_all(gsub(string,"\\3",marc_field_245$X245),"\\${2}.", "~"),NA)
}

za_instytucja <- marc_field_245 %>%
  select(ZA_UWAGI,X245c=`$c`) %>%
  filter(!is.na(X245c)) %>%
  mutate(instytucja = ifelse(grepl("\\;",X245c),str_replace_all(X245c, "(.*?)(\\;(?!.*\\;))( )+(.*?$)","\\4"),"")) %>%
  left_join(.,BN_wspoltworca,by="ZA_UWAGI")

x <- 1:lengths(za_instytucja[1])
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  za_instytucja$czy_nazwisko[i] <- grepl(za_instytucja$OS_NAZWISKO[i],za_instytucja$X245c[i])
  za_instytucja$czy_imie[i] <- grepl(za_instytucja$OS_IMIE[i],za_instytucja$X245c[i])
}

za_instytucja <- za_instytucja %>%
  filter(is.na(czy_nazwisko)&is.na(czy_imie)) %>%
  filter(instytucja!="") %>%
  filter(!grepl("^\\[[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]|^[a-zaáàâãäăāåąæeéèêëěēėęiíìîïīįioóòôõöőøœuúùûüűūůyýcćčçdďđđgģğkķlłļnńñňņŋrřsśšşsßtťŧþţzżźž]",instytucja)) %>%
  mutate(instytucja = str_remove(instytucja,"\\.$")) %>%
  select(ZA_UWAGI,instytucja) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#10: wydawnictwo
BN_wydawnictwo <- data %>%
  select(ZA_UWAGI, X260) %>%
  mutate(X260 = str_replace_all(X260,"s\\.n\\.", "b.w."), 
         X260 = str_replace_all(X260,"s\\.l\\.", "b.m."), 
         X260 = str_replace_all(X260,"S\\.l\\.", "b.m."), 
         X260 = str_remove(X260,"^\\\\+"), 
         rok_wydania = str_extract_all(X260, "(?<=\\$c).*(?=\\$e)|(?<=\\$c).*"), 
         bez_roku = str_replace_all(X260, ".\\$c.*", ""), 
         ile_wydawnictw = str_count(bez_roku, "\\$b"),
         ile_miejsc = str_count(bez_roku, "\\$a"),
         kolejnosc = str_replace_all(as.character(str_extract_all(bez_roku, "\\$.")), "[^a-z]", ""),
         bez_roku = str_replace_all(bez_roku, ";\\$b", ":$b"),
         wydaw_podziel = ifelse(ile_wydawnictw>ile_miejsc|kolejnosc=="caabb", str_replace_all(bez_roku, "(\\$a)(.*?)( :\\$b.*?)( :\\$b)", "\\1\\2\\3 ;$a\\2\\4"),bez_roku),
         wydawnictwo_test = str_replace_all(wydaw_podziel, "(\\$b)(.*?)( ;\\$a)", "\\1\\2|\\3")) %>%
  select(ZA_UWAGI,rok_wydania,wydawnictwo_test) %>%
  cSplit(., "wydawnictwo_test", sep = "|", direction = "long") %>%
  mutate(wydawnictwo = str_extract_all(wydawnictwo_test, "(?<=\\$b)(.*)"),
         miejsce_wydania = str_replace_all(str_extract_all(wydawnictwo_test, "(?<=\\$a)(.*)(?= {0,1}: {0,1}\\$b)|(?<=\\$a)(.*)($)")," ;\\$a", ", "),
         nazwa_prosta = str_to_lower(str_replace_all(str_replace_all(unlist(wydawnictwo_test), "\\$\\w", ""), "\\W", ""))) %>%
  left_join(.,PBL_wydawnictwa,by="nazwa_prosta") %>%
  mutate(to_samo = wydawnictwo==WY_NAZWA) %>%
  arrange(ZA_UWAGI,-to_samo,-WY_LICZBA_ZAPISOW)
BN_wydawnictwo$id_grupy <- cumsum(!duplicated(BN_wydawnictwo[1:3]))
BN_wydawnictwo <- BN_wydawnictwo[!duplicated(BN_wydawnictwo$id_grupy),] %>%
  mutate(WY_NAZWA = ifelse(!is.na(WY_NAZWA),as.character(WY_NAZWA),as.character(wydawnictwo)),
         WY_MIASTO = ifelse(!is.na(WY_MIASTO),as.character(WY_MIASTO),as.character(miejsce_wydania)),
         rok_wydania = str_replace_all(rok_wydania, "(.*)(\\.)", "\\1"),
         za_rok_wydania = ifelse(nchar(rok_wydania)==4,as.character(rok_wydania),NA),
         do_opisu = ifelse(is.na(za_rok_wydania),paste("[",str_extract(rok_wydania,"\\d{4}"),"]",sep = ""),""),
         WY_MIASTO = ifelse(substr(WY_MIASTO,1,1)=="["&substr(WY_MIASTO,nchar(WY_MIASTO),nchar(WY_MIASTO))!="]"&is.na(WY_WYDAWNICTWO_ID),paste(trim(WY_MIASTO),"]",sep = ""),as.character(WY_MIASTO))) %>%
  select(ZA_UWAGI,WY_WYDAWNICTWO_ID,WY_NAZWA,WY_MIASTO,za_rok_wydania,do_opisu)

#11: opis fizyczny książki
#pole 300 do opisu fizycznego
marc_field_300 <- data %>%
  select(ZA_UWAGI,X300)%>%
  filter(X300!="") %>%
  mutate(X300=str_replace_all(X300,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X300",sep = "~",direction = "long") %>%
  filter(X300!="") %>%
  mutate(X300=str_remove_all(X300,"^\\|")) %>%
  mutate(indicator = str_replace_all(X300,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X300,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_300)[1]))
colnames(empty_table) <-subfield_list
marc_field_300<-cbind(marc_field_300,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_300$X300 <- str_replace(marc_field_300$X300,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_300[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_300$X300),str_replace_all(gsub(string,"\\3",marc_field_300$X300),"\\${2}.", "~"),NA)
}
marc_field_300 <- marc_field_300 %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"),
         `$b` = str_remove(`$b`," \\;+$| \\:+$"),
         `$e` = ifelse(grepl("CD-ROM|DVD|VCD|CD",`$e`)&grepl("\\+ dysk|płyt",`$e`),str_extract(`$e`,"(?<=\\+)(dysk|płyt.*?)(CD-ROM|DVD|VCD|CD)(\\)){0,1}"),
                       ifelse(grepl("CD-ROM|DVD|VCD|CD",`$e`),str_extract(`$e`,"(^.*?)(CD-ROM|DVD|VCD|CD)(\\)){0,1}"),NA)),
         `$a` = ifelse(is.na(`$a`),"",as.character(`$a`)),
         `$b` = ifelse(is.na(`$b`),"",as.character(`$b`)),
         `$e` = ifelse(is.na(`$e`),"",as.character(`$e`)))
#pole 500 do opisu fizycznego
marc_field_500 <- data %>%
  select(ZA_UWAGI,X500)%>%
  filter(X500!="") %>%
  mutate(X500=str_replace_all(X500,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X500",sep = "~",direction = "long") %>%
  filter(X500!="") %>%
  mutate(X500=str_remove_all(X500,"^\\|")) %>%
  mutate(indicator = str_replace_all(X500,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X500,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_500)[1]))
colnames(empty_table) <-subfield_list
marc_field_500<-cbind(marc_field_500,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_500$X500 <- str_replace(marc_field_500$X500,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_500[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_500$X500),str_replace_all(gsub(string,"\\3",marc_field_500$X500),"\\${2}.", "~"),NA)
}
marc_field_500 <- marc_field_500 %>%
  filter(!grepl("oryg(\\.|\\,)",X500)&grepl("pseud|nazwa|dotycz|pol",X500,ignore.case = TRUE)) %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"))
  
#pole 546 do opisu fizycznego
marc_field_546 <- data %>%
  select(ZA_UWAGI,X546)%>%
  filter(X546!="") %>%
  mutate(X546=str_replace_all(X546,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X546",sep = "~",direction = "long") %>%
  filter(X546!="") %>%
  mutate(X546=str_remove_all(X546,"^\\|")) %>%
  mutate(indicator = str_replace_all(X546,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X546,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_546)[1]))
colnames(empty_table) <-subfield_list
marc_field_546<-cbind(marc_field_546,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_546$X546 <- str_replace(marc_field_546$X546,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_546[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_546$X546),str_replace_all(gsub(string,"\\3",marc_field_546$X546),"\\${2}.", "~"),NA)
}
marc_field_546 <- marc_field_546 %>%
  mutate(`$a` = str_remove(`$a`," \\;+$| \\:+$"))

za_opis_ks <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wydawnictwo %>% select(ZA_UWAGI,do_opisu),by="ZA_UWAGI") %>%
  left_join(.,marc_field_300 %>% select(ZA_UWAGI,X300a=`$a`,X300b=`$b`,X300e=`$e`),by="ZA_UWAGI") %>%
  left_join(.,marc_field_500 %>% select(ZA_UWAGI,X500a=`$a`),by="ZA_UWAGI") %>%
  left_join(.,marc_field_546 %>% select(ZA_UWAGI,X546a=`$a`),by="ZA_UWAGI")
za_opis_ks[is.na(za_opis_ks)]  <- ""
za_opis_ks <- za_opis_ks %>%
  mutate(za_opis_ks = paste(ifelse(do_opisu!="",paste(as.character(do_opisu),", ",sep = ""),""),ifelse(X300a!="",paste(as.character(X300a),", ",sep = ""),""),ifelse(X300b!="",paste(as.character(X300b),", ",sep = ""),""),ifelse(X300e!="",paste(as.character(X300e),", ",sep = ""),""),ifelse(X500a!="",paste(as.character(X500a),", ",sep = ""),""),ifelse(X546a!="",as.character(X546a),""),sep = ""),
         za_opis_ks = str_remove(za_opis_ks,"(, )+$")) %>%
  select(ZA_UWAGI,za_opis_ks) %>%
  unique() %>%
  arrange(ZA_UWAGI,-nchar(za_opis_ks))
za_opis_ks$id_grupy <- cumsum(!duplicated(za_opis_ks[1]))
za_opis_ks <- za_opis_ks[!duplicated(za_opis_ks$id_grupy),] %>%
  select(-id_grupy)

#12: seria wydawnicza
marc_field_490 <- data %>%
  select(ZA_UWAGI,X490,X800,X830) %>%
  mutate(X490 = ifelse(grepl("U\\+",X490),as.character(X830),as.character(X490))) %>%
  mutate(X800 = ifelse(X490!="","",as.character(X800)),
         X830 = ifelse(X490!="","",as.character(X830)),
         X800 = str_replace(X800,"(\\$a)(.*)(\\$t)","\\1"),
         X490 = ifelse(X490==""&X830!="",as.character(X830),
                       ifelse(X490==""&X800!="",as.character(X800),as.character(X490)))) %>%
  select(ZA_UWAGI,X490) %>%
  filter(X490!="") %>%
  mutate(X490=str_replace_all(X490,"(^|\\|)","~\\1")) %>%
  cSplit(.,"X490",sep = "~",direction = "long") %>%
  filter(X490!="") %>%
  mutate(X490=str_remove_all(X490,"^\\|")) %>%
  mutate(indicator = str_replace_all(X490,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X490,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_490)[1]))
colnames(empty_table) <-subfield_list
marc_field_490<-cbind(marc_field_490,empty_table)
subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  marc_field_490$X490 <- str_replace(marc_field_490$X490,subfield_list_char[i],"|\\1")
}
for (i in x) {
  progress(match(i,x), max.value = length(x)) 
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
  string_a <- "(^)(.*?\\|"
  string_b <- subfield_list_char2[i]
  string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
  string <- paste(string_a,string_b,string_c,sep = "")
  marc_field_490[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_490$X490),str_replace_all(gsub(string,"\\3",marc_field_490$X490),"\\${2}.", "~"),NA)
}
za_seria_wydawnicza <- marc_field_490 %>%
  mutate(`$a` = str_replace_all(`$a`,"(=)(\\$a)","\\1 "),
         `$a` = str_remove(`$a`," \\;+$| \\:+$"),
         `$v` = ifelse(is.na(`$v`),"",as.character(`$v`))) %>%
  filter(!is.na(`$a`)) %>%
  mutate(seria = str_remove(paste("(",`$a`,"; ",`$v`,")",sep = ""),"; (?=\\)$)"),
         seria = gsub("( : )(.)",". \\U\\2",perl=TRUE,seria)) %>%
  select(ZA_UWAGI,seria) %>%
  group_by(ZA_UWAGI) %>%
  mutate(seria = paste(seria,collapse = " ")) %>%
  ungroup() %>%
  unique() %>%
  mutate(seria = str_replace_all(seria,"\\$.","; ")) %>%
  right_join(.,data %>% select(ZA_UWAGI),by="ZA_UWAGI")

#13: tomy
za_tomy <- data %>%
  select(ZA_UWAGI) %>%
  mutate(za_tomy = NA)

#14: adnotacje
za_adnotacje <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,ZA_ADNOTACJE %>% select(ZA_UWAGI,ZA_ADNOTACJE),by="ZA_UWAGI") %>%
  left_join(.,BN_wspoltworca %>% select(ZA_UWAGI,ZA_ADNOTACJE),by="ZA_UWAGI") %>%
  mutate(ZA_ADNOTACJE = paste(ifelse(is.na(ZA_ADNOTACJE.x),"",paste(as.character(ZA_ADNOTACJE.x),"# ",sep = "")),ifelse(is.na(ZA_ADNOTACJE.y),"",as.character(ZA_ADNOTACJE.y)),sep = ""),
         ZA_ADNOTACJE = str_remove(ZA_ADNOTACJE,"(# )+$")) %>%
  select(ZA_UWAGI,ZA_ADNOTACJE) %>%
  unique() %>%
  arrange(ZA_UWAGI,-nchar(ZA_ADNOTACJE))
za_adnotacje$id_grupy <- cumsum(!duplicated(za_adnotacje[1]))
za_adnotacje <- za_adnotacje[!duplicated(za_adnotacje$id_grupy),] %>%
  select(-id_grupy)

#15: BN_URL
BN_URL <- data %>%
  select(ZA_UWAGI,BN_URL)

#wyrównanie liczby wierszy do liczby wierszy obiektu data
BN_wspoltworca <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wspoltworca %>% select(ZA_UWAGI,OS_OSOBA_ID,OS_NAZWISKO,OS_IMIE,fo_symbol),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, OS_OSOBA_ID = paste(OS_OSOBA_ID, collapse="|"), OS_NAZWISKO = paste(OS_NAZWISKO, collapse="|"), OS_IMIE = paste(OS_IMIE, collapse="|"), fo_symbol = paste(fo_symbol, collapse="|")) %>%
  mutate(fo_symbol = ifelse(fo_symbol=="NULL","NA",as.character(fo_symbol)))
BN_wydawnictwo <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,BN_wydawnictwo %>% select(ZA_UWAGI,WY_WYDAWNICTWO_ID,WY_NAZWA,WY_MIASTO,za_rok_wydania),by="ZA_UWAGI") %>%
  ddply(., .(ZA_UWAGI), summarize, WY_WYDAWNICTWO_ID = paste(WY_WYDAWNICTWO_ID, collapse="|"), WY_NAZWA = paste(WY_NAZWA, collapse="|"), WY_MIASTO = paste(WY_MIASTO, collapse="|"), za_rok_wydania = paste(unique(za_rok_wydania), collapse="|")) %>%
  mutate(za_rok_wydania = ifelse(za_rok_wydania=="NA","",as.integer(za_rok_wydania)))

#połączenie wszystkich elementów w jedną tabelę
kolejnosc <- c("ZA_UWAGI","RZ_NAZWA","ZA_RO_ROK","ZA_TYPE","RZ_RODZAJ_ID","DZ_NAZWA","DZ_DZIAL_ID","TW_TWORCA_ID","AM_AUTOR_ID","AM_NAZWISKO","AM_IMIE","ZA_TYTUL","ZA_TYTUL_ORYGINALU","ZA_JEZYK_ORYGINALU","OS_OSOBA_ID","OS_NAZWISKO","OS_IMIE","fo_symbol","za_opis_wspoltworcow","wydanie","za_tomy","instytucja","WY_WYDAWNICTWO_ID","WY_MIASTO","WY_NAZWA","za_rok_wydania","za_opis_ks","seria","TW_NAZWISKO","TW_IMIE","redaktor_dzialu","ZA_ADNOTACJE","BN_URL")
polaczone <- data %>%
  select(ZA_UWAGI) %>%
  left_join(.,pola_pbl,by = "ZA_UWAGI") %>%
  left_join(.,BN_autor,by = "ZA_UWAGI") %>%
  left_join(.,za_tytul,by = "ZA_UWAGI") %>%
  left_join(.,za_tytul_oryginalu,by = "ZA_UWAGI") %>%
  left_join(.,za_jezyk_oryginalu,by = "ZA_UWAGI") %>%
  left_join(.,BN_wspoltworca,by = "ZA_UWAGI") %>%
  left_join(.,za_opis_wspoltworcow,by = "ZA_UWAGI") %>%
  left_join(.,za_wydanie,by = "ZA_UWAGI") %>%
  left_join(.,za_instytucja,by = "ZA_UWAGI") %>%
  left_join(.,BN_wydawnictwo,by = "ZA_UWAGI") %>%
  left_join(.,za_opis_ks,by = "ZA_UWAGI") %>%
  left_join(.,za_seria_wydawnicza,by = "ZA_UWAGI") %>%
  left_join(.,za_tomy,by = "ZA_UWAGI") %>%
  left_join(.,za_adnotacje,by = "ZA_UWAGI") %>%
  left_join(.,BN_URL,by = "ZA_UWAGI") %>%
  select(noquote(kolejnosc))
colnames(polaczone) <- c("rekord_BN","rz_nazwa","za_ro_rok","za_type","rz_rodzaj_id","DZ_NAZWA","DZ_DZIAL_ID","tw_tworca_id","am_autor_id","am_nazwisko","am_imie","za_tytul","za_tytul_oryginalu","za_jezyk_oryginalu","os_osoba_id","os_nazwisko","os_imie","fo_symbol","za_opis_wspoltworcow","za_wydanie","za_tomy","za_instytucja","wy_wydawnictwo_id","wy_miejsce","wy_nazwa","za_rok_wydania","za_opis_fizyczny_ksiazki","za_seria_wydawnicza","tw_nazwisko","tw_imie","pracownik","za_adnotacje","BN_URL")

#zasygnalizowanie niepoprawnego kodowania
x <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("<U\\+(....)>",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)!=0,paste(polaczone$za_adnotacje,paste("UWAGA! Błąd kodowania w polu ",as.character(names(polaczone[i]))," Znajdź frazę \"???\" i zredaguj pole",sep = ""),sep = "# "),paste("UWAGA! Błąd kodowania w polu ",as.character(names(polaczone[i]))," Znajdź frazę \"???\" i zredaguj pole",sep = "")),as.character(polaczone$za_adnotacje))
  polaczone[,i] <- gsub("<U\\+(....)>", "???", polaczone[,i])
}
#zasygnalizowanie obecności znaku $ w którymś z pól
X <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("\\$",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano znak \"$\". Zredaguj treść pola.",sep = ""),paste(polaczone$za_adnotacje,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano znak \"$\". Zredaguj treść pola.",sep = ""),sep = "# ")),as.character(polaczone$za_adnotacje))
}
#zasygnalizowanie obecności frazy "character(0)" w którymś z pól
X <- 1:(length(polaczone)-2)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  polaczone$za_adnotacje <- ifelse(grepl("character\\(0\\)",polaczone[,i]),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano frazę \"character(0)\". Zredaguj treść pola.",sep = ""),paste(polaczone$za_adnotacje,paste("UWAGA! Ze względu na błędny zapis BN w polu ",as.character(names(polaczone[i]))," wydrukowano frazę \"character(0)\". Zredaguj treść pola.",sep = ""),sep = "# ")),as.character(polaczone$za_adnotacje))
}
#zasygnalizowanie obecności znaku # w opisie współtwórców
polaczone$za_adnotacje <- ifelse(grepl("\\#",polaczone$za_opis_wspoltworcow),
                                   ifelse(nchar(polaczone$za_adnotacje)==0,"UWAGA! Ze względu na konflikt w opisie współtwórców wybierz właściwą wartość (strefa odpowiedzialności \"#\" współtwórcy z pola 700)",paste(polaczone$za_adnotacje,"UWAGA! Ze względu na konflikt w opisie współtwórców wybierz właściwą wartość (strefa odpowiedzialności # współtwórcy z pola 700)",sep = "# ")),as.character(polaczone$za_adnotacje))
#korekta automatycznego IOK
automatyczny_IOK <- polaczone %>%
  mutate(czy_tyt_oryg = (!grepl("polsk",DZ_NAZWA)&!is.na(za_tytul_oryginalu))|grepl("polsk",DZ_NAZWA)) %>%
  filter(za_adnotacje==""&am_nazwisko!="NA"&!grepl("pseud|nazw",za_opis_fizyczny_ksiazki)&!grepl("\\|",am_nazwisko)&czy_tyt_oryg==TRUE) %>%
  select(rekord_BN) %>%
  unique() %>%
  filter(rekord_BN %notin% data$ZA_UWAGI[data$czy_automatycznie=="nie"]) %>%
  mutate(automatyczny_import = "tak")

write.csv2(automatyczny_IOK, "C:/Users/Cezary/Desktop/imp_2009_automatyczne_antologie.csv", row.names = F, na = '', fileEncoding = 'UTF-8')

out <- cSplit(polaczone, c("am_autor_id", "am_nazwisko", "am_imie","os_osoba_id","os_nazwisko", "os_imie", "fo_symbol","wy_wydawnictwo_id","wy_miejsce","wy_nazwa"),sep = "|",direction = "long") %>%
  unique()

out$rekord_BN <- ifelse(is.na(out$rekord_BN),'',as.character(out$rekord_BN))
out$rz_nazwa <- ifelse(is.na(out$rz_nazwa),'',as.character(out$rz_nazwa))
out$za_ro_rok <- ifelse(is.na(out$za_ro_rok),'',as.character(out$za_ro_rok))
out$za_type <- ifelse(is.na(out$za_type),'',as.character(out$za_type))
out$rz_rodzaj_id <- ifelse(is.na(out$rz_rodzaj_id),'',as.character(out$rz_rodzaj_id))
out$DZ_NAZWA <- ifelse(is.na(out$DZ_NAZWA),'',as.character(out$DZ_NAZWA))
out$DZ_DZIAL_ID <- ifelse(is.na(out$DZ_DZIAL_ID),'',as.character(out$DZ_DZIAL_ID))
out$tw_tworca_id <- ifelse(is.na(out$tw_tworca_id),'',as.character(out$tw_tworca_id))
out$am_autor_id <- ifelse(is.na(out$am_autor_id),'',as.character(out$am_autor_id))
out$am_nazwisko <- ifelse(is.na(out$am_nazwisko),'',as.character(out$am_nazwisko))
out$am_imie <- ifelse(is.na(out$am_imie),'',as.character(out$am_imie))
out$za_tytul <- ifelse(is.na(out$za_tytul),'',as.character(out$za_tytul))
out$za_tytul_oryginalu <- ifelse(is.na(out$za_tytul_oryginalu),'',as.character(out$za_tytul_oryginalu))
out$za_jezyk_oryginalu <- ifelse(is.na(out$za_jezyk_oryginalu),'',as.character(out$za_jezyk_oryginalu))
out$os_osoba_id <- ifelse(is.na(out$os_osoba_id),'',as.character(out$os_osoba_id))
out$os_nazwisko <- ifelse(is.na(out$os_nazwisko),'',as.character(out$os_nazwisko))
out$os_imie <- ifelse(is.na(out$os_imie),'',as.character(out$os_imie))
out$fo_symbol <- ifelse(is.na(out$fo_symbol),'',as.character(out$fo_symbol))
out$za_opis_wspoltworcow <- ifelse(is.na(out$za_opis_wspoltworcow),'',as.character(out$za_opis_wspoltworcow))
out$za_wydanie <- ifelse(is.na(out$za_wydanie),'',as.character(out$za_wydanie))
out$za_tomy <- ifelse(is.na(out$za_tomy),'',as.character(out$za_tomy))
out$za_instytucja <- ifelse(is.na(out$za_instytucja),'',as.character(out$za_instytucja))
out$wy_wydawnictwo_id <- ifelse(is.na(out$wy_wydawnictwo_id),'',as.character(out$wy_wydawnictwo_id))
out$wy_miejsce <- ifelse(is.na(out$wy_miejsce),'',as.character(out$wy_miejsce))
out$wy_nazwa <- ifelse(is.na(out$wy_nazwa),'',as.character(out$wy_nazwa))
out$za_rok_wydania <- ifelse(is.na(out$za_rok_wydania),'',as.character(out$za_rok_wydania))
out$za_opis_fizyczny_ksiazki <- ifelse(is.na(out$za_opis_fizyczny_ksiazki),'',as.character(out$za_opis_fizyczny_ksiazki))
out$za_seria_wydawnicza <- ifelse(is.na(out$za_seria_wydawnicza),'',as.character(out$za_seria_wydawnicza))
out$tw_nazwisko <- ifelse(is.na(out$tw_nazwisko),'',as.character(out$tw_nazwisko))
out$tw_imie <- ifelse(is.na(out$tw_imie),'',as.character(out$tw_imie))
out$pracownik <- ifelse(is.na(out$pracownik),'',as.character(out$pracownik))
out$za_adnotacje <- ifelse(is.na(out$za_adnotacje),'',as.character(out$za_adnotacje))
out$BN_URL <- ifelse(is.na(out$BN_URL),'',as.character(out$BN_URL))

out %$%  
    { rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,) & BN_URL==lag(BN_URL,)} %>% 
    as.numeric() %>% 
    {.} -> out$same
out$same[1] <- 0
out$dzielone <- paste(out$am_autor_id,out$am_nazwisko,out$am_imie,out$os_osoba_id,out$os_nazwisko,out$os_imie,out$fo_symbol,out$wy_wydawnictwo_id,out$wy_miejsce,out$wy_nazwa,sep = "")

out <- out %>%
  filter(!(same==1&dzielone=="")) %>%
  select(1:33)

out %$%  
    { rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,) & BN_URL==lag(BN_URL,)} %>% 
    as.numeric() %>% 
    {.} -> out$same

#ucięcie zbyt długich ciągów znaków, by weszły do oracle'a
dlugosci <- data.frame(pole = c("am_nazwisko", "am_imie", "za_tytul", "za_tytul_oryginalu", "za_jezyk_oryginalu", "os_nazwisko", "os_imie", "za_opis_wspoltworcow", "za_instytucja", "wy_miejsce", "wy_nazwa", "za_opis_fizyczny_ksiazki", "za_seria_wydawnicza", "tw_nazwisko", "tw_imie", "za_adnotacje"), liczba_znakow = c(50,40,500,500,100,50,40,500,255,40,255,1000,255,200,40,2000))
x <- match(dlugosci$pole,names(out))
for (i in x) {
  progress(match(i,x), max.value = length(x))
  dlugosc <- dlugosci$liczba_znakow[match(names(out[i]),dlugosci$pole)]
  out$za_adnotacje <- ifelse(dlugosc<nchar(as.character(out[,i]))&out$za_adnotacje!="",paste(out$za_adnotacje,paste("UWAGA! Pole ",as.character(names(out[i]))," było zbyt długie i zostało przycięte. Zredaguj treść pola.",sep = ""),sep = "# "),
                             ifelse(dlugosc<nchar(as.character(out[,i]))&out$za_adnotacje=="",paste("UWAGA! Pole ",as.character(names(out[i]))," było zbyt długie i zostało przycięte. Zredaguj treść pola.",sep = ""),as.character(out$za_adnotacje)))
  
  out[,i] <- ifelse(dlugosc<nchar(as.character(out[,i])),as.character(substr(out[,i],1,dlugosc)),as.character(out[,i]))
}

out$rekord_BN[out$same == 1] <- ""
out$rz_nazwa[out$same == 1] <- ""
out$za_ro_rok[out$same == 1] <- ""
out$za_type[out$same == 1] <- ""
out$rz_rodzaj_id[out$same == 1] <- ""
out$DZ_NAZWA[out$same == 1] <- ""
out$DZ_DZIAL_ID[out$same == 1] <- ""
out$tw_tworca_id[out$same == 1] <- ""
out$za_tytul[out$same == 1] <- ""
out$za_tytul_oryginalu[out$same == 1] <- ""
out$za_jezyk_oryginalu[out$same == 1] <- ""
out$za_opis_wspoltworcow[out$same == 1] <- ""
out$za_wydanie[out$same == 1] <- ""
out$za_tomy[out$same == 1] <- ""
out$za_instytucja[out$same == 1] <- ""
out$za_rok_wydania[out$same == 1] <- ""
out$za_opis_fizyczny_ksiazki[out$same == 1] <- ""
out$za_seria_wydawnicza[out$same == 1] <- ""
out$tw_nazwisko[out$same == 1] <- ""
out$tw_imie[out$same == 1] <- ""
out$pracownik[out$same == 1] <- ""
out$za_adnotacje[out$same == 1] <- ""
out$BN_URL[out$same == 1] <- ""

#przypisanie do automatycznego OK redaktora "automat"
out <- out %>%
  mutate(pracownik = ifelse(rekord_BN %in% automatyczny_IOK$rekord_BN,"AUTOMAT",as.character(pracownik))) %>%
  select(1:33)

#pętla zapisująca po ok. 2000 wierszy z uwzględnieniem kompletności rekordów bibliograficznych rozpisanych na kilka wierszy
out <- out %>%
  mutate(podzial = ifelse(rekord_BN!="",as.character(rekord_BN),NA)) %>%
  fill(podzial)
ile <- unique(out$podzial)
ile <- split(unique(ile), ceiling(seq_along(unique(ile))/1500))

x <- 1:length(ile)
for (i in x) {
  progress(match(i,x), max.value = length(x))
  final <- out %>%
    filter(podzial %in% ile[[i]]) %>%
    select(-podzial)
  write.xlsx(final, paste("C:/Users/Cezary/Desktop/2009_antologie_do_importu",i,".xlsx",sep = ""),sheetName = "gotowe")
}
```

```{r książki współwydania}
data <- bn_ok %>%
  filter(rodzaj_ksiazki=="współwydanie") %>%
  mutate(redaktor_dzialu = paste(redaktor_dzialu,"_wsp",sep = ""))


data <- harlequiny
data$X245 <- str_replace_all(data$X245, "\\]\\. ", "]|$a")
data$X245 <- str_replace_all(data$X245, "\\/[^\\$]", "/$c")
data <- cSplit(data, c("X245", "X246"), sep = "|", direction = "long")
data <- data.frame(data, licznik = 1:length(data$id))

#uwolnienie kolumn z danymi z bn i przetworzenie do PBL
#1
za_uwagi <- data %>%
  select(za_uwagi = id, licznik)
za_uwagi$za_uwagi <- str_replace_all(za_uwagi$za_uwagi," ","0")
za_uwagi$za_uwagi <- ifelse(nchar(za_uwagi$za_uwagi)==13,za_uwagi$za_uwagi, sprintf("%013d", as.integer(za_uwagi$za_uwagi)))

za_uwagi %$%  
    { za_uwagi == dplyr::lag(za_uwagi, 1)} %>% 
    as.numeric() %>% 
    {.} -> za_uwagi$same
za_uwagi$same[1] <- 0
za_uwagi$za_uwagi <- ifelse(za_uwagi$same==1,paste(za_uwagi$za_uwagi,"_2", sep = ""),za_uwagi$za_uwagi)

za_uwagi <- za_uwagi %>%
  select(1,2)
#2
rz_nazwa <- data.frame(rz_nazwa = rep("książka twórcy (podmiotowa)", length(1:length(za_uwagi$za_uwagi))))
rz_nazwa <- data.frame(rz_nazwa = rz_nazwa$rz_nazwa, licznik = 1:lengths(rz_nazwa))
#3
za_ro_rok <- data %>%
  select(za_ro_rok = rok, licznik)
#4
za_type <- data.frame(licznik = data$licznik, za_type = "KS")
#5
rz_rodzaj_id <- merge(x = rz_nazwa, y = PBL_rodzaje_zapisow, by.x = 'rz_nazwa', by.y = 'RZ_NAZWA', sort = FALSE,all.x = TRUE)
rz_rodzaj_id <- rz_rodzaj_id[order(rz_rodzaj_id$licznik),]
rz_rodzaj_id <- rz_rodzaj_id %>%
  select(RZ_RODZAJ_ID, licznik)
#6
BN_autor <- data.frame(autorzy = as.character(str_extract_all(data$X245, "(?<=\\/\\$c)(.*)(?= ;)")), licznik = data$licznik)
BN_autor <- mutate(BN_autor,
                   nazwa = str_replace_all(str_to_lower(BN_autor$autorzy), "\\W", ""))

nazwa2 <- ifelse(is.na(PBL_autorzy$AM_IMIE),as.character(PBL_autorzy$AM_NAZWISKO),paste(PBL_autorzy$AM_IMIE,PBL_autorzy$AM_NAZWISKO, sep = ""))
nazwa2 <- data.frame(nazwa2 = str_to_lower(str_replace_all(nazwa2, "\\W", "")))
nazwa2 <- data.frame(nazwa2 = str_replace_all(str_to_lower(nazwa2$nazwa2), "\\W", ""))
PBL_autorzy <- data.frame(PBL_autorzy, nazwa2 = nazwa2$nazwa2)
PBL_autorzy <- PBL_autorzy %>%
  filter(nazwa2 != "nana")

BN_PBL_autor <- merge(x = BN_autor, y = PBL_autorzy, by.x = 'nazwa', by.y = 'nazwa2', sort = FALSE, all.x = TRUE)
BN_PBL_autor <- BN_PBL_autor[order(BN_PBL_autor$licznik, BN_PBL_autor$AM_AUTOR_ID),]

BN_PBL_autor <- BN_PBL_autor[order(BN_PBL_autor$licznik, -BN_PBL_autor$AM_LICZBA_ZAPISOW),]

BN_PBL_autor %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_PBL_autor$same
BN_PBL_autor$same[1] <- 0

BN_PBL_autor <- BN_PBL_autor %>%
  filter(same==0) %>%
  select(1:14)
colnames(BN_PBL_autor)[14] <- "nazwa_naz_im"
BN_autor_podzielony <- data.frame(autor = str_replace_all(BN_autor$autorzy, "( (?!.* ))","|"), licznik = BN_autor$licznik)
BN_autor_podzielony <- cSplit(BN_autor_podzielony, c("autor"), sep = "|", direction = "wide")
BN_PBL_autor <- merge(BN_PBL_autor,BN_autor_podzielony,by = "licznik", all = TRUE)

am_autor_id <- BN_PBL_autor %>%
  select(licznik, AM_AUTOR_ID)
#7
am_nazwisko <- data.frame(nazwisko = BN_autor_podzielony$autor_2, licznik = BN_autor_podzielony$licznik)
aut_id_nazw <- merge(x = am_nazwisko, y = am_autor_id, by = "licznik", all.x=TRUE)
am_nazwisko <- data.frame(am_nazwisko = ifelse(is.na(aut_id_nazw$AM_AUTOR_ID),as.character(aut_id_nazw$nazwisko), NA), licznik = aut_id_nazw$licznik)
#8
am_imie <- data.frame(imie = BN_autor_podzielony$autor_1, licznik = BN_autor_podzielony$licznik)
aut_id_imie <- merge(x = am_imie, y = am_autor_id, by = "licznik", all.x=TRUE)
am_imie <- data.frame(am_imie = ifelse(is.na(aut_id_imie$AM_AUTOR_ID),as.character(aut_id_imie$imie), NA), licznik = aut_id_nazw$licznik)
#9
tw_tworca_id <- merge(x = BN_PBL_autor, y = PBL_autor_to_tworca, by.x = 'AM_AUTOR_ID', by.y = 'id autora', sort = FALSE, all.x = TRUE)
tw_tworca_id <- merge(x = tw_tworca_id, y = PBL_tworcy, by.x = 'id tworcy', by.y = 'TW_TWORCA_ID', sort = FALSE, all.x = TRUE)
tw_tworca_id <- tw_tworca_id %>%
  select(licznik,`id tworcy`,AM_NAZWISKO=autor_2,AM_IMIE=autor_1, DZ_NAZWA, TW_DZ_DZIAL_ID)
tw_tworca_id$`id tworcy`[tw_tworca_id$TW_DZ_DZIAL_ID==430] <- NA
tw_tworca_id$AM_NAZWISKO[tw_tworca_id$TW_DZ_DZIAL_ID==430] <- NA
tw_tworca_id$AM_IMIE[tw_tworca_id$TW_DZ_DZIAL_ID==430] <- NA
BN_PBL_tworca <- tw_tworca_id %>%
    select(1,TW_TWORCA_ID = 2,TW_NAZWISKO = 3,TW_IMIE = 4,DZ_NAZWA,TW_DZ_DZIAL_ID)

tw_tworca_id <- tw_tworca_id %>%
  select(1,TW_TWORCA_ID = 2,TW_NAZWISKO = 3,TW_IMIE = 4)

tw_tworca_id <- tw_tworca_id[order(tw_tworca_id$licznik,tw_tworca_id$TW_TWORCA_ID,tw_tworca_id$TW_NAZWISKO,tw_tworca_id$TW_IMIE),]
tw_tworca_id <- tw_tworca_id %>%
  unique()
tw_tworca_id %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> tw_tworca_id$same
tw_tworca_id$same[1] <- 0
tw_tworca_id <- tw_tworca_id %>%
  filter(same==0) %>%
  select(-length(tw_tworca_id))
#10
tw_nazwisko <- tw_tworca_id
tw_nazwisko$TW_NAZWISKO[!is.na(tw_nazwisko$TW_TWORCA_ID)] <- NA
tw_nazwisko <- tw_nazwisko %>%
  select(licznik,TW_NAZWISKO)
#11
tw_imie <- tw_tworca_id
tw_imie$TW_IMIE[!is.na(tw_imie$TW_TWORCA_ID)] <- NA
tw_imie <- tw_imie %>%
  select(licznik,TW_IMIE)
#12
BN_PBL_tworca <- BN_PBL_tworca[order(BN_PBL_tworca$licznik,BN_PBL_tworca$TW_TWORCA_ID,BN_PBL_tworca$TW_NAZWISKO,BN_PBL_tworca$TW_IMIE),]
BN_PBL_tworca <- BN_PBL_tworca %>%
  unique()
BN_PBL_tworca %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_PBL_tworca$same
BN_PBL_tworca$same[1] <- 0
BN_PBL_tworca <- BN_PBL_tworca %>%
  filter(same==0) %>%
  select(-length(BN_PBL_tworca))

dz_nazwa_full <- BN_PBL_tworca
dz_nazwa_full <- dz_nazwa_full[order(dz_nazwa_full$licznik),]

#dział na podstawie literatury
literatura_BN <- BN_PBL_tworca %>%
    select(licznik,TW_TWORCA_ID,TW_NAZWISKO,TW_IMIE)

marc_field_655 <- data %>%
  select(licznik,X655)%>%
  filter(X655!="")
marc_field_655$X655<-str_replace_all(marc_field_655$X655,"(^|\\|)","~\\1")
marc_field_655<- cSplit(marc_field_655,"X655",sep = "~",direction = "long")
marc_field_655<- marc_field_655%>%
  filter(X655!="")
marc_field_655$X655<-str_remove_all(marc_field_655$X655,"^\\|")
marc_field_655 <- mutate(marc_field_655,
               indicator = str_replace_all(marc_field_655$X655,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X655,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_655)[1]))
colnames(empty_table) <-subfield_list

marc_field_655<-cbind(marc_field_655,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field_655$X655 <- str_replace(marc_field_655$X655,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field_655[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_655$X655),str_replace_all(gsub(string,"\\3",marc_field_655$X655),"\\${2}.", "~"),NA)
}

literatura_BN <- merge(x = literatura_BN, y = marc_field_655, by.x = "licznik",all.x = TRUE)
literatura_BN <- literatura_BN %>%
  select(1,2,3,4,X655 = 7)

tw_do_ustalenia <- literatura_BN %>%
  filter(is.na(TW_TWORCA_ID))

dz_osob_bez_teatr <- PBL_dz_osob_bez_teatru %>%
  select(1,2) %>%
  unique()

dz_osob_bez_teatr <- mutate(dz_osob_bez_teatr,
                              nazwa = substr(str_replace(dz_osob_bez_teatr$DZ_NAZWA, "(.*?\\()(.*?)(\\).*$)","\\2"),1,nchar(str_replace(dz_osob_bez_teatr$DZ_NAZWA, "(.*?\\()(.*?)(\\).*$)","\\2"))-1))

reczne <- data.frame(DZ_DZIAL_ID = c(697,697,697,697,825,1037,1187,1454,884,902,544,544,544,544),DZ_NAZWA = c("Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (grecka starożytna)","Hasła osobowe (łacińska starożytna)","Hasła osobowe (syryjska)","Hasła osobowe (esperanto)","Hasła osobowe (holenderska)","Hasła osobowe (Indii)","Hasła osobowe (Afryki Subsaharyjskiej)","Hasła osobowe (Afryki Subsaharyjskiej)","Hasła osobowe (Afryki Subsaharyjskiej)","Hasła osobowe (Afryki Subsaharyjskiej)"), redaktor_dzialu = c("BEATAK","BEATAK","BEATAK","BEATAK","BEATAS","BEATAS","BEATAD","CEZARY","TOMASZU","EWA","EWA","EWA","EWA","EWA"), nazwa = c("angielsk","szkock","irlandzk","walijsk","greck","łacińsk","syryjsk","esperanck","niderlandzk","indyjsk","południowoafryka","senegalsk","nigeryjsk","afrykańsk"))
reczne <- reczne %>%
  select(1,2,4)
dz_osob_bez_teatr <- rbind(dz_osob_bez_teatr,reczne)
dz_osob_bez_teatr$nazwa[dz_osob_bez_teatr$nazwa=="literatura polsk"] <- "polsk"

literatura_dz <- sqldf("select *
                            from tw_do_ustalenia a
                            left join dz_osob_bez_teatr b on a.X655 like ('%'||b.nazwa||'%')")

literatura_dz <- literatura_dz[order(literatura_dz$licznik,literatura_dz$TW_NAZWISKO,literatura_dz$TW_IMIE,literatura_dz$DZ_DZIAL_ID),]
literatura_dz %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> literatura_dz$same
literatura_dz$same[1] <- 0
literatura_dz <- literatura_dz %>%
  filter(same==0) %>%
  select(-length(literatura_dz))
test <- mutate(BN_PBL_tworca,
               polaczone = paste(BN_PBL_tworca$TW_TWORCA_ID,BN_PBL_tworca$licznik,BN_PBL_tworca$TW_NAZWISKO,BN_PBL_tworca$TW_IMIE,sep = "|"))
literatura_dz <- mutate(literatura_dz,
                        polaczone = paste(literatura_dz$TW_TWORCA_ID,literatura_dz$licznik,literatura_dz$TW_NAZWISKO,literatura_dz$TW_IMIE,sep = "|"))

test <- sqldf("select *
                            from test a
                            left join literatura_dz b on a.polaczone=b.polaczone")

test$TW_DZ_DZIAL_ID <- ifelse(is.na(test$TW_TWORCA_ID), test$DZ_DZIAL_ID,test$TW_DZ_DZIAL_ID)
test$DZ_NAZWA <- ifelse(is.na(test$TW_TWORCA_ID), test$DZ_NAZWA..14, test$DZ_NAZWA)
BN_PBL_tworca_full <- test %>%
  filter(!is.na(TW_DZ_DZIAL_ID)) %>%
  select(1:16)
test <- test %>%
  filter(is.na(TW_DZ_DZIAL_ID)) %>%
  select(1:16)

dz_nazwa_full <- BN_PBL_tworca_full %>%
  select(TW_TWORCA_ID,licznik,DZ_NAZWA, TW_DZ_DZIAL_ID, tw_imie=TW_IMIE, tw_nazwisko=TW_NAZWISKO)
dz_nazwa_full <- dz_nazwa_full[order(dz_nazwa_full$licznik),]

dz_nazwa <- dz_nazwa_full %>%
  select(licznik, DZ_NAZWA)
#13
dz_dzial_id <- dz_nazwa_full %>%
  select(licznik, DZ_DZIAL_ID=TW_DZ_DZIAL_ID)
#14
marc_field <- data %>%
  select(licznik,X245)#%>%
marc_field$X245<-str_remove_all(marc_field$X245,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X245 <- str_replace(marc_field$X245,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X245),str_replace_all(gsub(string,"\\3",marc_field$X245),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
marc_field$`$a`[is.na(marc_field$`$a`)] <- ""
za_tytul <- data.frame(tytul_bn = paste(marc_field$`$a`,marc_field$`$b`,sep = ""), licznik = marc_field$licznik)
za_tytul$tytul_bn <- str_remove(za_tytul$tytul_bn, "\\s+\\/$")
za_tytul <- mutate(za_tytul,
                   tytul = gsub("([a-zęóąśłżźćń])( )(:)( {0,1})(\\({0,1})([a-zęóąśłżźćńA-ZĘÓĄŚŁŻŹĆŃ])(.)","\\1.\\2\\U\\5\\6\\E\\7",perl = TRUE, za_tytul$tytul_bn))
za_tytul$tytul <- gsub("( )(:)( {0,1}[a-z])(.)","\\1\\U\\3\\E\\4",perl = TRUE, za_tytul$tytul)
za_tytul$tytul <- str_replace(za_tytul$tytul, "([^\\.])(\\.$)","\\1")
za_tytul <- za_tytul %>%
  select(2,3)
za_tytul_copy <- za_tytul

lista_gat_pbl <- data.frame(gatunek = c("aforyzm","album","antologia","autobiografia","dziennik","esej","felieton","inne","kazanie","list","miniatura prozą","opowiadanie","poemat","powieść","proza","proza poetycka","reportaż","rozmyślanie religijne","rysunek, obraz","scenariusz","szkic","tekst biblijny","tekst dramatyczny","wiersz","wspomnienie","wypowiedź"))

test <- data %>%
  select(licznik,X655,X650)
test2 <- sqldf("select *
              from test
              left join lista_gat_pbl on lower(test.X650) like '%'||lista_gat_pbl.gatunek||'%'")
test <- sqldf("select *
              from test
              left join lista_gat_pbl on lower(test.X655) like '%'||lista_gat_pbl.gatunek||'%'")
test <- test %>%
  select(licznik,gatunek)
test2 <- test2 %>%
  select(licznik,gatunek)
test <- rbind(test,test2)
test <- test %>%
  unique()
  
test <- test[order(test$licznik,test$gatunek),]
test %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> test$same
test$same[1] <- 0
test <- test %>%
  filter(same==0) %>%
  select(-length(test))

za_tytul <- merge(x=za_tytul,y=test, by = "licznik", all.x = TRUE)
za_tytul$tytul <- ifelse(!is.na(za_tytul$gatunek),paste(za_tytul$tytul,". [",gsub("(^.)","\\U\\1",perl = TRUE, za_tytul$gatunek),"]",sep = ""),za_tytul$tytul)
#15
marc_field <- data %>%
  select(licznik,X246)
marc_field$X246 <- str_replace_all(marc_field$X246,"(^|\\|)","~\\1")
marc_field <- cSplit(marc_field,"X246",sep = "~",direction = "long")
marc_field$X246<-str_remove_all(marc_field$X246,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X246,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X246,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X246 <- str_replace(marc_field$X246,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X246),str_replace_all(gsub(string,"\\3",marc_field$X246),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
colnames(marc_field)[7] <- "inna"
marc_field$`$a`[is.na(marc_field$`$a`)] <- ""
marc_field$`$b`[is.na(marc_field$`$b`)] <- ""
za_tytul_oryginalu <- marc_field %>%
  select(licznik,`$a`,`$b`,`$i`)
za_tytul_oryginalu <- mutate(za_tytul_oryginalu,
                             tytul = ifelse(grepl("yt\\.{0,1} oryg|yt\\.{0,1}oryg|yt\\.{0,1} org|ytu[lł] orygina",za_tytul_oryginalu$`$i`),paste(za_tytul_oryginalu$`$a`,za_tytul_oryginalu$`$b`,sep = ""),NA))

za_tytul_oryginalu <- za_tytul_oryginalu[order(za_tytul_oryginalu$licznik,za_tytul_oryginalu$tytul),]
za_tytul_oryginalu %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> za_tytul_oryginalu$same
za_tytul_oryginalu$same[1] <- 0
za_tytul_oryginalu <- za_tytul_oryginalu %>%
  filter(same==0) %>%
  select(-length(za_tytul_oryginalu))
za_tytul_oryginalu <- za_tytul_oryginalu %>%
  select(1,5)

za_tytul_oryginalu$tytul <- gsub("([a-zęóąśłżźćń])( )(:)( {0,1})(\\({0,1})([a-zęóąśłżźćńA-ZĘÓĄŚŁŻŹĆŃ])(.)","\\1.\\2\\U\\5\\6\\E\\7",perl = TRUE, za_tytul_oryginalu$tytul)
za_tytul_oryginalu$tytul <- gsub("( )(:)( {0,1}[a-z])(.)","\\1\\U\\3\\E\\4",perl = TRUE, za_tytul_oryginalu$tytul)
za_tytul_oryginalu$tytul <- str_replace(za_tytul_oryginalu$tytul, "([^\\.])(\\.$)","\\1")
#16
marc_field <- data %>%
  select(licznik,X041)
marc_field$X041<-str_remove_all(marc_field$X041,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X041,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X041,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X041 <- str_replace(marc_field$X041,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X041),str_replace_all(gsub(string,"\\3",marc_field$X041),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
za_jezyk_oryginalu <- marc_field %>%
  select(licznik,jezyk_oryginalu = `$a`)
za_jezyk_oryginalu$jezyk_oryginalu <- str_replace_all(za_jezyk_oryginalu$jezyk_oryginalu,"\\$a","|")
#17
BN_wspoltworca <- data.frame(wspoltworca = str_remove_all(as.character(str_extract_all(data$X245,"(?<=; )(.*)(?=$)")),"\\.$"), licznik = data$licznik)
BN_wspoltworca$wspoltworca <- str_remove_all(BN_wspoltworca$wspoltworca," et al\\.")
BN_wspoltworca <- mutate(BN_wspoltworca,
                         funkcja = as.character(str_extract_all(BN_wspoltworca$wspoltworca,"(?<=\\[)(.*?)(?= [A-ZÓŚŁŻŹĆŃ])")),
                         os_imie = as.character(str_extract_all(BN_wspoltworca$wspoltworca,"(?<= )(.*)(?= (?!.* ))")),
                         os_nazwisko = str_replace_all(BN_wspoltworca$wspoltworca,"(.*)( (?!.* ))(.*)(\\])", "\\3"))

ws_prosty <- paste(BN_wspoltworca$os_nazwisko,BN_wspoltworca$os_imie)
ws_prosty <- unlist(ws_prosty)
ws_prosty <- str_to_lower(ws_prosty)
ws_prosty <- str_replace_all(ws_prosty, "\\W", "")
ws_prosty <- list(ws_prosty)
ws_prosty <- data.frame(ws_prosty)
colnames(ws_prosty) <- "nazwa"

fu_prosta <- BN_wspoltworca$funkcja
fu_prosta <- unlist(fu_prosta)
fu_prosta <- str_to_lower(fu_prosta)
fu_prosta <- str_replace_all(fu_prosta, "\\W", "")
fu_prosta <- list(fu_prosta)
fu_prosta <- data.frame(fu_prosta)
colnames(fu_prosta) <- "nazwa"

ws_BN <- data.frame(licznik = BN_wspoltworca$licznik, os_nazwisko = BN_wspoltworca$os_nazwisko, os_imie = BN_wspoltworca$os_imie, nazwa_prosta = ws_prosty$nazwa, funkcja = BN_wspoltworca$funkcja, nazwa = fu_prosta$nazwa)

BN_PBL_wspoltworcy <- merge(x = ws_BN, y = PBL_wspoltworcy, by = 'nazwa_prosta', sort = FALSE, all.x = TRUE)

BN_PBL_wspoltworcy <- merge(x = BN_PBL_wspoltworcy, y = PBL_funkcje, by = 'nazwa', sort = FALSE, all.x = TRUE)

BN_PBL_wspoltworcy <- BN_PBL_wspoltworcy[order(as.integer(as.character(BN_PBL_wspoltworcy$licznik))),]

#nazwisko

b_os_nazwisko <- data.frame(os_nazwisko = ifelse(is.na(BN_PBL_wspoltworcy$OS_OSOBA_ID), as.character(BN_PBL_wspoltworcy$os_nazwisko), NA))
b_os_imie <- data.frame(os_imie = ifelse(is.na(BN_PBL_wspoltworcy$OS_OSOBA_ID), as.character(BN_PBL_wspoltworcy$os_imie), NA))

BN_PBL_osoby_funkcje <- data.frame(licznik = BN_PBL_wspoltworcy$licznik, os_osoba_id = BN_PBL_wspoltworcy$OS_OSOBA_ID, b_os_nazwisko, b_os_imie, fo_symbol = BN_PBL_wspoltworcy$fo_symbol, fo_nazwa = BN_PBL_wspoltworcy$fo_nazwa )

#22
za_opis_wspoltworcow <- data.frame(za_opis_wspoltworcow = gsub("(\\[)(.)(.*)", "\\1\\U\\2\\E\\3", perl = TRUE, BN_wspoltworca$wspoltworca), licznik = data$licznik)

#23
za_wydanie <- data.frame(data$X250)
za_wydanie <- data.frame(str_replace_all(za_wydanie[,1], "\\$aWyd\\. ",""))
za_wydanie <- data.frame(str_replace_all(za_wydanie[,1], ".\\$.*",""))
za_wydanie <- data.frame(str_replace_all(za_wydanie[,1], "(\\d)(\\.$)","\\1"))
za_wydanie <- cbind(za_wydanie, 1:lengths(za_wydanie))
colnames(za_wydanie) <- c("za_wydanie", "licznik")
#24
marc_field <- data %>%
  select(licznik,X245)
marc_field$X245<-str_replace_all(marc_field$X245,"(^|\\|)","~\\1")
marc_field<- cSplit(marc_field,"X245",sep = "~",direction = "long")
marc_field<- marc_field%>%
  filter(X245!="")
marc_field$X245<-str_remove_all(marc_field$X245,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X245 <- str_replace(marc_field$X245,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X245),str_replace_all(gsub(string,"\\3",marc_field$X245),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}

za_instytucja <- marc_field %>%
  select(licznik, X245 = `$c`)

za_instytucja <- za_instytucja[order(za_instytucja$licznik,za_instytucja$X245),]
za_instytucja %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> za_instytucja$same
za_instytucja$same[1] <- 0
za_instytucja <- za_instytucja %>%
  filter(same==0) %>%
  select(-length(za_instytucja))

za_instytucja <- mutate(za_instytucja,
                        instytucja = ifelse(grepl("\\;",za_instytucja$X245),str_replace_all(za_instytucja$X245, "(.*?)(\\;(?!.*\\;))( )+(.*?$)","\\4"),""))

za_instytucja <- merge(x=za_instytucja,y=BN_PBL_wspoltworcy,by = "licznik",all.x = TRUE)
za_instytucja <- za_instytucja %>%
  select(1,2,3,6,7)
za_instytucja <- mutate(za_instytucja,
                        czy_naz = str_detect(za_instytucja$X245,as.character(za_instytucja$os_nazwisko)),
                        czy_im = str_detect(za_instytucja$X245,as.character(za_instytucja$os_imie)))
test <- za_instytucja %>%
  filter(is.na(czy_naz)&is.na(czy_im)) %>%
  filter(instytucja!="") %>%
  filter(!(grepl("^\\[[a-zęóąśłżźćń]|^[a-zęóąśłżźćń]",instytucja))) %>%
  select(licznik,instytucja)
test$instytucja <- str_remove(test$instytucja,"(?<=[a-zęóąśłżźćń])(\\.$)")
za_instytucja <- test
test <- data %>%
  select(licznik)
za_instytucja <- merge(x=za_instytucja,y=test,by = "licznik", all = TRUE)
#25
BN_wydawnictwo <- data.frame(X260 = data$X260, licznik = data$licznik)
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"s\\.n\\.", "b.w.")
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"s\\.l\\.", "b.m.")
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"S\\.l\\.", "b.m.")
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"\\$f", "$c")
BN_wydawnictwo$X260 <- str_remove(BN_wydawnictwo$X260,"^\\\\+")
#ręcznie wygenerować i naprawić błąd ":$a" - powinno być albo ;$a, albo :$b
test <- mutate(BN_wydawnictwo,
               dwuk = str_detect(BN_wydawnictwo$X260,"\\:\\$a"))
test <- test %>%
  filter(dwuk==TRUE)
#BN_wydawnictwo$X260[BN_wydawnictwo$X260=="$aKraków :$bCollegium Columbinum ;$aWarszawa :$aTowarzystwo Badań nad Wiekiem Osiemnastym,$ccop. 2006."] <- "$aKraków :$bCollegium Columbinum ;$aWarszawa :$bTowarzystwo Badań nad Wiekiem Osiemnastym,$ccop. 2006."

BN_wydawnictwo <- mutate(BN_wydawnictwo,
                      rok_wydania = str_extract_all(BN_wydawnictwo$X260, "(?<=\\$c).*(?=\\$e)|(?<=\\$c).*"),
                      bez_roku = str_replace_all(BN_wydawnictwo$X260, ".\\$c.*", ""))

BN_wydawnictwo$bez_roku <- str_replace_all(BN_wydawnictwo$bez_roku, ";\\$b", ":$b")
BN_wydawnictwo <- mutate(BN_wydawnictwo,
                      ile_wydawnictw = str_count(BN_wydawnictwo$bez_roku, "\\$b"),
                      ile_miejsc = str_count(BN_wydawnictwo$bez_roku, "\\$a"),
                      kolejnosc = str_remove(str_replace_all(as.character(str_extract_all(BN_wydawnictwo$bez_roku, "\\$.")), "[^a-z]", ""),"^c"),
                      podzielone = str_replace_all(BN_wydawnictwo$bez_roku,"(\\$.)","|\\1~"))

BN_wydawnictwo$podzielone <- str_remove(BN_wydawnictwo$podzielone,"^\\|")
BN_wydawnictwo$kolejnosc <- str_replace_all(BN_wydawnictwo$kolejnosc,"(.)","\\1|")
BN_wydawnictwo$kolejnosc <- str_remove(BN_wydawnictwo$kolejnosc,"\\|$")
BN_wydawnictwo <- cSplit(BN_wydawnictwo,c("kolejnosc","podzielone"), sep = "|", direction = "long")

BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same
BN_wydawnictwo$same[1] <- 0
BN_wydawnictwo$rok_wydania <- as.character(BN_wydawnictwo$rok_wydania)
BN_wydawnictwo$lp <- 1:lengths(BN_wydawnictwo)
pierwsze <- BN_wydawnictwo %>%
  filter(same==0)
drugie <- BN_wydawnictwo %>%
  filter(same==1)
drugie <- ddply(drugie, .(X260, licznik, rok_wydania, bez_roku, ile_wydawnictw, ile_miejsc, kolejnosc, same), summarize, podzielone = paste(podzielone, collapse=""), lp = paste(lp, collapse="|"))
BN_wydawnictwo <- rbind(pierwsze,drugie)
BN_wydawnictwo$lp <- str_replace(BN_wydawnictwo$lp,"(.*?)(\\|)(.*$)","\\1")
BN_wydawnictwo$lp <- as.integer(BN_wydawnictwo$lp)
BN_wydawnictwo <- BN_wydawnictwo[order(BN_wydawnictwo$licznik,BN_wydawnictwo$lp),]
BN_wydawnictwo <- BN_wydawnictwo %>%
  select(-lp)
BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "b" & kolejnosc == dplyr::lead(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same2
BN_wydawnictwo$same2[length(BN_wydawnictwo$podzielone)] <- 0

BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "a" & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same_a
BN_wydawnictwo$same_a[1] <- 0

BN_wydawnictwo$podzielone3 <- lead(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo$same_a2 <- lead(BN_wydawnictwo$same_a,n=1)
BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same_a2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone3,sep = ""),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- BN_wydawnictwo %>%
  filter(same_a==0)
BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)

BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same==0&BN_wydawnictwo$same2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone2,sep = "|"),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- cSplit(BN_wydawnictwo,"podzielone", sep = "|", direction = "long")
BN_wydawnictwo$bez_roku <- BN_wydawnictwo$podzielone
BN_wydawnictwo <- BN_wydawnictwo %>%
  select(licznik,rok_wydania,X260,bez_roku)
BN_wydawnictwo$rok_wydania <- as.character(BN_wydawnictwo$rok_wydania)
BN_wydawnictwo <- ddply(BN_wydawnictwo, .(licznik, rok_wydania, X260), summarize, bez_roku = paste(bez_roku, collapse=""))
BN_wydawnictwo$bez_roku <- str_remove_all(BN_wydawnictwo$bez_roku,"\\~")
#drugi raz
BN_wydawnictwo$bez_roku <- str_replace_all(BN_wydawnictwo$bez_roku, ";\\$b", ":$b")
BN_wydawnictwo <- mutate(BN_wydawnictwo,
                      ile_wydawnictw = str_count(BN_wydawnictwo$bez_roku, "\\$b"),
                      ile_miejsc = str_count(BN_wydawnictwo$bez_roku, "\\$a"),
                      kolejnosc = str_remove(str_replace_all(as.character(str_extract_all(BN_wydawnictwo$bez_roku, "\\$.")), "[^a-z]", ""),"^c"),
                      podzielone = str_replace_all(BN_wydawnictwo$bez_roku,"(\\$.)","|\\1~"))

BN_wydawnictwo$podzielone <- str_remove(BN_wydawnictwo$podzielone,"^\\|")
BN_wydawnictwo$kolejnosc <- str_replace_all(BN_wydawnictwo$kolejnosc,"(.)","\\1|")
BN_wydawnictwo$kolejnosc <- str_remove(BN_wydawnictwo$kolejnosc,"\\|$")
BN_wydawnictwo <- cSplit(BN_wydawnictwo,c("kolejnosc","podzielone"), sep = "|", direction = "long")
BN_wydawnictwo <- BN_wydawnictwo %>%
  filter(!is.na(podzielone))

BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same
BN_wydawnictwo$same[1] <- 0

BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "b" & kolejnosc == dplyr::lead(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same2
BN_wydawnictwo$same2[length(BN_wydawnictwo$podzielone)] <- 0

BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "a" & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same_a
BN_wydawnictwo$same_a[1] <- 0

BN_wydawnictwo$podzielone3 <- lead(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo$same_a2 <- lead(BN_wydawnictwo$same_a,n=1)
BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same_a2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone3,sep = ""),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- BN_wydawnictwo %>%
  filter(same_a==0)
BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)

BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same==0&BN_wydawnictwo$same2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone2,sep = "|"),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- cSplit(BN_wydawnictwo,"podzielone", sep = "|", direction = "long")
BN_wydawnictwo$bez_roku <- BN_wydawnictwo$podzielone
BN_wydawnictwo <- BN_wydawnictwo %>%
  select(licznik,rok_wydania,X260,bez_roku)
BN_wydawnictwo$rok_wydania <- as.character(BN_wydawnictwo$rok_wydania)
BN_wydawnictwo$czy <- str_detect(BN_wydawnictwo$bez_roku,"\\$a")
BN_wydawnictwo$bez_roku <- ifelse(BN_wydawnictwo$czy==TRUE,paste("|",BN_wydawnictwo$bez_roku,sep = ""),as.character(BN_wydawnictwo$bez_roku))
BN_wydawnictwo <- ddply(BN_wydawnictwo, .(licznik, rok_wydania, X260), summarize, bez_roku = paste(bez_roku, collapse=""))
BN_wydawnictwo$bez_roku <- str_remove_all(BN_wydawnictwo$bez_roku,"\\~")
BN_wydawnictwo$bez_roku <- str_remove_all(BN_wydawnictwo$bez_roku,"^\\|")

BN_wydawnictwo <- cSplit(BN_wydawnictwo, "bez_roku", sep = "|", direction = "long")
BN_wydawnictwo <- mutate(BN_wydawnictwo,
                  wydawnictwo = str_extract_all(BN_wydawnictwo$bez_roku, "(?<=\\$b)(.*)"),
                  miejsce_wydania = str_replace_all(str_extract_all(BN_wydawnictwo$bez_roku, "(?<=\\$a)(.*)(?= {0,1}: {0,1}\\$b)|(?<=\\$a)(.*)($)")," ;\\$a", ", "),
                  nazwa_prosta = str_to_lower(str_replace_all(str_replace_all(unlist(BN_wydawnictwo$bez_roku), "\\$\\w", ""), "\\W", "")),
                  lp = 1:lengths(BN_wydawnictwo))
BN_wydawnictwo$wydawnictwo <- str_remove(BN_wydawnictwo$wydawnictwo,"\\s+\\;$")
BN_wydawnictwo$wydawnictwo <- str_remove(BN_wydawnictwo$wydawnictwo,"\\s+\\:$")

BN_wydawnictwo$miejsce_wydania <- str_remove(BN_wydawnictwo$miejsce_wydania," \\[{0,10}etc\\.{0,10}\\]\\s{0,10}$")
BN_wydawnictwo$miejsce_wydania <- str_remove(BN_wydawnictwo$miejsce_wydania," \\[{0,10}etc\\.{0,10}\\s{0,10}$")
BN_wydawnictwo$miejsce_wydania <- ifelse(grepl("\\[",BN_wydawnictwo$miejsce_wydania)&!grepl("\\]",BN_wydawnictwo$miejsce_wydania),str_remove(BN_wydawnictwo$miejsce_wydania,"\\["),as.character(BN_wydawnictwo$miejsce_wydania))
BN_wydawnictwo$wydawnictwo <- ifelse(grepl("\\]",BN_wydawnictwo$wydawnictwo)&!grepl("\\[",BN_wydawnictwo$wydawnictwo),str_remove(BN_wydawnictwo$wydawnictwo,"\\]"),as.character(BN_wydawnictwo$wydawnictwo))
BN_PBL_wydawnictwa <- merge( x = BN_wydawnictwo, y = PBL_wydawnictwa, by = 'nazwa_prosta', sort = FALSE, all.x = TRUE, allow.cartesian = TRUE)
BN_PBL_wydawnictwa$to_samo <- BN_PBL_wydawnictwa$wydawnictwo==BN_PBL_wydawnictwa$WY_NAZWA
BN_PBL_wydawnictwa <- BN_PBL_wydawnictwa[order(as.integer(as.character(BN_PBL_wydawnictwa$licznik)), -BN_PBL_wydawnictwa$to_samo, -BN_PBL_wydawnictwa$WY_LICZBA_ZAPISOW),]

BN_PBL_wydawnictwa %$%  
    { as.integer(licznik) == dplyr::lag(as.integer(licznik), 1) & nazwa_prosta==lag(nazwa_prosta)} %>% 
    as.numeric() %>% 
    {.} -> BN_PBL_wydawnictwa$same
BN_PBL_wydawnictwa$same[1] <- 0

BN_PBL_wydawnictwa <- BN_PBL_wydawnictwa %>%
  filter(same==0)

wy_wydawnictwo_id <- BN_PBL_wydawnictwa %>%
  select(licznik, WY_WYDAWNICTWO_ID)

wy_wydawnictwo_id <- wy_wydawnictwo_id[order(as.integer(as.character(wy_wydawnictwo_id$licznik))),]
#26
wy_miejsce <- BN_PBL_wydawnictwa %>%
  select(licznik, WY_WYDAWNICTWO_ID,miejsce_wydania)
wy_miejsce$miejsce_wydania <- ifelse(is.na(wy_miejsce$WY_WYDAWNICTWO_ID),as.character(wy_miejsce$miejsce_wydania),"")

#27
wy_nazwa <- BN_PBL_wydawnictwa %>%
  select(licznik, WY_WYDAWNICTWO_ID,wydawnictwo)
wy_nazwa$wydawnictwo <- ifelse(is.na(wy_miejsce$WY_WYDAWNICTWO_ID),as.character(wy_nazwa$wydawnictwo),"")

#28
za_rok_wydania <- BN_PBL_wydawnictwa %>%
  select(licznik, rok_wydania) %>%
  unique()
za_rok_wydania$rok_wydania <- str_replace_all(za_rok_wydania$rok_wydania, "(.*)(\\.)", "\\1")
za_rok_wydania$dobry_rok <- ifelse(nchar(as.character(za_rok_wydania$rok_wydania))==4,as.character(za_rok_wydania$rok_wydania),NA)
za_rok_wydania$do_opisu <- ifelse(is.na(za_rok_wydania$dobry_rok),paste("[",str_extract(za_rok_wydania$rok_wydania,"\\d{4}"),"]",sep = ""),"")
#29
marc_field300 <- data %>%
  select(licznik,X300)
marc_field300$X300<-str_remove_all(marc_field300$X300,"^\\|")
marc_field300 <- mutate(marc_field300,
               indicator = str_replace_all(marc_field300$X300,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X300,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field300)[1]))
colnames(empty_table) <-subfield_list

marc_field300<-cbind(marc_field300,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field300$X300 <- str_replace(marc_field300$X300,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field300[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field300$X300),str_replace_all(gsub(string,"\\3",marc_field300$X300),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
marc_field300$`$a` <- str_remove(marc_field300$`$a`," \\;+$| \\:+$")
marc_field300$`$a`[is.na(marc_field300$`$a`)] <- ""

za_opis_ks <- data.frame(opis_ks = paste(za_rok_wydania$do_opisu, marc_field300$`$a`,marc_field300$`$b`,sep = ", "), licznik = as.integer(za_rok_wydania$licznik))
za_opis_ks$opis_ks <- str_replace(za_opis_ks$opis_ks,", , ", ", ")
za_opis_ks$opis_ks <- str_replace(za_opis_ks$opis_ks,", , ", ", ")
za_opis_ks$opis_ks <- str_remove_all(za_opis_ks$opis_ks, "^, |, $")
wsp_info <- data.frame(wsp = paste("[Współwyd.: ",BN_autor$autorzy,": ",za_tytul_copy$tytul,"]", sep = ""), za_uwagi)
wsp_info$za_uwagi <- str_remove_all(wsp_info$za_uwagi,"_2")
wsp_info %$%  
    { za_uwagi == dplyr::lag(za_uwagi, 1)} %>% 
    as.numeric() %>% 
    {.} -> wsp_info$same
wsp_info$same[1] <- 0
wsp_info <- data.frame(wsp_info, za_uwagi)
wsp_info$za_uwagi <- ifelse(grepl("_2", wsp_info$za_uwagi.1), as.character(wsp_info$za_uwagi),paste(wsp_info$za_uwagi,"_2",sep = ""))

wsp_info <- wsp_info %>%
  select(1,2)
wsp_info <- merge(x=wsp_info, y=za_uwagi, by = "za_uwagi")
wsp_info <- wsp_info %>%
  select(2,3)
za_opis_fizyczny_ksiazki <- merge(x=za_opis_ks,y=wsp_info, by = "licznik",all = TRUE)
za_opis_fizyczny_ksiazki <- data.frame(za_opis_fizyczny_ksiazki = paste(str_replace_all(za_opis_fizyczny_ksiazki$opis_ks,"(.*)(cm\\.)(.*)", "\\1\\2"), za_opis_fizyczny_ksiazki$wsp, sep = " "), licznik = za_opis_fizyczny_ksiazki$licznik)

#30
marc_field490 <- data %>%
  select(licznik,X490)
marc_field490 <- cSplit(marc_field490,"X490",sep = "|",direction = "long")
marc_field490 <- marc_field490%>%
  filter(X490!="")
marc_field490$X490<-str_remove_all(marc_field490$X490,"^\\|")
marc_field490 <- mutate(marc_field490,
               indicator = str_replace_all(marc_field490$X490,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X490,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field490)[1]))
colnames(empty_table) <-subfield_list

marc_field490<-cbind(marc_field490,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field490$X490 <- str_replace(marc_field490$X490,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field490[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field490$X490),str_replace_all(gsub(string,"\\3",marc_field490$X490),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}

marc_field490$`$a` <- str_remove(marc_field490$`$a`," \\;+$| \\:+$")
marc_field490$`$a`[is.na(marc_field490$`$a`)] <- ""
marc_field490$`$v`[is.na(marc_field490$`$v`)] <- ""
marc_field490$seria <- str_remove(paste("(",marc_field490$`$a`,", ",marc_field490$`$v`,")",sep = ""),", (?=\\)$)")

marc_field490 <- marc_field490 %>%
  select(licznik,seria)

marc_field490 <- ddply(marc_field490, .(licznik), summarize, seria = paste(seria, collapse=" "))
test <- data %>%
  select(licznik)
za_seria_wydawnicza <- merge(x = test, y = marc_field490, by = "licznik", all = TRUE)
#31
za_tomy <-data.frame(licznik=1:lengths(data), za_tomy = NA)
#32
pracownik <- merge(x = dz_nazwa_full, y = redaktorzy_dzialow, by.x = "TW_DZ_DZIAL_ID", by.y =  "DZ_DZIAL_ID", all.x = TRUE)
pracownik <- pracownik[order(as.integer(as.character(pracownik$licznik))),]
pracownik <- pracownik %>%
  select(licznik,redaktor_dzialu)
colnames(pracownik) <- c("licznik", "pracownik")

dz_nazwa_full <- data.frame(dz_nazwa_full, pracownik = pracownik$pracownik)
#33 adnotacje
za_adnotacje <- data.frame(cbind(data$licznik, data$X505))
colnames(za_adnotacje) <- c("licznik","X505")
za_adnotacje$X505 <- ifelse(is.na(za_adnotacje$X505),"",as.character(za_adnotacje$X505))
za_adnotacje$adnotacje <- paste(za_adnotacje$adnotacje,za_adnotacje$X505,sep = "|")
za_adnotacje$adnotacje[za_adnotacje$adnotacje=="|"] <- ""
za_adnotacje <- za_adnotacje %>%
  select(1,2)
#łączenie
#wyrównanie liczby wierszy
autorzy <- data.frame(cbind(am_autor_id$licznik,am_autor_id$AM_AUTOR_ID,as.character(am_nazwisko$am_nazwisko),as.character(am_imie$am_imie)))
colnames(autorzy) <- c("licznik", "AM_AUTOR_ID", "AM_NAZWISKO", "AM_IMIE")
autorzy$AM_AUTOR_ID <- ifelse(is.na(autorzy$AM_AUTOR_ID),"",as.character(autorzy$AM_AUTOR_ID))
autorzy$AM_NAZWISKO <- ifelse(is.na(autorzy$AM_NAZWISKO),"",as.character(autorzy$AM_NAZWISKO))
autorzy$AM_IMIE <- ifelse(is.na(autorzy$AM_IMIE),"",as.character(autorzy$AM_IMIE))
autorzy <- ddply(autorzy, .(licznik), summarize, AM_AUTOR_ID = paste(AM_AUTOR_ID, collapse="|"), AM_NAZWISKO = paste(AM_NAZWISKO, collapse="|"), AM_IMIE = paste(AM_IMIE, collapse="|"))
autorzy <- autorzy[order(as.integer(as.character(autorzy$licznik))),]

wspoltworcy <- data.frame(cbind(BN_PBL_wspoltworcy$licznik, BN_PBL_wspoltworcy$OS_OSOBA_ID,as.character(b_os_nazwisko$os_nazwisko),as.character(b_os_imie$os_imie),BN_PBL_wspoltworcy$fo_symbol))
colnames(wspoltworcy) <- c("licznik", "OS_OSOBA_ID", "OS_NAZWISKO", "OS_IMIE", "FO_SYMBOL")
wspoltworcy$OS_OSOBA_ID <- ifelse(is.na(wspoltworcy$OS_OSOBA_ID),"",as.character(wspoltworcy$OS_OSOBA_ID))
wspoltworcy$OS_NAZWISKO <- ifelse(is.na(wspoltworcy$OS_NAZWISKO),"",as.character(wspoltworcy$OS_NAZWISKO))
wspoltworcy$OS_IMIE <- ifelse(is.na(wspoltworcy$OS_IMIE),"",as.character(wspoltworcy$OS_IMIE))
wspoltworcy$FO_SYMBOL <- ifelse(is.na(wspoltworcy$FO_SYMBOL),"",as.character(wspoltworcy$FO_SYMBOL))
wspoltworcy <- ddply(wspoltworcy, .(licznik), summarize, OS_OSOBA_ID = paste(OS_OSOBA_ID, collapse="|"), OS_NAZWISKO = paste(OS_NAZWISKO, collapse="|"), OS_IMIE = paste(OS_IMIE, collapse="|"), FO_SYMBOL = paste(FO_SYMBOL, collapse="|"))
wspoltworcy <- wspoltworcy[order(as.integer(as.character(wspoltworcy$licznik))),]

wydawnictwa <- data.frame(cbind(wy_wydawnictwo_id$licznik, wy_wydawnictwo_id$WY_WYDAWNICTWO_ID,wy_nazwa$wydawnictwo,wy_miejsce$miejsce_wydania))
colnames(wydawnictwa) <- c("licznik", "WY_WYDAWNICTWO_ID", "WY_NAZWA", "WY_MIEJSCE")
wydawnictwa$WY_WYDAWNICTWO_ID <- ifelse(is.na(wydawnictwa$WY_WYDAWNICTWO_ID),"",as.character(wydawnictwa$WY_WYDAWNICTWO_ID))
wydawnictwa$WY_NAZWA <- ifelse(is.na(wydawnictwa$WY_NAZWA),"",as.character(wydawnictwa$WY_NAZWA))
wydawnictwa$WY_MIEJSCE <- ifelse(is.na(wydawnictwa$WY_MIEJSCE),"",as.character(wydawnictwa$WY_MIEJSCE))
wydawnictwa <- ddply(wydawnictwa, .(licznik), summarize, WY_WYDAWNICTWO_ID = paste(WY_WYDAWNICTWO_ID, collapse="|"), WY_NAZWA = paste(WY_NAZWA, collapse="|"), WY_MIEJSCE = paste(WY_MIEJSCE, collapse="|"))
wydawnictwa <- wydawnictwa[order(as.integer(as.character(wydawnictwa$licznik))),]

polaczone <- data.frame(
  licznik = za_uwagi$licznik,
  rekord_BN = za_uwagi$za_uwagi,
  rz_nazwa = rz_nazwa$rz_nazwa,
  za_ro_rok = za_ro_rok$za_ro_rok,
  za_type = za_type$za_type,
  rz_rodzaj_id = rz_rodzaj_id$RZ_RODZAJ_ID,
  DZ_NAZWA = dz_nazwa$DZ_NAZWA,
  DZ_DZIAL_ID = dz_dzial_id$DZ_DZIAL_ID,
  tw_tworca_id = tw_tworca_id$TW_TWORCA_ID,
  am_autor_id = autorzy$AM_AUTOR_ID,
  am_nazwisko = autorzy$AM_NAZWISKO,
  am_imie = autorzy$AM_IMIE,
  za_tytul = za_tytul$tytul,
  za_tytul_oryginalu = za_tytul_oryginalu$tytul,
  za_jezyk_oryginalu = za_jezyk_oryginalu$jezyk_oryginalu,
  os_osoba_id = wspoltworcy$OS_OSOBA_ID,
  os_nazwisko = wspoltworcy$OS_NAZWISKO,
  os_imie = wspoltworcy$OS_IMIE,
  fo_symbol = wspoltworcy$FO_SYMBOL,
  za_opis_wspoltworcow = za_opis_wspoltworcow$za_opis_wspoltworcow,
  za_wydanie = za_wydanie$za_wydanie,
  za_tomy = za_tomy$za_tomy,
  za_instytucja = za_instytucja$instytucja,
  wy_wydawnictwo_id = wydawnictwa$WY_WYDAWNICTWO_ID,
  wy_miejsce = wydawnictwa$WY_MIEJSCE,
  wy_nazwa = wydawnictwa$WY_NAZWA,
  za_rok_wydania = za_rok_wydania$dobry_rok,
  za_opis_fizyczny_ksiazki = za_opis_fizyczny_ksiazki$za_opis_fizyczny_ksiazki,
  za_seria_wydawnicza = za_seria_wydawnicza$seria,
  tw_nazwisko = tw_nazwisko$TW_NAZWISKO,
  tw_imie = tw_imie$TW_IMIE,
  pracownik = pracownik$pracownik,
  za_adnotacje = za_adnotacje$X505
)

out <- cSplit(polaczone, c("am_autor_id", "am_nazwisko", "am_imie","os_osoba_id","os_nazwisko", "os_imie", "fo_symbol","wy_wydawnictwo_id","wy_miejsce","wy_nazwa"),sep = "|",direction = "long")
out <- out %>%
  unique()
out$licznik <- ifelse(is.na(out$licznik),'',as.character(out$licznik))
out$rekord_BN <- ifelse(is.na(out$rekord_BN),'',as.character(out$rekord_BN))
out$rz_nazwa <- ifelse(is.na(out$rz_nazwa),'',as.character(out$rz_nazwa))
out$za_ro_rok <- ifelse(is.na(out$za_ro_rok),'',as.character(out$za_ro_rok))
out$za_type <- ifelse(is.na(out$za_type),'',as.character(out$za_type))
out$rz_rodzaj_id <- ifelse(is.na(out$rz_rodzaj_id),'',as.character(out$rz_rodzaj_id))
out$DZ_NAZWA <- ifelse(is.na(out$DZ_NAZWA),'',as.character(out$DZ_NAZWA))
out$DZ_DZIAL_ID <- ifelse(is.na(out$DZ_DZIAL_ID),'',as.character(out$DZ_DZIAL_ID))
out$tw_tworca_id <- ifelse(is.na(out$tw_tworca_id),'',as.character(out$tw_tworca_id))
out$am_autor_id <- ifelse(is.na(out$am_autor_id),'',as.character(out$am_autor_id))
out$am_nazwisko <- ifelse(is.na(out$am_nazwisko),'',as.character(out$am_nazwisko))
out$am_imie <- ifelse(is.na(out$am_imie),'',as.character(out$am_imie))
out$za_tytul <- ifelse(is.na(out$za_tytul),'',as.character(out$za_tytul))
out$za_tytul_oryginalu <- ifelse(is.na(out$za_tytul_oryginalu),'',as.character(out$za_tytul_oryginalu))
out$za_jezyk_oryginalu <- ifelse(is.na(out$za_jezyk_oryginalu),'',as.character(out$za_jezyk_oryginalu))
out$os_osoba_id <- ifelse(is.na(out$os_osoba_id),'',as.character(out$os_osoba_id))
out$os_nazwisko <- ifelse(is.na(out$os_nazwisko),'',as.character(out$os_nazwisko))
out$os_imie <- ifelse(is.na(out$os_imie),'',as.character(out$os_imie))
out$fo_symbol <- ifelse(is.na(out$fo_symbol),'',as.character(out$fo_symbol))
out$za_opis_wspoltworcow <- ifelse(is.na(out$za_opis_wspoltworcow),'',as.character(out$za_opis_wspoltworcow))
out$za_wydanie <- ifelse(is.na(out$za_wydanie),'',as.character(out$za_wydanie))
out$za_tomy <- ifelse(is.na(out$za_tomy),'',as.character(out$za_tomy))
out$za_instytucja <- ifelse(is.na(out$za_instytucja),'',as.character(out$za_instytucja))
out$wy_wydawnictwo_id <- ifelse(is.na(out$wy_wydawnictwo_id),'',as.character(out$wy_wydawnictwo_id))
out$wy_miejsce <- ifelse(is.na(out$wy_miejsce),'',as.character(out$wy_miejsce))
out$wy_nazwa <- ifelse(is.na(out$wy_nazwa),'',as.character(out$wy_nazwa))
out$za_rok_wydania <- ifelse(is.na(out$za_rok_wydania),'',as.character(out$za_rok_wydania))
out$za_opis_fizyczny_ksiazki <- ifelse(is.na(out$za_opis_fizyczny_ksiazki),'',as.character(out$za_opis_fizyczny_ksiazki))
out$za_seria_wydawnicza <- ifelse(is.na(out$za_seria_wydawnicza),'',as.character(out$za_seria_wydawnicza))
out$tw_nazwisko <- ifelse(is.na(out$tw_nazwisko),'',as.character(out$tw_nazwisko))
out$tw_imie <- ifelse(is.na(out$tw_imie),'',as.character(out$tw_imie))
out$pracownik <- ifelse(is.na(out$pracownik),'',as.character(out$pracownik))
out$za_adnotacje <- ifelse(is.na(out$za_adnotacje),'',as.character(out$za_adnotacje))

out %$%  
    { licznik == dplyr::lag(licznik, 1) & rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,)} %>% 
    as.numeric() %>% 
    {.} -> out$same
out$same[1] <- 0
out$dzielone <- paste(out$am_autor_id,out$am_nazwisko,out$am_imie,out$os_osoba_id,out$os_nazwisko,out$os_imie,out$fo_symbol,out$wy_wydawnictwo_id,out$wy_miejsce,out$wy_nazwa,sep = "")

out <- out %>%
  filter(!(same==1&dzielone=="")) %>%
  select(1:33)

out %$%  
    { licznik == dplyr::lag(licznik, 1) & rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,)} %>% 
    as.numeric() %>% 
    {.} -> out$same

out$rekord_BN[out$same == 1] <- ""
out$rz_nazwa[out$same == 1] <- ""
out$za_ro_rok[out$same == 1] <- ""
out$za_type[out$same == 1] <- ""
out$rz_rodzaj_id[out$same == 1] <- ""
out$DZ_NAZWA[out$same == 1] <- ""
out$DZ_DZIAL_ID[out$same == 1] <- ""
out$tw_tworca_id[out$same == 1] <- ""
out$za_tytul[out$same == 1] <- ""
out$za_tytul_oryginalu[out$same == 1] <- ""
out$za_jezyk_oryginalu[out$same == 1] <- ""
out$za_opis_wspoltworcow[out$same == 1] <- ""
out$za_wydanie[out$same == 1] <- ""
out$za_tomy[out$same == 1] <- ""
out$za_instytucja[out$same == 1] <- ""
out$za_rok_wydania[out$same == 1] <- ""
out$za_opis_fizyczny_ksiazki[out$same == 1] <- ""
out$za_seria_wydawnicza[out$same == 1] <- ""
out$tw_nazwisko[out$same == 1] <- ""
out$tw_imie[out$same == 1] <- ""
out$pracownik[out$same == 1] <- ""
out$za_adnotacje[out$same == 1] <- ""

out <- out %>%
  select(1:33)
write.csv2(out, "C:/Users/Cezary/Desktop/2005-2008_harlequiny_do_importu.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')
#out <- read.csv2("C:/Users/Cezary/Desktop/2005-2008_podmiotowa_do_importu.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE)
#out$rekord_BN <- ifelse(is.na(out$rekord_BN),"", as.character(out$rekord_BN))
#out$rekord_BN <- ifelse(nchar(out$rekord_BN)==13,out$rekord_BN, sprintf("%013d", as.integer(out$rekord_BN)))
#out$rekord_BN[out$rekord_BN=="           NA"] <- ""



```

```{r przygotowanie pliku do masowego nadpisania rekordów w bazie}
#może nie ma sensu zapisywać tych plików wcześniej, tylko teraz je połaczyć?
#to muszą mieć inną nazwę
#a może zrobić pętlę z wczytaniem, że się pliki dodają? - fajne, ale to pierwsze bardziej praktyczne

```

```{r przygotowanie list pracowników}
#docelowo przygotowujemy plik od razu na dysk, ale na razie xlsx do wgrania na dysk
#po tym przygotować na dysku unikatowe linki


#bn_ok + numer zapisu pozyskany na podstawie wyszukania w bazie danych

#docelowo będziemy tworzyć listy pracowników od razu na dysku, na razie funkcja tworzenia jest ciągle rozwijana przez twórców pakietu, więc póki co zostaje xslx
kolejnosc <- c("pracownik","ZA_ZAPIS_ID","typ_ksiazki","link","link_1","rok","status","blad_w_imporcie_tytulu","X100","X245","X650","X655","X246","X250","X260","X300","X380","X490","X500","X501","X546","X600","X700","X041","X080")
test <- bn_ok %>%
  select(pracownik = redaktor_dzialu,typ_ksiazki = rodzaj_ksiazki,link = BN_URL, rok, X100, X245, X650, X655, X246, X250, X260, X300, X490, X500, X501, X546, X600, X700, X041, X080) %>%
  mutate(link_1 = paste("=HYPERLINK(\"",link,"\";\"link do książki w BN\")",sep = ""),
         blad_w_imporcie_tytulu = FALSE)

#tutaj wyszukanie bazy, które da id zapisu i status, potem merge i select%>%
  select(noquote(kolejnosc))

#ZA_ZAPIS_ID,status pobrane z bazy tuż po imporcie
#pracownik	ZA_ZAPIS_ID	typ_ksiazki	link	link	rok	status	blad_w_imporcie_tytulu	X100	X245	X650	X655	X246	X250	X260	X300	X380	X490	X500	X501	X546	X600	X700	X041	X080

```

```{r książki współwydane harlequiny}
data <- harlequiny
data$X245 <- str_replace_all(data$X245, "\\]\\. ", "]|$a")
data$X245 <- str_replace_all(data$X245, "\\/[^\\$]", "/$c")
data <- cSplit(data, c("X245", "X246"), sep = "|", direction = "long")
data <- data.frame(data, licznik = 1:length(data$id))

#uwolnienie kolumn z danymi z bn i przetworzenie do PBL
#1
za_uwagi <- data %>%
  select(za_uwagi = id, licznik)
za_uwagi$za_uwagi <- str_replace_all(za_uwagi$za_uwagi," ","0")
za_uwagi$za_uwagi <- ifelse(nchar(za_uwagi$za_uwagi)==13,za_uwagi$za_uwagi, sprintf("%013d", as.integer(za_uwagi$za_uwagi)))

za_uwagi %$%  
    { za_uwagi == dplyr::lag(za_uwagi, 1)} %>% 
    as.numeric() %>% 
    {.} -> za_uwagi$same
za_uwagi$same[1] <- 0
za_uwagi$za_uwagi <- ifelse(za_uwagi$same==1,paste(za_uwagi$za_uwagi,"_2", sep = ""),za_uwagi$za_uwagi)

za_uwagi <- za_uwagi %>%
  select(1,2)
#2
rz_nazwa <- data.frame(rz_nazwa = rep("książka twórcy (podmiotowa)", length(1:length(za_uwagi$za_uwagi))))
rz_nazwa <- data.frame(rz_nazwa = rz_nazwa$rz_nazwa, licznik = 1:lengths(rz_nazwa))
#3
za_ro_rok <- data %>%
  select(za_ro_rok = rok, licznik)
#4
za_type <- data.frame(licznik = data$licznik, za_type = "KS")
#5
rz_rodzaj_id <- merge(x = rz_nazwa, y = PBL_rodzaje_zapisow, by.x = 'rz_nazwa', by.y = 'RZ_NAZWA', sort = FALSE,all.x = TRUE)
rz_rodzaj_id <- rz_rodzaj_id[order(rz_rodzaj_id$licznik),]
rz_rodzaj_id <- rz_rodzaj_id %>%
  select(RZ_RODZAJ_ID, licznik)
#6
BN_autor <- data.frame(autorzy = as.character(str_extract_all(data$X245, "(?<=\\/\\$c)(.*)(?= ;)")), licznik = data$licznik)
BN_autor <- mutate(BN_autor,
                   nazwa = str_replace_all(str_to_lower(BN_autor$autorzy), "\\W", ""))

nazwa2 <- ifelse(is.na(PBL_autorzy$AM_IMIE),as.character(PBL_autorzy$AM_NAZWISKO),paste(PBL_autorzy$AM_IMIE,PBL_autorzy$AM_NAZWISKO, sep = ""))
nazwa2 <- data.frame(nazwa2 = str_to_lower(str_replace_all(nazwa2, "\\W", "")))
nazwa2 <- data.frame(nazwa2 = str_replace_all(str_to_lower(nazwa2$nazwa2), "\\W", ""))
PBL_autorzy <- data.frame(PBL_autorzy, nazwa2 = nazwa2$nazwa2)
PBL_autorzy <- PBL_autorzy %>%
  filter(nazwa2 != "nana")

BN_PBL_autor <- merge(x = BN_autor, y = PBL_autorzy, by.x = 'nazwa', by.y = 'nazwa2', sort = FALSE, all.x = TRUE)
BN_PBL_autor <- BN_PBL_autor[order(BN_PBL_autor$licznik, BN_PBL_autor$AM_AUTOR_ID),]

BN_PBL_autor <- BN_PBL_autor[order(BN_PBL_autor$licznik, -BN_PBL_autor$AM_LICZBA_ZAPISOW),]

BN_PBL_autor %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_PBL_autor$same
BN_PBL_autor$same[1] <- 0

BN_PBL_autor <- BN_PBL_autor %>%
  filter(same==0) %>%
  select(1:14)
colnames(BN_PBL_autor)[14] <- "nazwa_naz_im"
BN_autor_podzielony <- data.frame(autor = str_replace_all(BN_autor$autorzy, "( (?!.* ))","|"), licznik = BN_autor$licznik)
BN_autor_podzielony <- cSplit(BN_autor_podzielony, c("autor"), sep = "|", direction = "wide")
BN_PBL_autor <- merge(BN_PBL_autor,BN_autor_podzielony,by = "licznik", all = TRUE)

am_autor_id <- BN_PBL_autor %>%
  select(licznik, AM_AUTOR_ID)
#7
am_nazwisko <- data.frame(nazwisko = BN_autor_podzielony$autor_2, licznik = BN_autor_podzielony$licznik)
aut_id_nazw <- merge(x = am_nazwisko, y = am_autor_id, by = "licznik", all.x=TRUE)
am_nazwisko <- data.frame(am_nazwisko = ifelse(is.na(aut_id_nazw$AM_AUTOR_ID),as.character(aut_id_nazw$nazwisko), NA), licznik = aut_id_nazw$licznik)
#8
am_imie <- data.frame(imie = BN_autor_podzielony$autor_1, licznik = BN_autor_podzielony$licznik)
aut_id_imie <- merge(x = am_imie, y = am_autor_id, by = "licznik", all.x=TRUE)
am_imie <- data.frame(am_imie = ifelse(is.na(aut_id_imie$AM_AUTOR_ID),as.character(aut_id_imie$imie), NA), licznik = aut_id_nazw$licznik)
#9
tw_tworca_id <- merge(x = BN_PBL_autor, y = PBL_autor_to_tworca, by.x = 'AM_AUTOR_ID', by.y = 'id autora', sort = FALSE, all.x = TRUE)
tw_tworca_id <- merge(x = tw_tworca_id, y = PBL_tworcy, by.x = 'id tworcy', by.y = 'TW_TWORCA_ID', sort = FALSE, all.x = TRUE)
tw_tworca_id <- tw_tworca_id %>%
  select(licznik,`id tworcy`,AM_NAZWISKO=autor_2,AM_IMIE=autor_1, DZ_NAZWA, TW_DZ_DZIAL_ID)
tw_tworca_id$`id tworcy`[tw_tworca_id$TW_DZ_DZIAL_ID==430] <- NA
tw_tworca_id$AM_NAZWISKO[tw_tworca_id$TW_DZ_DZIAL_ID==430] <- NA
tw_tworca_id$AM_IMIE[tw_tworca_id$TW_DZ_DZIAL_ID==430] <- NA
BN_PBL_tworca <- tw_tworca_id %>%
    select(1,TW_TWORCA_ID = 2,TW_NAZWISKO = 3,TW_IMIE = 4,DZ_NAZWA,TW_DZ_DZIAL_ID)

tw_tworca_id <- tw_tworca_id %>%
  select(1,TW_TWORCA_ID = 2,TW_NAZWISKO = 3,TW_IMIE = 4)

tw_tworca_id <- tw_tworca_id[order(tw_tworca_id$licznik,tw_tworca_id$TW_TWORCA_ID,tw_tworca_id$TW_NAZWISKO,tw_tworca_id$TW_IMIE),]
tw_tworca_id <- tw_tworca_id %>%
  unique()
tw_tworca_id %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> tw_tworca_id$same
tw_tworca_id$same[1] <- 0
tw_tworca_id <- tw_tworca_id %>%
  filter(same==0) %>%
  select(-length(tw_tworca_id))
#10
tw_nazwisko <- tw_tworca_id
tw_nazwisko$TW_NAZWISKO[!is.na(tw_nazwisko$TW_TWORCA_ID)] <- NA
tw_nazwisko <- tw_nazwisko %>%
  select(licznik,TW_NAZWISKO)
#11
tw_imie <- tw_tworca_id
tw_imie$TW_IMIE[!is.na(tw_imie$TW_TWORCA_ID)] <- NA
tw_imie <- tw_imie %>%
  select(licznik,TW_IMIE)
#12
BN_PBL_tworca <- BN_PBL_tworca[order(BN_PBL_tworca$licznik,BN_PBL_tworca$TW_TWORCA_ID,BN_PBL_tworca$TW_NAZWISKO,BN_PBL_tworca$TW_IMIE),]
BN_PBL_tworca <- BN_PBL_tworca %>%
  unique()
BN_PBL_tworca %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_PBL_tworca$same
BN_PBL_tworca$same[1] <- 0
BN_PBL_tworca <- BN_PBL_tworca %>%
  filter(same==0) %>%
  select(-length(BN_PBL_tworca))

dz_nazwa_full <- BN_PBL_tworca
dz_nazwa_full <- dz_nazwa_full[order(dz_nazwa_full$licznik),]

#dział na podstawie literatury
literatura_BN <- BN_PBL_tworca %>%
    select(licznik,TW_TWORCA_ID,TW_NAZWISKO,TW_IMIE)

marc_field_655 <- data %>%
  select(licznik,X655)%>%
  filter(X655!="")
marc_field_655$X655<-str_replace_all(marc_field_655$X655,"(^|\\|)","~\\1")
marc_field_655<- cSplit(marc_field_655,"X655",sep = "~",direction = "long")
marc_field_655<- marc_field_655%>%
  filter(X655!="")
marc_field_655$X655<-str_remove_all(marc_field_655$X655,"^\\|")
marc_field_655 <- mutate(marc_field_655,
               indicator = str_replace_all(marc_field_655$X655,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X655,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field_655)[1]))
colnames(empty_table) <-subfield_list

marc_field_655<-cbind(marc_field_655,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field_655$X655 <- str_replace(marc_field_655$X655,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field_655[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field_655$X655),str_replace_all(gsub(string,"\\3",marc_field_655$X655),"\\${2}.", "~"),NA)
}

literatura_BN <- merge(x = literatura_BN, y = marc_field_655, by.x = "licznik",all.x = TRUE)
literatura_BN <- literatura_BN %>%
  select(1,2,3,4,X655 = 7)

tw_do_ustalenia <- literatura_BN %>%
  filter(is.na(TW_TWORCA_ID))

dz_osob_bez_teatr <- PBL_dz_osob_bez_teatru %>%
  select(1,2) %>%
  unique()

dz_osob_bez_teatr <- mutate(dz_osob_bez_teatr,
                              nazwa = substr(str_replace(dz_osob_bez_teatr$DZ_NAZWA, "(.*?\\()(.*?)(\\).*$)","\\2"),1,nchar(str_replace(dz_osob_bez_teatr$DZ_NAZWA, "(.*?\\()(.*?)(\\).*$)","\\2"))-1))

reczne <- data.frame(DZ_DZIAL_ID = c(697,697,697,697,825,1037,1187,1454,884,902,544,544,544,544),DZ_NAZWA = c("Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (brytyjska i irlandzka)","Hasła osobowe (grecka starożytna)","Hasła osobowe (łacińska starożytna)","Hasła osobowe (syryjska)","Hasła osobowe (esperanto)","Hasła osobowe (holenderska)","Hasła osobowe (Indii)","Hasła osobowe (Afryki Subsaharyjskiej)","Hasła osobowe (Afryki Subsaharyjskiej)","Hasła osobowe (Afryki Subsaharyjskiej)","Hasła osobowe (Afryki Subsaharyjskiej)"), redaktor_dzialu = c("BEATAK","BEATAK","BEATAK","BEATAK","BEATAS","BEATAS","BEATAD","CEZARY","TOMASZU","EWA","EWA","EWA","EWA","EWA"), nazwa = c("angielsk","szkock","irlandzk","walijsk","greck","łacińsk","syryjsk","esperanck","niderlandzk","indyjsk","południowoafryka","senegalsk","nigeryjsk","afrykańsk"))
reczne <- reczne %>%
  select(1,2,4)
dz_osob_bez_teatr <- rbind(dz_osob_bez_teatr,reczne)
dz_osob_bez_teatr$nazwa[dz_osob_bez_teatr$nazwa=="literatura polsk"] <- "polsk"

literatura_dz <- sqldf("select *
                            from tw_do_ustalenia a
                            left join dz_osob_bez_teatr b on a.X655 like ('%'||b.nazwa||'%')")

literatura_dz <- literatura_dz[order(literatura_dz$licznik,literatura_dz$TW_NAZWISKO,literatura_dz$TW_IMIE,literatura_dz$DZ_DZIAL_ID),]
literatura_dz %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> literatura_dz$same
literatura_dz$same[1] <- 0
literatura_dz <- literatura_dz %>%
  filter(same==0) %>%
  select(-length(literatura_dz))
test <- mutate(BN_PBL_tworca,
               polaczone = paste(BN_PBL_tworca$TW_TWORCA_ID,BN_PBL_tworca$licznik,BN_PBL_tworca$TW_NAZWISKO,BN_PBL_tworca$TW_IMIE,sep = "|"))
literatura_dz <- mutate(literatura_dz,
                        polaczone = paste(literatura_dz$TW_TWORCA_ID,literatura_dz$licznik,literatura_dz$TW_NAZWISKO,literatura_dz$TW_IMIE,sep = "|"))

test <- sqldf("select *
                            from test a
                            left join literatura_dz b on a.polaczone=b.polaczone")

test$TW_DZ_DZIAL_ID <- ifelse(is.na(test$TW_TWORCA_ID), test$DZ_DZIAL_ID,test$TW_DZ_DZIAL_ID)
test$DZ_NAZWA <- ifelse(is.na(test$TW_TWORCA_ID), test$DZ_NAZWA..14, test$DZ_NAZWA)
BN_PBL_tworca_full <- test %>%
  filter(!is.na(TW_DZ_DZIAL_ID)) %>%
  select(1:16)
test <- test %>%
  filter(is.na(TW_DZ_DZIAL_ID)) %>%
  select(1:16)

dz_nazwa_full <- BN_PBL_tworca_full %>%
  select(TW_TWORCA_ID,licznik,DZ_NAZWA, TW_DZ_DZIAL_ID, tw_imie=TW_IMIE, tw_nazwisko=TW_NAZWISKO)
dz_nazwa_full <- dz_nazwa_full[order(dz_nazwa_full$licznik),]

dz_nazwa <- dz_nazwa_full %>%
  select(licznik, DZ_NAZWA)
#13
dz_dzial_id <- dz_nazwa_full %>%
  select(licznik, DZ_DZIAL_ID=TW_DZ_DZIAL_ID)
#14
marc_field <- data %>%
  select(licznik,X245)#%>%
marc_field$X245<-str_remove_all(marc_field$X245,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X245 <- str_replace(marc_field$X245,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X245),str_replace_all(gsub(string,"\\3",marc_field$X245),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
marc_field$`$a`[is.na(marc_field$`$a`)] <- ""
za_tytul <- data.frame(tytul_bn = paste(marc_field$`$a`,marc_field$`$b`,sep = ""), licznik = marc_field$licznik)
za_tytul$tytul_bn <- str_remove(za_tytul$tytul_bn, "\\s+\\/$")
za_tytul <- mutate(za_tytul,
                   tytul = gsub("([a-zęóąśłżźćń])( )(:)( {0,1})(\\({0,1})([a-zęóąśłżźćńA-ZĘÓĄŚŁŻŹĆŃ])(.)","\\1.\\2\\U\\5\\6\\E\\7",perl = TRUE, za_tytul$tytul_bn))
za_tytul$tytul <- gsub("( )(:)( {0,1}[a-z])(.)","\\1\\U\\3\\E\\4",perl = TRUE, za_tytul$tytul)
za_tytul$tytul <- str_replace(za_tytul$tytul, "([^\\.])(\\.$)","\\1")
za_tytul <- za_tytul %>%
  select(2,3)
za_tytul_copy <- za_tytul

lista_gat_pbl <- data.frame(gatunek = c("aforyzm","album","antologia","autobiografia","dziennik","esej","felieton","inne","kazanie","list","miniatura prozą","opowiadanie","poemat","powieść","proza","proza poetycka","reportaż","rozmyślanie religijne","rysunek, obraz","scenariusz","szkic","tekst biblijny","tekst dramatyczny","wiersz","wspomnienie","wypowiedź"))

test <- data %>%
  select(licznik,X655,X650)
test2 <- sqldf("select *
              from test
              left join lista_gat_pbl on lower(test.X650) like '%'||lista_gat_pbl.gatunek||'%'")
test <- sqldf("select *
              from test
              left join lista_gat_pbl on lower(test.X655) like '%'||lista_gat_pbl.gatunek||'%'")
test <- test %>%
  select(licznik,gatunek)
test2 <- test2 %>%
  select(licznik,gatunek)
test <- rbind(test,test2)
test <- test %>%
  unique()
  
test <- test[order(test$licznik,test$gatunek),]
test %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> test$same
test$same[1] <- 0
test <- test %>%
  filter(same==0) %>%
  select(-length(test))

za_tytul <- merge(x=za_tytul,y=test, by = "licznik", all.x = TRUE)
za_tytul$tytul <- ifelse(!is.na(za_tytul$gatunek),paste(za_tytul$tytul,". [",gsub("(^.)","\\U\\1",perl = TRUE, za_tytul$gatunek),"]",sep = ""),za_tytul$tytul)
#15
marc_field <- data %>%
  select(licznik,X246)
marc_field$X246 <- str_replace_all(marc_field$X246,"(^|\\|)","~\\1")
marc_field <- cSplit(marc_field,"X246",sep = "~",direction = "long")
marc_field$X246<-str_remove_all(marc_field$X246,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X246,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X246,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X246 <- str_replace(marc_field$X246,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X246),str_replace_all(gsub(string,"\\3",marc_field$X246),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
colnames(marc_field)[7] <- "inna"
marc_field$`$a`[is.na(marc_field$`$a`)] <- ""
marc_field$`$b`[is.na(marc_field$`$b`)] <- ""
za_tytul_oryginalu <- marc_field %>%
  select(licznik,`$a`,`$b`,`$i`)
za_tytul_oryginalu <- mutate(za_tytul_oryginalu,
                             tytul = ifelse(grepl("yt\\.{0,1} oryg|yt\\.{0,1}oryg|yt\\.{0,1} org|ytu[lł] orygina",za_tytul_oryginalu$`$i`),paste(za_tytul_oryginalu$`$a`,za_tytul_oryginalu$`$b`,sep = ""),NA))

za_tytul_oryginalu <- za_tytul_oryginalu[order(za_tytul_oryginalu$licznik,za_tytul_oryginalu$tytul),]
za_tytul_oryginalu %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> za_tytul_oryginalu$same
za_tytul_oryginalu$same[1] <- 0
za_tytul_oryginalu <- za_tytul_oryginalu %>%
  filter(same==0) %>%
  select(-length(za_tytul_oryginalu))
za_tytul_oryginalu <- za_tytul_oryginalu %>%
  select(1,5)

za_tytul_oryginalu$tytul <- gsub("([a-zęóąśłżźćń])( )(:)( {0,1})(\\({0,1})([a-zęóąśłżźćńA-ZĘÓĄŚŁŻŹĆŃ])(.)","\\1.\\2\\U\\5\\6\\E\\7",perl = TRUE, za_tytul_oryginalu$tytul)
za_tytul_oryginalu$tytul <- gsub("( )(:)( {0,1}[a-z])(.)","\\1\\U\\3\\E\\4",perl = TRUE, za_tytul_oryginalu$tytul)
za_tytul_oryginalu$tytul <- str_replace(za_tytul_oryginalu$tytul, "([^\\.])(\\.$)","\\1")
#16
marc_field <- data %>%
  select(licznik,X041)
marc_field$X041<-str_remove_all(marc_field$X041,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X041,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X041,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X041 <- str_replace(marc_field$X041,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X041),str_replace_all(gsub(string,"\\3",marc_field$X041),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
za_jezyk_oryginalu <- marc_field %>%
  select(licznik,jezyk_oryginalu = `$a`)
za_jezyk_oryginalu$jezyk_oryginalu <- str_replace_all(za_jezyk_oryginalu$jezyk_oryginalu,"\\$a","|")
#17
BN_wspoltworca <- data.frame(wspoltworca = str_remove_all(as.character(str_extract_all(data$X245,"(?<=; )(.*)(?=$)")),"\\.$"), licznik = data$licznik)
BN_wspoltworca$wspoltworca <- str_remove_all(BN_wspoltworca$wspoltworca," et al\\.")
BN_wspoltworca <- mutate(BN_wspoltworca,
                         funkcja = as.character(str_extract_all(BN_wspoltworca$wspoltworca,"(?<=\\[)(.*?)(?= [A-ZÓŚŁŻŹĆŃ])")),
                         os_imie = as.character(str_extract_all(BN_wspoltworca$wspoltworca,"(?<= )(.*)(?= (?!.* ))")),
                         os_nazwisko = str_replace_all(BN_wspoltworca$wspoltworca,"(.*)( (?!.* ))(.*)(\\])", "\\3"))

ws_prosty <- paste(BN_wspoltworca$os_nazwisko,BN_wspoltworca$os_imie)
ws_prosty <- unlist(ws_prosty)
ws_prosty <- str_to_lower(ws_prosty)
ws_prosty <- str_replace_all(ws_prosty, "\\W", "")
ws_prosty <- list(ws_prosty)
ws_prosty <- data.frame(ws_prosty)
colnames(ws_prosty) <- "nazwa"

fu_prosta <- BN_wspoltworca$funkcja
fu_prosta <- unlist(fu_prosta)
fu_prosta <- str_to_lower(fu_prosta)
fu_prosta <- str_replace_all(fu_prosta, "\\W", "")
fu_prosta <- list(fu_prosta)
fu_prosta <- data.frame(fu_prosta)
colnames(fu_prosta) <- "nazwa"

ws_BN <- data.frame(licznik = BN_wspoltworca$licznik, os_nazwisko = BN_wspoltworca$os_nazwisko, os_imie = BN_wspoltworca$os_imie, nazwa_prosta = ws_prosty$nazwa, funkcja = BN_wspoltworca$funkcja, nazwa = fu_prosta$nazwa)

BN_PBL_wspoltworcy <- merge(x = ws_BN, y = PBL_wspoltworcy, by = 'nazwa_prosta', sort = FALSE, all.x = TRUE)

BN_PBL_wspoltworcy <- merge(x = BN_PBL_wspoltworcy, y = PBL_funkcje, by = 'nazwa', sort = FALSE, all.x = TRUE)

BN_PBL_wspoltworcy <- BN_PBL_wspoltworcy[order(as.integer(as.character(BN_PBL_wspoltworcy$licznik))),]

#nazwisko

b_os_nazwisko <- data.frame(os_nazwisko = ifelse(is.na(BN_PBL_wspoltworcy$OS_OSOBA_ID), as.character(BN_PBL_wspoltworcy$os_nazwisko), NA))
b_os_imie <- data.frame(os_imie = ifelse(is.na(BN_PBL_wspoltworcy$OS_OSOBA_ID), as.character(BN_PBL_wspoltworcy$os_imie), NA))

BN_PBL_osoby_funkcje <- data.frame(licznik = BN_PBL_wspoltworcy$licznik, os_osoba_id = BN_PBL_wspoltworcy$OS_OSOBA_ID, b_os_nazwisko, b_os_imie, fo_symbol = BN_PBL_wspoltworcy$fo_symbol, fo_nazwa = BN_PBL_wspoltworcy$fo_nazwa )

#22
za_opis_wspoltworcow <- data.frame(za_opis_wspoltworcow = gsub("(\\[)(.)(.*)", "\\1\\U\\2\\E\\3", perl = TRUE, BN_wspoltworca$wspoltworca), licznik = data$licznik)

#23
za_wydanie <- data.frame(data$X250)
za_wydanie <- data.frame(str_replace_all(za_wydanie[,1], "\\$aWyd\\. ",""))
za_wydanie <- data.frame(str_replace_all(za_wydanie[,1], ".\\$.*",""))
za_wydanie <- data.frame(str_replace_all(za_wydanie[,1], "(\\d)(\\.$)","\\1"))
za_wydanie <- cbind(za_wydanie, 1:lengths(za_wydanie))
colnames(za_wydanie) <- c("za_wydanie", "licznik")
#24
marc_field <- data %>%
  select(licznik,X245)
marc_field$X245<-str_replace_all(marc_field$X245,"(^|\\|)","~\\1")
marc_field<- cSplit(marc_field,"X245",sep = "~",direction = "long")
marc_field<- marc_field%>%
  filter(X245!="")
marc_field$X245<-str_remove_all(marc_field$X245,"^\\|")
marc_field <- mutate(marc_field,
               indicator = str_replace_all(marc_field$X245,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X245,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field)[1]))
colnames(empty_table) <-subfield_list

marc_field<-cbind(marc_field,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field$X245 <- str_replace(marc_field$X245,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field$X245),str_replace_all(gsub(string,"\\3",marc_field$X245),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}

za_instytucja <- marc_field %>%
  select(licznik, X245 = `$c`)

za_instytucja <- za_instytucja[order(za_instytucja$licznik,za_instytucja$X245),]
za_instytucja %$%  
    { licznik == dplyr::lag(licznik, 1) } %>% 
    as.numeric() %>% 
    {.} -> za_instytucja$same
za_instytucja$same[1] <- 0
za_instytucja <- za_instytucja %>%
  filter(same==0) %>%
  select(-length(za_instytucja))

za_instytucja <- mutate(za_instytucja,
                        instytucja = ifelse(grepl("\\;",za_instytucja$X245),str_replace_all(za_instytucja$X245, "(.*?)(\\;(?!.*\\;))( )+(.*?$)","\\4"),""))

za_instytucja <- merge(x=za_instytucja,y=BN_PBL_wspoltworcy,by = "licznik",all.x = TRUE)
za_instytucja <- za_instytucja %>%
  select(1,2,3,6,7)
za_instytucja <- mutate(za_instytucja,
                        czy_naz = str_detect(za_instytucja$X245,as.character(za_instytucja$os_nazwisko)),
                        czy_im = str_detect(za_instytucja$X245,as.character(za_instytucja$os_imie)))
test <- za_instytucja %>%
  filter(is.na(czy_naz)&is.na(czy_im)) %>%
  filter(instytucja!="") %>%
  filter(!(grepl("^\\[[a-zęóąśłżźćń]|^[a-zęóąśłżźćń]",instytucja))) %>%
  select(licznik,instytucja)
test$instytucja <- str_remove(test$instytucja,"(?<=[a-zęóąśłżźćń])(\\.$)")
za_instytucja <- test
test <- data %>%
  select(licznik)
za_instytucja <- merge(x=za_instytucja,y=test,by = "licznik", all = TRUE)
#25
BN_wydawnictwo <- data.frame(X260 = data$X260, licznik = data$licznik)
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"s\\.n\\.", "b.w.")
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"s\\.l\\.", "b.m.")
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"S\\.l\\.", "b.m.")
BN_wydawnictwo$X260 <- str_replace_all(BN_wydawnictwo$X260,"\\$f", "$c")
BN_wydawnictwo$X260 <- str_remove(BN_wydawnictwo$X260,"^\\\\+")
#ręcznie wygenerować i naprawić błąd ":$a" - powinno być albo ;$a, albo :$b
test <- mutate(BN_wydawnictwo,
               dwuk = str_detect(BN_wydawnictwo$X260,"\\:\\$a"))
test <- test %>%
  filter(dwuk==TRUE)
#BN_wydawnictwo$X260[BN_wydawnictwo$X260=="$aKraków :$bCollegium Columbinum ;$aWarszawa :$aTowarzystwo Badań nad Wiekiem Osiemnastym,$ccop. 2006."] <- "$aKraków :$bCollegium Columbinum ;$aWarszawa :$bTowarzystwo Badań nad Wiekiem Osiemnastym,$ccop. 2006."

BN_wydawnictwo <- mutate(BN_wydawnictwo,
                      rok_wydania = str_extract_all(BN_wydawnictwo$X260, "(?<=\\$c).*(?=\\$e)|(?<=\\$c).*"),
                      bez_roku = str_replace_all(BN_wydawnictwo$X260, ".\\$c.*", ""))

BN_wydawnictwo$bez_roku <- str_replace_all(BN_wydawnictwo$bez_roku, ";\\$b", ":$b")
BN_wydawnictwo <- mutate(BN_wydawnictwo,
                      ile_wydawnictw = str_count(BN_wydawnictwo$bez_roku, "\\$b"),
                      ile_miejsc = str_count(BN_wydawnictwo$bez_roku, "\\$a"),
                      kolejnosc = str_remove(str_replace_all(as.character(str_extract_all(BN_wydawnictwo$bez_roku, "\\$.")), "[^a-z]", ""),"^c"),
                      podzielone = str_replace_all(BN_wydawnictwo$bez_roku,"(\\$.)","|\\1~"))

BN_wydawnictwo$podzielone <- str_remove(BN_wydawnictwo$podzielone,"^\\|")
BN_wydawnictwo$kolejnosc <- str_replace_all(BN_wydawnictwo$kolejnosc,"(.)","\\1|")
BN_wydawnictwo$kolejnosc <- str_remove(BN_wydawnictwo$kolejnosc,"\\|$")
BN_wydawnictwo <- cSplit(BN_wydawnictwo,c("kolejnosc","podzielone"), sep = "|", direction = "long")

BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same
BN_wydawnictwo$same[1] <- 0
BN_wydawnictwo$rok_wydania <- as.character(BN_wydawnictwo$rok_wydania)
BN_wydawnictwo$lp <- 1:lengths(BN_wydawnictwo)
pierwsze <- BN_wydawnictwo %>%
  filter(same==0)
drugie <- BN_wydawnictwo %>%
  filter(same==1)
drugie <- ddply(drugie, .(X260, licznik, rok_wydania, bez_roku, ile_wydawnictw, ile_miejsc, kolejnosc, same), summarize, podzielone = paste(podzielone, collapse=""), lp = paste(lp, collapse="|"))
BN_wydawnictwo <- rbind(pierwsze,drugie)
BN_wydawnictwo$lp <- str_replace(BN_wydawnictwo$lp,"(.*?)(\\|)(.*$)","\\1")
BN_wydawnictwo$lp <- as.integer(BN_wydawnictwo$lp)
BN_wydawnictwo <- BN_wydawnictwo[order(BN_wydawnictwo$licznik,BN_wydawnictwo$lp),]
BN_wydawnictwo <- BN_wydawnictwo %>%
  select(-lp)
BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "b" & kolejnosc == dplyr::lead(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same2
BN_wydawnictwo$same2[length(BN_wydawnictwo$podzielone)] <- 0

BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "a" & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same_a
BN_wydawnictwo$same_a[1] <- 0

BN_wydawnictwo$podzielone3 <- lead(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo$same_a2 <- lead(BN_wydawnictwo$same_a,n=1)
BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same_a2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone3,sep = ""),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- BN_wydawnictwo %>%
  filter(same_a==0)
BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)

BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same==0&BN_wydawnictwo$same2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone2,sep = "|"),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- cSplit(BN_wydawnictwo,"podzielone", sep = "|", direction = "long")
BN_wydawnictwo$bez_roku <- BN_wydawnictwo$podzielone
BN_wydawnictwo <- BN_wydawnictwo %>%
  select(licznik,rok_wydania,X260,bez_roku)
BN_wydawnictwo$rok_wydania <- as.character(BN_wydawnictwo$rok_wydania)
BN_wydawnictwo <- ddply(BN_wydawnictwo, .(licznik, rok_wydania, X260), summarize, bez_roku = paste(bez_roku, collapse=""))
BN_wydawnictwo$bez_roku <- str_remove_all(BN_wydawnictwo$bez_roku,"\\~")
#drugi raz
BN_wydawnictwo$bez_roku <- str_replace_all(BN_wydawnictwo$bez_roku, ";\\$b", ":$b")
BN_wydawnictwo <- mutate(BN_wydawnictwo,
                      ile_wydawnictw = str_count(BN_wydawnictwo$bez_roku, "\\$b"),
                      ile_miejsc = str_count(BN_wydawnictwo$bez_roku, "\\$a"),
                      kolejnosc = str_remove(str_replace_all(as.character(str_extract_all(BN_wydawnictwo$bez_roku, "\\$.")), "[^a-z]", ""),"^c"),
                      podzielone = str_replace_all(BN_wydawnictwo$bez_roku,"(\\$.)","|\\1~"))

BN_wydawnictwo$podzielone <- str_remove(BN_wydawnictwo$podzielone,"^\\|")
BN_wydawnictwo$kolejnosc <- str_replace_all(BN_wydawnictwo$kolejnosc,"(.)","\\1|")
BN_wydawnictwo$kolejnosc <- str_remove(BN_wydawnictwo$kolejnosc,"\\|$")
BN_wydawnictwo <- cSplit(BN_wydawnictwo,c("kolejnosc","podzielone"), sep = "|", direction = "long")
BN_wydawnictwo <- BN_wydawnictwo %>%
  filter(!is.na(podzielone))

BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same
BN_wydawnictwo$same[1] <- 0

BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "b" & kolejnosc == dplyr::lead(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same2
BN_wydawnictwo$same2[length(BN_wydawnictwo$podzielone)] <- 0

BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo %$%  
    { licznik == dplyr::lag(licznik, 1) & kolejnosc == "a" & kolejnosc == dplyr::lag(kolejnosc, 1) } %>% 
    as.numeric() %>% 
    {.} -> BN_wydawnictwo$same_a
BN_wydawnictwo$same_a[1] <- 0

BN_wydawnictwo$podzielone3 <- lead(BN_wydawnictwo$podzielone,n=1)
BN_wydawnictwo$same_a2 <- lead(BN_wydawnictwo$same_a,n=1)
BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same_a2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone3,sep = ""),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- BN_wydawnictwo %>%
  filter(same_a==0)
BN_wydawnictwo$podzielone2 <- lag(BN_wydawnictwo$podzielone,n=1)

BN_wydawnictwo$podzielone <- ifelse(BN_wydawnictwo$same==0&BN_wydawnictwo$same2==1,paste(BN_wydawnictwo$podzielone,BN_wydawnictwo$podzielone2,sep = "|"),as.character(BN_wydawnictwo$podzielone))
BN_wydawnictwo <- cSplit(BN_wydawnictwo,"podzielone", sep = "|", direction = "long")
BN_wydawnictwo$bez_roku <- BN_wydawnictwo$podzielone
BN_wydawnictwo <- BN_wydawnictwo %>%
  select(licznik,rok_wydania,X260,bez_roku)
BN_wydawnictwo$rok_wydania <- as.character(BN_wydawnictwo$rok_wydania)
BN_wydawnictwo$czy <- str_detect(BN_wydawnictwo$bez_roku,"\\$a")
BN_wydawnictwo$bez_roku <- ifelse(BN_wydawnictwo$czy==TRUE,paste("|",BN_wydawnictwo$bez_roku,sep = ""),as.character(BN_wydawnictwo$bez_roku))
BN_wydawnictwo <- ddply(BN_wydawnictwo, .(licznik, rok_wydania, X260), summarize, bez_roku = paste(bez_roku, collapse=""))
BN_wydawnictwo$bez_roku <- str_remove_all(BN_wydawnictwo$bez_roku,"\\~")
BN_wydawnictwo$bez_roku <- str_remove_all(BN_wydawnictwo$bez_roku,"^\\|")

BN_wydawnictwo <- cSplit(BN_wydawnictwo, "bez_roku", sep = "|", direction = "long")
BN_wydawnictwo <- mutate(BN_wydawnictwo,
                  wydawnictwo = str_extract_all(BN_wydawnictwo$bez_roku, "(?<=\\$b)(.*)"),
                  miejsce_wydania = str_replace_all(str_extract_all(BN_wydawnictwo$bez_roku, "(?<=\\$a)(.*)(?= {0,1}: {0,1}\\$b)|(?<=\\$a)(.*)($)")," ;\\$a", ", "),
                  nazwa_prosta = str_to_lower(str_replace_all(str_replace_all(unlist(BN_wydawnictwo$bez_roku), "\\$\\w", ""), "\\W", "")),
                  lp = 1:lengths(BN_wydawnictwo))
BN_wydawnictwo$wydawnictwo <- str_remove(BN_wydawnictwo$wydawnictwo,"\\s+\\;$")
BN_wydawnictwo$wydawnictwo <- str_remove(BN_wydawnictwo$wydawnictwo,"\\s+\\:$")

BN_wydawnictwo$miejsce_wydania <- str_remove(BN_wydawnictwo$miejsce_wydania," \\[{0,10}etc\\.{0,10}\\]\\s{0,10}$")
BN_wydawnictwo$miejsce_wydania <- str_remove(BN_wydawnictwo$miejsce_wydania," \\[{0,10}etc\\.{0,10}\\s{0,10}$")
BN_wydawnictwo$miejsce_wydania <- ifelse(grepl("\\[",BN_wydawnictwo$miejsce_wydania)&!grepl("\\]",BN_wydawnictwo$miejsce_wydania),str_remove(BN_wydawnictwo$miejsce_wydania,"\\["),as.character(BN_wydawnictwo$miejsce_wydania))
BN_wydawnictwo$wydawnictwo <- ifelse(grepl("\\]",BN_wydawnictwo$wydawnictwo)&!grepl("\\[",BN_wydawnictwo$wydawnictwo),str_remove(BN_wydawnictwo$wydawnictwo,"\\]"),as.character(BN_wydawnictwo$wydawnictwo))
BN_PBL_wydawnictwa <- merge( x = BN_wydawnictwo, y = PBL_wydawnictwa, by = 'nazwa_prosta', sort = FALSE, all.x = TRUE, allow.cartesian = TRUE)
BN_PBL_wydawnictwa$to_samo <- BN_PBL_wydawnictwa$wydawnictwo==BN_PBL_wydawnictwa$WY_NAZWA
BN_PBL_wydawnictwa <- BN_PBL_wydawnictwa[order(as.integer(as.character(BN_PBL_wydawnictwa$licznik)), -BN_PBL_wydawnictwa$to_samo, -BN_PBL_wydawnictwa$WY_LICZBA_ZAPISOW),]

BN_PBL_wydawnictwa %$%  
    { as.integer(licznik) == dplyr::lag(as.integer(licznik), 1) & nazwa_prosta==lag(nazwa_prosta)} %>% 
    as.numeric() %>% 
    {.} -> BN_PBL_wydawnictwa$same
BN_PBL_wydawnictwa$same[1] <- 0

BN_PBL_wydawnictwa <- BN_PBL_wydawnictwa %>%
  filter(same==0)

wy_wydawnictwo_id <- BN_PBL_wydawnictwa %>%
  select(licznik, WY_WYDAWNICTWO_ID)

wy_wydawnictwo_id <- wy_wydawnictwo_id[order(as.integer(as.character(wy_wydawnictwo_id$licznik))),]
#26
wy_miejsce <- BN_PBL_wydawnictwa %>%
  select(licznik, WY_WYDAWNICTWO_ID,miejsce_wydania)
wy_miejsce$miejsce_wydania <- ifelse(is.na(wy_miejsce$WY_WYDAWNICTWO_ID),as.character(wy_miejsce$miejsce_wydania),"")

#27
wy_nazwa <- BN_PBL_wydawnictwa %>%
  select(licznik, WY_WYDAWNICTWO_ID,wydawnictwo)
wy_nazwa$wydawnictwo <- ifelse(is.na(wy_miejsce$WY_WYDAWNICTWO_ID),as.character(wy_nazwa$wydawnictwo),"")

#28
za_rok_wydania <- BN_PBL_wydawnictwa %>%
  select(licznik, rok_wydania) %>%
  unique()
za_rok_wydania$rok_wydania <- str_replace_all(za_rok_wydania$rok_wydania, "(.*)(\\.)", "\\1")
za_rok_wydania$dobry_rok <- ifelse(nchar(as.character(za_rok_wydania$rok_wydania))==4,as.character(za_rok_wydania$rok_wydania),NA)
za_rok_wydania$do_opisu <- ifelse(is.na(za_rok_wydania$dobry_rok),paste("[",str_extract(za_rok_wydania$rok_wydania,"\\d{4}"),"]",sep = ""),"")
#29
marc_field300 <- data %>%
  select(licznik,X300)
marc_field300$X300<-str_remove_all(marc_field300$X300,"^\\|")
marc_field300 <- mutate(marc_field300,
               indicator = str_replace_all(marc_field300$X300,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X300,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field300)[1]))
colnames(empty_table) <-subfield_list

marc_field300<-cbind(marc_field300,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field300$X300 <- str_replace(marc_field300$X300,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field300[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field300$X300),str_replace_all(gsub(string,"\\3",marc_field300$X300),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}
marc_field300$`$a` <- str_remove(marc_field300$`$a`," \\;+$| \\:+$")
marc_field300$`$a`[is.na(marc_field300$`$a`)] <- ""

za_opis_ks <- data.frame(opis_ks = paste(za_rok_wydania$do_opisu, marc_field300$`$a`,marc_field300$`$b`,sep = ", "), licznik = as.integer(za_rok_wydania$licznik))
za_opis_ks$opis_ks <- str_replace(za_opis_ks$opis_ks,", , ", ", ")
za_opis_ks$opis_ks <- str_replace(za_opis_ks$opis_ks,", , ", ", ")
za_opis_ks$opis_ks <- str_remove_all(za_opis_ks$opis_ks, "^, |, $")
wsp_info <- data.frame(wsp = paste("[Współwyd.: ",BN_autor$autorzy,": ",za_tytul_copy$tytul,"]", sep = ""), za_uwagi)
wsp_info$za_uwagi <- str_remove_all(wsp_info$za_uwagi,"_2")
wsp_info %$%  
    { za_uwagi == dplyr::lag(za_uwagi, 1)} %>% 
    as.numeric() %>% 
    {.} -> wsp_info$same
wsp_info$same[1] <- 0
wsp_info <- data.frame(wsp_info, za_uwagi)
wsp_info$za_uwagi <- ifelse(grepl("_2", wsp_info$za_uwagi.1), as.character(wsp_info$za_uwagi),paste(wsp_info$za_uwagi,"_2",sep = ""))

wsp_info <- wsp_info %>%
  select(1,2)
wsp_info <- merge(x=wsp_info, y=za_uwagi, by = "za_uwagi")
wsp_info <- wsp_info %>%
  select(2,3)
za_opis_fizyczny_ksiazki <- merge(x=za_opis_ks,y=wsp_info, by = "licznik",all = TRUE)
za_opis_fizyczny_ksiazki <- data.frame(za_opis_fizyczny_ksiazki = paste(str_replace_all(za_opis_fizyczny_ksiazki$opis_ks,"(.*)(cm\\.)(.*)", "\\1\\2"), za_opis_fizyczny_ksiazki$wsp, sep = " "), licznik = za_opis_fizyczny_ksiazki$licznik)

#30
marc_field490 <- data %>%
  select(licznik,X490)
marc_field490 <- cSplit(marc_field490,"X490",sep = "|",direction = "long")
marc_field490 <- marc_field490%>%
  filter(X490!="")
marc_field490$X490<-str_remove_all(marc_field490$X490,"^\\|")
marc_field490 <- mutate(marc_field490,
               indicator = str_replace_all(marc_field490$X490,"(^.*?)(\\$.*)","\\1"))
subfield_list<- str_extract_all(data$X490,"\\$.")
subfield_list<- unique(unlist(subfield_list))
empty_table<- data.frame(matrix(ncol = length(subfield_list),nrow = lengths(marc_field490)[1]))
colnames(empty_table) <-subfield_list

marc_field490<-cbind(marc_field490,empty_table)

subfield_list_char <- paste("(",subfield_list,")",sep = "")
subfield_list_char <- str_replace_all(subfield_list_char,"\\$","\\\\$")

x <- 1:length(subfield_list)

for (i in x) {
  marc_field490$X490 <- str_replace(marc_field490$X490,subfield_list_char[i],"|\\1")
  progress(match(i,x), max.value = length(x)) 
}
for (i in x) {
  subfield_list_char2 <- str_replace_all(subfield_list,"\\$","\\\\$")
string_a <- "(^)(.*?\\|"
string_b <- subfield_list_char2[i]
string_c <- ")(.*?)(\\,{0,1})((\\|\\$)(.*)|$)"
string <- paste(string_a,string_b,string_c,sep = "")
marc_field490[,i+3] <- ifelse(grepl(subfield_list_char2[i],marc_field490$X490),str_replace_all(gsub(string,"\\3",marc_field490$X490),"\\${2}.", "~"),NA)
progress(match(i,x), max.value = length(x))  
}

marc_field490$`$a` <- str_remove(marc_field490$`$a`," \\;+$| \\:+$")
marc_field490$`$a`[is.na(marc_field490$`$a`)] <- ""
marc_field490$`$v`[is.na(marc_field490$`$v`)] <- ""
marc_field490$seria <- str_remove(paste("(",marc_field490$`$a`,", ",marc_field490$`$v`,")",sep = ""),", (?=\\)$)")

marc_field490 <- marc_field490 %>%
  select(licznik,seria)

marc_field490 <- ddply(marc_field490, .(licznik), summarize, seria = paste(seria, collapse=" "))
test <- data %>%
  select(licznik)
za_seria_wydawnicza <- merge(x = test, y = marc_field490, by = "licznik", all = TRUE)
#31
za_tomy <-data.frame(licznik=1:lengths(data), za_tomy = NA)
#32
pracownik <- merge(x = dz_nazwa_full, y = redaktorzy_dzialow, by.x = "TW_DZ_DZIAL_ID", by.y =  "DZ_DZIAL_ID", all.x = TRUE)
pracownik <- pracownik[order(as.integer(as.character(pracownik$licznik))),]
pracownik <- pracownik %>%
  select(licznik,redaktor_dzialu)
colnames(pracownik) <- c("licznik", "pracownik")

dz_nazwa_full <- data.frame(dz_nazwa_full, pracownik = pracownik$pracownik)
#33 adnotacje
za_adnotacje <- data.frame(cbind(data$licznik, data$X505))
colnames(za_adnotacje) <- c("licznik","X505")
za_adnotacje$X505 <- ifelse(is.na(za_adnotacje$X505),"",as.character(za_adnotacje$X505))
za_adnotacje$adnotacje <- paste(za_adnotacje$adnotacje,za_adnotacje$X505,sep = "|")
za_adnotacje$adnotacje[za_adnotacje$adnotacje=="|"] <- ""
za_adnotacje <- za_adnotacje %>%
  select(1,2)
#łączenie
#wyrównanie liczby wierszy
autorzy <- data.frame(cbind(am_autor_id$licznik,am_autor_id$AM_AUTOR_ID,as.character(am_nazwisko$am_nazwisko),as.character(am_imie$am_imie)))
colnames(autorzy) <- c("licznik", "AM_AUTOR_ID", "AM_NAZWISKO", "AM_IMIE")
autorzy$AM_AUTOR_ID <- ifelse(is.na(autorzy$AM_AUTOR_ID),"",as.character(autorzy$AM_AUTOR_ID))
autorzy$AM_NAZWISKO <- ifelse(is.na(autorzy$AM_NAZWISKO),"",as.character(autorzy$AM_NAZWISKO))
autorzy$AM_IMIE <- ifelse(is.na(autorzy$AM_IMIE),"",as.character(autorzy$AM_IMIE))
autorzy <- ddply(autorzy, .(licznik), summarize, AM_AUTOR_ID = paste(AM_AUTOR_ID, collapse="|"), AM_NAZWISKO = paste(AM_NAZWISKO, collapse="|"), AM_IMIE = paste(AM_IMIE, collapse="|"))
autorzy <- autorzy[order(as.integer(as.character(autorzy$licznik))),]

wspoltworcy <- data.frame(cbind(BN_PBL_wspoltworcy$licznik, BN_PBL_wspoltworcy$OS_OSOBA_ID,as.character(b_os_nazwisko$os_nazwisko),as.character(b_os_imie$os_imie),BN_PBL_wspoltworcy$fo_symbol))
colnames(wspoltworcy) <- c("licznik", "OS_OSOBA_ID", "OS_NAZWISKO", "OS_IMIE", "FO_SYMBOL")
wspoltworcy$OS_OSOBA_ID <- ifelse(is.na(wspoltworcy$OS_OSOBA_ID),"",as.character(wspoltworcy$OS_OSOBA_ID))
wspoltworcy$OS_NAZWISKO <- ifelse(is.na(wspoltworcy$OS_NAZWISKO),"",as.character(wspoltworcy$OS_NAZWISKO))
wspoltworcy$OS_IMIE <- ifelse(is.na(wspoltworcy$OS_IMIE),"",as.character(wspoltworcy$OS_IMIE))
wspoltworcy$FO_SYMBOL <- ifelse(is.na(wspoltworcy$FO_SYMBOL),"",as.character(wspoltworcy$FO_SYMBOL))
wspoltworcy <- ddply(wspoltworcy, .(licznik), summarize, OS_OSOBA_ID = paste(OS_OSOBA_ID, collapse="|"), OS_NAZWISKO = paste(OS_NAZWISKO, collapse="|"), OS_IMIE = paste(OS_IMIE, collapse="|"), FO_SYMBOL = paste(FO_SYMBOL, collapse="|"))
wspoltworcy <- wspoltworcy[order(as.integer(as.character(wspoltworcy$licznik))),]

wydawnictwa <- data.frame(cbind(wy_wydawnictwo_id$licznik, wy_wydawnictwo_id$WY_WYDAWNICTWO_ID,wy_nazwa$wydawnictwo,wy_miejsce$miejsce_wydania))
colnames(wydawnictwa) <- c("licznik", "WY_WYDAWNICTWO_ID", "WY_NAZWA", "WY_MIEJSCE")
wydawnictwa$WY_WYDAWNICTWO_ID <- ifelse(is.na(wydawnictwa$WY_WYDAWNICTWO_ID),"",as.character(wydawnictwa$WY_WYDAWNICTWO_ID))
wydawnictwa$WY_NAZWA <- ifelse(is.na(wydawnictwa$WY_NAZWA),"",as.character(wydawnictwa$WY_NAZWA))
wydawnictwa$WY_MIEJSCE <- ifelse(is.na(wydawnictwa$WY_MIEJSCE),"",as.character(wydawnictwa$WY_MIEJSCE))
wydawnictwa <- ddply(wydawnictwa, .(licznik), summarize, WY_WYDAWNICTWO_ID = paste(WY_WYDAWNICTWO_ID, collapse="|"), WY_NAZWA = paste(WY_NAZWA, collapse="|"), WY_MIEJSCE = paste(WY_MIEJSCE, collapse="|"))
wydawnictwa <- wydawnictwa[order(as.integer(as.character(wydawnictwa$licznik))),]

polaczone <- data.frame(
  licznik = za_uwagi$licznik,
  rekord_BN = za_uwagi$za_uwagi,
  rz_nazwa = rz_nazwa$rz_nazwa,
  za_ro_rok = za_ro_rok$za_ro_rok,
  za_type = za_type$za_type,
  rz_rodzaj_id = rz_rodzaj_id$RZ_RODZAJ_ID,
  DZ_NAZWA = dz_nazwa$DZ_NAZWA,
  DZ_DZIAL_ID = dz_dzial_id$DZ_DZIAL_ID,
  tw_tworca_id = tw_tworca_id$TW_TWORCA_ID,
  am_autor_id = autorzy$AM_AUTOR_ID,
  am_nazwisko = autorzy$AM_NAZWISKO,
  am_imie = autorzy$AM_IMIE,
  za_tytul = za_tytul$tytul,
  za_tytul_oryginalu = za_tytul_oryginalu$tytul,
  za_jezyk_oryginalu = za_jezyk_oryginalu$jezyk_oryginalu,
  os_osoba_id = wspoltworcy$OS_OSOBA_ID,
  os_nazwisko = wspoltworcy$OS_NAZWISKO,
  os_imie = wspoltworcy$OS_IMIE,
  fo_symbol = wspoltworcy$FO_SYMBOL,
  za_opis_wspoltworcow = za_opis_wspoltworcow$za_opis_wspoltworcow,
  za_wydanie = za_wydanie$za_wydanie,
  za_tomy = za_tomy$za_tomy,
  za_instytucja = za_instytucja$instytucja,
  wy_wydawnictwo_id = wydawnictwa$WY_WYDAWNICTWO_ID,
  wy_miejsce = wydawnictwa$WY_MIEJSCE,
  wy_nazwa = wydawnictwa$WY_NAZWA,
  za_rok_wydania = za_rok_wydania$dobry_rok,
  za_opis_fizyczny_ksiazki = za_opis_fizyczny_ksiazki$za_opis_fizyczny_ksiazki,
  za_seria_wydawnicza = za_seria_wydawnicza$seria,
  tw_nazwisko = tw_nazwisko$TW_NAZWISKO,
  tw_imie = tw_imie$TW_IMIE,
  pracownik = pracownik$pracownik,
  za_adnotacje = za_adnotacje$X505
)

out <- cSplit(polaczone, c("am_autor_id", "am_nazwisko", "am_imie","os_osoba_id","os_nazwisko", "os_imie", "fo_symbol","wy_wydawnictwo_id","wy_miejsce","wy_nazwa"),sep = "|",direction = "long")
out <- out %>%
  unique()
out$licznik <- ifelse(is.na(out$licznik),'',as.character(out$licznik))
out$rekord_BN <- ifelse(is.na(out$rekord_BN),'',as.character(out$rekord_BN))
out$rz_nazwa <- ifelse(is.na(out$rz_nazwa),'',as.character(out$rz_nazwa))
out$za_ro_rok <- ifelse(is.na(out$za_ro_rok),'',as.character(out$za_ro_rok))
out$za_type <- ifelse(is.na(out$za_type),'',as.character(out$za_type))
out$rz_rodzaj_id <- ifelse(is.na(out$rz_rodzaj_id),'',as.character(out$rz_rodzaj_id))
out$DZ_NAZWA <- ifelse(is.na(out$DZ_NAZWA),'',as.character(out$DZ_NAZWA))
out$DZ_DZIAL_ID <- ifelse(is.na(out$DZ_DZIAL_ID),'',as.character(out$DZ_DZIAL_ID))
out$tw_tworca_id <- ifelse(is.na(out$tw_tworca_id),'',as.character(out$tw_tworca_id))
out$am_autor_id <- ifelse(is.na(out$am_autor_id),'',as.character(out$am_autor_id))
out$am_nazwisko <- ifelse(is.na(out$am_nazwisko),'',as.character(out$am_nazwisko))
out$am_imie <- ifelse(is.na(out$am_imie),'',as.character(out$am_imie))
out$za_tytul <- ifelse(is.na(out$za_tytul),'',as.character(out$za_tytul))
out$za_tytul_oryginalu <- ifelse(is.na(out$za_tytul_oryginalu),'',as.character(out$za_tytul_oryginalu))
out$za_jezyk_oryginalu <- ifelse(is.na(out$za_jezyk_oryginalu),'',as.character(out$za_jezyk_oryginalu))
out$os_osoba_id <- ifelse(is.na(out$os_osoba_id),'',as.character(out$os_osoba_id))
out$os_nazwisko <- ifelse(is.na(out$os_nazwisko),'',as.character(out$os_nazwisko))
out$os_imie <- ifelse(is.na(out$os_imie),'',as.character(out$os_imie))
out$fo_symbol <- ifelse(is.na(out$fo_symbol),'',as.character(out$fo_symbol))
out$za_opis_wspoltworcow <- ifelse(is.na(out$za_opis_wspoltworcow),'',as.character(out$za_opis_wspoltworcow))
out$za_wydanie <- ifelse(is.na(out$za_wydanie),'',as.character(out$za_wydanie))
out$za_tomy <- ifelse(is.na(out$za_tomy),'',as.character(out$za_tomy))
out$za_instytucja <- ifelse(is.na(out$za_instytucja),'',as.character(out$za_instytucja))
out$wy_wydawnictwo_id <- ifelse(is.na(out$wy_wydawnictwo_id),'',as.character(out$wy_wydawnictwo_id))
out$wy_miejsce <- ifelse(is.na(out$wy_miejsce),'',as.character(out$wy_miejsce))
out$wy_nazwa <- ifelse(is.na(out$wy_nazwa),'',as.character(out$wy_nazwa))
out$za_rok_wydania <- ifelse(is.na(out$za_rok_wydania),'',as.character(out$za_rok_wydania))
out$za_opis_fizyczny_ksiazki <- ifelse(is.na(out$za_opis_fizyczny_ksiazki),'',as.character(out$za_opis_fizyczny_ksiazki))
out$za_seria_wydawnicza <- ifelse(is.na(out$za_seria_wydawnicza),'',as.character(out$za_seria_wydawnicza))
out$tw_nazwisko <- ifelse(is.na(out$tw_nazwisko),'',as.character(out$tw_nazwisko))
out$tw_imie <- ifelse(is.na(out$tw_imie),'',as.character(out$tw_imie))
out$pracownik <- ifelse(is.na(out$pracownik),'',as.character(out$pracownik))
out$za_adnotacje <- ifelse(is.na(out$za_adnotacje),'',as.character(out$za_adnotacje))

out %$%  
    { licznik == dplyr::lag(licznik, 1) & rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,)} %>% 
    as.numeric() %>% 
    {.} -> out$same
out$same[1] <- 0
out$dzielone <- paste(out$am_autor_id,out$am_nazwisko,out$am_imie,out$os_osoba_id,out$os_nazwisko,out$os_imie,out$fo_symbol,out$wy_wydawnictwo_id,out$wy_miejsce,out$wy_nazwa,sep = "")

out <- out %>%
  filter(!(same==1&dzielone=="")) %>%
  select(1:33)

out %$%  
    { licznik == dplyr::lag(licznik, 1) & rekord_BN==lag(rekord_BN,) & rz_nazwa==lag(rz_nazwa,) & za_ro_rok==lag(za_ro_rok,) & za_type==lag(za_type,) & rz_rodzaj_id==lag(rz_rodzaj_id,) & DZ_NAZWA==lag(DZ_NAZWA,) & DZ_DZIAL_ID==lag(DZ_DZIAL_ID,) & tw_tworca_id==lag(tw_tworca_id,) & za_tytul==lag(za_tytul,) & za_tytul_oryginalu==lag(za_tytul_oryginalu,) & za_jezyk_oryginalu==lag(za_jezyk_oryginalu,) & za_opis_wspoltworcow==lag(za_opis_wspoltworcow,) & za_wydanie==lag(za_wydanie,) & za_tomy==lag(za_tomy,) & za_instytucja==lag(za_instytucja,) & za_rok_wydania==lag(za_rok_wydania,) & za_opis_fizyczny_ksiazki==lag(za_opis_fizyczny_ksiazki,) & za_seria_wydawnicza==lag(za_seria_wydawnicza,) & tw_nazwisko==lag(tw_nazwisko,) & tw_imie==lag(tw_imie,) & pracownik==lag(pracownik,) & za_adnotacje==lag(za_adnotacje,)} %>% 
    as.numeric() %>% 
    {.} -> out$same

out$rekord_BN[out$same == 1] <- ""
out$rz_nazwa[out$same == 1] <- ""
out$za_ro_rok[out$same == 1] <- ""
out$za_type[out$same == 1] <- ""
out$rz_rodzaj_id[out$same == 1] <- ""
out$DZ_NAZWA[out$same == 1] <- ""
out$DZ_DZIAL_ID[out$same == 1] <- ""
out$tw_tworca_id[out$same == 1] <- ""
out$za_tytul[out$same == 1] <- ""
out$za_tytul_oryginalu[out$same == 1] <- ""
out$za_jezyk_oryginalu[out$same == 1] <- ""
out$za_opis_wspoltworcow[out$same == 1] <- ""
out$za_wydanie[out$same == 1] <- ""
out$za_tomy[out$same == 1] <- ""
out$za_instytucja[out$same == 1] <- ""
out$za_rok_wydania[out$same == 1] <- ""
out$za_opis_fizyczny_ksiazki[out$same == 1] <- ""
out$za_seria_wydawnicza[out$same == 1] <- ""
out$tw_nazwisko[out$same == 1] <- ""
out$tw_imie[out$same == 1] <- ""
out$pracownik[out$same == 1] <- ""
out$za_adnotacje[out$same == 1] <- ""

out <- out %>%
  select(1:33)
write.csv2(out, "C:/Users/Cezary/Desktop/2005-2008_harlequiny_do_importu.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')
#out <- read.csv2("C:/Users/Cezary/Desktop/2005-2008_podmiotowa_do_importu.csv", encoding = "Windows-1250", header = TRUE, stringsAsFactors = FALSE)
#out$rekord_BN <- ifelse(is.na(out$rekord_BN),"", as.character(out$rekord_BN))
#out$rekord_BN <- ifelse(nchar(out$rekord_BN)==13,out$rekord_BN, sprintf("%013d", as.integer(out$rekord_BN)))
#out$rekord_BN[out$rekord_BN=="           NA"] <- ""
```

```{r harlequin - pomoc}
#twórcy
memory.limit(100000)
nowi_tworcy <- out %>%
  select(licznik, tw_nazwisko, tw_imie)
nowi_tworcy <- nowi_tworcy %>%
  filter(tw_nazwisko!="")
nowi_tworcy <- nowi_tworcy[order(nowi_tworcy$tw_nazwisko, nowi_tworcy$tw_nazwisko, as.integer(as.character(nowi_tworcy$licznik))),]
nowi_tworcy %$%  
    { tw_nazwisko==lag(tw_nazwisko,1) & tw_imie==lag(tw_imie,)} %>% 
    as.numeric() %>% 
    {.} -> nowi_tworcy$same
nowi_tworcy$same[1] <- 0
nowi_tworcy <- nowi_tworcy %>%
  filter(same==0) %>%
  select(-same)
nazwa <- ifelse(is.na(nowi_tworcy$tw_imie),as.character(nowi_tworcy$tw_nazwisko),paste(nowi_tworcy$tw_nazwisko,nowi_tworcy$tw_imie, sep = ""))
nazwa <- data.frame(nazwa = str_to_lower(str_replace_all(nazwa, "\\W", "")))
nowi_tworcy <- data.frame(nowi_tworcy,nazwa)
tworcy_pbl <- PBL_tworcy %>%
  select(1,2,3,18)

x <- 1:length(nowi_tworcy$licznik)

tworcy_check <- data.frame(licznik = as.character(), bn_nazwisko = as.character(), bn_imie = as.character(), n_aut = as.character(), TW_TWORCA_ID = as.character(), TW_NAZWISKO = as.character(), TW_IMIE = as.character(), V1 = as.character(), stringsAsFactors=FALSE)
for (i in x) {
progress(i, max.value = length(x))
lkj <- as.matrix(stringdistmatrix(a=nowi_tworcy$nazwa[i],b=tworcy_pbl$nazwa, method = "jw"))
lkj <- data.frame(V1 = as.vector(lkj))
kjh <- data.frame(licznik = rep(nowi_tworcy$licznik[i], length(tworcy_pbl$nazwa)), bn_nazwisko = rep(nowi_tworcy$tw_nazwisko[i], length(tworcy_pbl$nazwa)), bn_imie = rep(nowi_tworcy$tw_imie[i], length(tworcy_pbl$nazwa)), n_aut = rep(nowi_tworcy$nazwa[i], length(tworcy_pbl$nazwa)), tworcy_pbl, lkj)
kjh <- kjh[order(kjh$V1),]
kjh <- kjh %>%
  top_n(-5,V1)
tworcy_check <- rbind(tworcy_check,kjh)
}
write.csv2(tworcy_check, "C:/Users/Cezary/Desktop/2005-2008_tworcy_check_har.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')

#wydawnictwa
nowe_wydawnictwo <- out %>%
  select(licznik, wy_miejsce, wy_nazwa)
nowe_wydawnictwo <- nowe_wydawnictwo %>%
  filter(wy_miejsce!="")
nowe_wydawnictwo <- nowe_wydawnictwo[order(nowe_wydawnictwo$wy_nazwa, nowe_wydawnictwo$wy_miejsce, as.integer(as.character(nowe_wydawnictwo$licznik))),]
nowe_wydawnictwo %$%  
    { wy_nazwa==lag(wy_nazwa,1) & wy_miejsce==lag(wy_miejsce,)} %>% 
    as.numeric() %>% 
    {.} -> nowe_wydawnictwo$same
nowe_wydawnictwo$same[1] <- 0
nowe_wydawnictwo <- nowe_wydawnictwo %>%
  filter(same==0) %>%
  select(-same)
nazwa <- ifelse(is.na(nowe_wydawnictwo$wy_nazwa),as.character(nowe_wydawnictwo$wy_miejsce),paste(nowe_wydawnictwo$wy_miejsce,nowe_wydawnictwo$wy_nazwa, sep = ""))
nazwa <- data.frame(nazwa = str_to_lower(str_replace_all(nazwa, "\\W", "")))
nowe_wydawnictwo <- data.frame(nowe_wydawnictwo,nazwa)
wydawnictwa_pbl <- PBL_wydawnictwa %>%
  select(1,3,2,10)

x <- 1:length(nowe_wydawnictwo$licznik)

wydawnictwa_check <- data.frame(licznik = as.character(), bn_miejsce = as.character(), bn_nazwa = as.character(), n_aut = as.character(), WY_WYDAWNICTWO_ID = as.character(), WY_MIEJSCE = as.character(), WY_NAZWA = as.character(), V1 = as.character(), stringsAsFactors=FALSE)
for (i in x) {
progress(i, max.value = length(x))
lkj <- as.matrix(stringdistmatrix(a=nowe_wydawnictwo$nazwa[i],b=wydawnictwa_pbl$nazwa_prosta, method = "jw"))
lkj <- data.frame(V1 = as.vector(lkj))
kjh <- data.frame(licznik = rep(nowe_wydawnictwo$licznik[i], length(wydawnictwa_pbl$nazwa_prosta)), bn_miejsce = rep(nowe_wydawnictwo$wy_miejsce[i], length(wydawnictwa_pbl$nazwa_prosta)), bn_nazwa = rep(nowe_wydawnictwo$wy_nazwa[i], length(wydawnictwa_pbl$nazwa_prosta)), n_aut = rep(nowe_wydawnictwo$nazwa[i], length(wydawnictwa_pbl$nazwa_prosta)), wydawnictwa_pbl, lkj)
kjh <- kjh[order(kjh$V1),]
kjh <- kjh %>%
  top_n(-5,V1)
wydawnictwa_check <- rbind(wydawnictwa_check,kjh)
}
write.csv2(wydawnictwa_check, "C:/Users/Cezary/Desktop/2005-2008_wydawnictwa_check_har.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')
```

```{r aktualizacja harlequinów}
#tworcy
tworcy_check_har <- gs_read(gs_title("2005-2008_tworcy_check_har"))
tworcy_check_har <- tworcy_check_har %>%
  filter(decyzja=="tak") %>%
  select(bn_nazwisko, bn_imie, TW_TWORCA_ID)
tworcy_check_har$merge_tworcy <- paste(tworcy_check_har$bn_nazwisko,tworcy_check_har$bn_imie,sep = "|")
out$merge_tworcy <- paste(out$tw_nazwisko,out$tw_imie,sep = "|")

final <- merge(x=out, y=tworcy_check_har, by = "merge_tworcy", all.x = TRUE)
final <-final[order(as.integer(as.character(final$licznik)), final$DZ_NAZWA, final$am_autor_id, final$am_nazwisko, final$os_osoba_id, final$os_nazwisko, final$wy_wydawnictwo_id, final$wy_nazwa),]

final$TW_TWORCA_ID[final$tw_nazwisko==""|final$tw_nazwisko!=final$bn_nazwisko] <- NA
final$bn_nazwisko[final$tw_nazwisko==""|final$tw_nazwisko!=final$bn_nazwisko] <- NA
final$bn_imie[final$tw_nazwisko==""|final$tw_nazwisko!=final$bn_nazwisko] <- NA

final <- mutate(final,
                napr = ifelse(final$tw_tworca_id=="",as.character(final$TW_TWORCA_ID),as.character(final$tw_tworca_id)))
final$tw_tworca_id <- final$napr

final$tw_imie <- ifelse(is.na(final$tw_tworca_id),as.character(final$tw_imie),NA)
final$tw_nazwisko <- ifelse(is.na(final$tw_tworca_id),as.character(final$tw_nazwisko),NA)
final <- final %>% 
  select(2:34)

#wydawnictwa
wydawnictwa_check_har <- gs_read(gs_title("2005-2008_wydawnictwa_check_har"))
wydawnictwa_check_har <- wydawnictwa_check_har %>%
  filter(decyzja=="tak") %>%
  select(bn_nazwa,bn_miejsce,WY_WYDAWNICTWO_ID)

wydawnictwa_check_har$bn_miejsce <- str_remove(wydawnictwa_check_har$bn_miejsce," \\[{0,10}etc\\.{0,10}\\]\\s{0,10}$")
wydawnictwa_check_har$bn_nazwa <- str_remove(wydawnictwa_check_har$bn_nazwa," \\[{0,10}etc\\.{0,10}\\s{0,10}$")
wydawnictwa_check_har$bn_miejsce <- ifelse(grepl("\\[",wydawnictwa_check_har$bn_miejsce)&!grepl("\\]",wydawnictwa_check_har$bn_miejsce),str_remove(BN_wydawnictwo$bn_miejsce,"\\["),as.character(wydawnictwa_check_har$bn_miejsce))
wydawnictwa_check_har$bn_nazwa <- ifelse(grepl("\\]",wydawnictwa_check_har$bn_nazwa)&!grepl("\\[",wydawnictwa_check_har$bn_nazwa),str_remove(wydawnictwa_check_har$bn_nazwa,"\\]"),as.character(wydawnictwa_check_har$bn_nazwa))

wydawnictwa_check_har$merge_wyd <- paste(wydawnictwa_check_har$bn_nazwa,wydawnictwa_check_har$bn_miejsce,sep = "|")
final$merge_wyd <- paste(final$wy_nazwa,final$wy_miejsce,sep = "|")

final <- merge(x=final, y=wydawnictwa_check_har, by = "merge_wyd", all.x = TRUE)

final <-final[order(as.integer(as.character(final$licznik)), final$DZ_NAZWA, final$am_autor_id, final$am_nazwisko, final$os_osoba_id, final$os_nazwisko, final$wy_wydawnictwo_id, final$wy_nazwa),]

final$WY_WYDAWNICTWO_ID[final$wy_nazwa==""&is.na(final$wy_miejsce)] <- NA
final$wy_miejsce[final$wy_nazwa==""&is.na(final$wy_miejsce)] <- NA
final$wy_nazwa[final$wy_nazwa==""&is.na(final$wy_miejsce)] <- NA

final <- mutate(final,
                napr = ifelse(final$wy_wydawnictwo_id=="",as.character(final$WY_WYDAWNICTWO_ID),as.character(final$wy_wydawnictwo_id)))
final$wy_wydawnictwo_id <- final$napr

final$wy_miejsce <- ifelse(is.na(final$wy_wydawnictwo_id),as.character(final$wy_miejsce),NA)
final$wy_nazwa <- ifelse(is.na(final$wy_wydawnictwo_id),as.character(final$wy_nazwa),NA)
final <- final %>%
  select(2:34)
final$rekord_BN <- ifelse(final$rekord_BN=="","",paste("'",final$rekord_BN,sep = ""))
write.csv2(final, "C:/Users/Cezary/Desktop/2005_2008_harlequiny_gotowe.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')
#write.csv2(final, "C:/Users/cezar/Desktop/gotowe.csv", row.names = F, na = '', fileEncoding = 'Windows-1250')
```

